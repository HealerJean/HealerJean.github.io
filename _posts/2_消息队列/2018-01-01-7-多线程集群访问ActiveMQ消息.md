---
title: 多线程集群访问ActiveMQ消息
date: 2018-01-01 03:33:00
tags: 
- MQ
category: 
- MQ
description: 多线程集群访问ActiveMQ消息
---

<!-- 

https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/blogImages/
　　首行缩进

<font  clalss="healerColor" color="red" size="5" >     </font>

<font  clalss="healerSize"  size="5" >     </font>
-->




## 前言

#### [博主github](https://github.com/HealerJean)
#### [博主个人博客http://blog.healerjean.com](http://HealerJean.github.io)    



## 解释

+ 一般情况下，相同消费者的情况下，static静态的接收的消息比单个接收的消息多（未经测试完全）

+ 准备工作：一旦有消费者率先读取到消息之后，就会霸占所有的消息，所以测试的话，一定要先开启所有的消费者，在打开生产者

  

### 1、生产者`Producer61616`

```java

import com.hlj.activemq.constants.ActiveMqConstant;
import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;


public class Producer61616 {

    /**
     * 队列的名称
     */
    public static final String QUEUE_NAME = "Thread.Consumer.queue";
    /** 发送消息的数量 */
    private static final int SEND_NUMBER = 50;

    public static void main(String[] args) {

        ConnectionFactory connectionFactory = new ActiveMQConnectionFactory(
                ActiveMqConstant.USERNAME,
                ActiveMqConstant.PASSWORD,
                ActiveMqConstant.BROKER_URL);
        try {
            // 构造从工厂得到连接对象
            Connection connection = connectionFactory.createConnection();
            connection.start();

            // 获取操作连接,一个发送或接收消息的线程
            Session session = connection.createSession(
                    Boolean.TRUE,
                    Session.AUTO_ACKNOWLEDGE);

            // 消息的目的地;消息发送给谁.
            Destination destination = session.createQueue(QUEUE_NAME);

            // 根据目的地获取一个生产者
            MessageProducer producer = session.createProducer(destination);

            //构造消息
            sendTextMessage(session, producer);
            session.commit();
            session.close();
            connection.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


    /**
     * 1、创建TextMessage
     */
    private static void sendTextMessage(Session session, MessageProducer producer) throws JMSException {
        for (int i = 1; i <= SEND_NUMBER; i++) {
            TextMessage message = session.createTextMessage("ActiveMq 发送的消息" + i);
            // 发送消息到目的地方
            System.out.println("发送消息：" + "ActiveMq 发送的消息" + i);
            producer.send(message);
        }
    }






}

```





### 2、线程类`ConsumerThread`

```java
import javax.jms.*;

/**
 * @author HealerJean
 * @ClassName ConsumerThread
 * @date 2019/9/4  16:26.
 * @Description
 */
public class ConsumerThread extends Thread {

    private ConnectionFactory cf ;
    private String queueName ;

    public ConsumerThread(ConnectionFactory cf,String queueName){
        this.cf = cf;
        this.queueName = queueName;
    }

    @Override
    public void run(){
        try{
            Connection connection = cf.createConnection();
            connection.start();
            Session session = connection.createSession(Boolean.TRUE, Session.AUTO_ACKNOWLEDGE);
            Destination destination = session.createQueue(queueName);
            MessageConsumer consumer = session.createConsumer(destination);
            consumer.setMessageListener(msg -> {
                try {
                    TextMessage textMessage = (TextMessage)msg;
                    System.out.println(textMessage.getText());
                    session.commit();
                    session.close();
                    connection.close();
                } catch (JMSException e) {
                    e.printStackTrace();
                }
            });

        }catch(Exception err){
            err.printStackTrace();
        }
    }

}
```



### 3、消费者 `Consumer61616`

```java
public class Consumer61616 {


    public static final String QUEUE_NAME = "Thread.Consumer.queue";
    public static final String TCP_URL = "tcp://localhost:61616";
    public static final  int THREAD_COUNT = 5 ;

    public static void main(String[] args) {
        ConnectionFactory connectionFactory = new ActiveMQConnectionFactory(
                ActiveMqConstant.USERNAME,
                ActiveMqConstant.PASSWORD,
                TCP_URL);

        for (int i = 1; i <= THREAD_COUNT; i++) {
            Thread thread = new ConsumerThread(connectionFactory, QUEUE_NAME);
            thread.start();
            System.out.println("线程"+i+"启动");
        }
    }

}
```



### 4、消费者`Consumer61617`

```java

import com.hlj.activemq.constants.ActiveMqConstant;
import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;


public class Consumer61617 {


    public static final String QUEUE_NAME = "Thread.Consumer.queue";
    public static final String TCP_URL = "tcp://localhost:61617";
    public static final  int THREAD_COUNT = 5 ;

    public static void main(String[] args) {
        ConnectionFactory connectionFactory = new ActiveMQConnectionFactory(
                ActiveMqConstant.USERNAME,
                ActiveMqConstant.PASSWORD,
                TCP_URL);

        for (int i = 1; i <= THREAD_COUNT; i++) {
            Thread thread = new ConsumerThread(connectionFactory, QUEUE_NAME);
            thread.start();
            System.out.println("线程"+i+"启动");
        }
    }


}
```





### 5、运行这两个消费者

#### 5.1、61616消费者控制台

![1567593167953](D:\study\HealerJean.github.io\blogImages\1567593167953.png)



#### 5.2、61617消费者控制台

![1567593184368](D:\study\HealerJean.github.io\blogImages\1567593184368.png)





### 6、运行生产者，成功消费

![1567593256078](D:\study\HealerJean.github.io\blogImages\1567593256078.png)











<font  color="red" size="5" >     
感兴趣的，欢迎添加博主微信
 </font>       

   



哈，博主很乐意和各路好友交流，如果满意，请打赏博主任意金额，感兴趣的在微信转账的时候，备注您的微信或者其他联系方式。添加博主微信哦。    

请下方留言吧。可与博主自由讨论哦

|微信 | 微信公众号|支付宝|
|:-------:|:-------:|:------:|
| ![微信](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|![支付宝](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/alpay.jpg) |



<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'gUJPFkC9I6afHv8L',
    });
    gitalk.render('gitalk-container');
</script> 

