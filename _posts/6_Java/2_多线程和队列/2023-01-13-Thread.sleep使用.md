---
title: Thread.sleep使用
date: 2023-01-13 00:00:00
tags: 
- Java
category: 
- Java
description: Thread.sleep使用
---

**前言**     

 Github：[https://github.com/HealerJean](https://github.com/HealerJean)         

 博客：[http://blog.healerjean.com](http://HealerJean.github.io)          

# 1、思考两个问题

**Q1：假设现在是 2021-05-04 12:00:00.000，如果我调用一下 Thread.Sleep(1000) ，在 2021-05-04 12:00:01.000 的时候，这个线程会不会被唤醒？ **    

A1：不一定。因为你只是告诉操作系统：在未来的1000毫秒内我不想再参与到 `CPU` 竞争。那么 `1000` 毫秒过去之后，这时候也许另外一个线程正在使用 `CPU` ，那么这时候操作系统是不会重新分配 `CPU` 的，直到那个线程挂起或结束；况且，即使这个时候恰巧轮到操作系统进行 `CPU` 分配，那么当前线程也不一定就是总优先级最高的那个，`CPU` 还是可能被其他线程抢占去。       



**Q2：某人的代码中用了一句看似莫明其妙的话：Thread.Sleep(0) 。既然是 Sleep 0 毫秒，那么他跟去掉这句代码相比，有啥区别么**？       

A2：有，而且区别很明显。`Thread.Sleep(0)` 的作用，就是“触发操作系统立刻重新进行一次 `CPU` 竞争”。竞争的结果也许是当前线程仍然获得 `CPU` 控制权，也许会换成别的线程获得 `CPU` 控制权。**这也是我们在大循环里面经常会写一句 `Thread.Sleep(0)`  ，因为这样就给了其他线程比如 `Paint` 线程获得 `CPU` 控制权的权力，这样界面就不会假死在那里**。



# 2、介绍

```java
while (true) {
  if( check() ) {
    //执行某个操作
  }
  Thread.sleep(10);
}

```

**出现的问题：**这么做可以让线程每个 `10` 毫秒陷入一次睡眠，避免 `while` 死循环大量暂用 `CPU` 时间。然而`Thread.sleep` 的执行并非没有成本，如果循环中 `sleep` 的时间过短，开销也非常大。

**原因：`sleep` 的主要开销来自线程的切换，当代码运行到 `Thread.sleep` 时，当前线程进入 `time_wait`状态，通常我们会说线程进入睡眠状态，此时该线程不需要占用 `CPU`了，操作系统就会执行一次线程切换，将该线程的 `CPU` 时间给其他线程使用，这种切换叫做主动线程切换，是该线程使用 `sleep` 主动让出 `CPU` 时间，而不是 `CPU` 时间用完了操作系统将`CPU`使用权强行切换给其他线程。**     

网上有人对线程上下文切换时间做过计算，每一次大概需要消耗5微妙左右`CPU` 时间。而每一次 `sleep` 会造成2次线程切换，一次切出去， 一次切回来，那么就会消耗 `10` 微妙 `CPU` 时间。这个消耗虽然很小，但是架不住次数多，就像上面的示例进程，每条切换将近 `500` 次数，那么这个进程每运行 `1` 秒，就会平白浪费 `500` 微妙也就是 `5` 毫秒在线程切换上，这是一种可耻的浪费。      

系统调用相对于普通代码执行，也是一项重量级操作，每执行一次系统调用，操作系统需要将该线程的状态从用户太切为内核态，完成后还需要切回来，这也设计到执行现场的保存和恢复，设计到 `CPU` 上下文切换。 当然，系统调用的切换开销不及线程切换的开销大，据统计，每次系统调用，涉及到切换小下文的的消耗时间为 `200` 纳秒，远小于线程切换的 `5` 微妙，但是如果次数多了，消耗的总和也不可忽视。



**重点：**`sleep` 期间是不占用 `cpu` 的，对 `sleep` 来说，占用 `cpu` 主要是 `cpu` 时间片切换耗费的时间



# 3、使用场景

> 不建议使用，使用信号量等















![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'im6axJVCX31S8Kpn',
    });
    gitalk.render('gitalk-container');
</script> 




<!-- Gitalk end -->



