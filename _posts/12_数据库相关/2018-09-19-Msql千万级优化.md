---
title: Msqlåƒä¸‡çº§ä¼˜åŒ–
date: 2018-09-19 03:33:00
tags: 
- Database
category: 
- Database
description: Msqlåƒä¸‡çº§ä¼˜åŒ–
---
**å‰è¨€**     

 Githubï¼š[https://github.com/HealerJean](https://github.com/HealerJean)         

 åšå®¢ï¼š[http://blog.healerjean.com](http://HealerJean.github.io)          



# ä¸€ã€åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜ `SQL`** 

> è§£é‡Šï¼šè¡¨ä¸­çš„å­—æ®µè¶Šå¤šä¸‹é¢çš„ä¼˜åŒ–è¶Šæ˜æ˜¾ï¼Œå¦åˆ™å³ä½¿ä½¿ç”¨äº†ä¸‹é¢çš„ä¼˜åŒ–ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾   
>
> é€šè¿‡ä¸‹é¢çš„å¯ä»¥è§‚å¯Ÿåˆ° å½“è¾¾åˆ°`1000`ä¸‡çš„æ—¶å€™ï¼ŒæŸ¥è¯¢æ—¶é—´åˆ°äº†37sï¼Œå¤ªå¯æ€•äº†    
>

```sql
select * from tb_ams_inf_repay_stat limit 0,10 ; 
#  0.003s

select * from tb_ams_inf_repay_stat  limit 10000,10 ;  
# 1ä¸‡ 0.023s

select * from tb_ams_inf_repay_stat  limit 100000,10 ;
# 10ä¸‡ 0.191s

select * from tb_ams_inf_repay_stat limit 1000000,10 ;
# 100ä¸‡ 1.942s

select * from tb_ams_inf_repay_stat limit 10000000,10 ;
# 1000ä¸‡ 37.323s

```

## 1ã€ç®€å•ä¼˜åŒ–

#### 1ï¼‰å­æŸ¥è¯¢

> 0.23s ç®€ç›´è¦é£èµ·æ¥äº†    
>
> **1ã€å…ˆä½¿ç”¨è¦†ç›–ç´¢å¼• `index` æŸ¥è¯¢ ï¼Œæˆ‘ä»¬åªæŸ¥è¯¢ `id` ç´¢å¼•è¿™ä¸€ä¸ªå­—æ®µï¼Œæ¯” `select * ` æˆ–è€…å¤šä¸ªå­—æ®µå¿«å¤šäº†ï¼Œå› ä¸ºåªè¦æˆ‘ä»¬å†™ä¸Šè¿™äº›å­—æ®µï¼Œæˆ‘ä»¬åªéœ€è¦ `10`ä¸ªï¼Œä½†æ˜¯ä»ç¬¬ä¸€æ¡å¼€å§‹åˆ° `1000`ä¸‡æ¡å…¶å®æ˜¯éƒ½è¦å»æ‰«æçš„**     
>
> **2ã€ç„¶åå†è¿›è¡Œç´¢å¼•èŒƒå›´å†… `range`æŸ¥è¯¢** 

```sql
0.23s 
select *
from tb_ams_inf_repay_stat
where id > (select id from tb_ams_inf_repay_stat limit 1000000, 1)
limit 0,10 ;


--æ¨èä½¿ç”¨ 
select * from table where id > 243800 order by id limit 10;
```


<table border="1" style="border-collapse:collapse">
<tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr>
<tr><td>1</td><td>PRIMARY</td><td>tb_ams_inf_repay_stat</td><td>range</td><td>PRIMARY</td><td>PRIMARY</td><td>8</td><td>NULL</td><td>3258410</td><td>Using where</td></tr>
<tr><td>2</td><td>SUBQUERY</td><td>tb_ams_inf_repay_stat</td><td>index</td><td>NULL</td><td>idx_orgcd_loannum</td><td>216</td><td>NULL</td><td>19753500</td><td>Using index</td></tr></table>


#### 2ï¼‰`Join` è¿æ¥

```sql
-- 0.31 

SELECT *
FROM tb_ams_inf_repay_stat a
       JOIN (select id from tb_ams_inf_repay_stat limit 1000010, 10) b ON a.ID = b.id
```

<table border="1" style="border-collapse:collapse">
<tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr>
<tr><td>1</td><td>PRIMARY</td><td>&lt;derived2&gt;</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>1000020</td><td>NULL</td></tr>
<tr><td>1</td><td>PRIMARY</td><td>a</td><td>eq_ref</td><td>PRIMARY</td><td>PRIMARY</td><td>8</td><td>b.id</td><td>1</td><td>NULL</td></tr>
<tr><td>2</td><td>DERIVED</td><td>tb_ams_inf_repay_stat</td><td>index</td><td>NULL</td><td>idx_orgcd_loannum</td><td>216</td><td>NULL</td><td>19753500</td><td>Using index</td></tr></table>


## 2ã€å…¶ä»–ä¼˜åŒ–

### 1ï¼‰å¸¦æœ‰æ¡ä»¶çš„ï¼Œ`id` è¿ç»­çš„æŸ¥è¯¢ï¼ˆ`between`ï¼‰

```sql
0.03s 
select * from tb_ams_inf_repay_stat  where id  between 1000000 and 1000010  	 ;
```



### 2ï¼‰å¸¦æœ‰æ¡ä»¶ï¼Œ`id` ä¸è¿ç»­çš„æŸ¥è¯¢ï¼Œè€ƒè™‘å»ºç«‹ç´¢å¼•

```sql
20s æ…¢æ­»äº†
select * from tb_ams_inf_repay_stat  	where org_cd = 'xmsd'  	limit 1000000,10 ;
```

```java
-- org_cdå»ºç«‹ç´¢å¼•

select *
from tb_ams_inf_repay_stat
where org_cd = 'xmsd'
  and id > (select id from tb_ams_inf_repay_stat where org_cd = 'xmsd' limit 1000000,1)
limit 0,10 ;

0.2s å¯ä»¥è¯´ç›¸å½“çš„å¿«äº† 
```




<table>
<tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr>
<tr><td>1</td><td>PRIMARY</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>~~~~</td></tr>
<tr><td>2</td><td>SUBQUERY</td><td>tb_ams_inf_repay_stat</td><td>ref</td><td>idx_orgcd_loannum</td><td>idx_orgcd_loannum</td><td>93</td><td>const</td><td>1</td><td>Using where; Using index</td></tr></table>




# äºŒã€åƒä¸‡æµ‹è¯•æ•°æ®ç”Ÿæˆ

## 1ã€å­˜å‚¨è¿‡ç¨‹

### 1ï¼‰è¡¨

```java
create table if not exists `user_demo`
(
    `id`          bigint unsigned not null auto_increment comment 'ä¸»é”®',
    `name`        varchar(32)     not null default '' comment 'å§“å',
    `age`         int             not null default 0 comment 'å¹´é¾„',
    `phone`       varchar(32)     not null default '' comment 'ç”µè¯',
    `email`       varchar(64)     not null default '' comment 'é‚®ç®±',
    `start_time`  datetime                 default null comment 'å¼€å§‹æ—¶é—´',
    `end_time`    datetime                 default null comment 'ç»“æŸæ—¶é—´',
    `valid_flag`  int             not null default 1 comment '1æœ‰æ•ˆ 0 åºŸå¼ƒ',
    `create_time` datetime        not null default current_timestamp comment 'åˆ›å»ºæ—¶é—´',
    `update_time` datetime        not null default current_timestamp on update current_timestamp comment 'æ›´æ–°æ—¶é—´',
    primary key (`id`)
) engine = innodb
  default charset = utf8;

```

### 2ï¼‰å­˜å‚¨è¿‡ç¨‹

```sql
drop procedure if exists test_batch_create;
create procedure test_batch_create(in loop_counts int, in date varchar(50))
begin
    declare i int;
    set i = 0;
    set autocommit = 0; -- å…³é—­è‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œæé«˜æ’å…¥æ•ˆç‡
    while i < loop_counts
        do
            insert into `user_demo` (name, age, phone, email, start_time, end_time, valid_flag)
            values (concat('å¼ ', floor(rand() * 2 * i)), floor(rand() * i), floor(rand() * 3 * i),
                    concat( floor(rand() * 2 * i), '@gmail.com'), date_add(date ,interval i day), date_add(date ,interval i*2 day), 1);
            set i = i + 1;
        end while;
    commit;
end;

```

### 3ï¼‰æ‰§è¡Œ

```sql
CALL test_batch_create(10, '2023-07-01');
```





# ä¸‰ã€ä¸‰ç§å¤§æ•°æ®é‡æŸ¥è¯¢

## 1ã€ä¸‰ç§å¤§æ•°æ®æŸ¥è¯¢æ–¹å¼å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦               | æµå¼æŸ¥è¯¢ï¼ˆ`Streaming`ï¼‰          | `LIMIT` åˆ†é¡µ                   | `id > last_id LIMIT size`    |
| ---------------------- | -------------------------------- | ------------------------------ | ---------------------------- |
| **åŸç†**               | æ•°æ®åº“é€è¡Œè¿”å›ï¼Œå®¢æˆ·ç«¯è¾¹è¯»è¾¹å¤„ç† | è·³è¿‡ `offset` è¡Œï¼Œå– `size` æ¡ | åŸºäºä¸»é”®ï¼Œä»ä¸Šæ¬¡ç»“æŸä½ç½®ç»§ç»­ |
| **æ€§èƒ½ï¼ˆå¤§æ•°æ®é‡ï¼‰**   | æœ€ä¼˜                             | å·®ï¼Œ`offset` è¶Šå¤§è¶Šæ…¢ï¼‰        | å¥½ï¼Œä½†ä¾èµ–ç´¢å¼•ï¼‰             |
| **å†…å­˜å ç”¨ï¼ˆå®¢æˆ·ç«¯ï¼‰** | ä½ï¼Œé€æ¡å¤„ç†                     | ä¸­ç­‰ï¼Œæ¯é¡µåŠ è½½                 | ä¸­ç­‰ï¼Œæ¯é¡µåŠ è½½               |
| **æ•°æ®åº“è¿æ¥å ç”¨**     | é«˜ï¼Œéœ€é•¿æ—¶é—´ä¿æŒ                 | ä½ï¼ŒçŸ­è¿æ¥                     | ä½ï¼ŒçŸ­è¿æ¥                   |
| **å®ç°å¤æ‚åº¦**         | é«˜                               | ä½                             | ä¸­                           |
| **æ˜¯å¦æ”¯æŒéšæœºè·³é¡µ**   | ä¸æ”¯æŒ                           | æ”¯æŒï¼ˆå¦‚ç¬¬100é¡µï¼‰              | ä¸æ”¯æŒï¼ˆåªèƒ½ä¸‹ä¸€é¡µ           |
| **é€‚ç”¨åœºæ™¯**           | å¯¼å‡ºã€`ETL`ã€å®æ—¶å¤„ç†            | å‰ç«¯åˆ†é¡µå±•ç¤º                   | åå°ä»»åŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—æ‹‰å–       |



## 2ã€ä¸‰ç§æŸ¥è¯¢ä»‹ç»

### 1ï¼‰æµå¼æŸ¥è¯¢

- æµå¼æŸ¥è¯¢ = **æœåŠ¡å™¨ç«¯æ¸¸æ ‡ + å®¢æˆ·ç«¯é€è¡Œè¯»å–**
- ä¼˜ç‚¹ï¼šå†…å­˜ä½ã€å“åº”å¿«ï¼ˆé¦–æ¡æ•°æ®å¿«ï¼‰ã€å¿«ç…§å›ºå®š
- ç¼ºç‚¹ï¼šè¿æ¥é•¿ã€ä¸èƒ½è·³é¡µã€å®ç°å¤æ‚

```java
@GetMapping(value = "selectList", produces = MediaType.APPLICATION_JSON_UTF8_VALUE)
@ResponseBody
public ResponseBean selectList() {
    List<User> users = Lists.newArrayList();

    try(SqlSession sqlSession = sqlSessionFactory.openSession()){
        UserMapper mapper = sqlSession.getMapper(UserMapper.class);
        mapper.getStreamAll(new ResultHandler<User>() {
            private int batchCount = 0;
            private List<User> batch = new ArrayList<>(1000);
            @Override
            public void handleResult(ResultContext<? extends User> resultContext) {
                User user = resultContext.getResultObject();
                batch.add(user);
                batchCount++;

                // æ¯ 1000 æ¡å¤„ç†ä¸€æ¬¡ï¼ˆå¦‚æ‰¹é‡å…¥åº“ã€å†™æ–‡ä»¶ï¼‰
                if (batchCount % 1000 == 0) {
                    processBatch(batch);
                    batch.clear();
                    sqlSession.commit();
                }
            }
            private void processBatch(List<User> batch) {
                // ä¾‹å¦‚ï¼šæ‰¹é‡æ’å…¥ã€å¯¼å‡ºæ–‡ä»¶ã€å‘é€æ¶ˆæ¯ç­‰
            }
        });
        sqlSession.commit();
    }

    log.info("ç”¨æˆ·ç®¡ç†--------selectLisï¼šã€{}ã€‘", JsonUtils.toJsonString(users));
    return ResponseBean.buildSuccess(users);
}
```



#### aã€å·¥ä½œåŸç†

1. **å»ºç«‹è¿æ¥åï¼Œå‘é€ SQL æŸ¥è¯¢**ï¼š `SELECT * FROM user`
2. **`JDBC` é©±åŠ¨è®¾ç½®æµå¼æ¨¡å¼**ï¼š
   - è°ƒç”¨ `Statement.setFetchSize(Integer.MIN_VALUE)`ï¼ˆ**ä½†æ¯æ¬¡è¯»å–çš„å—å¤§å°ç”±é©±åŠ¨å†³å®š**ï¼‰
     - `Integer.MIN_VALUE` æ˜¯ `MySQL JDBC` é©±åŠ¨çš„â€œé­”æ³•å€¼â€ï¼Œè¡¨ç¤ºâ€œè¯·ç”¨æµå¼â€
     - å‘Šè¯‰æ•°æ®åº“ï¼šâ€œæˆ‘è¦æµå¼è¯»å–ï¼Œä¸è¦ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ç»“æœåŠ è½½åˆ°å†…å­˜ã€‚
3. **æ•°æ®åº“å¼€å§‹è¿”å›æ•°æ®å—ï¼ˆ`Chunk`ï¼‰**ï¼š
   - æ•°æ®åº“ä¸ä¼šä¸€æ¡ä¸€æ¡å‘ï¼Œè€Œæ˜¯æŒ‰**ç½‘ç»œåŒ…å¤§å°æˆ–é©±åŠ¨ç¼“å†²åŒº**ï¼ˆå¦‚ 4KBã€8KBï¼‰åˆ†æ‰¹å‘é€ã€‚
   - ä¾‹å¦‚ï¼šä¸€æ¬¡å‘ `100` æ¡ï¼Œä¸‹ä¸€æ¬¡å†å‘ `100` æ¡â€¦â€¦
4. **`JDBC` é©±åŠ¨åœ¨æœ¬åœ°ç»´æŠ¤ä¸€ä¸ªå°å‹ç¼“å†²åŒº**ï¼š
   - å½“ç¼“å†²åŒºçš„æ•°æ®è¢«ç¨‹åºæ¶ˆè´¹å®Œï¼Œé©±åŠ¨ä¼šè‡ªåŠ¨ä»ç½‘ç»œè¯»å–ä¸‹ä¸€æ‰¹ã€‚
5. **`MyBatis` å°†æ¯æ¡è®°å½•å–å‡ºï¼Œå›è°ƒ `handleResult()`**ï¼š
   - å¯¹ä½ æ¥è¯´ï¼Œå°±æ˜¯â€œä¸€æ¡ä¸€æ¡â€åœ°å¤„ç†ã€‚



#### bã€**æ˜¯â€œä¸€æ¡ä¸€æ¡â€è¯»å–å—ï¼Ÿ**

| é—®é¢˜                     | å›ç­”                                             |
| ------------------------ | ------------------------------------------------ |
| **æ˜¯â€œä¸€æ¡ä¸€æ¡â€è¯»å–å—ï¼Ÿ** | **ä»åº”ç”¨å¤„ç†è§’åº¦çœ‹ï¼šæ˜¯çš„ï¼Œæ¯æ¡è®°å½•éƒ½å•ç‹¬å›è°ƒã€‚** |
| **åº•å±‚çœŸçš„åªä¼ ä¸€æ¡å—ï¼Ÿ** | ä¸æ˜¯ï¼Œæ˜¯â€œå°æ‰¹é‡åˆ†å—ä¼ è¾“â€ï¼Œä½†å¯¹å¼€å‘è€…é€æ˜ã€‚       |
| **å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ**         | å†…å­˜å ç”¨ä½ï¼Œé€‚åˆå¤„ç†ç™¾ä¸‡çº§æ•°æ®ã€‚                 |
| **é£é™©ï¼Ÿ**               | è¿æ¥é•¿æ—¶é—´ä¸é‡Šæ”¾ï¼Œéœ€è°¨æ…ç®¡ç†èµ„æºã€‚               |



#### cã€ç™¾ä¸‡æ•°æ®æµå¼æŸ¥è¯¢å¤§æ¦‚è€—æ—¶èŒƒå›´

| åœºæ™¯                                                  | é¢„ä¼°è€—æ—¶                | è¯´æ˜                     |
| ----------------------------------------------------- | ----------------------- | ------------------------ |
| **ç†æƒ³æƒ…å†µ**ï¼ˆæœ¬åœ°æ•°æ®åº“ã€SSDã€ç®€å•æŸ¥è¯¢ã€æ— å¤„ç†é€»è¾‘ï¼‰ | **10 ~ 30 ç§’**          | æ•°æ®åº“å¿«ï¼Œç½‘ç»œå¿«ï¼Œå¤„ç†å¿« |
| **ä¸€èˆ¬æƒ…å†µ**ï¼ˆå†…ç½‘ã€æ™®é€šç¡¬ç›˜ã€å­—æ®µè¾ƒå¤šï¼‰              | **30 ç§’ ~ 2 åˆ†é’Ÿ**      | å¸¸è§ä¼ä¸šç¯å¢ƒ             |
| **å¤æ‚æƒ…å†µ**ï¼ˆè¿œç¨‹æ•°æ®åº“ã€æ…¢æŸ¥è¯¢ã€å¤§å­—æ®µã€å¤æ‚å¤„ç†ï¼‰  | **2 ~ 10 åˆ†é’Ÿç”šè‡³æ›´é•¿** | å« BLOBã€JSONã€è®¡ç®—ç­‰    |

| é—®é¢˜                       | å›ç­”                                           |
| -------------------------- | ---------------------------------------------- |
| **ç™¾ä¸‡æ•°æ®æµå¼æŸ¥è¯¢è€—æ—¶ï¼Ÿ** | **é€šå¸¸ 30 ç§’ ~ 2 åˆ†é’Ÿ**                        |
| **æœ€å¿«èƒ½åˆ°å¤šå°‘ï¼Ÿ**         | 10+ ç§’ï¼ˆç†æƒ³ç¯å¢ƒï¼‰                             |
| **æœ€æ…¢ä¼šå¤šä¹…ï¼Ÿ**           | 10 åˆ†é’Ÿ+ï¼ˆç½‘ç»œå·®ã€å¤„ç†æ…¢ï¼‰                     |
| **å¦‚ä½•åŠ å¿«ï¼Ÿ**             | ä¼˜åŒ– SQLã€è®¾ç½® `fetchSize`ã€åˆ†æ‰¹å¤„ç†ã€å‡çº§ç¡¬ä»¶ |



#### dã€``fetchSize`` è®¾ç½®è§£é‡Š

> **`Integer.MIN_VALUE` æ˜¯â€œå¼€å…³**

| è®¾ç½®                          | æ˜¯å¦å¯ç”¨æœåŠ¡å™¨ç«¯æ¸¸æ ‡   | æ˜¯å¦æµå¼     | æ˜¯å¦ OOM é£é™©    |
| ----------------------------- | ---------------------- | ------------ | ---------------- |
| `fetchSize=1000`              | âŒ å¦ï¼ˆé»˜è®¤å®¢æˆ·ç«¯æ¸¸æ ‡ï¼‰ | âŒ ä¸æ˜¯çœŸæµå¼ | âœ… æœ‰ï¼ˆå…¨é‡åŠ è½½ï¼‰ |
| `fetchSize=Integer.MIN_VALUE` | âœ… æ˜¯ï¼ˆæœåŠ¡å™¨ç«¯æ¸¸æ ‡ï¼‰   | âœ… çœŸæµå¼     | âŒ æ— ï¼ˆåˆ†æ‰¹æ‹‰å–ï¼‰ |

- `fetchSize(1000)`

  - **ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®ä»æœåŠ¡å™¨æ‹‰åˆ°å®¢æˆ·ç«¯å†…å­˜**

  - ç„¶ååœ¨æœ¬åœ°â€œå‡è£…â€æ˜¯åˆ†æ‰¹è¿”å›ï¼ˆæ¯æ¬¡è¿”å› 1000 æ¡ï¼‰

  - ä½†å†…å­˜å·²ç»å æ»¡äº†



### 2ï¼‰`LIMIT` åˆ†é¡µ

- **`LIMIT 1000000, 10` ä¸ºä»€ä¹ˆæ…¢**

  - æ•°æ®åº“ä»éœ€**æ‰«æå‰ 1,000,000 æ¡è®°å½•**ï¼Œå³ä½¿ä¸è¿”å›ã€‚

  - å°¤å…¶æ˜¯ `ORDER BY` å­˜åœ¨æ—¶ï¼Œå¯èƒ½æ— æ³•åˆ©ç”¨ç´¢å¼•è¦†ç›–ã€‚

  - è¿™å«â€œ**åç§»é‡é™·é˜±ï¼ˆ`Offset` `Pagination` `Problem`ï¼‰**â€ã€‚

- **ä½•æ—¶ä¸è¦ç”¨ï¼Ÿ**

  - `offset > 10,000` æ—¶åŸºæœ¬ä¸å¯ç”¨

  - é«˜å¹¶å‘åˆ†é¡µæ¥å£ï¼ˆå¦‚ `/api/users?page=100`ï¼‰

- **ä½•æ—¶å¯ç”¨ï¼Ÿ**

  - å‰ç«¯å±•ç¤ºï¼Œé¡µæ•°å°‘ï¼ˆå¦‚ â‰¤ 100ï¼‰

  - æ•°æ®é‡å°ï¼ˆå¦‚ < 10ä¸‡ï¼‰

### 3ï¼‰``id > last_id LIMIT size``

**ä¼˜åŠ¿ï¼š**

- æ€§èƒ½ç¨³å®šï¼š`WHERE id > ? LIMIT ?` èµ°ä¸»é”®ç´¢å¼•ï¼Œ**O(log n)**
- æ— åç§»é‡é—®é¢˜ï¼Œç¿»é¡µé£å¿«
- é€‚åˆâ€œä¸‹ä¸€é¡µâ€åœºæ™¯ï¼ˆå¦‚å¾®åšã€æ¶ˆæ¯æµï¼‰

**ç¼ºç‚¹ï¼š**

- ä¸èƒ½è·³é¡µï¼ˆå¦‚ç›´æ¥è·³ç¬¬10é¡µï¼‰
- ä¾èµ–**å•è°ƒé€’å¢å­—æ®µ**ï¼ˆå¦‚ `id`, `create_time`ï¼‰
- å¦‚æœ `id` æœ‰åˆ é™¤æˆ–ä¸è¿ç»­ï¼Œå¯èƒ½å¯¼è‡´â€œæ¼æ•°æ®â€æˆ–â€œé‡å¤â€



## 3ã€å¸¸è§é—®é¢˜ç­”ç–‘

### 1ï¼‰æ™®é€šæŸ¥è¯¢ `VS` æµå¼

| æ–¹å¼     | æ™®é€šæŸ¥è¯¢ `List<User>`    | æµå¼æŸ¥è¯¢ `ResultHandler`       |
| -------- | ------------------------ | ------------------------------ |
| å†…å­˜ä½¿ç”¨ | ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ | æ¯æ¬¡åªå¤„ç†ä¸€æ¡ï¼Œå†…å­˜å ç”¨å°     |
| é€‚ç”¨åœºæ™¯ | æ•°æ®é‡å°ï¼ˆå‡ åƒã€å‡ ä¸‡ï¼‰   | **å¤§æ•°æ®é‡ï¼ˆå‡ åä¸‡ã€ä¸Šç™¾ä¸‡ï¼‰** |
| é£é™©     | å¯èƒ½ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰     | **é¿å… OOM**                   |
| å¤„ç†æ–¹å¼ | å…ˆæŸ¥å®Œå†å¤„ç†             | è¾¹æŸ¥è¾¹å¤„ç†ï¼ˆå®æ—¶ï¼‰             |



### 2ï¼‰æµå¼ vs `IdSize`

| å¯¹æ¯”é¡¹                 | æµå¼æŸ¥è¯¢ï¼ˆStreamingï¼‰    | è‡ªå®šä¹‰ ID åˆ†é¡µï¼ˆWHERE id BETWEEN ? AND ?ï¼‰ |
| ---------------------- | ------------------------ | ------------------------------------------ |
| åœºæ™¯                   | æ‰¹é‡å¯¼å‡ºã€`ETL`          | `API` åˆ†é¡µã€æ¶ˆæ¯æ‹‰å–                       |
| **SQL æ‰§è¡Œæ¬¡æ•°**       | 1 æ¬¡                     | N æ¬¡ï¼ˆå¦‚ 100 ä¸‡ / 1000 = 1000 æ¬¡ï¼‰         |
| **è¿æ¥**               | é•¿è¿æ¥ï¼ˆé£é™©ï¼‰           | çŸ­è¿æ¥ï¼ˆå®‰å…¨ï¼‰                             |
| **å†…å­˜å ç”¨**           | ä½ï¼ˆé€æ¡å¤„ç†ï¼‰           | ä½ï¼ˆæ¯é¡µå¤„ç†å®Œå°±é‡Šæ”¾ï¼‰                     |
| **æ•°æ®åº“å‹åŠ›**         | ä½ï¼ˆä¸€æ¬¡è¿æ¥ï¼Œæµå¼è¯»ï¼‰   | é«˜ï¼ˆé¢‘ç¹æŸ¥è¯¢ï¼Œç´¢å¼•æ‰«æï¼‰                   |
| **ç½‘ç»œå¼€é”€**           | ä½ï¼ˆä¸€æ¬¡è¿æ¥ï¼ŒæŒç»­ä¼ è¾“ï¼‰ | é«˜ï¼ˆå¤šæ¬¡è¿æ¥æˆ–é•¿è¿æ¥ï¼‰                     |
| **æ˜¯å¦éœ€è¦ `ID` è¿ç»­** | ä¸éœ€è¦                   | éœ€è¦ï¼ˆå¦åˆ™åˆ†é¡µä¸å‡†ï¼‰                       |
| **èƒ½å¦å¹¶è¡Œå¤„ç†**       | ä¸èƒ½ï¼ˆé¡ºåºæµï¼‰           | èƒ½ï¼ˆä¸åŒ ID èŒƒå›´å¯å¤šçº¿ç¨‹ï¼‰                 |
| **èƒ½å¦ä¸­æ–­/æ¢å¤**      | éš¾ï¼ˆæµä¸­æ–­å°±å¤±è´¥ï¼‰       | èƒ½ï¼ˆè®°å½•æœ€å ID å³å¯ï¼‰                     |
| **é¦–æ¬¡å“åº”æ—¶é—´**       | ç¨æ…¢ï¼ˆå»ºç«‹æµéœ€è¦æ—¶é—´ï¼‰   | å¿«ï¼ˆç¬¬ä¸€é¡µå¾ˆå¿«è¿”å›ï¼‰                       |
| **æ€»è€—æ—¶**             | **é€šå¸¸æ›´çŸ­**             | é€šå¸¸æ›´é•¿ï¼ˆN æ¬¡æŸ¥è¯¢ + é—´éš™ï¼‰                |
| **å®ç°å¤æ‚åº¦**         | ç®€å•                     | ç¨å¤æ‚ï¼ˆéœ€ç®¡ç†åˆ†é¡µé€»è¾‘ï¼‰                   |



### 3ï¼‰æ€§èƒ½å¯¹æ¯”å®éªŒ

| æŸ¥è¯¢æ–¹å¼               | æŸ¥è¯¢ç¬¬ 10 é¡µï¼ˆæ¯é¡µ 100ï¼‰ | æŸ¥è¯¢ç¬¬ 100,000 é¡µ | å…¨é‡å¯¼å‡º        |
| ---------------------- | ------------------------ | ----------------- | --------------- |
| `LIMIT offset, size`   | 50ms                     | 12s               | ä¸å¯è¡Œ          |
| `WHERE id > ? LIMIT ?` | 5ms                      | 5ms               | éœ€è‡ªå·±å¾ªç¯      |
| æµå¼æŸ¥è¯¢               | ä¸é€‚ç”¨                   | ä¸é€‚ç”¨            | 8s ï¼ˆå†…å­˜ç¨³å®šï¼‰ |



### 4ï¼‰é€‰å‹å»ºè®®

| ä½ è¦åšä»€ä¹ˆï¼Ÿ                   | é€‰å“ªç§ï¼Ÿ                                 |
| ------------------------------ | ---------------------------------------- |
| åš `Excel` å¯¼å‡ºï¼Œæ•°æ®é‡ > 10ä¸‡ | âœ… æµå¼æŸ¥è¯¢                               |
| åšåå°ç®¡ç†åˆ†é¡µï¼Œæœ€å¤šç¿» 100 é¡µ  | âœ… `LIMIT`                                |
| åš `App` ä¿¡æ¯æµï¼Œæ— é™ä¸‹æ‹‰      | âœ… `Id > last_id`                         |
| åšå®šæ—¶ä»»åŠ¡ï¼Œå¤„ç†æœªåŒæ­¥æ•°æ®     | âœ… `Id > last_max_id`                     |
| åšå®æ—¶è®¡ç®—ï¼Œç›‘å¬æ•°æ®å˜åŒ–       | âŒ ä»¥ä¸Šéƒ½ä¸è¡Œ â†’ ç”¨ **CDCï¼ˆå¦‚ Debeziumï¼‰** |



### 5ï¼‰æµå¼æŸ¥è¯¢å¦‚ä½•é¿å…å æ»¡è¿æ¥

åœºæ™¯ï¼šå®‰å…¨åœ°æµå¼æŸ¥è¯¢ 1000 ä¸‡æ¡è®¢å•æ•°æ®ï¼Œç”¨äºå¯¼å‡º Excelï¼Œ**ä¸é˜»å¡ä¸»ä¸šåŠ¡è¿æ¥æ± ï¼Œä¸å¼•å‘ OOMï¼Œæ”¯æŒä¸­æ–­åç»§ç»­**ã€‚

1. **ä¸“ç”¨æ•°æ®æº**ï¼šä¸ºæµå¼æŸ¥è¯¢é…ç½®ç‹¬ç«‹çš„è¿æ¥æ± ï¼ˆå¦‚ HikariCP å•ç‹¬é…ç½®ï¼‰
2. **é™åˆ¶å¹¶å‘**ï¼šåŒä¸€æ—¶é—´åªå…è®¸ 1~2 ä¸ªæµå¼ä»»åŠ¡ï¼ˆåŠ é”ï¼‰
3. **è¶…æ—¶æ§åˆ¶**ï¼šè®¾ç½® `queryTimeout` å’Œ `socketTimeout`
4. **åˆ†æ‰¹æµå¼**ï¼šæ¯ 1 ä¸‡æ¡ commit ä¸€æ¬¡ï¼Œé¿å…äº‹åŠ¡è¿‡é•¿
5. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ `@Async` æˆ–çº¿ç¨‹æ± å¤„ç†æµæ•°æ®

| é—®é¢˜         | è§£å†³æ–¹æ¡ˆ                                     |
| ------------ | -------------------------------------------- |
| å æ»¡ä¸»è¿æ¥æ±  | âœ… ç‹¬ç«‹æ•°æ®æºï¼Œæœ€å¤§3è¿æ¥                      |
| å¹¶å‘å¤ªå¤š     | âœ… åŠ é”                                       |
| è¿æ¥å¤ªä¹…     | âœ… è®¾ç½® `max-lifetime` + åˆ†æ‰¹ commit          |
| äº‹åŠ¡è¿‡é•¿     | âœ… æ¯ `1`ä¸‡æ¡ commit ä¸€æ¬¡                     |
| å¡ä½ä¸å“åº”   | âœ… è®¾ç½® `queryTimeout` + `connection-timeout` |
| å¤±è´¥é‡æ¥     | âœ… Redis è®°å½• `lastId`ï¼Œæ”¯æŒç»­ä¼               |

#### aã€ä¸“ç”¨æ•°æ®æº

`application.yml`

```yml
spring:
  datasource:
    # ä¸»æ•°æ®æºï¼ˆä¸šåŠ¡ç”¨ï¼‰
    master:
      jdbc-url: jdbc:mysql://localhost:3306/app_db?useSSL=false&useUnicode=true
      username: root
      password: root
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5

    # ä¸“ç”¨æ•°æ®æºï¼ˆæµå¼æŸ¥è¯¢ç”¨ï¼‰
    streaming:
      jdbc-url: jdbc:mysql://localhost:3306/app_db?useSSL=false&useUnicode=true&defaultFetchSize=1000
      username: root
      password: root
      hikari:
        pool-name: StreamingHikariPool
        maximum-pool-size: 3          # ä¸¥æ ¼é™åˆ¶ï¼šæœ€å¤š3ä¸ªæµå¼ä»»åŠ¡
        minimum-idle: 0
        max-lifetime: 1800000         # 30åˆ†é’Ÿï¼Œé¿å…é•¿è¿æ¥åƒµæ­»
        idle-timeout: 600000          # 10åˆ†é’Ÿç©ºé—²è¶…æ—¶
        connection-timeout: 30000     # 30ç§’è·å–è¿æ¥è¶…æ—¶
```

`StreamingDataSourceConfig.java`

> âœ… å…³é”®å‚æ•°è¯´æ˜ï¼š
>
> - `maximum-pool-size: 3`ï¼šæœ€å¤š `3` ä¸ªæµå¼ä»»åŠ¡å¹¶è¡Œ
> - `defaultFetchSize=1000`ï¼š`JDBC`  é»˜è®¤ fetch å¤§å°ï¼Œå¯ç”¨æµå¼
> - `max-lifetime`ï¼šé˜²æ­¢è¿æ¥å¤ªä¹…è¢«é˜²ç«å¢™æ–­å¼€

```java
@Configuration
@ConditionalOnProperty(prefix = "spring.datasource.streaming", name = "jdbc-url")
public class StreamingDataSourceConfig {

    @Bean("streamingDataSource")
    @ConfigurationProperties("spring.datasource.streaming")
    public DataSource streamingDataSource() {
        return DataSourceBuilder.create().type(HikariDataSource.class).build();
    }

    @Bean("streamingSqlSessionFactory")
    public SqlSessionFactory sqlSessionFactory(@Qualifier("streamingDataSource") DataSource dataSource) 
    throws Exception {
        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
        bean.setDataSource(dataSource);
        // å¯è®¾ç½®æ’ä»¶ã€typeHandlerç­‰
        return bean.getObject();
    }
}
```

#### bã€`Mapper` å±‚å¯ç”¨æµå¼æŸ¥è¯¢

> `@Options(fetchSize = Integer.MIN_VALUE)` æ˜¯ MyBatis å¯ç”¨æµå¼çš„å…³é”®ï¼

```java
@Mapper
public interface OrderMapper {

    @Select("SELECT id, user_id, amount, create_time FROM orders WHERE id > #{lastId} ORDER BY id")
    @Options(fetchSize = Integer.MIN_VALUE) // å¯ç”¨æœåŠ¡å™¨ç«¯æ¸¸æ ‡
    void streamOrders(@Param("lastId") Long lastId, ResultHandler<Order> handler);
}
```



#### cã€æœåŠ¡å±‚å®ç°åˆ†æ‰¹å¤„ç† + è‡ªåŠ¨æäº¤

- **æ ¸å¿ƒé€»è¾‘ï¼š**
  - `SqlSession` æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡
  - æ¯å¤„ç† `BATCH_SIZE` æ¡ `commit()` ä¸€æ¬¡
  - lastId` è®°å½•ä½ç½®ï¼Œå¯ç”¨äºæ–­ç‚¹ç»­ä¼ 
- è§£å†³çš„å››å¤§é—®é¢˜

| é—®é¢˜                                    | åæœ                       | åˆ†æ‰¹æäº¤å¦‚ä½•è§£å†³           |
| --------------------------------------- | -------------------------- | -------------------------- |
| 1. äº‹åŠ¡è¿‡é•¿ï¼ˆLong-running Transactionï¼‰ | é”è¡¨ã€å›æ»šæ®µè†¨èƒ€ã€ä¸»ä»å»¶è¿Ÿ | ä¸»åŠ¨æäº¤ï¼Œæ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡ |
| 2. å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰                      | `JVM` å †å†…å­˜è€—å°½ï¼ŒæœåŠ¡å´©æºƒ | é‡Šæ”¾ MyBatis ä¸€çº§ç¼“å­˜      |
| 3. è¿æ¥è¢«é•¿æ—¶é—´å ç”¨                     | è¿æ¥æ± è€—å°½ï¼Œå½±å“å…¶ä»–ä¸šåŠ¡   | å‡å°‘å•æ¬¡è¿æ¥æŒæœ‰æ—¶é—´       |
| 4. æ•…éšœåéœ€é‡å¤´å†æ¥                     | ä»»åŠ¡å¤±è´¥ï¼Œè¿›åº¦ä¸¢å¤±         | ç»“åˆ `lastId` å¯æ–­ç‚¹ç»­ä¼    |

**é—®é¢˜1ï¼šäº‹åŠ¡è¿‡é•¿æœ‰å•¥é—®é¢˜ï¼Ÿæœ€è‡´å‘½ï¼Ÿ**

- **æç«¯æƒ…å†µï¼šå¯¼å‡º 1000 ä¸‡æ¡æ•°æ®ï¼Œäº‹åŠ¡æŒç»­ 30 åˆ†é’Ÿ â†’ æ•´ä¸ª `orders` è¡¨å‡ ä¹ä¸å¯å†™ï¼**

- `MyBatis` é»˜è®¤å¼€å¯äº‹åŠ¡ï¼ˆ`SqlSession` çº§åˆ«ï¼‰
- å¦‚æœä½ ä¸ `commit()`ï¼Œæ•´ä¸ªæµå¼æŸ¥è¯¢ä¼š**åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œåˆ°åº•**
- æ•°æ®åº“ä¼šï¼š
  - **é•¿æ—¶é—´æŒæœ‰é”**ï¼ˆå¦‚ `InnoDB` çš„ `next-key lock`ï¼‰
  - **ä¸æ–­å¢é•¿å›æ»šæ®µï¼ˆ`undo` `log`ï¼‰**
  - **é˜»å¡å…¶ä»– `DML` æ“ä½œ**
  - **å¯¼è‡´ä¸»ä»å¤åˆ¶å»¶è¿Ÿï¼ˆ`binlog`  å†™å…¥å»¶è¿Ÿï¼‰**

**é—®é¢˜2ï¼šå†…å­˜æº¢å‡ºï¼ˆ`OOM`ï¼‰â€”â€”`MyBatis` éšè—é™·é˜±**

**ç­”æ¡ˆï¼š**å¾ˆå¤šäººä»¥ä¸ºâ€œæµå¼æŸ¥è¯¢ = ä¸å å†…å­˜â€ï¼Œä½† **`MyBatis` çš„ä¸€çº§ç¼“å­˜ï¼ˆ`Local Cache`ï¼‰ä¼šç¼“å­˜æ‰€æœ‰å·²æŸ¥è¯¢çš„å¯¹è±¡å¼•ç”¨**ï¼å³ä½¿ä½ ç”¨ `ResultHandler` é€æ¡å¤„ç†`MyBatis` ä»ä¼šæŠŠæ¯ä¸€æ¡ç»“æœ**ç¼“å­˜åœ¨ `SqlSession` å†…éƒ¨**ã€‚`1000` ä¸‡æ¡è®¢å•ï¼Œæ¯æ¡ `1KB` â†’ è‡³å°‘å ç”¨ **`10GB` å†…å­˜**ï¼

```java
@Service
public class OrderExportService {

    @Autowired
    @Qualifier("streamingSqlSessionFactory")
    private SqlSessionFactory streamingSqlSessionFactory;

    private static final int BATCH_SIZE = 10_000; // æ¯å¤„ç†1ä¸‡æ¡ commit ä¸€æ¬¡

    public void exportAllOrders() {
        try (SqlSession sqlSession = streamingSqlSessionFactory.openSession(ExecutorType.SIMPLE)) {
            OrderMapper mapper = sqlSession.getMapper(OrderMapper.class);
            AtomicLong counter = new AtomicLong(0);
            AtomicLong lastId = new AtomicLong(0);

            ResultHandler<Order> handler = resultContext -> {
                Order order = resultContext.getResultObject();
                lastId.set(order.getId());

                // ä¸šåŠ¡å¤„ç†ï¼šå†™å…¥ Excelã€å‘ MQã€å†™æ–‡ä»¶ç­‰
                processOrder(order);

                long count = counter.incrementAndGet();

                // æ¯ 10000 æ¡æäº¤ä¸€æ¬¡ï¼Œé¿å…äº‹åŠ¡è¿‡é•¿
                if (count % BATCH_SIZE == 0) {
                    log.info("Committing batch at order id: {}, total: {}", lastId.get(), count);
                    sqlSession.commit();
                }
            };

            // å¼€å§‹æµå¼æŸ¥è¯¢
            mapper.streamOrders(lastId.get(), handler);
            sqlSession.commit(); // æœ€åä¸€æ‰¹
            log.info("Export completed. Total records: {}", counter.get());

        } catch (Exception e) {
            log.error("Stream export failed", e);
            throw new RuntimeException("Export failed", e);
        }
    }

    private void processOrder(Order order) {
        // æ¨¡æ‹Ÿå¤„ç†ï¼šå†™å…¥æ–‡ä»¶ã€å‘MQç­‰
        // ExcelWriter.write(order);
        // rabbitTemplate.convertAndSend("export.queue", order);
    }
}
```





#### dã€è¶…æ—¶æ§åˆ¶

- `JDBC` å±‚è¶…æ—¶ï¼ˆ`application.yml`ï¼‰

```yml
spring:
  datasource:
    streaming:
      hikari:
        # è·å–è¿æ¥è¶…æ—¶
        connection-timeout: 30000
        # SQL æ‰§è¡Œè¶…æ—¶ï¼ˆHikariCP 1.4+ï¼‰
        leak-detection-threshold: 600000  # 10åˆ†é’Ÿæœªå½’è¿˜è¿æ¥æŠ¥è­¦
```

- `MyBatis` å±‚è®¾ç½® `queryTimeout`

```java
@Options(fetchSize = Integer.MIN_VALUE, timeout = 300) // 300ç§’è¶…æ—¶
@Select("SELECT ...")
void streamOrders(...);
```



#### e `Spring` å±‚è®¾ç½®å¼‚æ­¥ä»»åŠ¡è¶…æ—¶

```java
@Async
@Timeout(3600) // 1å°æ—¶è¶…æ—¶
public void export() { ... }
```



#### fã€æ–­ç‚¹ç»­ä¼ ï¼ˆé¿å…å¤±è´¥åä»å¤´å†æ¥ï¼‰

```java
// å¯æŒä¹…åŒ– lastId
@Scheduled(fixedDelay = 30_000)
void saveProgress() {
    // å°† lastId å†™å…¥ DB æˆ– Redis
    redisTemplate.opsForValue().set("export:lastId", lastId.get());
}

// å¯åŠ¨æ—¶è¯»å–
Long getLastIdFromRedis() {
    return redisTemplate.opsForValue().get("export:lastId");
}
```





### 6ï¼‰`MyBatis` æµå¼æŸ¥è¯¢çš„â€œçœŸç›¸

> **â€œæµå¼â€åªå‘ç”Ÿåœ¨æ•°æ®åº“åˆ°åº”ç”¨çš„ä¼ è¾“è¿‡ç¨‹ï¼ŒMyBatis å†…éƒ¨ä»æ˜¯â€œå…¨é‡ç¼“å­˜â€**ã€‚

```
æ•°æ®åº“
   â†“ (æµå¼ä¼ è¾“ï¼Œæ¯æ¬¡å‡ KB)
JDBC Driver â†’ ResultSet
   â†“ (é€è¡Œè¯»å–)
MyBatis Core
   â”œâ”€â”€â†’ è°ƒç”¨ä½ çš„ ResultHandler.onResult()     âœ… å†…å­˜åŠæ—¶é‡Šæ”¾
   â””â”€â”€â†’ ç¼“å­˜åˆ° LocalCache.list              ğŸ”´ å¼•ç”¨ä¸€ç›´æŒæœ‰ï¼Œä¸é‡Šæ”¾ï¼
          â†“
     SqlSession æŒæœ‰è¿™ä¸ª list
          â†“
     æ•´ä¸ª JVM å †å†…å­˜æŒç»­å¢é•¿ â†’ OOM
```

#### aã€ ä¸ºä»€ä¹ˆè¿˜ä¼š `OOM`ï¼Ÿâ€”â€”`MyBatis` ä¸€çº§ç¼“å­˜çš„â€œå‰¯ä½œç”¨

ç­”æ¡ˆï¼š`MyBatis` ä¸ºäº†æ”¯æŒ `ExecutorType.REUSE` å’Œ ç»“æœå¼•ç”¨å»é‡ï¼Œé»˜è®¤å¼€å¯äº† **æœ¬åœ°ç¼“å­˜ï¼ˆLocal Cacheï¼‰**ã€‚å³ä½¿ä½ ç”¨ `ResultHandler`ï¼Œ`MyBatis` ä»ç„¶ä¼šï¼š

> ğŸ”´ **æŠŠæ¯ä¸€æ¡æŸ¥è¯¢ç»“æœç¼“å­˜åœ¨ `SqlSession` å†…éƒ¨çš„ä¸€ä¸ª `List` ä¸­ï¼**

æºç è¯æ®åœ¨ `DefaultResultHandler` å’Œ `CachingExecutor` ä¸­ï¼š

```java
// DefaultResultHandler.java
private final List<Object> list;

@Override
public void handleResult(ResultContext<? extends Object> context) {
  list.add(context.getResultObject()); // çœ‹è¿™é‡Œï¼æ¯æ¡ç»“æœéƒ½ add è¿›å»äº†ï¼
}
```

#### bã€å¦‚ä½•çœŸæ­£è§£å†³ `OOM`ï¼Ÿâ€”â€”`commit()` æ˜¯å…³é”®

ç­”æ¡ˆï¼šå®šæœŸ `sqlSession.commit()`å½“ä½ è°ƒç”¨ `commit()` æ—¶ï¼ŒMyBatis ä¼šï¼š

1. æäº¤äº‹åŠ¡
2. **æ¸…ç©ºä¸€çº§ç¼“å­˜ï¼ˆLocal Cacheï¼‰**
3. å†…éƒ¨é‚£ä¸ª `list` è¢«æ¸…ç©ºï¼Œæ‰€æœ‰å¯¹è±¡å¼•ç”¨é‡Šæ”¾
4. `GC` å¯ä»¥å›æ”¶å†…å­˜

```java
    /**
     * sqlSessionFactory
     */
    @Resource
    private SqlSessionFactory sqlSessionFactory;


    @GetMapping(value = "selectList", produces = MediaType.APPLICATION_JSON_UTF8_VALUE)
    @ResponseBody
    public ResponseBean selectList() {
        List<User> users = Lists.newArrayList();

        try(SqlSession sqlSession = sqlSessionFactory.openSession()){
            UserMapper mapper = sqlSession.getMapper(UserMapper.class);
            mapper.getStreamAll(new ResultHandler<User>() {
                private int batchCount = 0;
                private List<User> batch = new ArrayList<>(1000);
                @Override
                public void handleResult(ResultContext<? extends User> resultContext) {
                    User user = resultContext.getResultObject();
                    batch.add(user);
                    batchCount++;

                    // æ¯ 1000 æ¡å¤„ç†ä¸€æ¬¡ï¼ˆå¦‚æ‰¹é‡å…¥åº“ã€å†™æ–‡ä»¶ï¼‰
                    if (batchCount % 1000 == 0) {
                        processBatch(batch);
                        batch.clear();
                        sqlSession.commit();
                    }
                }
                private void processBatch(List<User> batch) {
                    // ä¾‹å¦‚ï¼šæ‰¹é‡æ’å…¥ã€å¯¼å‡ºæ–‡ä»¶ã€å‘é€æ¶ˆæ¯ç­‰
                }
            });
            sqlSession.commit();
        }

        log.info("ç”¨æˆ·ç®¡ç†--------selectLisï¼šã€{}ã€‘", JsonUtils.toJsonString(users));
        return ResponseBean.buildSuccess(users);
    }
}
```





# å››ã€å·¥å…·ç±»

```java
package com.healerjean.proj.utils.db;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.google.common.collect.Lists;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.Future;
import java.util.function.BiFunction;
import java.util.function.Function;

/**
 * MybatisPlusQueryUtils
 *
 * @author zhangyujin
 * @date 2023/6/25$  12:05$
 */
public final class MybatisBatchUtils {

    /**
     * queryAll
     *
     * @param function     function
     * @param queryWrapper queryWrapper
     * @param pageSize     pageSize
     * @return {@link List<R>}
     */

    public static <Q, R> List<R> queryAllByLimit(BiFunction<Page<R>, Q, IPage<R>> function,
                                                 Q queryWrapper,
                                                 long pageSize) {

        IPage<R> initPage = function.apply(new Page<>(1, 0, true), queryWrapper).setSize(pageSize);
        List<R> result = new ArrayList<>();
        for (int i = 1; i <= initPage.getPages(); i++) {
            IPage<R> page = function.apply(new Page<>(i, pageSize, false), queryWrapper);
            if (CollectionUtils.isEmpty(page.getRecords())) {
                break;
            }
            result.addAll(page.getRecords());
        }
        return result;
    }


    /**
     * queryAll
     *
     * @param function function
     * @param query    query
     * @param minMax   minMax
     * @return {@link List<R>}
     */
    public static <Q, R> List<R> queryAllByIdSize(BiFunction<IdQueryBO, Q, List<R>> function,
                                                  Q query,
                                                  IdQueryBO minMax) {
        List<R> result = Lists.newArrayList();
        Long minId = minMax.getMinId();
        Long size = minMax.getSize();
        while (minId != null) {
            IdQueryBO idQueryBO = new IdQueryBO(minId, size);
            List<R> dbList = function.apply(idQueryBO, query);
            if (CollectionUtils.isEmpty(dbList)) {
                break;
            }
            minId = idQueryBO.getMaxId();
            result.addAll(dbList);
        }
        return result;
    }

    /**
     * queryAll
     *
     * @param function function
     * @param query    query
     * @param minMax   minMax
     * @return {@link List<R>}
     */
    public static <Q, R> List<R> queryAllByIdSub(BiFunction<IdQueryBO, Q, List<R>> function,
                                                 Q query,
                                                 IdQueryBO minMax) {
        List<R> result = Lists.newArrayList();
        Long minId = minMax.getMinId();
        Long maxId = minMax.getMaxId();
        Long size = minMax.getSize();
        for (long i = minId; i <= maxId; i = i + size) {
            long endId = Math.min(i + size, maxId);
            boolean maxEqualFlag = endId == maxId;
            IdQueryBO idQueryBO = new IdQueryBO(true, i, maxEqualFlag, endId, size);
            List<R> dbList = function.apply(idQueryBO, query);
            if (CollectionUtils.isEmpty(dbList)) {
                break;
            }
            result.addAll(dbList);
            if (maxEqualFlag) {
                break;
            }
        }
        return result;
    }


    /**
     * queryAll
     *
     * @param executorService çº¿ç¨‹æ± 
     * @param function        åˆ†é¡µå‡½æ•°
     * @param queryWrapper    æŸ¥è¯¢æ¡ä»¶
     * @param pageSize        pageSize åˆ†é¡µå¤§å°
     * @param coverFunction   coverFunction å¯¹è±¡è½¬åŒ–
     * @return {@link List< Future< List<T>>>}
     */
    public static <Q, R, T> List<Future<List<T>>> queryAllByPoolLimit(CompletionService<List<T>> executorService,
                                                                      BiFunction<Page<R>, Q, IPage<R>> function,
                                                                      Q queryWrapper,
                                                                      int pageSize,
                                                                      Function<List<R>, List<T>> coverFunction) {

        IPage<R> initPage = function.apply(new Page<>(1, 0, true), queryWrapper).setSize(pageSize);

        List<Future<List<T>>> result = new ArrayList<>();
        for (int i = 1; i <= initPage.getPages(); i++) {
            int finalI = i;
            Future<List<T>> future = executorService.submit(() -> {
                IPage<R> page = function.apply(new Page<>(finalI, pageSize, false), queryWrapper);
                return coverFunction.apply(page.getRecords());
            });
            result.add(future);
        }
        return result;
    }


    /**
     * queryAll
     *
     * @param executorService çº¿ç¨‹æ± 
     * @param function        åˆ†é¡µå‡½æ•°
     * @param query           æŸ¥è¯¢æ¡ä»¶
     * @param minMax          minMax æœ€å°Idå’Œæœ€å¤§Id
     * @param coverFunction   coverFunction å¯¹è±¡è½¬åŒ–
     */
    public static <Q, R, T> List<Future<List<T>>> queryAllByPoolIdSub(CompletionService<List<T>> executorService,
                                                                      BiFunction<IdQueryBO, Q, List<R>> function,
                                                                      Q query,
                                                                      IdQueryBO minMax,
                                                                      Function<List<R>, List<T>> coverFunction) {
        Long minId = minMax.getMinId();
        Long maxId = minMax.getMaxId();
        Long size = minMax.getSize();
        List<Future<List<T>>> result = new ArrayList<>();
        for (long i = minId; i <= maxId; i = i + size) {
            long endId = Math.min(i + size, maxId);
            boolean maxEqualFlag = endId == maxId;
            IdQueryBO idQueryBO = new IdQueryBO(true, i, maxEqualFlag, endId, size);
            Future<List<T>> future = executorService.submit(() -> {
                List<R> list = function.apply(idQueryBO, query);
                return coverFunction.apply(list);
            });
            result.add(future);
            if (maxEqualFlag) {
                break;
            }
        }
        return result;
    }

}

```












## 1ã€çº¿ç¨‹æ±  `Id` åˆ†æ®µæŸ¥è¯¢

### 1ï¼‰çº¿ç¨‹æ±  `Id` åˆ†æ®µå·¥å…·

```java
package com.healerjean.proj.utils.db;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.google.common.collect.Lists;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.Future;
import java.util.function.BiFunction;
import java.util.function.Function;

/**
 * MybatisPlusQueryUtils
 *
 * @author zhangyujin
 * @date 2023/6/25$  12:05$
 */
public final class MybatisBatchUtils {



    /**
     * queryAll
     *
     * @param executorService çº¿ç¨‹æ± 
     * @param function        åˆ†é¡µå‡½æ•°
     * @param query           æŸ¥è¯¢æ¡ä»¶
     * @param minMax          minMax æœ€å°Idå’Œæœ€å¤§Id
     * @param coverFunction   coverFunction å¯¹è±¡è½¬åŒ–
     */
    public static <Q, R, T> List<Future<List<T>>> queryAllByPoolIdSub(CompletionService<List<T>> executorService,
                                                                      BiFunction<IdQueryBO, Q, List<R>> function,
                                                                      Q query,
                                                                      IdQueryBO minMax,
                                                                      Function<List<R>, List<T>> coverFunction) {
        Long minId = minMax.getMinId();
        Long maxId = minMax.getMaxId();
        Long size = minMax.getSize();
        List<Future<List<T>>> result = new ArrayList<>();
        for (long i = minId; i <= maxId; i = i + size) {
            long endId = Math.min(i + size, maxId);
            boolean maxEqualFlag = endId == maxId;
            IdQueryBO idQueryBO = new IdQueryBO(true, i, maxEqualFlag, endId, size);
            Future<List<T>> future = executorService.submit(() -> {
                List<R> list = function.apply(idQueryBO, query);
                return coverFunction.apply(list);
            });
            result.add(future);
            if (maxEqualFlag) {
                break;
            }
        }
        return result;
    }

}

```



### 2ï¼‰`Manager` å±‚

```java
/**
 * æ ¹æ®æŸ¥è¯¢æ¡ä»¶è·å–æœ€å¤§Idå’Œæœ€å°Id
 *
 * @param query query
 * @return ImmutablePair<Long, Long>
 */
@Override
public ImmutablePair<Long, Long> queryMinAndMaxId(UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    queryWrapper.select("min(id) as \"minId\"", "max(id) as \"maxId\"");
    LambdaQueryWrapper<UserDemo> lambdaQueryWrapper = queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .like(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .like(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .like(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .le(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .ge(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());
    Map<String, Object> map = userDemoDao.getMap(lambdaQueryWrapper);
    return ImmutablePair.of(MapUtils.getLong(map, "minId"), MapUtils.getLong(map, "maxId"));
}

/**
 * æ ¹æ®idåŒºé—´æŸ¥è¯¢æ•°æ®
 *
 * @param idQueryBO idQueryBO
 * @return {@link List< UserDemo>}
 */
@Override
public List<UserDemo> queryUserDemoByIdSub(IdQueryBO idQueryBO, UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    if (!CollectionUtils.isEmpty(query.getSelectFields())) {
        queryWrapper.select(StringUtils.join(query.getSelectFields(), ","));
    }
    LambdaQueryWrapper<UserDemo> lambdaQueryWrapper = queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .eq(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .eq(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .eq(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .lt(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .gt(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());

    if (idQueryBO.getMinEqualFlag()) {
        lambdaQueryWrapper.ge(UserDemo::getId, idQueryBO.getMinId());
    } else {
        lambdaQueryWrapper.gt(UserDemo::getId, idQueryBO.getMinId());
    }

    if (idQueryBO.getMaxEqualFlag()) {
        lambdaQueryWrapper.le(UserDemo::getId, idQueryBO.getMaxId());
    } else {
        lambdaQueryWrapper.lt(UserDemo::getId, idQueryBO.getMaxId());
    }
    return userDemoDao.list(lambdaQueryWrapper);
}
```



### 3ï¼‰`BO` å¯¹è±¡ `IdQueryBO`

```java
package com.healerjean.proj.utils.db;

import lombok.Data;
import lombok.experimental.Accessors;

import java.io.Serializable;

/**
 * @author zhangyujin
 * @date 2023/7/5$  15:45$
 */
@Accessors(chain = true)
@Data
public class IdQueryBO implements Serializable {

    /**
     * serialVersionUID
     */
    private static final long serialVersionUID = 3145985803712258405L;

    /**
     * æ˜¯å¦ç­‰äºæœ€å°
     */
    private Boolean minEqualFlag;
    /**
     * æœ€å°Id
     */
    private Long minId;

    /**
     * æ˜¯å¦ç­‰äºæœ€å¤§
     */
    private Boolean maxEqualFlag;
    /**
     * æœ€å¤§Id
     */
    private Long maxId;

    /**
     * æ¯æ¬¡æŸ¥è¯¢å¤šå°‘ä¸ª
     */
    private Long size;

    public IdQueryBO(Long minId, Long maxId, Long size) {
        this.minId = minId;
        this.maxId = maxId;
        this.size = size;
    }

    public IdQueryBO(Boolean minEqualFlag, Long minId, Boolean maxEqualFlag, Long maxId, Long size) {
        this.minEqualFlag = minEqualFlag;
        this.minId = minId;
        this.maxEqualFlag = maxEqualFlag;
        this.maxId = maxId;
        this.size = size;
    }
}

```



### 4ï¼‰`Service`

```java
    /**
     * æ ¹æ®
     *
     * @param completionService completionService
     * @param query             queryBO
     * @return List<Future < List < UserDemoExcel>>>
     */
    @Override
    public List<Future<List<UserDemoExcel>>> queryAllUserDemoByPoolIdSub(CompletionService<List<UserDemoExcel>> completionService, UserDemoQueryBO query) {
        ImmutablePair<Long, Long> minAndMaxId = userDemoManager.queryMinAndMaxId(query);
        Long minId = minAndMaxId.getLeft();
        Long maxId = minAndMaxId.getRight();
        IdQueryBO idQueryBO = new IdQueryBO(minId, maxId, 2L);
        return MybatisBatchUtils.queryAllByPoolIdSub(completionService,
                (p, q) -> userDemoManager.queryUserDemoByIdSub(p, q),
                query,
                idQueryBO,
                UserConverter.INSTANCE::covertUserDemoPoToExcelList);
    }
```



### 5ï¼‰å•æµ‹

```java
@DisplayName("testQueryMinAndMaxId")
@Test
public void testQueryMinAndMaxId() {
    CompletionService<List<UserDemoExcel>> completionService = new ExecutorCompletionService(ThreadPoolUtils.DEFAULT_THREAD_POOL_TASK_EXECUTOR);

    UserDemoQueryBO queryBO = new UserDemoQueryBO();
    List<Future<List<UserDemoExcel>>> futures = userDemoService.queryAllUserDemoByPoolIdSub(completionService, 
                                                                                            queryBO);
    List<UserDemoExcel> all = Lists.newArrayList();
    for (int i = 0; i < futures.size(); i++) {
        try {
            Future<List<UserDemoExcel>> future = completionService.take();
            List<UserDemoExcel> userDemos = future.get();
            if (CollectionUtils.isEmpty(userDemos)) {
                continue;
            }
            all.addAll(future.get());
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
    log.info("[testQueryMinAndMaxId] res:{}", JsonUtils.toString(all));
}

```



## 2ã€çº¿ç¨‹æ±  `limit` åˆ†é¡µæŸ¥è¯¢

### 1ï¼‰çº¿ç¨‹æ± åˆ†é¡µè¯»å·¥å…·

```java
package com.healerjean.proj.utils.db;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.google.common.collect.Lists;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.Future;
import java.util.function.BiFunction;
import java.util.function.Function;

/**
 * MybatisPlusQueryUtils
 *
 * @author zhangyujin
 * @date 2023/6/25$  12:05$
 */
public final class MybatisBatchUtils {

    /**
     * queryAll
     *
     * @param executorService çº¿ç¨‹æ± 
     * @param function        åˆ†é¡µå‡½æ•°
     * @param queryWrapper    æŸ¥è¯¢æ¡ä»¶
     * @param pageSize        pageSize åˆ†é¡µå¤§å°
     * @param coverFunction   coverFunction å¯¹è±¡è½¬åŒ–
     * @return {@link List< Future< List<T>>>}
     */
    public static <Q, R, T> List<Future<List<T>>> queryAllByPoolLimit(CompletionService<List<T>> executorService,
                                                                      BiFunction<Page<R>, Q, IPage<R>> function,
                                                                      Q queryWrapper,
                                                                      int pageSize,
                                                                      Function<List<R>, List<T>> coverFunction) {

        IPage<R> initPage = function.apply(new Page<>(1, 0, true), queryWrapper).setSize(pageSize);

        List<Future<List<T>>> result = new ArrayList<>();
        for (int i = 1; i <= initPage.getPages(); i++) {
            int finalI = i;
            Future<List<T>> future = executorService.submit(() -> {
                IPage<R> page = function.apply(new Page<>(finalI, pageSize, false), queryWrapper);
                return coverFunction.apply(page.getRecords());
            });
            result.add(future);
        }
        return result;
    }


}

```



### 2ï¼‰`Manager` å±‚

```java
/**
 * è·å–æŸ¥è¯¢æ¡ä»¶
 *
 * @param query query
 * @return LambdaQueryWrapper<UserDemo>
 */
@Override
public LambdaQueryWrapper<UserDemo> queryBuilderQueryWrapper(UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    if (!CollectionUtils.isEmpty(query.getSelectFields())) {
        queryWrapper.select(StringUtils.join(query.getSelectFields(), ","));
    }
    if (!CollectionUtils.isEmpty(query.getOrderByList())) {
        query.getOrderByList().forEach(item -> queryWrapper.orderBy(Boolean.TRUE, item.getDirection(), 
                                                                    item.getProperty()));
    }
    return queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .eq(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .eq(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .eq(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .lt(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .gt(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());
}
```

### 3ï¼‰`Service`

```java
/**
 * queryFutureAll
 *
 * @param completionService completionService
 * @param query             query
 * @return List<Future < List < UserDemoExcel>>>
 */
@Override
public List<Future<List<UserDemoExcel>>> queryAllUserDemoByPoolLimit(CompletionService<List<UserDemoExcel>> completionService, UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = userDemoManager.queryBuilderQueryWrapper(query);
    return MybatisBatchUtils.queryAllByPoolLimit(completionService,
            (p, q) -> userDemoDao.page(p, q),
            queryWrapper,
            1,
            UserConverter.INSTANCE::covertUserDemoPoToExcelList);
}

```



### 4ï¼‰å•æµ‹

```java
@DisplayName("testQueryUserDemoByLimit")
@Test
public void testQueryUserDemoByLimit() {
    CompletionService<List<UserDemoExcel>> completionService = new ExecutorCompletionService(ThreadPoolUtils.DEFAULT_THREAD_POOL_TASK_EXECUTOR);

    UserDemoQueryBO queryBO = new UserDemoQueryBO();
    List<Future<List<UserDemoExcel>>> futures = userDemoService.queryAllUserDemoByPoolLimit(completionService, 
                                                                                            queryBO);
    List<UserDemoExcel> all = Lists.newArrayList();
    for (int i = 0; i < futures.size(); i++) {
        try {
            Future<List<UserDemoExcel>> future = completionService.take();
            List<UserDemoExcel> userDemos = future.get();
            if (CollectionUtils.isEmpty(userDemos)) {
                continue;
            }
            all.addAll(future.get());
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
    log.info("[testQueryUserDemoByLimit] res:{}", JsonUtils.toString(all));
}

```













![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)




<!-- Gitalk è¯„è®º start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>Â 
<div id="gitalk-container"></div>Â    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'sVtG9yWYSIPvoieX',
    });
    gitalk.render('gitalk-container');
</script>Â 

<!-- Gitalk end -->

