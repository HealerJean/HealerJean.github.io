---
title: 6_config分布式配置中心
date: 2018-11-29 03:33:00
tags: 
- SpringCloud
category: 
- SpringCloud
description: 6_config分布式配置中心
---






# 1、Config配置中心：5001

## 1.1、添加pom依赖

```xml
<!--config-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server</artifactId>
</dependency>

```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.healerjean.proj</groupId>
        <artifactId>hlj-parent</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>hlj-config-5001</artifactId>
    <version>${project.healerjean.version}</version>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--config-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-server</artifactId>
        </dependency>

        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>

```

## 1.2、启动类 

> `@EnableConfigServer` ：添加分布式配置服务端支持

```java
@EnableConfigServer //添加分布式配置服务端支持
@SpringBootApplication
public class Config_5001_Application {

    public static void main(String[] args) {
        SpringApplication.run(Config_5001_Application.class, args);
    }

}

```

# 2、Github存储配置信息 

## 2.1、创建仓库`cloud-config`

### 2.1.1、根目录创建配置项目文件夹 `config-client`



![1586936994852](D:\study\HealerJean.github.io\blogImages\1586936994852.png)





### 2.1.2、创建配置文件`properties`

> **命名规则**：`自定义项目名称-profile.properties`



![1586937020658](D:\study\HealerJean.github.io\blogImages\1586937020658.png)







`client.properties`

```properties
from=github-default
```

`client-dev.properties`

```properties
from=github-dev
```

`client-local.properties`

```properties
from=github-local
```

`client-prod.properties`

```properties
from=github-prod
```



### 2.1.3、上传到Github 



![1586937072702](D:\study\HealerJean.github.io\blogImages\1586937072702.png)







## 2.2、Config配置中心配置 

### 2.1.1、`application.properties`



```properties
spring.application.name=hlj-config-server
server.port=5001


# config => git仓库
spring.cloud.config.server.git.uri=https://github.com/HealerJean/cloud-config/
# 配置文件所属文件夹路径
spring.cloud.config.server.git.searchPaths=config-client
# 分支名称
spring.cloud.config.label=master
#公开仓库不需要写用户名和密码，如果是私有仓库则需要些用户名和密码
spring.cloud.config.server.git.username=
spring.cloud.config.server.git.password=
```



## 2.3、启动测试 

### 2.3.1、http访问路径解释   

> application：properties代表的项目名   
>
> profile：properties代表的Profile    
>
> label：Gihub分支名称    



| http路径                             |
| ------------------------------------ |
| /{application}/{profile}[/{label}]   |
| /{label}/{application}-{profile}.yml |
| /{application}-{profile}.yml         |
| /{application}-{profile}.properties  |



```http
http://localhost.admin:5001/client/prod/master
```

**接口返回：**

```json
{
    "name": "client",
    "profiles": [
        "prod"
    ],
    "label": "master",
    "version": null,
    "state": null,
    "propertySources": [
        {
            "name": "https://github.com/HealerJean/cloud-config/config-client/client-prod.properties",
            "source": {
                "from": "github-prod"
            }
        },
        {
            "name": "https://github.com/HealerJean/cloud-config/config-client/client.properties",
            "source": {
                "from": "github-default"
            }
        }
    ]
}
```





```http
http://localhost.admin:5001/client/master
```

**接口返回：**

```json
{
    "name": "client",
    "profiles": [
        "master"
    ],
    "label": null,
    "version": null,
    "state": null,
    "propertySources": [
        {
            "name": "https://github.com/HealerJean/cloud-config/config-client/client.properties",
            "source": {
                "from": "github-default"
            }
        }
    ]
}
```





# 3、`Config`客户端：6001 

## 3.1、pom.xml依赖 

```xml
<!--starter-config-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>

```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.healerjean.proj</groupId>
        <artifactId>hlj-parent</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>hlj-config-client-6001</artifactId>
    <version>${project.healerjean.version}</version>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--starter-config-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>

        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>

```





## 3.2、`Url`获取`Config`配置

### 3.2.1、`bootstrap.properties`

```properties
spring.application.name=client
server.port=6001

#1、 通过地址访问配置文件
spring.cloud.config.profile=prod
spring.cloud.config.label=master
spring.cloud.config.uri=http://localhost:5001/
```



### 3.2.2、`ConfigClientController`  

> **`@RefreshScope`：`spring-cloud` 实现更新配置不用重启服务** 

```java
package com.healerjean.proj.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;


@RefreshScope //`spring-cloud` 实现更新配置不用重启服务** 
@RestController
@RequestMapping("api/config/client")
public class ConfigClientController {

    @Value("${from}")
    private String from;

    @GetMapping("fromValue")
    public String from() {
        return this.from;
    }

}

```



### 3.2.3、启动测试

```http
http://127.0.0.1:6001/api/config/client/fromValue
```

**接口返回：**    

```
github-prod
```



# 3、启用服务发现  

## 3.1、Config配置中心_5001  

### 3.1.1、`pom.xml`依赖

```xml
<!--starter-eureka-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-eureka</artifactId>
</dependency>
```



```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.healerjean.proj</groupId>
        <artifactId>hlj-parent</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>hlj-config-server-5001</artifactId>
    <version>${project.healerjean.version}</version>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--config-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-server</artifactId>
        </dependency>

        <!--starter-eureka-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-eureka</artifactId>
        </dependency>

        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>

```





### 3.1.2、`application.properties`

```properties
spring.application.name=hlj-config-server
server.port=5001


# config => git仓库
spring.cloud.config.server.git.uri=https://github.com/HealerJean/cloud-config/
# 配置文件所属文件夹路径
spring.cloud.config.server.git.searchPaths=config-client
# 分支名称
spring.cloud.config.label=master
#公开仓库不需要写用户名和密码，如果是私有仓库则需要些用户名和密码
spring.cloud.config.server.git.username=
spring.cloud.config.server.git.password=

#指定服务注册中心
eureka.client.serviceUrl.defaultZone=http://localhost:1111/eureka/,http://localhost:1112/eureka/
```

### 3.1.3、启动类 

```java
package com.healerjean.proj;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.config.server.EnableConfigServer;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@EnableConfigServer //添加分布式配置服务端支持
@EnableEurekaClient //添加服务发现
@SpringBootApplication
public class Config_5001_Application {

    public static void main(String[] args) {
        SpringApplication.run(Config_5001_Application.class, args);
    }

}

```





## 3.2、Config客户端_6001  

### 3.2.1、pom.xml依赖 

```xml
<!--starter-eureka-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-eureka</artifactId>
</dependency>
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.healerjean.proj</groupId>
        <artifactId>hlj-parent</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>hlj-config-client-6001</artifactId>
    <version>${project.healerjean.version}</version>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>

        <!--hlj-common-->
        <dependency>
            <groupId>com.healerjean.proj</groupId>
            <artifactId>hlj-common</artifactId>
            <version>${project.healerjean.version}</version>
        </dependency>

        <!--starter-config-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>

        <!--starter-eureka-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-eureka</artifactId>
        </dependency>

        <!--starter-web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>


        <!--swagger-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
        </dependency>
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>

```



### 3.2.2、`bootstrap.properties`  

```

```



#### 4.2.2、启用注册发现


```java

@EnableDiscoveryClient
@SpringBootApplication
public class Application {

   public static void main(String[] args) {
      new SpringApplicationBuilder(Application.class).web(true).run(args);
   }
}

```

#### 4.2.3、配置服务注册中心和服务端的config


```properties
spring.application.name=client
server.port=6001

# 2、通过服务发现
spring.cloud.config.profile=prod
spring.cloud.config.label=master
spring.cloud.config.discovery.service-id=HLJ-CONFIG-SERVER
#指定服务注册中心
eureka.client.serviceUrl.defaultZone=http://localhost:1111/eureka/,http://localhost:1112/eureka/

```



## 



## [HealerJean-代码下载](https://github.com/HealerJean/com-hlj-springcloud/tree/master/6)



## 5、项目实战中的config


### 5.1、新建项目sso-config

#### 5.1.1、添加pom依赖



```xml
 <dependencies>
      <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-config-server</artifactId>
      </dependency>

```


```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>

   <groupId>com.carl.auth</groupId>
   <artifactId>sso-config</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <packaging>jar</packaging>

   <name>sso-config</name>
   <description>Demo project for Spring Boot</description>

   <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>1.5.10.RELEASE</version>
      <relativePath/> <!-- lookup parent from repository -->
   </parent>

   <properties>
      <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
      <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
      <java.version>1.8</java.version>
      <spring-cloud.version>Edgware.SR2</spring-cloud.version>
   </properties>

   <dependencies>
      <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-config-server</artifactId>
      </dependency>

      <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-test</artifactId>
         <scope>test</scope>
      </dependency>
   </dependencies>

   <dependencyManagement>
      <dependencies>
         <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
         </dependency>
      </dependencies>
   </dependencyManagement>

   <build>
      <plugins>
         <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
         </plugin>
      </plugins>
   </build>


</project>
```


#### 5.1.2、添加配置管理器支持注解


```java

@EnableConfigServer
@SpringBootApplication
public class SsoConfigApplication {

   public static void main(String[] args) {
      SpringApplication.run(SsoConfigApplication.class, args);
   }
}

```


#### 5.1.3、编辑config服务端配置文件



```yml

server:
  #服务端口
  port: 8888
  #访问路径
  context-path: /config
  
#指定日志输出文件
logging:
  file: "logs/sso-config.log"
info:
  name : "配置中心"

---

spring:
  profiles:
    #本地配置文件
    active:
      #配置文件本地化
      - native
application:
    #指定应用名称
    name: sso-config
    
```

#### 5.1.4、运行这个spring boot项目，浏览器访问 http://localhost:8888/config/ 说明下面的启动成功

![pX6QROsIqT4lMgLe](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/blogImages/pX6QROsIqT4lMgLe.png)



#### 5.1.5、配置中心的位置，创建resource 下创建config文件夹，创建sso-dev.propetries 编辑配置文件

<font  color="red" size="4"> 
 1、上面我们提到配置是放置于配置中心，而不放在服务内<br/>
 2、由于配置是放在与本地，那么spring的默认配置在目录为resources/config<br/>
  </font>

写入内容

```
hello_key=value

```
![h0WCGlpbKfAJZEqk](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/blogImages/h0WCGlpbKfAJZEqk.png)


#### 5.1.6、重新启动spring boot项目，访问 http://localhost:8888/config/sso/dev 


![E5Xazs9mMYUiudtq](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/blogImages/E5Xazs9mMYUiudtq.png)


```json

name:应用名称 sso -dev.properties配置文件的名称
label 表示分支名称 master
version 表示git上对应的版本号
{
	"name": "sso",
	"profiles": ["dev"],
	"label": null,
	"version": null,
	"state": null,
	"propertySources": [{
		"name": "classpath:/config/sso-dev.properties",
		"source": {
			"hello_key": "value"
		}
	}]
}


```


### 5.2、接入客户端



```

#指定日志文件
logging.file=logs/cas.log
info.name=单点登录系统

#定义application.name的id
spring.application.name=sso
#寻找配置中心为sso-dev.properties
spring.profiles.active=dev
#指定配置中心地址
spring.cloud.config.uri=http://localhost:8888/config
#开启配置中心
spring.cloud.config.enabled=true
#支持自动任务去配置中心刷新配置
spring.cloud.config.watch.enabled=true
#30秒刷新一次
spring.cloud.config.watch.initialDelay=30000
#请求配置中心超市
spring.cloud.config.watch.delay=1000
#检查配置健康
health.config.enabled=true


```

<br/><br/><br/>
<font color="red"> 感兴趣的，欢迎添加博主微信， </font><br/>
哈，博主很乐意和各路好友交流，如果满意，请打赏博主任意金额，感兴趣的在微信转账的时候，备注您的微信或者其他联系方式。添加博主微信哦。
<br/>
请下方留言吧。可与博主自由讨论哦

|微信 | 微信公众号|支付宝|
|:-------:|:-------:|:------:|
| ![微信](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|![支付宝](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/alpay.jpg) |




<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'ex5IX1liqBwJ4cGs',
    });
    gitalk.render('gitalk-container');
</script> 

<!-- Gitalk end -->

