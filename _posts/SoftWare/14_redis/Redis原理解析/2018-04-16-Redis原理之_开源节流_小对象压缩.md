---
title: Redis原理之_开源节流_小对象压缩
date: 2018-04-16 03:33:00
tags: 
- Redis
category: 
- Redis
description: Redis原理之_开源节流_小对象压缩
---

**前言**     

 Github：[https://github.com/HealerJean](https://github.com/HealerJean)         

 博客：[http://blog.healerjean.com](http://HealerJean.github.io)          



# 1、引入

> `Redis` 是一个非常耗费内存的数据库，它所有的数据都放在内存里。如果我们不注意节 约使用内存，`Redis` 就会因为我们的无节制使用出现内存不足而崩溃。`Redis` 作者为了优化数据结构的内存占用，也苦心孤诣增加了非常多的优化点，这些优化也是以牺牲代码的可读性 为代价的，当然毫无疑问这是非常值得的，尤其像 `Redis` 这种数据库。    



# 2、`32bit` vs `64bit`

> `Redis` 如果使用 `32bit` 进行编译，内部所有数据结构所使用的指针空间占用会少一半， 如果你对`Redis` 使用内存不超过 `4G`，可以考虑使用 `32bit` 进行编译，可以节约大量内存。 `4G` 的容量作为一些小型站点的缓存数据库是绰绰有余了，如果不足还可以通过增加实例的方式来解决。





# 3、小对象压缩存储 (`ziplist`)

> 如果 `Redis` 内部管理的集合数据结构很小，它会使用紧凑存储形式压缩存储。
>
> 这就好比 `HashMap` 本来是二维结构，但是如果内部元素比较少，使用二维结构反而浪费空间，还不如使用一维数组进行存储，需要查找时，因为元素少进行遍历也很快，甚至可 以比 `HashMap` 本身的查找还要快。比如下面我们可以使用数组来模拟 `HashMap` 的增删改 操作。



![image-20210531175325393](/Users/healerjean/Desktop/HealerJean/HCode/HealerJean.github.io/blogImages/image-20210531175325393.png)

## 3.1、`Hash `元素少的时候用`ziplist`

> 如果它存储的是 `hash` 结构，那么 `key `和 `value` 会作为两个 `entry` 相邻存在一起。

```shell
127.0.0.1:6379> hset hello a 1 
(integer) 1
127.0.0.1:6379> hset hello b 2 
(integer) 1
127.0.0.1:6379> hset hello c 3 
(integer) 1

127.0.0.1:6379> type hello
hash
127.0.0.1:6379> object encoding hello 
"ziplist"
```



## 3.2、`zset` 元素少的时候用`ziplist`

> 如果它存储的是 `zset`，那么 `value` 和 `score` 会作为两个 `entry` 相邻存在一起。

```shell

127.0.0.1:6379> zadd world 1 a 
(integer) 1
127.0.0.1:6379> zadd world 2 b 
(integer) 1
127.0.0.1:6379> zadd world 3 c 
(integer) 1

127.0.0.1:6379> type word
zset
127.0.0.1:6379> object encoding world 
"ziplist"
```



## 3.3 `set` 存放整数元素少的时候用`intset`

> `Redis` 的 `intset` 是一个紧凑的整数数组结构，它用于存放元素都是整数的并且元素个数 较少的 `set` 集合













![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'AAAAAAAAAAAAAAAAAA',
    });
    gitalk.render('gitalk-container');
</script> 



<!-- Gitalk end -->



