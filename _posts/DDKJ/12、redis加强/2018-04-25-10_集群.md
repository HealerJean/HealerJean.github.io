---
title: 10、redis集群
date: 2018-03-06 03:33:00
tags: 
- Redis
category: 
- Redis
description: redis集群
---
<!-- image url 
https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages
　　首行缩进
<font color="red">  </font>
-->

## 前言

sentinel是高可用，那么集群的话就是分布式方案了。redis分布方案有两种

#### 客户端分区方案，优点是分区逻辑可控，缺点是需要自己处理数据路由，高可用，故障转移等问题

#### 代理方案：优点是简化客户端分布式逻辑，缺点是加重架构部署复杂度和性能消耗（我们公司就是使用的代理负载均衡）

## 1、数据分布（Redis cluster采用哈希分区规则）

### 1、节点取余分区

使用特定的数据，如redis的key，再更加节点的数量N使用公式 hash(key)%N,计算出hash值，用来决定数据映射到哪个节点上（和hashmap有点像）当节点数量变化的时候，如收缩或者扩容，数据节点的映射关系需要重新计算。

### 2、一致性哈希分区

为每个节点分配一个token，范围一般在0-2的32次幂，这些token构成一个哈希换，数据进行读写操作的时候，先根据key计算hash值，然后顺时针找到第一个大于等于该哈希值的toaken节点。

好处：假如和删除节点只影响哈希环中相邻的节点。对其他节点没有影响。
缺点：加减节点会造成hash环中的部分数据无法命中。需要手动处理或者忽略掉这部分数据。正因为存在这些缺点所以一般采用虚拟槽进行改进

### 3、虚拟槽分区
当前集群有5个节点，每个及诶单平均复制3276个槽，由于采用高质量的hash算法，每个槽的数据比较均匀，将数据平均分到5个节点进行分区，Redis Cluster就是采用这种分区

## 2、集群功能限制

#### 1、key的事物操作支持有限，只支持多个key在同一节点的事物操作，当多个key分布在不同的节点上的时候无法使用事物功能

#### 2、不支持多数据库空间，redis，也就是说值能使用一个暑假库空间 db等于0

#### 3、复制结构只支持一层，不支持嵌套树状结构。从节点只能复制主节点

#### 4、批量操作支持有限 mset ，mget 目前只支持具有相同sloot值的批量操作，因为mset 其实也就是多个key的存储，可能存储到不同的节点也说不定。所以不支持


## 3、搭建集群（使用redis-trib.rb工具）

准备工作：
1、Redis集群节点数量至少为6个才能保证组完成高可用的集群
2、集群节点统一目录，一般为3个目录，conf，data，log分布存放配置，数据和日志相关配置文件


```
daemonize yes 
logfile "6379.log"  //也就是说redis-server启动之后的日志放到了dir目录下的6379.log
dbfilename "dump-6379.rdb"
dir "/usr/local/redis/dir"


cluster-enabled yes   //开启集群模式
cluster-config-file nodes-6481.conf   //集群内部配置文件
cluster-node-timeout 15000  //节点超时时间 


```
建议使用linux系统操作

### 1、Ruby环境准备
安装完成之后，看看环境是否正确，重新安装一个redis端口为6379，就用这个redis来操作搭建集群了。

```
healerjean$ ./redis-trib.rb
Usage: redis-trib <command> <options> <arguments ...>

  create          host1:port1 ... hostN:portN
                  --replicas <arg>
  check           host:port
  info            host:port
  fix             host:port
                  --timeout <arg>
  reshard         host:port
                  --from <arg>
                  --to <arg>
                  --slots <arg>
                  --yes
                  --timeout <arg>
                  --pipeline <arg>
  rebalance       host:port
                  --weight <arg>

```

### 2、开始创建集群

1、--replicas 参数指定集群中没给主节点配备几个从节点，这里设置为1，就是说每个主节点分配1个从节点，一般是先主节点，前三个主节点，再从节点，后三个从节点。可以通过下面的命令日志可以观察到


```
Using 3 masters:
127.0.0.1:6481
127.0.0.1:6482
127.0.0.1:6483
Adding replica 127.0.0.1:6484 to 127.0.0.1:6481
Adding replica 127.0.0.1:6485 to 127.0.0.1:6482
Adding replica 127.0.0.1:6486 to 127.0.0.1:6483
```

2、如果部署节点尽量使用不同的IP地址。redis-trib.rb会尽可能保证主从节点不在同一个机器上。因此会重新排列节点的列表的顺序


3、下面应该使用redis服务器所在的Ip，我这里是本机测试使用，所以使用的127.0.0.1，如果是windows加虚拟机就会出问题。尽管连接了虚拟机的IP，但是代码连接不到redis。所以虚拟机也要使用虚拟机所在ip


```
./redis-trib.rb  create --replicas 1 127.0.0.1:6481 127.0.0.1:6482 127.0.0.1:6483 127.0.0.1:6484 127.0.0.1:6485 127.0.0.1:6486

```

#### 2.1、开始执行命令
```
healerjean$ ./redis-trib.rb  create --replicas 1 127.0.0.1:6481 127.0.0.1:6482 127.0.0.1:6483 127.0.0.1:6484 127.0.0.1:6485 127.0.0.1:6486
>>> Creating cluster
>>> Performing hash slots allocation on 6 nodes...
Using 3 masters:
127.0.0.1:6481
127.0.0.1:6482
127.0.0.1:6483
Adding replica 127.0.0.1:6484 to 127.0.0.1:6481
Adding replica 127.0.0.1:6485 to 127.0.0.1:6482
Adding replica 127.0.0.1:6486 to 127.0.0.1:6483
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
Can I set the above configuration? (type 'yes' to accept): 
```

#### 2.1、执行节点握手和槽的fenpei
可以看到下面的16384个槽全部被分配完毕，而且分配均匀给了master节点

```
输入 yes

Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join...
>>> Performing Cluster Check (using node 127.0.0.1:6481)
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   slots: (0 slots) slave
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   slots: (0 slots) slave
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   slots: (0 slots) slave
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
MacBook-Pro:src healerjean$ 

```

### 3、集群完整性检查和master和slave信息查看

集群完整性是指所有的槽都分配到了存活的主节点上，只要有一个槽没有分配给主主节点，则表示不完整。使用下面的命令检测，只要给出集群中任意一个节点就也可以看看集群是否完成。6379则不能成功，因为它不属于集群


```
./redis-trib.rb check 127.0.0.1:6481

出现结果是：[OK] All 16384 slots covered.则表示集群创建完整

```

```

MacBook-Pro:src healerjean$ ./redis-trib.rb check 127.0.0.1:6379
[ERR] Node 127.0.0.1:6379 is not configured as a cluster node.
MacBook-Pro:src healerjean$ ./redis-trib.rb check 127.0.0.1:6481
>>> Performing Cluster Check (using node 127.0.0.1:6481)
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   slots: (0 slots) slave
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   slots: (0 slots) slave
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   slots: (0 slots) slave
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
MacBook-Pro:src healerjean$ 
```

### 4、集群扩容
准备连个节点，一个将来是主节点，一个是从节点
这里为了和上面的的好区分，节点的端口设置为6385和6386

redis为我们提供了一种假如集群的命令但是不建议使用，而是使用ruby的命令，redis提供的命令为如下，当下面的节点已经假如其他集群，下面的命令会将它所在的集群和本集群进行合并。而使用redis-trib.rb则不会，因为他会检查，同时放弃加入集群的操作

```
不建议使用
cluster meet 127.0.0.1 6385 
```


```
建议使用：第一个参数为新节点的“”ip:端口“”，第二个参数为集群中的任一有效的节点，也就是随便写

./redis-trib.rb add-node 127.0.0.1:6385 127.0.0.1:6481 

```

### 4.1、开始扩容加入master主节点
```
观察到 [OK] New node added correctly. 表示成功

healerjean$ ./redis-trib.rb add-node 127.0.0.1:6385 127.0.0.1:6481 
>>> Adding node 127.0.0.1:6385 to cluster 127.0.0.1:6481
>>> Performing Cluster Check (using node 127.0.0.1:6481)
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   slots: (0 slots) slave
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   slots: (0 slots) slave
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   slots: (0 slots) slave
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 127.0.0.1:6385 to make it join the cluster.
[OK] New node added correctly.
MacBook-Pro:src healerjean$ 

```

### 4.2、检查master节点的槽

随便进入一个节点，这里我选了主节点6481，输入下面的命令之后，我们能看到并没有给它分配槽。这个槽后面我们慢慢分配


```
cluster nodes，当然也可以使用rb的check命令
```

```
127.0.0.1:6481> cluster nodes
5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6385 master - 0 1524762381923 0 connected
4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483 master - 0 1524762386469 3 connected 10923-16383
518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481 myself,master - 0 0 1 connected 0-5460
42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486 slave 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 0 1524762384953 6 connected
9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485 slave 1ed5a33205eac6bcd02672731b8fff55485bd81b 0 1524762388993 5 connected
96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484 slave 518f740fa4823ad65972f0605983be347f9ccc79 0 1524762386975 4 connected
1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482 master - 0 1524762387983 2 connected 5461-10922
127.0.0.1:6481> 
```

### 4.3、给这个节点分配从节点

把6386当成slave加入. master-id 为自己作为slave时候，master的id，这里应该是6385主节点的id，可以通过check查看基本信息的id （后面的端口7000随便写）
```
./redis-trib.rb add-node --slave --master-id  5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6386 127.0.0.1:6481  

```


```
healerjean$ ./redis-trib.rb add-node --slave --master-id  5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6386 127.0.0.1:6481  
>>> Adding node 127.0.0.1:6386 to cluster 127.0.0.1:6481
>>> Performing Cluster Check (using node 127.0.0.1:6481)
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6385
   slots: (0 slots) master
   0 additional replica(s)
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   slots: (0 slots) slave
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   slots: (0 slots) slave
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   slots: (0 slots) slave
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 127.0.0.1:6386 to make it join the cluster.
Waiting for the cluster to join.
>>> Configure node as replica of 127.0.0.1:6385.
[OK] New node added correctly.
MacBook-Pro:src healerjean$ 

```


#### 4.3.1、查看master和salve信息


```
./redis-trib check 127.0.0.1 6481
```


```
可以看到 从节点6386复制的是6385主节点
S: e4b8e373e245e7297a612b56126fd0e01afc7965 127.0.0.1:6386
   slots: (0 slots) slave
   replicates 5041f91a03330df4c0667b91f11151df965cdaad
M: 5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6385


healerjean$ ./redis-trib.rb check 127.0.0.1:6481
>>> Performing Cluster Check (using node 127.0.0.1:6481)
M: 518f740fa4823ad65972f0605983be347f9ccc79 127.0.0.1:6481
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: e4b8e373e245e7297a612b56126fd0e01afc7965 127.0.0.1:6386
   slots: (0 slots) slave
   replicates 5041f91a03330df4c0667b91f11151df965cdaad
M: 5041f91a03330df4c0667b91f11151df965cdaad 127.0.0.1:6385
   slots: (0 slots) master
   1 additional replica(s)
M: 4b420c1a34f8d1053e314c05776fbfc50a3cba5e 127.0.0.1:6483
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 42e99055fef2fc54030b1764878925ba878551a8 127.0.0.1:6486
   slots: (0 slots) slave
   replicates 4b420c1a34f8d1053e314c05776fbfc50a3cba5e
S: 9c8806f52d7e71c0ef2dc7908879dc84fe40e5c8 127.0.0.1:6485
   slots: (0 slots) slave
   replicates 1ed5a33205eac6bcd02672731b8fff55485bd81b
S: 96b105f0e33e3c5ccbe5983c7f65f52e7971eac9 127.0.0.1:6484
   slots: (0 slots) slave
   replicates 518f740fa4823ad65972f0605983be347f9ccc79
M: 1ed5a33205eac6bcd02672731b8fff55485bd81b 127.0.0.1:6482
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
MacBook-Pro:src healerjean$ 
```



<br/><br/><br/>
如果满意，请打赏博主任意金额，感兴趣的请下方留言吧。可与博主自由讨论哦

|支付包 | 微信|微信公众号|
|:-------:|:-------:|:------:|
|![支付宝](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/alpay.jpg) | ![微信](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|




<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean123.github.io`,
		owner: 'HealerJean123',
		admin: ['HealerJean123'],
		id: 'IHSSj1AcHEeBDXA9',
    });
    gitalk.render('gitalk-container');
</script> 

<!-- Gitalk end -->

