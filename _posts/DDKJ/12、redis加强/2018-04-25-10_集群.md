---
title: 10、redis集群
date: 2018-03-06 03:33:00
tags: 
- Redis
category: 
- Redis
description: redis集群
---
<!-- image url 
https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages
　　首行缩进
<font color="red">  </font>
-->

## 前言

sentinel是高可用，那么集群的话就是分布式方案了。redis分布方案有两种

#### 客户端分区方案，优点是分区逻辑可控，缺点是需要自己处理数据路由，高可用，故障转移等问题

#### 代理方案：优点是简化客户端分布式逻辑，缺点是加重架构部署复杂度和性能消耗（我们公司就是使用的代理负载均衡）

## 1、数据分布（Redis cluster采用哈希分区规则）

### 1、节点取余分区

使用特定的数据，如redis的key，再更加节点的数量N使用公式 hash(key)%N,计算出hash值，用来决定数据映射到哪个节点上（和hashmap有点像）当节点数量变化的时候，如收缩或者扩容，数据节点的映射关系需要重新计算。

### 2、一致性哈希分区

为每个节点分配一个token，范围一般在0-2的32次幂，这些token构成一个哈希换，数据进行读写操作的时候，先根据key计算hash值，然后顺时针找到第一个大于等于该哈希值的toaken节点。

好处：假如和删除节点只影响哈希环中相邻的节点。对其他节点没有影响。
缺点：加减节点会造成hash环中的部分数据无法命中。需要手动处理或者忽略掉这部分数据。正因为存在这些缺点所以一般采用虚拟槽进行改进

### 3、虚拟槽分区
当前集群有5个节点，每个及诶单平均复制3276个槽，由于采用高质量的hash算法，每个槽的数据比较均匀，将数据平均分到5个节点进行分区，Redis Cluster就是采用这种分区

## 2、集群功能限制

#### 1、key的事物操作支持有限，只支持多个key在同一节点的事物操作，当多个key分布在不同的节点上的时候无法使用事物功能

#### 2、不支持多数据库空间，redis，也就是说值能使用一个暑假库空间 db等于0

#### 3、复制结构只支持一层，不支持嵌套树状结构。从节点只能复制主节点

#### 4、批量操作支持有限 mset ，mget 目前只支持具有相同sloot值的批量操作，因为mset 其实也就是多个key的存储，可能存储到不同的节点也说不定。所以不支持


## 3、搭建集群（使用redis-trib.rb工具）

准备工作：
1、Redis集群节点数量至少为6个才能保证组完成高可用的集群
2、集群节点统一目录，一般为3个目录，conf，data，log分布存放配置，数据和日志相关配置文件


```
daemonize yes 
logfile "6379.log"  //也就是说redis-server启动之后的日志放到了dir目录下的6379.log
dbfilename "dump-6379.rdb"
dir "/usr/local/redis/dir"


cluster-enabled yes   //开启集群模式
cluster-config-file nodes-6481.conf   //集群内部配置文件
cluster-node-timeout 15000  //节点超时时间 


```
建议使用linux系统操作






<br/><br/><br/>
如果满意，请打赏博主任意金额，感兴趣的请下方留言吧。可与博主自由讨论哦

|支付包 | 微信|微信公众号|
|:-------:|:-------:|:------:|
|![支付宝](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/alpay.jpg) | ![微信](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|




<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean123.github.io`,
		owner: 'HealerJean123',
		admin: ['HealerJean123'],
		id: 'IHSSj1AcHEeBDXA9',
    });
    gitalk.render('gitalk-container');
</script> 

<!-- Gitalk end -->

