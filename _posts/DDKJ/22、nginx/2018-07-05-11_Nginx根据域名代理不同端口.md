---
title: Nginx根据域名代理不同端口
date: 2018-07-05 03:33:00
tags: 
- Nginx
category: 
- Nginx
description: Nginx根据域名代理不同端口
---
<!-- image url 
https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/blogImages
　　首行缩进
<font color="red">  </font>
-->

## 前言



```

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}

```



## 1、基本命令



### 1.1、启动

```shell
Linux  ./nginx -c conf/nginx.conf
windows start nginx
```





### 1.2、停止

```shell
./nginx -s stop
```



### 1.3、有序退出

```shell
./nginx -s quit
```



### 1.4、配置修改后，重新载入

```shell
./nginx -s reload
```



### 1.5、重启

```shell
./nginx -s reopen  
```



### 1.6、检测配置文件

```shell
./nginx -t
```



### 1.7、平滑重启

```shell

kill -HUP nginx进程号
kill -HUP '/var/run/nginx.pid"

当nginx接收到HUP信号时，它会尝试先解析配置文件（如果指定文件，就使用指定的，否则使用默认的），如果成功，就应用新的配置文件（例如：重新打开日志文件或监听的套接字），之后，nginx运行新的工作进程并从容关闭旧的工作进程，通知工作进程关闭监听套接字，但是继续为当前连接的客户提供服务，所有客户端的服务完成后，旧的工作进程就关闭，如果新的配置文件应用失败，nginx继续使用之前的配置进行工作。

```



## 2、属性解释

### 2.1、listen 监听的端口；server_name 建议的域名或者ip



### 2.2、`autoindex on;` 



+  解释 ：开启浏览功能，开启网站目录文件列表功能，访问目录时列出其中的文件列表，默认不开启  



```conf

 server {
        listen       80;
        server_name  test.nginx.com;
        root   D:/nginx/;
        # 开启网站目录文件列表功能，访问目录时列出其中的文件列表，默认不开启  
        autoindex on; 
       
    }

```



+ 测试

  

```http
http://test.nginx.com
```



![1571991172801](D:\study\HealerJean.github.io\blogImages\1571991172801.png)



### 2.3、 index   

+ 解释 ：如果url没有匹配，则优先index文件，没有这个属性值也是默认会查找index.html文件

```conf
 server {
        listen       80;
        server_name  test.nginx.com;
        root   D:/nginx/;
        index  index.html index.htm;
        autoindex on; 
       
    }

```



+ 测试     

我在root目录下放入一个index.html文件，并写入文件内容index



```http
http://test.nginx.com
```



![1571991233356](D:\study\HealerJean.github.io\blogImages\1571991233356.png)





### 2.4、location匹配规则



##### 2.4.1、匹配规则

| 模式                | 含义                                                         |
| ------------------- | ------------------------------------------------------------ |
| location = /uri     | = 表示精确匹配，只有完全匹配上才能生效                       |
| location ^~ /uri    | ^~ 开头对URL路径进行前缀匹配，并且在正则之前。前缀匹配，如果有包含关系时，按最大匹配原则进行匹配。比如在前缀匹配：`location /dir01` 与`location /dir01/dir02`，如有请求 `http://localhost/dir01/dir02/file` 将最终匹配到 `location /dir01/dir02` |
| location ~ pattern  | 正则匹配：区分大小写的                                       |
| location ~* pattern | 正则匹配：不区分大小写的                                     |
| location /uri       | 不带任何修饰符，也表示前缀匹配，在正则匹配之后               |
| location /          |                                                              |



##### 2.4.2、匹配顺序

- 首先精确匹配 `=`
- 其次前缀匹配 `^~`
- 其次是按文件中顺序的正则匹配
- 然后匹配不带任何修饰的前缀匹配。
- 最后是交给 `/` 通用匹配
- 当有匹配成功时候，停止匹配，按当前匹配规则处理请求



##### 2.4.3、测试



```

location = / {
   echo "规则A";
}
location = /login {
   echo "规则B";
}
location ^~ /static/ {
   echo "规则C";
}
location ^~ /static/files {
    echo "规则X";
}
location ~ \.(gif|jpg|png|js|css)$ {
   echo "规则D";
}
location ~* \.png$ {
   echo "规则E";
}
location /img {
    echo "规则Y";
}
location / {
   echo "规则F";

```





| url                                 | 匹配规则 |                                                              |
| ----------------------------------- | -------- | ------------------------------------------------------------ |
| http://localhost/                   | A        |                                                              |
| http://localhost/login              | B        |                                                              |
| http://localhost/register           | F        |                                                              |
| http://localhost/static/a.html      | C        |                                                              |
| http://localhost/static/files/a.exe | X        | 虽然 规则C 也能匹配到，但因为最大匹配原则，最终选中了 规则X  |
| http://localhost/a.gif              | D        |                                                              |
| http://localhost/b.jpg              | D        | `规则 D` 顺序优先，`规则 E` 不起作用                         |
| http://localhost/static/c.png       | C        |                                                              |
| http://localhost/a.PNG              | E        | 规则 E 不区分大小写。                                        |
| http://localhost/img/a.gif          | D        | 虽然 规则Y 也可以匹配上，但是因为正则匹配优先，而忽略了 规则Y。 |
| http://localhost/img/a.tiff         | Y        |                                                              |







### 2.5、 日志记录



#### 2.5.1、默认日志

 虽然下面的log_format的注释没有打开，但是也是有日志查看的在logs文件夹下，下面的log_format开启是自定义日志支持



#### ![1571994776277](D:\study\HealerJean.github.io\blogImages\1571994776277.png)





#### 2.5.2、打开自定日志支持  



**开启自定义支持之后，我们访问当前的server就不会进入上面的日志文件中了**



```
 log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

```



##### 2.5.2.1、自定义日志的目录和文件



```
 server {
        listen       80;
        server_name  test.nginx.com;

        access_log  D:/nginx/log/access.log  ; //默认是main级别的，我们一般生成设置这个就可以了
      

        root   D:/nginx/;
        index  index.html index.htm;
       
    }
```



```
127.0.0.1 - - [25/Oct/2019:17:14:09 +0800] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36"
127.0.0.1 - - [25/Oct/2019:17:14:12 +0800] "GET /1111111111111 HTTP/1.1" 404 555 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36"

```



##### 2.5.2.2、添加多个自定义级别 



```
server {
        listen       80;
        server_name  test.nginx.com;

        access_log  D:/nginx/log/access.log  main;
        error_log   D:/nginx/log/error.log   warn;

        root   D:/nginx/;
        index  index.html index.htm;
       
    }

```



**分别访问正常的url和错误的404url**



![1571995635850](D:\study\HealerJean.github.io\blogImages\1571995635850.png)

![1571995733276](D:\study\HealerJean.github.io\blogImages\1571995733276.png)





+ access.log 



```
127.0.0.1 - - [25/Oct/2019:17:26:53 +0800] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36" "-"
127.0.0.1 - - [25/Oct/2019:17:28:19 +0800] "GET /1111111111111 HTTP/1.1" 404 555 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36" "-"

```



+ error_log

```
2019/10/25 17:28:19 [error] 7856#9844: *2 CreateFile() "D:/nginx/1111111111111" failed (2: The system cannot find the file specified), client: 127.0.0.1, server: test.nginx.com, request: "GET /1111111111111 HTTP/1.1", host: "test.nginx.com"


```



### 2.6、自定义错误页面

 **注意目录和文件名**

```java
error_page   500 502 503 504  /50x.html; 
proxy_intercept_errors on;
  location = /50x.html {
   root   html;
}
```



![1571996031462](D:\study\HealerJean.github.io\blogImages\1571996031462.png)



```
server {
        listen       80;
        server_name  test.nginx.com;

        access_log  D:/nginx/log/access.log  main;
        error_log   D:/nginx/log/error.log   warn;

        root   D:/nginx/;
        index  index.html index.htm;
       
        error_page   500 502 503 504  /50x.html;
        proxy_intercept_errors on;
        location = /50x.html {
            root   html;
        }
    }
```



### 2.7、alias 别名（注意是目录）



```
location /name/ {
      alias /home/www/huan/;
}


访问http://test.nginx.com/name/a.html实际指定的是/home/www/huan/a.html。
注意：alias指定的目录后面必须要加上"/"，即/home/www/huan/不能改成/home/www/huan


上面的配置也可以改成root目录配置，
location /name/ {
  root /home/www/;
}

```



### 2.8、控制站点访问



```
    # 控制站点访问
         location /NginxDeny {
            deny 127.0.0.1;
            allow 128.163.0.0/24;
            allow 128.163.1.1;
            deny all;

        }

```





## 2、域名配置

### 2.1、




```http

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 100m;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /usr/local/nginxSoft/log/access.log main;
    error_log  /usr/local/nginxSoft/log/error.log warn;


    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;



# 1、负载均衡

  upstream mysite {  
     server 47.104.466.466:8080 ;  
     server 47.104.122.122:8080 backup;   
   }


    server {
        listen       80;
        server_name  server.healerjean.cn;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                   
        location / {
         proxy_pass http://mysite;

        }
    }
       

 # 2、部署前端代码（root.txt可以直接放到目录下面）

     server {
            listen       80;
            server_name  info.healerjean.cn infomsg.healerjean.cn infoquan.healerjean.cn ;

            root        /usr/local/VueWebInfoProject/;
            index       index.html,index.htm;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header REMOTE-HOST $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         
            location / {
                try_files $uri /index.html;
            }
     }

# 3、反向代理互利
       
    server {
        listen       80;
        server_name  xiaodang.m.duoqushop.com;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;


        location / {
          proxy_pass http://proxy.m.fqapps.com;
        }
		}
		
# 4、<!--地址重写-->
		server {
			listen       80 ;
			server_name     duodian.cai.dangqukeji.cn ;
			
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header REMOTE-HOST $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			
			return 301 http://graceway.m.duoqugame.net$request_uri;
			
			 # 最早支持的写法
         # rewrite ^(.*)$ https://$host$1 permanent;               
       
         # 这是nginx最新支持的写法
         # return 301 https://$server_name$request_uri;      
         # return 301 https://$host$request_uri;

}


# 5、反向代理的时候，添加localtion,验证根目录


server {
        listen       80;
        server_name  kequyh.m.dangquyouhui.cn ;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header REMOTE-HOST $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

       location = /root.txt {
            default_type text/html;
            return 200 '32f9262143d2479080df590b3cff55f4';  
        }

        location / {
          proxy_pass http://proxy.m.fqapps.com;
        }
}




# 6、监听别的端口以及配置访问日志

upstream backend {
        server 10.10.10.10:8031 weight=1 max_fails=2 fail_timeout=30s; 
        server 10.10.10.11:8031 weight=1 max_fails=2 fail_timeout=30s; 
}

server {
        listen 9999;
	    #可以不写  server_name  120.131.9.128; 
        access_log  /usr/local/service/log/nginx/scf_manager.log ;

        proxy_set_header Host $host:9999;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP  $remote_addr;


        root /usr/local/service/app/scf/scf-manager-webapp/;

        location ~ ^/api/ {
            proxy_pass http://backend;
        }

        location / {
            try_files $uri $uri/ /index.html;

        }


        location ~ ^/\. {
                deny all;
        }

        error_page   500 502 503 504  /50x.html;
        proxy_intercept_errors on;
        location = /50x.html {
            root   html;
        }
}





# 7、本地配置nginx前后端项目

server {


        listen       80;
        server_name  scf-manage-web;
    
        #后台
        location /api {
         proxy_set_header Host  $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_buffering off;

         proxy_pass http://127.0.0.1:8084/api;
         proxy_set_header Cookie $http_cookie;

        }
      
        # 前端
        location / {
         proxy_set_header Host  $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_buffering off;


         proxy_pass http://127.0.0.1:8086;
         proxy_set_header Cookie $http_cookie;

        }
    }










}

```





#### 添加多个conf文件



```
1、在nginx安装目前下 新建 vhost 文件夹，在文件下创建 *.conf 的文件 ，如 video.haile.com.conf ，命名规则大多以域名的方法来命名文件。

2、编辑 conf 文件，把我们平常放在 nginx.conf 里的 server{...}  段复制过来直接粘贴到 conf 里。

3、在 nginx.conf 的 http{...} 段中加入   include E:/nginx-1.8.1/vhosts/*.conf;

注：这里 include 需要用到全路径，且文件后缀是用 conf

```




<br/><br/><br/>
如果满意，请打赏博主任意金额，感兴趣的在微信转账的时候，添加博主微信哦， 请下方留言吧。可与博主自由讨论哦

|支付包 | 微信|微信公众号|
|:-------:|:-------:|:------:|
|![支付宝](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/alpay.jpg) | ![微信](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|




<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'BDmbQGzyjhzVE43y',
    });
    gitalk.render('gitalk-container');
</script> 

<!-- Gitalk end -->

