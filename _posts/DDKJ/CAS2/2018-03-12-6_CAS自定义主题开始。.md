---
title: 5、CAS自定义主题开始
date: 2018-03-12 17:53:00
tags: 
- CAS
category: 
- CAS
description: CAS自定义主题开始。
---
<!-- image url 
https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages
-->

## 前言

有时候，如果一个产品对于公司来说没有自主性，那是多么可悲，凡是都要依靠他人提供的，如果一旦他人除了问题，那么我们的产品到底还能用吗。简单而言。我们要知道如果修改默认的页面。不要让产品受限。

一般有两种自定义的页面，一种是所有的客户端统一用一种页面（比如：我公司），一种是不同客户端有可能有不同的登录页面（比如: 天猫，淘宝）下面从第一种开始讲解

## 1、主题必备知识

### 1.1、主题登录的流程

![WX20180313-103201@2x](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-103201@2x.png)



### 1.2、静态资源存放位置

主题：说白了也就是页面么，页面当然要用静态资源喽

1、主题配置文件存放在src/main/resources并且命名为[theme_name].properties

2、静态资源(js,css)存放目录为src/main/resources/static

3、html资源存(thymeleaf)放目录为src/main/resources/templates

4、主题页面html存放目录为src/main/resources/templates/[theme]
<br/>

|目录|意义|
|----|----|----|
|services|需要配置自定义登录的网站模版，用这个来匹配客户端的url，根据url生成登录模板|
|static|静态文件目录，用于存放js，css代码的|
|templates|模板代码 casLoginView.html 这个名称不可瞎改|
|properties|网址模板的配置信息，比如css的存放位置信息，将来通过thymeleaf直接读取|


### 1.3、service的配置详解

在2_md中讲到过要实现客户端登录，需要service，但是这个service不仅仅是用来实现登录的，它与主题也有非常重要的关系，没有它，就不会有默认的主题。<br/>


|**参数**|**意义**|
|---|---|
|@class|模版注册的类|
|serviceId|表示哪一个网站使用这个模板，用正则表达式匹配客户端url|
|name|给这个模板命名|
|id|模板的id，建议json文件命名为 name_id 这样好区分，而且官网推荐|
|description|注释，就说明这个模板，或则这个网站|
|evaluationOrder|就是主题的顺序，这么多主题匹配，肯定是这个id越小，越先匹配|
|theme|主题名称，主题名称建议和网站名称一致|
|attributeReleasePolicy|cas参数返回策略，这个大家现在配置不配置，无所谓了,不影响操操作|

### 1.4、cas官方给我们提供的主题在哪里

当我们的程序通过 sudo ./build.sh run ,跑起来之后。会在项目中生成一个文件夹名字叫overlays,所有关于模板以及方法全部都在这里面，通过它来提供给我们展示预览，

也就是说我们的主题修改其实就是覆盖它。<br/>

![WX20180313-105048](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-105048.png)




## 2、客户端自定义主题

### 2.1、service 根据url确定要选用的主题，这里非常重要

注意点：id、evaluationOrder、theme这三个配置不要和别的站点重复了

evaluationOrder 指的是匹配的顺序，你越小，就越先匹配上。也就是说先匹配有自定义主题的，没有自定义主题的也就是默认的，应该放到最后面。默认的主题order数字要大一点。

### 最重要的部分

这是时候想起我们之前在2_md添加客户端的时候，就已经添加了一个service(`HTTPSandIMAPS-10000003.json`)。那个service中虽然没有添加主题theme，但是其实这个里面已经具备主题了，也就是系统默认的apereo。当时这里的evaluationOrder，写了1、也就是说这个要第一个匹配。那么这样的话就代表，即使再创建service添加了其他客户端url的匹配，同时也创建了自定义主题。但是它不会进入自定义主题的。因为匹配规则，是先匹配到去order会先去最小的里面。也就是 opereo。

我测试的项目中有3个客户端，所以我将上面的order随机写了1000.2个客户端使用自定义的主题，第3个客户端使用系统提供的默认的主题。那么我们提供的这个默认的主题，就可以修改下上面所说的那个添加客户端所创建的service了。将这个service order写为1000。顺便将名字。

#### 下面的id和order命名一定要注意。如果有的不能成功则，变成其他的order再试试。个人建议直接以order以10以后开始命名，id也是。

```
//下面theme:apereo可加可不加，因为本来就是默认的
{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps|http)://.*",
  "name" : "HTTPS and IMAPS",
  "id" : 10000013,
  "description" : "This service definition authorizes all application urls that support HTTPS and IMAPS and HTTP protocols.",
  "evaluationOrder" : 1000,
  "attributeReleasePolicy": {
    "@class": "org.apereo.cas.services.ReturnAllAttributeReleasePolicy"
  }
}

```


1、客户端1 casclientone ：8081
```
{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps|http)://casclientone.*",
  "name" : "casclientone",
  "id" : 10000011,
  "description" : "客户端casclientone项目访问过来，跳转到casclientone主题",
  "evaluationOrder" : 11,
  "theme": "casclientone"
}


```
2、客户端2 casclienttwo ：8082


```
{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps|http)://casclienttwo.*",
  "name" : "casclienttwo",
  "id" : 10000012,
  "description" : "客户端casclienttwo项目访问过来，跳转到casclienttwo主题",
  "evaluationOrder" :12,
  "theme": "casclienttwo"
}



```

![WX20180313-140550](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-140550.png)




### 2.2、新建static，自定义主题文件夹,并添加css文件


**1、casclientone.css**

static/themes/casclientone/css/casclientone.css

```
h1 {
    color: #FF40E5;
}
```

**2、casclienttwo.css**

static/themes/casclientone/css/casclienttwo.css

```
h1 {
    color: #2339FF;
}

```

![WX20180313-115415](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-115415.png)



### 2.3、新建主题配置文件，用来给前端页面提供css文件路径，


当然文件路径也可以在模板html中自己写死，这里主要是前端使用了thymeleaf模板，可以使用变量，导入css路径等


1、casclientone.properties

```
casclientone.css.file=/themes/casclientone/css/casclientone.css
casclientone.pageTitle=客户端casclientone主题

```

2、casclienttwo.properties

```
casclienttwo.css.file=/themes/casclienttwo/css/casclienttwo.css
casclienttwo.pageTitle=客户端casclienttwo主题

```

![WX20180313-115721](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-115721.png)



### 2.4、添加模板文件吧。朋友们，名字一定是唯一的 casLoginView.html。

因为相当于是覆盖之前的，所以名字是唯一的


![WX20180313-133207](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-133207.png)


#### 2.4.1、客户端1:casclientone的模板内容,测试完成，我会详解下面中的thymeleaf是怎么用的。客户端2.和1基本一样，只是下面的说明中有点不同

1、导入css文件 ，可以观察到下面使用的thymeleaf方言。和大工项目有点像，里面用的变量`casclientone.css.file`是我们在`casclientone.properties`中配置的，而`casclientone.properties`中它代表着css的地址。其实这个css地址也完全可以写死。一般我们可不就是写死么


2、标题 `<h1 th:text="${#themes.code('casclientone.pageTitle')}"></h1>

` 也是在properties中配置的名字。

```
<link rel="stylesheet" th:href="@{${#themes.code('casclientone.css.file')}}"/>

```

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title th:text="${#themes.code('casclientone.pageTitle')}"></title>
    <link rel="stylesheet" th:href="@{${#themes.code('casclientone.css.file')}}"/>
</head>

<body>
<h1 th:text="${#themes.code('casclientone.pageTitle')}"></h1>
<div>
    <form method="post" th:object="${credential}">
        <div th:if="${#fields.hasErrors('*')}">
            <span th:each="err : ${#fields.errors('*')}" th:utext="${err}"/>
        </div>
        <h2 th:utext="#{screen.welcome.instructions}"></h2>

        <section class="row">
            <label for="username" th:utext="#{screen.welcome.label.netid}"/>
            <div th:unless="${openIdLocalId}">
                <input class="required"
                       id="username"
                       size="25"
                       tabindex="1"
                       type="text"
                       th:disabled="${guaEnabled}"
                       th:field="*{username}"
                       th:accesskey="#{screen.welcome.label.netid.accesskey}"
                       autocomplete="off"/>
            </div>
        </section>

        <section class="row">
            <label for="password" th:utext="#{screen.welcome.label.password}"/>
            <div>
                <input class="required"
                       type="password"
                       id="password"
                       size="25"
                       tabindex="2"
                       th:accesskey="#{screen.welcome.label.password.accesskey}"
                       th:field="*{password}"
                       autocomplete="off"/>
            </div>
        </section>

        <section>
            <input type="hidden" name="execution" th:value="${flowExecutionKey}"/>
            <input type="hidden" name="_eventId" value="submit"/>
            <input type="hidden" name="geolocation"/>
            <input class="btn btn-submit btn-block"
                   name="submit"
                   accesskey="l"
                   th:value="#{screen.welcome.button.login}"
                   tabindex="6"
                   type="submit"/>
        </section>
    </form>
</div>
</body>
</html>


```
### 2.5、启动开始测试，成功

sso-server 8443
sso-client-one 8001
sso-client-two 8002
sso-client-pac4j 8003


#### 2.5.1、访问客户端1 

http://casclientone:8081/clientone

![WX20180313-140701@2x](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-140701@2x.png)


#### 2.5.2、访问客户端2 

http://casclienttwo:8082/clienttwo/

![WX20180313-140841@2x](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-140841@2x.png)



#### 2.5.3、访问客户端3.这个没有配置自定义主题。所以还是默认的

http://casclientpac4j:8083/clientpac4j

![WX20180313-140811@2x](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-140811@2x.png)



## 3、自定义默认的主题<br/>

理解：就是说吧系统提供的默认主题，变成我们自定义的默认的主题，这个时候，我们能够观察到，其实之前的主题名字，默认也是apereo，现在我们还是使用它

<br/>

### 3.1、新建service用来配置默认的主题模板

```
{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^(https|imaps|http)://.*",
  "name" : "Apereo",
  "theme" : "apereo",
  "id" : 10000002,
  "description" : "Apereo foundation service",
  "evaluationOrder" : 2
}
```
![WX20180313-105424](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-105424.png)


### 3.2、新建css样式文件

路径 static/themes/apereo/css下新建文件apereo.css

![WX20180313-105840](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/blogImages/WX20180313-105840.png)


### 3.2、新建主题配置文件，apereo.properties




如果满意，请打赏博主任意金额，感兴趣的请下方留言吧。可与博主自由讨论哦

|支付包 | 微信|微信公众号|
|:-------:|:-------:|:------:|
|![支付宝](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/alpay.jpg) | ![微信](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/tctip/weixin.jpg)|![微信公众号](https://raw.githubusercontent.com/HealerJean123/HealerJean123.github.io/master/assets/img/my/qrcode_for_gh_a23c07a2da9e_258.jpg)|



<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean123.github.io`,
		owner: 'HealerJean123',
		admin: ['HealerJean123'],
		id: 'fYcbohoj7Dm8YA6S',
    });
    gitalk.render('gitalk-container');
</script> 

<!-- Gitalk end -->






