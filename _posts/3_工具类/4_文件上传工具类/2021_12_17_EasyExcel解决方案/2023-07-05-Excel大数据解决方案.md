---
title: Excel大数据解决方案
date: 2023-12-12 00:00:00
tags: 
- Java
category: 
- Java
description: Excel大数据解决方案
---

**前言**     

 Github：[https://github.com/HealerJean](https://github.com/HealerJean)         

 博客：[http://blog.healerjean.com](http://HealerJean.github.io)          



# 一、线程池 `limit` 分页查询

## 1、线程池分页读工具

```java
package com.healerjean.proj.utils.db;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.google.common.collect.Lists;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.Future;
import java.util.function.BiFunction;
import java.util.function.Function;

/**
 * MybatisPlusQueryUtils
 *
 * @author zhangyujin
 * @date 2023/6/25$  12:05$
 */
public final class MybatisBatchUtils {

    /**
     * queryAll
     *
     * @param function     function
     * @param queryWrapper queryWrapper
     * @param pageSize     pageSize
     * @return {@link List<R>}
     */
    public static <Q, R, T> List<Future<List<T>>> queryAll(CompletionService<List<T>> executorService,
                                                           BiFunction<Page<R>, Q, IPage<R>> function,
                                                           Q queryWrapper,
                                                           int pageSize,
                                                           Function<List<R>, List<T>> coverFunction) {
        IPage<R> initPage = function.apply(new Page<>(1, 0), queryWrapper).setSize(pageSize);

        List<Future<List<T>>> result = new ArrayList<>();
        for (int i = 1; i <= initPage.getPages(); i++) {
            int finalI = i;
            Future<List<T>> future = executorService.submit(() -> {
                IPage<R> page = function.apply(new Page<>(finalI, pageSize), queryWrapper);
                return coverFunction.apply(page.getRecords());
            });
            result.add(future);
        }
        return result;
    }


}

```

## 2、`Manager` 层

```java
/**
 * 获取查询条件
 *
 * @param query query
 * @return LambdaQueryWrapper<UserDemo>
 */
@Override
public LambdaQueryWrapper<UserDemo> queryBuilderQueryWrapper(UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    if (!CollectionUtils.isEmpty(query.getSelectFields())) {
        queryWrapper.select(StringUtils.join(query.getSelectFields(), ","));
    }
    if (!CollectionUtils.isEmpty(query.getOrderByList())) {
        query.getOrderByList().forEach(item -> queryWrapper.orderBy(Boolean.TRUE, item.getDirection(), 
                                                                    item.getProperty()));
    }
    return queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .eq(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .eq(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .eq(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .lt(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .gt(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());
}
```

## 3、`Service`

```java
/**
 * queryFutureAll
 *
 * @param completionService completionService
 * @param query             query
 * @return List<Future < List < UserDemoExcel>>>
 */
@Override
public List<Future<List<UserDemoExcel>>> queryFutureAll(CompletionService<List<UserDemoExcel>> completionService, UserDemoQueryBO query) {
    LambdaQueryWrapper<UserDemo> userDemoLambdaQueryWrapper = userDemoManager.queryBuilderQueryWrapper(query);
    return MybatisBatchUtils.queryAll(completionService,
            (p, q) -> userDemoDao.page(p, q),
            userDemoLambdaQueryWrapper,
            1,
            UserConverter.INSTANCE::covertUserDemoPoToExcelList);
}
```



## 4、导出

```java
package com.healerjean.proj.controller;

import com.alibaba.excel.EasyExcel;
import com.alibaba.excel.ExcelWriter;
import com.alibaba.excel.write.metadata.WriteSheet;
import com.alibaba.excel.write.style.column.LongestMatchColumnWidthStyleStrategy;
import com.google.common.collect.Lists;
import com.healerjean.proj.common.data.bo.BaseRes;
import com.healerjean.proj.data.bo.UserDemoQueryBO;
import com.healerjean.proj.data.excel.UserDemoExcel;
import com.healerjean.proj.service.UserDemoService;
import com.healerjean.proj.utils.ThreadPoolUtils;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.CollectionUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.ExecutorCompletionService;
import java.util.concurrent.Future;
import java.util.concurrent.atomic.AtomicLong;

/**
 * ExcelController
 *
 * @author zhangyujin
 * @date 2023/6/26$  18:17$
 */
@RestController
@RequestMapping("hlj/excel")
@Api(tags = "Excel-控制器")
@Slf4j
public class ExcelController {

    /**
     * excel sheet最大行数(算标题)
     */
    public static final Integer EXCEL_SHEET_ROW_MAX_SIZE = 1000001;

    private static final String PATH = "/Users/healerjean/Desktop/data/write/";
    private static final String CURRENT_TIME_MILLIS_NAME = "CURRENT_TIME_MILLIS";
    private static final String WRITE_SIMPLE_EXCEL_RESULT_FILE = PATH + "simpleWrite" + CURRENT_TIME_MILLIS_NAME + ".xlsx";

    /**
     * userDemoService
     */
    @Resource
    private UserDemoService userDemoService;

    @ApiOperation(value = "导出")
    @PostMapping("export")
    @ResponseBody
    public BaseRes<List<UserDemoExcel>> export() {
        String newFileName = WRITE_SIMPLE_EXCEL_RESULT_FILE.replace(CURRENT_TIME_MILLIS_NAME, String.valueOf(System.currentTimeMillis()));

        ExcelWriter excelWriter = EasyExcel.write(newFileName, UserDemoExcel.class).registerWriteHandler(new LongestMatchColumnWidthStyleStrategy()).autoCloseStream(false).build();
        WriteSheet writeSheet = EasyExcel.writerSheet(1, "Sheet1").build();

        AtomicLong count = new AtomicLong();
        CompletionService<List<UserDemoExcel>> completionService = new ExecutorCompletionService(ThreadPoolUtils.DEFAULT_THREAD_POOL_TASK_EXECUTOR);
        List<Future<List<UserDemoExcel>>> futures = userDemoService.queryFutureAll(completionService, new UserDemoQueryBO());
        List<UserDemoExcel> all = Lists.newArrayList();
        for (int i = 0;  i< futures.size() ; i++) {
            try {
                Future<List<UserDemoExcel>> future = completionService.take();
                List<UserDemoExcel> userDemos = future.get();
                if (CollectionUtils.isEmpty(userDemos)) {
                    continue;
                }
                writeSheet.setSheetNo((int) (count.addAndGet(userDemos.size()) /2 + 1));
                writeSheet.setSheetName("Sheet" + writeSheet.getSheetNo());
                excelWriter.write(userDemos, writeSheet);
                all.addAll(future.get());

            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }

        if (excelWriter != null) {
            excelWriter.finish();
        }
        return BaseRes.buildSuccess(all);
    }
}
```



# 二、线程池 `Id` 分段查询

## 1、线程池 `Id` 分段工具

```java
package com.healerjean.proj.utils.db;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.google.common.collect.Lists;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.Future;
import java.util.function.BiFunction;
import java.util.function.Function;

/**
 * MybatisPlusQueryUtils
 *
 * @author zhangyujin
 * @date 2023/6/25$  12:05$
 */
public final class MybatisBatchUtils {



    /**
     * queryAll
     *
     * @param executorService 线程池
     * @param function        分页函数
     * @param query           查询条件
     * @param minMax          minMax 最小Id和最大Id
     * @param coverFunction   coverFunction 对象转化
     */
    public static <Q, R, T> List<Future<List<T>>> queryAll(CompletionService<List<T>> executorService,
                                                           BiFunction<IdQueryBO, Q, List<R>> function,
                                                           Q query,
                                                           IdQueryBO minMax,
                                                           Function<List<R>, List<T>> coverFunction) {
        Long minId = minMax.getMinId();
        Long maxId = minMax.getMaxId();
        Long size = minMax.getSize();
        List<Future<List<T>>> result = new ArrayList<>();
        for (long i = minId; i <= maxId; i = i + size) {
            long endId = Math.min(i + size, maxId);
            boolean maxEqualFlag = endId == maxId;
            IdQueryBO idQueryBO = new IdQueryBO(true, i, maxEqualFlag, endId, size);
            Future<List<T>> future = executorService.submit(() -> {
                List<R> list = function.apply(idQueryBO, query);
                return coverFunction.apply(list);
            });
            result.add(future);
            if (maxEqualFlag) {
                break;
            }
        }
        return result;
    }

}

```



## 2、`Manager` 层

```java

/**
 * 根据查询条件获取最大Id和最小Id
 *
 * @param query query
 * @return ImmutablePair<Long, Long>
 */
@Override
public ImmutablePair<Long, Long> queryMinAndMaxId(UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    queryWrapper.select("min(id) as \"minId\"", "max(id) as \"maxId\"");
    LambdaQueryWrapper<UserDemo> lambdaQueryWrapper = queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .like(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .like(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .like(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .le(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .ge(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());
    Map<String, Object> map = userDemoDao.getMap(lambdaQueryWrapper);
    return ImmutablePair.of(MapUtils.getLong(map, "minId"), MapUtils.getLong(map, "maxId"));
}

/**
 * 根据id区间查询数据
 *
 * @param idQueryBO idQueryBO
 * @return {@link List< UserDemo>}
 */
@Override
public List<UserDemo> queryUserDemoByIdSub(IdQueryBO idQueryBO, UserDemoQueryBO query) {
    QueryWrapper<UserDemo> queryWrapper = new QueryWrapper<>();
    if (!CollectionUtils.isEmpty(query.getSelectFields())) {
        queryWrapper.select(StringUtils.join(query.getSelectFields(), ","));
    }
    LambdaQueryWrapper<UserDemo> lambdaQueryWrapper = queryWrapper.lambda()
            .eq(Objects.nonNull(query.getId()), UserDemo::getId, query.getId())
            .eq(Objects.nonNull(query.getValidFlag()), UserDemo::getValidFlag, query.getValidFlag())
            .eq(StringUtils.isNotBlank(query.getName()), UserDemo::getName, query.getName())
            .eq(StringUtils.isNotBlank(query.getPhone()), UserDemo::getPhone, query.getPhone())
            .eq(StringUtils.isNotBlank(query.getEmail()), UserDemo::getEmail, query.getEmail())
            .like(StringUtils.isNotBlank(query.getLikeName()), UserDemo::getName, query.getLikeName())
            .like(StringUtils.isNotBlank(query.getLikePhone()), UserDemo::getPhone, query.getLikePhone())
            .lt(Objects.nonNull(query.getQueryTime()), UserDemo::getStartTime, query.getQueryTime())
            .gt(Objects.nonNull(query.getQueryTime()), UserDemo::getEndTime, query.getQueryTime());

    if (idQueryBO.getMinEqualFlag()) {
        lambdaQueryWrapper.ge(UserDemo::getId, idQueryBO.getMinId());
    } else {
        lambdaQueryWrapper.gt(UserDemo::getId, idQueryBO.getMinId());
    }

    if (idQueryBO.getMaxEqualFlag()) {
        lambdaQueryWrapper.le(UserDemo::getId, idQueryBO.getMaxId());
    } else {
        lambdaQueryWrapper.lt(UserDemo::getId, idQueryBO.getMaxId());
    }
    return userDemoDao.list(lambdaQueryWrapper);
}
```



## 3、`BO` 对象

### 1）`IdQueryBO`

```java
package com.healerjean.proj.utils.db;

import lombok.Data;
import lombok.experimental.Accessors;

import java.io.Serializable;

/**
 * @author zhangyujin
 * @date 2023/7/5$  15:45$
 */
@Accessors(chain = true)
@Data
public class IdQueryBO implements Serializable {

    /**
     * serialVersionUID
     */
    private static final long serialVersionUID = 3145985803712258405L;

    /**
     * 是否等于最小
     */
    private Boolean minEqualFlag;
    /**
     * 最小Id
     */
    private Long minId;

    /**
     * 是否等于最大
     */
    private Boolean maxEqualFlag;
    /**
     * 最大Id
     */
    private Long maxId;

    /**
     * 每次查询多少个
     */
    private Long size;

    public IdQueryBO(Long minId, Long maxId, Long size) {
        this.minId = minId;
        this.maxId = maxId;
        this.size = size;
    }

    public IdQueryBO(Boolean minEqualFlag, Long minId, Boolean maxEqualFlag, Long maxId, Long size) {
        this.minEqualFlag = minEqualFlag;
        this.minId = minId;
        this.maxEqualFlag = maxEqualFlag;
        this.maxId = maxId;
        this.size = size;
    }
}

```



## 4、`Service`

```java
  /**
   * 根据
   *
   * @param completionService completionService
   * @param query             queryBO
   * @return List<Future < List < UserDemoExcel>>>
   */
  @Override
  public List<Future<List<UserDemoExcel>>> queryUserDemoByIdSub(CompletionService<List<UserDemoExcel>> 
                                                              completionService, UserDemoQueryBO query) {
      ImmutablePair<Long, Long> minAndMaxId = userDemoManager.queryMinAndMaxId(query);
      Long minId = minAndMaxId.getLeft();
      Long maxId = minAndMaxId.getRight();
      IdQueryBO idQueryBO = new IdQueryBO(minId, maxId, 2L);
      return MybatisBatchUtils.queryAll(completionService,
              (p, q) -> userDemoManager.queryUserDemoByIdSub(p, q),
              query,
              idQueryBO,
              UserConverter.INSTANCE::covertUserDemoPoToExcelList);
  }
```



## 5、单测

```java
package com.healerjean.proj.service;

import com.google.common.collect.Lists;
import com.healerjean.proj.base.BaseJunit5SpringTest;
import com.healerjean.proj.data.bo.UserDemoQueryBO;
import com.healerjean.proj.data.excel.UserDemoExcel;
import com.healerjean.proj.utils.JsonUtils;
import com.healerjean.proj.utils.ThreadPoolUtils;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.util.CollectionUtils;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.ExecutorCompletionService;
import java.util.concurrent.Future;

/**
 * UserDemoServiceTest
 *
 * @author zhangyujin
 * @date 2023/7/5$  15:31$
 */
@Slf4j
@DisplayName("UserDemoServiceTest")
public class UserDemoServiceTest extends BaseJunit5SpringTest {

    /**
     * userDemoService
     */
    @Resource
    private UserDemoService userDemoService;


    @DisplayName("testQueryMinAndMaxId")
    @Test
    public void testQueryMinAndMaxId() {
        CompletionService<List<UserDemoExcel>> completionService = new ExecutorCompletionService(ThreadPoolUtils.DEFAULT_THREAD_POOL_TASK_EXECUTOR);

        UserDemoQueryBO queryBO = new UserDemoQueryBO();
        List<Future<List<UserDemoExcel>>> futures = userDemoService.queryUserDemoByIdSub(completionService, 
                                                                                         queryBO);
        List<UserDemoExcel> all = Lists.newArrayList();
        for (int i = 0; i < futures.size(); i++) {
            try {
                Future<List<UserDemoExcel>> future = completionService.take();
                List<UserDemoExcel> userDemos = future.get();
                if (CollectionUtils.isEmpty(userDemos)) {
                    continue;
                }
                all.addAll(future.get());
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }
        log.info("[testQueryMinAndMaxId] res:{}", JsonUtils.toString(all));
    }


}

```





![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'LZ3Kx0FGWl4bB7U9',
    });
    gitalk.render('gitalk-container');
</script> 




<!-- Gitalk end -->



