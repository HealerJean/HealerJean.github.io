---
title: HttpçŸ¥è¯†æ±‡æ€»
date: 2019-02-20 03:33:00
tags: 
- Utils
category: 
- Utils
description: HttpçŸ¥è¯†æ±‡æ€»
---



**å‰è¨€**     

 Githubï¼š[https://github.com/HealerJean](https://github.com/HealerJean)         

 åšå®¢ï¼š[http://blog.healerjean.com](http://HealerJean.github.io)          



# ä¸€ã€`Http` åè®®  

## 1ã€`http` è¿æ¥  

> `HTTP`ï¼ˆ`HyperText` `Transfer` `Protocol`ï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰æ˜¯ Web åº”ç”¨çš„åŸºç¡€é€šä¿¡åè®®ï¼Œä¹Ÿæ˜¯ç§»åŠ¨ç«¯å¸¸ç”¨çš„ç½‘ç»œåè®®ä¹‹ä¸€ã€‚`HTTP` æ˜¯ä¸€ç§**åº”ç”¨å±‚åè®®**ï¼Œå»ºç«‹åœ¨å¯é çš„ **TCP åè®®**ä¹‹ä¸Šã€‚



### 1ï¼‰ çŸ­è¿æ¥ã€é•¿è¿æ¥

- **`HTTP/1.0` é»˜è®¤ä½¿ç”¨çŸ­è¿æ¥**ï¼š
  - æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å•ç‹¬å»ºç«‹ä¸€æ¬¡ `TCP` è¿æ¥ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚åç«‹å³å…³é—­è¿æ¥ã€‚è¿™ç§æ–¹å¼å¼€é”€å¤§ã€æ•ˆç‡ä½ã€‚
- **`HTTP/1.1` é»˜è®¤ä½¿ç”¨é•¿è¿æ¥ï¼ˆæŒä¹…è¿æ¥ï¼‰**ï¼š 
  - åŒä¸€ä¸ª `TCP` è¿æ¥ä¸Šå¯ä»¥è¿ç»­å‘é€å¤šä¸ª `HTTP` è¯·æ±‚å’Œå“åº”ï¼Œæ— éœ€ä¸ºæ¯ä¸ªè¯·æ±‚é‡æ–°å»ºç«‹è¿æ¥ï¼Œæ˜¾è‘—å‡å°‘äº†è¿æ¥å»ºç«‹å¼€é”€ï¼Œæå‡æ€§èƒ½
  - é€šè¿‡ `Connection: keep-alive` å¤´éƒ¨å®ç°ï¼ˆ`HTTP/1.1` ä¸­é»˜è®¤å¯ç”¨ï¼‰ã€‚
  - `HTTP` åè®®æœ¬èº«æ˜¯**æ— çŠ¶æ€**çš„ï¼Œå®ƒå¹¶ä¸è´Ÿè´£ç»´æŠ¤å®¢æˆ·ç«¯çš„â€œåœ¨çº¿çŠ¶æ€â€ã€‚
    - æŸäº›åº”ç”¨åœºæ™¯ï¼ˆå¦‚å³æ—¶é€šè®¯ã€å®æ—¶æ¨é€ï¼‰ä¸­ï¼Œå®¢æˆ·ç«¯ä¼šå®šæœŸå‘æœåŠ¡å™¨å‘é€â€œå¿ƒè·³è¯·æ±‚â€ä»¥è¡¨æ˜è‡ªèº«åœ¨çº¿ï¼Œä½†è¿™å±äº**ä¸šåŠ¡å±‚çš„è®¾è®¡**ï¼Œå¹¶é `HTTP` åè®®çš„å›ºæœ‰æœºåˆ¶ã€‚
    - çœŸæ­£çš„è¿æ¥ä¿æ´»ä¹Ÿå¯ä¾èµ– `TCP` å±‚çš„ `SO_KEEPALIVE` é€‰é¡¹ï¼Œä½†å…¶é»˜è®¤è¶…æ—¶æ—¶é—´è¾ƒé•¿ï¼ˆé€šå¸¸æ•°å°æ—¶ï¼‰ï¼Œä¸é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ã€‚

| åœºæ™¯                             | éœ€è¦â€œå¿ƒè·³â€ | è¯´æ˜                                                         |
| -------------------------------- | ---------- | ------------------------------------------------------------ |
| æ™®é€šç½‘é¡µæµè§ˆï¼ˆ`HTTP/1.1`ï¼‰       | ä¸éœ€è¦     | æµè§ˆå™¨è‡ªåŠ¨å¤ç”¨è¿æ¥ï¼Œç”¨å®Œå¯ä¿æŒç©ºé—²ä¸€æ®µæ—¶é—´ï¼ˆ `Keep-Alive: timeout=5` ï¼‰ |
| `WebSocket` /`MQTT` / è‡ªå®šä¹‰åè®® | éœ€è¦       | åº”ç”¨å±‚éœ€å®ç°å¿ƒè·³åŒ…æ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§                             |
| ç§»åŠ¨ `App` åå°ä¿æ´»              | å¯èƒ½éœ€è¦   | å› ç³»ç»Ÿé™åˆ¶ï¼ˆå¦‚ `Android` çœç”µç­–ç•¥ï¼‰ï¼Œéœ€ä¸»åŠ¨å‘åŒ…é˜²æ­¢è¿æ¥è¢«å›æ”¶ |



### 2ï¼‰é•¿è¿æ¥ã€é•¿è½®è¯¢

- **ä»‹ç»**
  - **é•¿è¿æ¥ï¼ˆå¦‚ `WebSocket`ã€`TCP` `Keep-Alive`ï¼‰**ï¼š
    - è¿æ¥å»ºç«‹åé•¿æœŸä¿æŒï¼Œ**æœåŠ¡ç«¯éœ€ä¸ºæ¯ä¸ªè¿æ¥ç»´æŠ¤çŠ¶æ€ï¼ˆå†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼‰ç™¾ä¸‡çº§è¿æ¥å¯¹æœåŠ¡å™¨å‹åŠ›æå¤§**ã€‚
  - **é•¿è½®è¯¢ï¼ˆ`Long` `Polling`ï¼‰**ï¼šé•¿è½®è¯¢çš„å”¯ä¸€ä¼˜åŠ¿æ˜¯ï¼š**æ— éœ€å¿ƒè·³ã€æ— çŠ¶æ€ã€å…¼å®¹ HTTP ç”Ÿæ€ï¼ˆé…ç½®ä¸­å¿ƒï¼‰**ã€‚
    - **åŸºäº `HTTP` é•¿è¿æ¥**ï¼ˆ`Keep`-`Alive`ï¼‰ï¼Œå®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ `hold` ä½è¿æ¥ç›´åˆ°æœ‰æ•°æ®æˆ–è¶…æ—¶ï¼Œ**å“åº”åè¿æ¥å¯å¤ç”¨æˆ–å…³é—­**ã€‚
    - è™½ç„¶æ¯æ¬¡äº¤äº’æ˜¯â€œè¯·æ±‚-å“åº”â€ï¼Œä½†**å•æ¬¡è¿æ¥å¯¿å‘½è¾ƒé•¿**ï¼ŒæœåŠ¡ç«¯ä»éœ€ä¸ºæ¯ä¸ª `pending` è¯·æ±‚ç»´æŠ¤çŠ¶æ€ï¼ˆå¦‚ `event` `loop` ä¸­çš„ç­‰å¾…é˜Ÿåˆ—ï¼‰ï¼Œ**é«˜å¹¶å‘ä¸‹åŒæ ·æœ‰å‹åŠ›ï¼Œä½†é€šå¸¸ä½äºçœŸé•¿è¿æ¥**ã€‚
- ä¸€å¥è¯æ€»ç»“ï¼š

  - æƒ³â€œç”¨ `HTTP` ä¼ªè£…æˆæ¨é€â€ä¸”å®æ—¶æ€§è¦æ±‚ä¸æ˜¯æç«¯é«˜ï¼Œé€‰**é•¿è½®è¯¢**ï¼›

  - æƒ³â€œçœŸæ­£æŒä¹…ã€åŒå‘ã€ä½å»¶è¿Ÿâ€ï¼Œç›´æ¥ä¸Š**é•¿è¿æ¥**ï¼ˆå¦‚ `WebSocket`ï¼‰ã€‚

#### aã€åŸç†æ¯”è¾ƒ

| ç»´åº¦           | é•¿è½®è¯¢                                                       | é•¿è¿æ¥                                                       |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **æ ¸å¿ƒæœºåˆ¶**   | å®¢æˆ·ç«¯å‘è¯·æ±‚ â†’ æœåŠ¡ç«¯æŒ‚èµ· â†’ æœ‰æ•°æ®/è¶…æ—¶è¿”å› â†’ å®¢æˆ·ç«¯ç«‹å³é‡å‘ | `TCP` è¿æ¥é•¿æœŸä¿æŒï¼Œå¯å¤šæ¬¡åŒå‘é€šä¿¡                           |
| **å®æ—¶æ€§**     | æ¯”çŸ­è½®è¯¢å¥½ï¼Œæ•°æ®ä¸€äº§ç”Ÿå°±èƒ½ç«‹åˆ»è¿”å›ï¼›ä½†ä»æœ‰â€œè¯·æ±‚-ç­‰å¾…â€å‘¨æœŸï¼Œå»¶è¿Ÿåœ¨æ¯«ç§’åˆ°ç§’çº§ã€‚ | æ•°æ®éšæ—¶å¯æ¨é€ï¼Œå»¶è¿Ÿæœ€ä½ï¼Œèƒ½åšåˆ°â€œå³æ—¶åˆ°è¾¾â€ã€‚                 |
| **è¿æ¥å¼€é”€**   | æ¯æ¬¡â€œæŒ‚èµ·â€éƒ½ä¼šå ç”¨æœåŠ¡å™¨çº¿ç¨‹/è¿›ç¨‹èµ„æºï¼›å¹¶å‘é«˜æ—¶å®¹æ˜“æŠŠè¿æ¥æ•°è€—å°½ã€‚ | è¿æ¥å¤ç”¨ï¼Œçœå»äº†åå¤æ¡æ‰‹ã€æŒ¥æ‰‹çš„æ¶ˆè€—ï¼›ä½†ä¿æŒç©ºé—²è¿æ¥æœ¬èº«ä¹Ÿæœ‰å†…å­˜å’Œå¥æŸ„å¼€é”€ã€‚ |
| **å®ç°å¤æ‚åº¦** | **æœåŠ¡å™¨è¦èƒ½â€œ`hold`â€ä½è¯·æ±‚ï¼Œéœ€è¦å¼‚æ­¥`I/O` æˆ–çº¿ç¨‹æ± ï¼Œä»£ç æ¯”çŸ­è½®è¯¢å¤æ‚ã€‚** | **å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½è¦å¤„ç†å¿ƒè·³ã€è¶…æ—¶ã€æ–­çº¿é‡è¿ï¼Œåè®®å±‚æˆ–åº”ç”¨å±‚éƒ½è¦é¢å¤–é€»è¾‘ã€‚** |
| **å†…å­˜å¼€é”€**   | ä¸­ï¼ˆæ¯ä¸ª `pending` è¯·æ±‚éœ€çŠ¶æ€ï¼‰                              | é«˜ï¼ˆæ¯ä¸ªè¿æ¥é•¿æœŸå å†…å­˜ï¼‰                                     |
| **å…¸å‹åœºæ™¯**   | `WebIM`ã€åœ¨çº¿èŠå¤©ã€å®æ—¶é€šçŸ¥â€”â€”æ—¢è¦å®æ—¶åˆä¸æƒ³ç«‹å³ä¸Š `WebSocket` çš„åœºæ™¯ã€‚é…ç½®ä¸­å¿ƒ | `WebSocket`ã€æ•°æ®åº“è¿æ¥æ± ã€éœ€è¦åŒå‘æŒç»­é€šä¿¡çš„åå°æœåŠ¡ã€‚      |



#### bã€æ€§èƒ½çŠ¶æ€

| åœºæ™¯                                    | é•¿è½®è¯¢ vs é•¿è¿æ¥                          |
| --------------------------------------- | ----------------------------------------- |
| **ç†æƒ³æƒ…å†µ**ï¼ˆå®¢æˆ·ç«¯å¶å°”æ‹‰å–ï¼‰          | é•¿è½®è¯¢å‹åŠ› << é•¿è¿æ¥ï¼ˆå¤§éƒ¨åˆ†æ—¶é—´æ— è¿æ¥ï¼‰  |
| **ç°å®æƒ…å†µ**ï¼ˆå®¢æˆ·ç«¯æŒç»­ç›‘å¬ï¼‰          | é•¿è½®è¯¢å‹åŠ› â‰ˆ é•¿è¿æ¥ï¼ˆå§‹ç»ˆæœ‰ pendingï¼‰     |
| **æç«¯æƒ…å†µ**ï¼ˆçŸ­ `timeout` + é«˜é¢‘é‡è¯•ï¼‰ | é•¿è½®è¯¢å‹åŠ› > é•¿è¿æ¥ï¼ˆé¢‘ç¹å»ºè¿ + HTTP å¼€é”€ |



### 2ï¼‰`Http` çŠ¶æ€ç 

> `HTTP` çŠ¶æ€ç æ˜¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„å“åº”çŠ¶æ€ï¼Œç”¨ä»¥å¿«é€Ÿäº†è§£è¯·æ±‚å¤„ç†çš„æƒ…å†µã€‚è¿™äº›çŠ¶æ€ç åˆ†ä¸ºäº”å¤§ç±»ï¼Œæ¯ç±»ä»¥ä¸åŒçš„ç™¾ä½æ•°å­—å¼€å¤´

- **1xxï¼ˆä¿¡æ¯æ€§å“åº”ï¼‰**ï¼šè¡¨ç¤ºè¯·æ±‚å·²è¢«æ¥æ”¶ï¼Œç»§ç»­å¤„ç†ã€‚
- **2xxï¼ˆæˆåŠŸå“åº”ï¼‰**ï¼šè¡¨ç¤ºè¯·æ±‚å·²æˆåŠŸè¢«æœåŠ¡å™¨æ¥æ”¶ã€ç†è§£å’Œå¤„ç†ã€‚
- **3xxï¼ˆé‡å®šå‘ï¼‰**ï¼šä¸ºäº†å®Œæˆè¯·æ±‚ï¼Œéœ€è¦è¿›ä¸€æ­¥æ“ä½œã€‚é€šå¸¸ï¼Œè¿™äº›çŠ¶æ€ç ç”¨äºå°†è¯·æ±‚é‡å®šå‘åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚
- **4xxï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰**ï¼šè¯·æ±‚åŒ…å«è¯­æ³•é”™è¯¯æˆ–æ— æ³•å®Œæˆè¯·æ±‚ã€‚é™¤éè¿›è¡Œä¿®æ”¹ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¸åº”é‡å¤æäº¤è¿™ä¸ªè¯·æ±‚ã€‚
- **5xxï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰**ï¼šæœåŠ¡å™¨åœ¨å°è¯•å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ã€‚è¿™ç±»é”™è¯¯é€šå¸¸ç”±æœåŠ¡å™¨ç«¯çš„é—®é¢˜å¼•èµ·ã€‚



#### aã€1xx çŠ¶æ€ç ï¼ˆå·²æ”¶åˆ°è¯·æ±‚ï¼‰

- è§£é‡Šï¼šä¿¡æ¯å“åº”ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²æ”¶åˆ°è¯·æ±‚ï¼Œä½†æ˜¯éœ€è¦è¯·æ±‚è€…ç»§ç»­æ“ä½œã€‚

- è¯´æ˜ï¼šä¸»è¦æ¶‰åŠçš„çŠ¶æ€ç æœ‰101ã€102å’Œ103ï¼Œä¸»è¦ç”¨äºåè®®åˆ‡æ¢ã€æŒ‡ç¤ºæœåŠ¡å™¨æ­£åœ¨å¤„ç†è¯·æ±‚ä»¥åŠé¢„åŠ è½½æç¤ºç­‰ã€‚

| **çŠ¶æ€ç ** | **ä½œç”¨**                                                     |
| ---------- | ------------------------------------------------------------ |
| 101        | è¿™åªæ˜¯ä¸ªä¸´æ—¶çš„å“åº”çŠ¶æ€ï¼Œå®ƒè¡¨ç¤ºåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„å†…å®¹éƒ½æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯å®¢æˆ·ç«¯éœ€è¦ç»§ç»­å‘é€è¯·æ±‚ï¼Œæ‰èƒ½å®Œæˆæœ¬æ¬¡è¯·æ±‚è¿‡ç¨‹ã€‚ |
| 102        | è¯¥ä»£ç æ˜¯å“åº”å®¢æˆ·ç«¯çš„ Upgrade æ ‡å¤´å‘é€çš„ï¼Œå¹¶ä¸”æŒ‡ç¤ºæœåŠ¡å™¨ä¹Ÿæ­£åœ¨åˆ‡æ¢çš„åè®®ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨wsåè®®æ—¶å¸¸ä¼šè§åˆ°è¿™ä¸ªçŠ¶æ€ç  |
| 103        | é¢„åŠ è½½æç¤ºã€‚æ­¤çŠ¶æ€ä»£ç ä¸»è¦ç”¨äºä¸Link é“¾æ¥å¤´ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å…è®¸ç”¨æˆ·ä»£ç†åœ¨æœåŠ¡å™¨ä»åœ¨å‡†å¤‡å“åº”æ—¶å¼€å§‹é¢„åŠ è½½èµ„æºã€‚ |

#### bã€2xx çŠ¶æ€ç ï¼ˆå“åº”æˆåŠŸï¼‰

- è§£é‡Šï¼šå“åº”æˆåŠŸï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²æ¥æ”¶åˆ°è¯·æ±‚å¹¶æ­£ç¡®å¤„ç†

- è¯´æ˜ï¼šåŒ…æ‹¬200ï¼ˆæˆåŠŸï¼‰ã€201ï¼ˆåˆ›å»ºèµ„æºï¼‰ã€202ï¼ˆæ¥å—ä½†æœªå¤„ç†ï¼‰ã€204ï¼ˆæ— å†…å®¹ï¼‰ã€206ï¼ˆéƒ¨åˆ†å†…å®¹ï¼‰ç­‰ï¼Œä»£è¡¨å„ç§å½¢å¼çš„æˆåŠŸå“åº”

| **çŠ¶æ€ç ** | **ä½œç”¨**                                                     |
| ---------- | ------------------------------------------------------------ |
| 200        | æœåŠ¡å™¨å·²æˆåŠŸå¤„ç†äº†è¯·æ±‚ã€‚é€šå¸¸ï¼Œè¿™è¡¨ç¤ºæœåŠ¡å™¨ä¾›äº†è¯·æ±‚çš„ç½‘é¡µã€‚   |
| 201        | è¯·æ±‚æˆåŠŸå¹¶ä¸”æœåŠ¡å™¨åˆ›å»ºäº†æ–°çš„èµ„æºã€‚                           |
| 202        | æœåŠ¡å™¨å·²æ¥å—è¯·æ±‚ï¼Œä½†å°šæœªå¤„ç†ã€‚                               |
| 203        | æœåŠ¡å™¨å·²æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œä½†è¿”å›çš„ä¿¡æ¯å¯èƒ½æ¥è‡ªå¦ä¸€æ¥æº         |
| 204        | æœåŠ¡å™¨å·²æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œä½†æ²¡æœ‰è¿”å›ä»»ä½•å®ä½“å†…å®¹ï¼Œå¹¶ä¸”æµè§ˆå™¨ä¸éœ€è¦åˆ·æ–°æˆ–è€…é‡å®šå‘ |
| 205        | æœåŠ¡å™¨å·²æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œä½†æ²¡æœ‰è¿”å›ä»»ä½•å®ä½“å†…å®¹ï¼Œä¸è¿‡æµè§ˆå™¨åº”è¯¥ç«‹å³åˆ·æ–°å½“å‰é¡µé¢ |
| 206        | æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†éƒ¨åˆ† `GET`è¯·æ±‚                               |

#### cã€3xx çŠ¶æ€ç ï¼ˆé‡å®šå‘ï¼‰

- è§£é‡Šï¼šé‡å®šå‘ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²æ¥æ”¶åˆ°è¯·æ±‚ï¼Œä½†æ˜¯æ²¡æœ‰ç›´æ¥å¤„ç†ï¼Œè€Œæ˜¯è¿›è¡Œäº†é‡å®šå‘

- è¯´æ˜ï¼šæ¶‰åŠé‡å®šå‘åœºæ™¯ï¼ŒåŒ…æ‹¬301ï¼ˆæ°¸ä¹…ç§»åŠ¨ï¼‰ã€302ï¼ˆä¸´æ—¶é‡å®šå‘ï¼‰ã€304ï¼ˆæœªä¿®æ”¹ï¼Œä½¿ç”¨ç¼“å­˜ï¼‰ç­‰ã€‚

| **çŠ¶æ€ç ** | **ä½œç”¨**                                                     |
| ---------- | ------------------------------------------------------------ |
| 300        | é’ˆå¯¹è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¯æ‰§è¡Œå¤šç§æ“ä½œã€‚æœåŠ¡å™¨å¯æ ¹æ®è¯·æ±‚è€…(user_agent)é€‰æ‹©ä¸€é¡¹æ“ä½œï¼Œæˆ–æä¾›æ“ä½œåˆ—è¡¨ä¾›è¯·æ±‚è€…é€‰æ‹©ã€‚ |
| 301        | è¯·æ±‚çš„ç½‘é¡µå·²æ°¸ä¹…ç§»åŠ¨åˆ°æ–°ä½ç½®ã€‚æœåŠ¡å™¨è¿”å›æ­¤å“åº”å¯¹GETæˆ–HEADè¯·æ±‚çš„å“åº”æ—¶ï¼Œä¼šè‡ªåŠ¨å°†è¯·æ±‚è€…è½¬åˆ°æ–°ä½ç½® |
| 302        | è¯·æ±‚çš„èµ„æºè¢«ä¸´æ—¶é‡å®šå‘åˆ°äº†åˆ«çš„URIã€‚ä½†è¿™ä¸ªé‡å®šå‘åªæ˜¯ä¸´æ—¶çš„ï¼Œä¸‹æ¬¡è¯·æ±‚å½“å‰èµ„æºæ—¶ä»ç„¶åº”è¯¥ä½¿ç”¨å½“å‰çš„åœ°å€ |
| 303        | æœåŠ¡ç«¯å·²ç»æ”¶åˆ°è¯·æ±‚ï¼Œä½†æ˜¯ä¸ä¼šè¿›è¡Œå¤„ç†ã€‚å®¢æˆ·ç«¯éœ€è¦å‘å“åº”ä¸­æºå¸¦çš„æ–°çš„URIå‘é€GETè¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ‰ä¼šè¿›è¡Œå¤„ç† |
| 304        | è¡¨ç¤ºå½“å‰èµ„æºå·²è¢«ä¸‹è½½è¿‡ï¼Œå¹¶ä¸”æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤å®¢æˆ·ç«¯åº”è¯¥ä»ç¼“å­˜ä¸­è·å–è¯¥èµ„æº |
| 305        | å½“å‰èµ„æºéœ€è¦ä½¿ç”¨æŒ‡å®šçš„ä»£ç†æ‰èƒ½è®¿é—®                           |
| 306        | æœ€æ–°çš„è§„èŒƒä¸­ï¼Œ306ä¸å†è¢«ä½¿ç”¨                                  |
| 307        | è¯·æ±‚çš„èµ„æºç°åœ¨ä¸´æ—¶ä»ä¸åŒçš„ URI å“åº”è¯·æ±‚ã€‚ç”±äºè¿™æ ·çš„é‡å®šå‘æ˜¯ä¸´æ—¶çš„ï¼Œå®¢æˆ·ç«¯åº”å½“ç»§ç»­å‘åŸæœ‰åœ°å€å‘é€ä»¥åçš„è¯·æ±‚ã€‚åªæœ‰åœ¨Cache-Controlæˆ–Expiresä¸­è¿›è¡Œäº†æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå“åº”æ‰æ˜¯å¯ç¼“å­˜çš„ |

#### dã€4xx çŠ¶æ€ç ï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰

- è§£é‡Šï¼šå®¢æˆ·ç«¯é”™è¯¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚ä¸­å­˜åœ¨é”™è¯¯ï¼Œæ— æ³•å®Œæˆè¯·æ±‚

- è¯´æ˜ï¼šå¦‚400ï¼ˆé”™è¯¯è¯·æ±‚ï¼‰ã€401ï¼ˆæœªæˆæƒï¼‰ã€403ï¼ˆç¦æ­¢è®¿é—®ï¼‰ã€404ï¼ˆæ‰¾ä¸åˆ°é¡µé¢ï¼‰ã€413ï¼ˆè¯·æ±‚å®ä½“å¤ªå¤§ï¼‰ç­‰ã€‚

| **çŠ¶æ€ç ** | **ä½œç”¨**                                                     |
| ---------- | ------------------------------------------------------------ |
| 400        | è¯·æ±‚æœ‰è¯¯ã€‚å®ƒåŒ…å«ä¸¤ç§æƒ…å†µï¼š1.è¯­ä¹‰æœ‰è¯¯ã€‚æœåŠ¡ç«¯æ— æ³•ç†è§£å½“å‰è¯·æ±‚çš„å«ä¹‰ï¼Œå› æ­¤å®¢æˆ·ç«¯å¿…é¡»å¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹æ‰å¯ä»¥é‡æ–°å‘é€ã€‚2.å‚æ•°æœ‰è¯¯ã€‚å®¢æˆ·ç«¯è¯·æ±‚ä¸­æºå¸¦çš„å‚æ•°ä¸ç¬¦åˆæœåŠ¡ç«¯çš„è¦æ±‚ï¼Œå¦‚æ•°é‡ä¸ä¸€è‡´ï¼Œç±»å‹é”™è¯¯ï¼Œä½“ç§¯è¿‡å¤§ï¼ˆå¦‚ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶å¤§å°è¶…å‡ºäº†æœåŠ¡ç«¯é…ç½®ï¼‰ç­‰ã€‚ |
| 401        | æœªæˆæƒã€‚å³å½“å‰è¯·æ±‚éœ€è¦è¿›è¡Œç”¨æˆ·éªŒè¯                           |
| 402        | è¯¥çŠ¶æ€ç æš‚æœªä½¿ç”¨ï¼Œå°†æ¥å¯èƒ½ç”¨äºæ•°å­—æ”¯ä»˜ç³»ç»Ÿ                   |
| 403        | æœåŠ¡å™¨å·²ç»æ¥å—å¹¶ç†è§£äº†è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æ‰§è¡Œ                     |
| 404        | è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨                                             |
| 405        | è¯·æ±‚æ–¹æ³•ä¸å…è®¸ã€‚æ¯”å¦‚æœåŠ¡ç«¯è®¾ç½®æŸä¸ªèµ„æºåªèƒ½ç”¨POSTæ–¹æ³•è¿›è¡Œè®¿é—®ï¼Œè€Œå®¢æˆ·ç«¯å‘é€çš„æ˜¯ä¸€ä¸ªGETè¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°±ä¼šè¿”å›çŠ¶æ€ç 405 |
| 406        | è¯·æ±‚çš„èµ„æºçš„å†…å®¹ç‰¹æ€§æ— æ³•æ»¡è¶³è¯·æ±‚å¤´ä¸­çš„æ¡ä»¶ï¼Œå› æ­¤æ— æ³•ç”Ÿæˆå“åº”å®ä½“ã€‚æ¯”å¦‚å®¢æˆ·ç«¯è®¾ç½®è¿”å›çš„æ•°æ®ç±»å‹å¿…é¡»æ˜¯JSONï¼Œè€ŒæœåŠ¡ç«¯æ²¡æœ‰é…ç½®è½¬æ¢JSONæ‰€ä¾èµ–çš„åŒ…ï¼Œæˆ–è€…æ‰€è¯·æ±‚çš„èµ„æºæœ¬èº«å°±æ— æ³•è½¬åŒ–ä¸ºJSONï¼Œè¿™æ—¶æœåŠ¡ç«¯å°±æ— æ³•ç”Ÿæˆç¬¦åˆå®¢æˆ·ç«¯è¦æ±‚çš„å“åº”å®ä½“ï¼Œå› æ­¤å°±ä¼šè¿”å›çŠ¶æ€ç 406ã€‚ |
| 407        | éœ€è¦åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šè¿›è¡Œèº«ä»½éªŒè¯ã€‚è¯¥çŠ¶æ€ç ä¸401ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒè¦æ±‚å®¢æˆ·ç«¯å¿…é¡»åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šè¿›è¡Œèº«ä»½éªŒè¯ |
| 408        | è¯·æ±‚è¶…æ—¶ã€‚                                                   |
| 409        | æœåŠ¡å™¨åœ¨å®Œæˆè¯·æ±‚æ—¶å‘ç”Ÿå†²çªã€‚æœåŠ¡å™¨å¿…é¡»åœ¨å“åº”ä¸­åŒ…å«æœ‰å…³å†²çªçš„ä¿¡æ¯ |
| 410        | å¦‚æœè¯·æ±‚çš„èµ„æºå·²æ°¸ä¹…åˆ é™¤ï¼ŒæœåŠ¡å™¨å°±ä¼šè¿”å›æ­¤å“åº”ã€‚             |
| 411        | æœåŠ¡å™¨ä¸æ¥å—ä¸å«æœ‰æ•ˆå†…å®¹é•¿åº¦æ ‡å¤´å­—æ®µçš„è¯·æ±‚ã€‚                 |
| 412        | æœåŠ¡å™¨æœªæ»¡è¶³è¯·æ±‚è€…åœ¨è¯·æ±‚ä¸­è®¾ç½®çš„å…¶ä¸­ä¸€ä¸ªå‰ææ¡ä»¶ã€‚           |
| 413        | æœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œå› ä¸ºè¯·æ±‚å®ä½“è¿‡å¤§ï¼Œè¶…å‡ºæœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›   |
| 414        | è¯·æ±‚çš„URIé€šå¸¸ä¸ºç½‘å€è¿‡é•¿ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†                      |
| 415        | è¯·æ±‚çš„æ ¼å¼ä¸å—è¯·æ±‚é¡µé¢çš„æ”¯æŒ                                 |
| 416        | å¦‚æœé¡µé¢æ— æ³•æä¾›è¯·æ±‚çš„èŒƒå›´ï¼Œåˆ™æœåŠ¡å™¨ä¼šè¿”å›æ­¤çŠ¶æ€ä»£ç          |
| 417        | æœåŠ¡å™¨æœªæ»¡è¶³"æœŸæœ›"è¯·æ±‚æ ‡å¤´å­—æ®µçš„è¦æ±‚                         |



#### eã€5xx çŠ¶æ€ç ï¼ˆæœåŠ¡ç«¯é”™è¯¯ï¼‰

- è§£é‡Šï¼šæœåŠ¡ç«¯é”™è¯¯ï¼Œè¡¨ç¤ºæœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯

- è¯´æ˜ï¼šæœåŠ¡å™¨é—®é¢˜ï¼Œä¸èƒ½å®Œæˆè¯·æ±‚ï¼Œå¦‚500ï¼ˆå†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼‰ã€502ï¼ˆæ— æ•ˆç½‘å…³ï¼‰ã€503ï¼ˆæœåŠ¡ä¸å¯ç”¨ï¼‰ã€504ï¼ˆç½‘å…³è¶…æ—¶ï¼‰ç­‰ã€‚

| **çŠ¶æ€ç ** | **ä½œç”¨**                                                     |
| ---------- | ------------------------------------------------------------ |
| 500        | æœåŠ¡å™¨é‡åˆ°é”™è¯¯ï¼Œæ— æ³•å®Œæˆè¯·æ±‚                                 |
| 501        | æœåŠ¡å™¨ä¸å…·å¤‡å®Œæˆè¯·æ±‚çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨æ— æ³•è¯†åˆ«è¯·æ±‚æ–¹æ³•æ—¶å¯èƒ½ä¼šè¿”å›æ­¤ä»£ç  |
| 502        | æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†ï¼Œä»ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°æ— æ•ˆå“åº”               |
| 503        | æœåŠ¡å™¨ç›®å‰æ— æ³•ä½¿ç”¨ï¼Œç”±äºè¶…è½½æˆ–åœæœºç»´æŠ¤ã€‚é€šå¸¸ï¼Œè¿™åªæ˜¯æš‚æ—¶çŠ¶æ€ |
| 504        | æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†ï¼Œä½†æ˜¯æ²¡æœ‰åŠæ—¶ä»ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚       |
| 505        | æœåŠ¡å™¨ä¸æ”¯æŒè¯·æ±‚ä¸­æ‰€ç”¨çš„HTTPåè®®ç‰ˆæœ¬                         |











## 2ã€æµè§ˆå™¨ä¸­è¾“å…¥ç½‘å€å‘ç”Ÿäº†ä»€ä¹ˆ  

> è‹¥ä½¿ç”¨ `HTTPS`ï¼Œè¿˜ä¼šåœ¨ `TCP` è¿æ¥å»ºç«‹åè¿›è¡Œ **`TLS` ï¼ˆ`Transport Layer Security`ï¼Œä¼ è¾“å±‚å®‰å…¨åè®®ï¼‰æ¡æ‰‹**ï¼Œå®ŒæˆåŠ å¯†é€šé“çš„å»ºç«‹ã€‚

### 1ï¼‰åŸºæœ¬æµç¨‹

1. **`URL` è§£æ**ï¼š æµè§ˆå™¨è§£æ `URL`ï¼Œæå–åè®®ï¼ˆå¦‚ `http`/`https`ï¼‰ã€åŸŸåï¼ˆå¦‚ `www.example.com`ï¼‰ã€ç«¯å£ã€è·¯å¾„ç­‰ä¿¡æ¯ã€‚
2. **`DNS` æŸ¥è¯¢**ï¼š
   - é¦–å…ˆæ£€æŸ¥æœ¬åœ° **`Hosts` æ–‡ä»¶**ï¼›
   - ç„¶åæŸ¥è¯¢æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„ **`DNS` ç¼“å­˜**ï¼›
   - è‹¥æœªå‘½ä¸­ï¼Œåˆ™å‘é…ç½®çš„ **`DNS` æœåŠ¡å™¨**å‘èµ·é€’å½’æŸ¥è¯¢ï¼Œæœ€ç»ˆè·å¾—ç›®æ ‡åŸŸåå¯¹åº”çš„ **`IP` åœ°å€**ã€‚
3. **å»ºç«‹ `TCP` è¿æ¥**ï¼š æµè§ˆå™¨é€šè¿‡è·å¾—çš„ `IP` åœ°å€ï¼Œä¸ `Web` æœåŠ¡å™¨è¿›è¡Œ **`TCP` ä¸‰æ¬¡æ¡æ‰‹**ï¼Œå»ºç«‹å¯é è¿æ¥ã€‚
4. **å‘é€ `HTTP` è¯·æ±‚**ï¼šåœ¨å·²å»ºç«‹çš„ `TCP` è¿æ¥ä¸Šï¼Œæµè§ˆå™¨å‘é€ `HTTP` è¯·æ±‚æŠ¥æ–‡ï¼ˆå¦‚ `GET /index.html HTTP/1.1`ï¼‰ã€‚
5. **æ¥æ”¶ `HTTP` å“åº”**ï¼šæœåŠ¡å™¨å¤„ç†è¯·æ±‚åè¿”å› `HTTP` å“åº”ï¼ˆåŒ…å«çŠ¶æ€ç ã€å“åº”å¤´å’Œ `HTML` å†…å®¹ç­‰ï¼‰ã€‚
6. **æ¸²æŸ“é¡µé¢**ï¼š æµè§ˆå™¨è§£æ `HTML`ã€åŠ è½½ `CSS/JS`ã€æ‰§è¡Œè„šæœ¬ï¼Œå¹¶æœ€ç»ˆå°†é¡µé¢æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚



### 2ï¼‰`VIP` å‚ä¸

```
ç”¨æˆ·æµè§ˆå™¨
     â†“ è¾“å…¥åŸŸåï¼ˆå¦‚ www.example.comï¼‰
DNS æœåŠ¡å™¨
     â†“ è¿”å› VIPï¼ˆå¦‚ 203.0.113.10ï¼‰
VIPï¼ˆè™šæ‹ŸIPï¼‰
     â†“ ç”±è´Ÿè½½å‡è¡¡å™¨æˆ–é«˜å¯ç”¨é›†ç¾¤æŒæœ‰
çœŸå®æœåŠ¡å™¨ï¼ˆServer A / Server B / ...ï¼‰
     â†“ å¤„ç†å®é™…è¯·æ±‚
```

![image-20251112181827201](/Users/zhangyujin1/Desktop/HealerJean/HCode/HealerJean.github.io/blogImages/image-20251112181827201.png)



| ä¼˜åŠ¿         | è¯´æ˜                                     |
| ------------ | ---------------------------------------- |
| **é«˜å¯ç”¨**   | ä¸€å°æœåŠ¡å™¨å®•æœºï¼Œæµé‡è‡ªåŠ¨åˆ‡åˆ°å…¶ä»–æœºå™¨     |
| **å¼¹æ€§æ‰©å±•** | åŠ æœºå™¨åªéœ€åœ¨è´Ÿè½½å‡è¡¡åŠ èŠ‚ç‚¹ï¼Œæ— éœ€æ”¹ `DNS` |
| **ç»´æŠ¤é€æ˜** | å‡çº§/é‡å¯æœåŠ¡å™¨ä¸å½±å“ç”¨æˆ·è®¿é—®            |
| **å®‰å…¨éš”ç¦»** | çœŸå®æœåŠ¡å™¨ `IP` ä¸æš´éœ²ï¼Œå‡å°‘æ”»å‡»é¢       |





## 3ã€`TCP` ä¸‰æ¬¡æ¡æ‰‹  

> `TCP` ä¸‰æ¬¡æ¡æ‰‹ï¼ˆ`Three-way Handshake`ï¼‰ æ˜¯å»ºç«‹å¯é   `TCP` è¿æ¥çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç¡®ä¿é€šä¿¡åŒæ–¹éƒ½èƒ½æ­£å¸¸æ”¶å‘æ•°æ®ã€‚



### 1ï¼‰å…³é”®å­—æ®µè¯´æ˜

- `SYN`ï¼ˆ`Synchronize Sequence Numbers`ï¼‰ï¼šåŒæ­¥åºåˆ—å·ï¼Œç”¨äºå‘èµ·è¿æ¥ã€‚
- `ACK`ï¼ˆ`Acknowledgement`ï¼‰ï¼šç¡®è®¤å·ï¼Œè¡¨ç¤ºæœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå­—èŠ‚åºå·ã€‚
  - **`ACK`ï¼ˆå¤§å†™ï¼‰**ï¼š**æ§åˆ¶æ ‡å¿—ä½**ï¼Œæ˜¯ä¸€ä¸ª 1-bit çš„æ ‡å¿—ã€‚å½“ `ACK` = `1` æ—¶ï¼Œè¡¨ç¤ºæœ¬æŠ¥æ–‡æ®µä¸­çš„ ç¡®è®¤å·ï¼ˆ`ack`ï¼‰å­—æ®µæœ‰æ•ˆã€‚
  - **`ack`ï¼ˆå°å†™ï¼‰**ï¼š**ç¡®è®¤å·å­—æ®µ**ï¼Œæ˜¯ä¸€ä¸ª `32` ä½çš„æ•°å€¼ï¼Œè¡¨ç¤ºâ€œæœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå­—èŠ‚çš„åºå·â€ï¼Œå³å¯¹å¯¹æ–¹å‘é€æ•°æ®çš„ç¡®è®¤
- `seq`ï¼šå½“å‰æŠ¥æ–‡çš„åºåˆ—å·ã€‚
- `ack`ï¼šç¡®è®¤å·ï¼ˆå³å¯¹æ–¹ `seq` + `1`ï¼‰ã€‚



### 2ï¼‰æ¡æ‰‹è¿‡ç¨‹

![image-20251112103629284](/Users/zhangyujin1/Desktop/HealerJean/HCode/HealerJean.github.io/blogImages/image-20251112103629284.png)

åˆå§‹çŠ¶æ€ï¼šå®¢æˆ·ç«¯ & æœåŠ¡å™¨ï¼š`CLOSED`

æœåŠ¡å™¨å‡†å¤‡å°±ç»ªï¼šæœåŠ¡å™¨è°ƒç”¨ `listen()` åè¿›å…¥ï¼š`LISTEN`



**ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰**

- å®¢æˆ·ç«¯å‘é€ï¼š`SYN=1, seq=x`
- å®¢æˆ·ç«¯çŠ¶æ€å˜ä¸ºï¼š`SYN_SENT`
  - `SYN`ï¼šç½®ä¸º 1ï¼Œ è¡¨ç¤ºéœ€è¦å»ºç«‹ `TCP`è¿æ¥     
    `seq`ï¼šåºåˆ—å·ï¼Œæ˜¯ç”±å‘é€ç«¯éšæœºç”Ÿæˆçš„

**ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰**

- æœåŠ¡å™¨å›å¤ï¼š`SYN=1, ACK=1, seq=y, ack=x+1`
- æœåŠ¡å™¨çŠ¶æ€å˜ä¸ºï¼š`SYN_RECEIVED`ï¼ˆå¸¸ç®€å†™ä¸º `SYN_RCVD`ï¼‰



**ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰**

- å®¢æˆ·ç«¯å‘é€ï¼š`ACK=1, seq=x+1, ack=y+1`
- å®¢æˆ·ç«¯çŠ¶æ€å˜ä¸ºï¼š`ESTABLISHED`
- æœåŠ¡å™¨æ”¶åˆ°åä¹Ÿå˜ä¸ºï¼š`ESTABLISHED`



### 3ï¼‰çŠ¶æ€è¯´æ˜

| çŠ¶æ€           | å«ä¹‰                                                         |
| -------------- | ------------------------------------------------------------ |
| `CLOSED`       | åˆå§‹çŠ¶æ€ï¼šå®¢æˆ·ç«¯ & æœåŠ¡å™¨                                    |
| `LISTEN`       | æœåŠ¡å™¨ç­‰å¾…æ¥è‡ªä»»æ„è¿œç¨‹ä¸»æœºçš„è¿æ¥è¯·æ±‚ã€‚                       |
| `SYN_SENT`     | å®¢æˆ·ç«¯å·²å‘é€ `SYN`ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ã€‚                       |
| `SYN_RECEIVED` | æœåŠ¡å™¨å·²æ”¶åˆ° `SYN` å¹¶å‘é€äº† `SYN`+`ACK`ï¼Œç­‰å¾…å®¢æˆ·ç«¯æœ€ç»ˆç¡®è®¤ã€‚ |
| `ESTABLISHED`  | è¿æ¥å·²æˆåŠŸå»ºç«‹ï¼Œå¯è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚                             |



### 4ï¼‰ä¸ºä»€ä¹ˆæ˜¯â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼ŸäºŒæ¬¡æ¡æ‰‹æœ‰ä»€ä¹ˆé—®é¢˜

> **æ ¸å¿ƒç›®çš„ï¼šé˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µçªç„¶ä¼ åˆ°æœåŠ¡ç«¯ï¼Œå¯¼è‡´é”™è¯¯åœ°å»ºç«‹è¿æ¥ï¼Œæµªè´¹æœåŠ¡å™¨èµ„æºã€‚**



#### aã€é—®é¢˜å‡ºç°-ä¸¤æ¬¡æ¡æ‰‹

> **æ— æ³•ç¡®è®¤å®¢æˆ·ç«¯æ˜¯å¦çœŸçš„å¸Œæœ›å»ºç«‹è¿æ¥**ã€‚

1. å®¢æˆ·ç«¯ï¼ˆ`Client`ï¼‰**æ›¾å‘æœåŠ¡å™¨**ï¼ˆ`Server`ï¼‰å‘é€ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼ˆ`SYN `æŠ¥æ–‡ï¼‰ï¼Œä½†è¯¥æŠ¥æ–‡**å¹¶æœªä¸¢å¤±ï¼Œè€Œæ˜¯åœ¨ç½‘ç»œä¸­é•¿æ—¶é—´æ»ç•™**ï¼›
2. æ­¤æ—¶å®¢æˆ·ç«¯æ—©å·²æ”¾å¼ƒè¯¥è¿æ¥ï¼ˆå¯èƒ½å·²æ­£å¸¸å…³é—­ï¼‰ï¼Œä½†æ»ç•™çš„ `SYN` æŠ¥æ–‡**åœ¨è¿æ¥é‡Šæ”¾åå¾ˆä¹…æ‰åˆ°è¾¾æœåŠ¡å™¨**ï¼›
3. æœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ªâ€œè¿‡æœŸâ€çš„ `SYN` åï¼Œè¯¯ä»¥ä¸ºæ˜¯å®¢æˆ·ç«¯å‘èµ·çš„æ–°è¿æ¥è¯·æ±‚ï¼Œäºæ˜¯å›å¤ `SYN+ACK` å¹¶**ç«‹å³è¿›å…¥è¿æ¥å»ºç«‹çŠ¶æ€ï¼ˆ`ESTABLISHED`ï¼‰**ï¼›
4. ç„¶è€Œï¼Œå®¢æˆ·ç«¯å½“å‰**å¹¶æœªå‘èµ·ä»»ä½•è¿æ¥è¯·æ±‚**ï¼Œå› æ­¤ä¼š**å¿½ç•¥æœåŠ¡å™¨å‘æ¥çš„ `SYN+ACK`**ï¼›
5. ç»“æœï¼š**æœåŠ¡å™¨å•æ–¹é¢è®¤ä¸ºè¿æ¥å·²å»ºç«‹**ï¼ŒæŒç»­ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œå¯¼è‡´**å†…å­˜ã€ç«¯å£ç­‰èµ„æºè¢«æ— æ•ˆå ç”¨**ï¼Œä¸¥é‡æ—¶å¯èƒ½å¼•å‘èµ„æºè€—å°½ã€‚



#### bã€é—®é¢˜è§£å†³ï¼šä¸‰æ¬¡æ¡æ‰‹

> **ç¬¬ä¸‰æ¬¡æ¡æ‰‹æœ¬è´¨ä¸Šæ˜¯å¯¹â€œå®¢æˆ·ç«¯å½“å‰æ„æ„¿â€çš„æœ€ç»ˆç¡®è®¤**ï¼Œç¡®ä¿è¿æ¥è¯·æ±‚æ˜¯â€œæ–°é²œä¸”æœ‰æ•ˆâ€çš„ã€‚

- æœåŠ¡å™¨åœ¨æ”¶åˆ° `SYN` åï¼Œä»…è¿›å…¥ `SYN_RECV` çŠ¶æ€ï¼Œ**ä¸ä¼šç«‹å³åˆ†é…å®Œæ•´è¿æ¥èµ„æº**ï¼›
- åªæœ‰å½“å®¢æˆ·ç«¯**ä¸»åŠ¨å›ä¼  `ACK`**ï¼ˆç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼‰åï¼ŒåŒæ–¹æ‰çœŸæ­£è¿›å…¥ `ESTABLISHED` çŠ¶æ€ï¼›
- åœ¨ä¸Šè¿°è¿‡æœŸ `SYN` åœºæ™¯ä¸­ï¼š
  - æœåŠ¡å™¨å› **æ”¶ä¸åˆ°ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ `ACK`**ï¼Œä¼šåœ¨è¶…æ—¶åä¸¢å¼ƒè¯¥åŠè¿æ¥ï¼›
  - **è¿æ¥ä¸ä¼šå»ºç«‹ï¼Œèµ„æºä¸ä¼šæµªè´¹**ã€‚

#### cã€**å››æ¬¡æ¡æ‰‹ï¼Ÿæ²¡å¿…è¦**ï¼š

ç¬¬ä¸‰æ¬¡æ¡æ‰‹å·²è¶³å¤Ÿå®ŒæˆåŒå‘ç¡®è®¤ï¼Œæ›´å¤šæ¡æ‰‹åªä¼šå¢åŠ å»¶è¿Ÿï¼Œæ— å®é™…æ”¶ç›Šã€‚**ä¸‰æ¬¡æ¡æ‰‹æ˜¯å¯é æ€§ä¸æ•ˆç‡ä¹‹é—´çš„æœ€ä½³å¹³è¡¡**ï¼Œæ—¢é¿å…äº†èµ„æºæµªè´¹ï¼Œåˆç¡®ä¿äº†è¿æ¥çš„æ­£ç¡®å»ºç«‹ã€‚

| æ¡æ‰‹æ¬¡æ•° | æ˜¯å¦èƒ½é˜²æ­¢â€œè¿‡æœŸ `SYN`â€æ”»å‡» | æ˜¯å¦å¯é å»ºç«‹åŒå‘è¿æ¥ |
| -------- | -------------------------- | -------------------- |
| ä¸¤æ¬¡     | ä¸èƒ½                       | æœåŠ¡å™¨å•æ–¹é¢å»ºç«‹     |
| ä¸‰æ¬¡     | èƒ½                         | åŒæ–¹å…±åŒç¡®è®¤         |



## 4ã€`SYN` æ”»å‡» 

### 1ï¼‰æ”»å‡»åŸç†

> `SYN` `Flood` æ˜¯ä¸€ç§å…¸å‹çš„ **æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆ`DoS`ï¼‰**ï¼Œåˆ©ç”¨ `TCP` ä¸‰æ¬¡æ¡æ‰‹çš„æœºåˆ¶ç¼ºé™·è¿›è¡Œæ”»å‡»ï¼š
>
> æ³¨æ„ï¼šè¿™ç§æ”»å‡»ä¸ä¾èµ–æ¼æ´ï¼Œè€Œæ˜¯**æ»¥ç”¨åè®®æ­£å¸¸è¡Œä¸º**ï¼Œå±äºèµ„æºè€—å°½å‹æ”»å‡»ã€‚

1. æ”»å‡»è€…ä¼ªé€ å¤§é‡**æº `IP` åœ°å€**ï¼ˆé€šå¸¸æ˜¯ä¸å­˜åœ¨æˆ–ä¸å¯è¾¾çš„åœ°å€ï¼‰ï¼Œå‘ç›®æ ‡æœåŠ¡å™¨å‘é€å¤§é‡ `SYN` è¯·æ±‚ï¼›
2. æœåŠ¡å™¨æ”¶åˆ° `SYN` åï¼Œä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…èµ„æºï¼ˆå¦‚å†…å­˜ã€åŠè¿æ¥é˜Ÿåˆ—æ¡ç›®ï¼‰ï¼Œå¹¶å›å¤ `SYN+ACK`ï¼Œè¿›å…¥  `SYN_RECEIVED`çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„æœ€ç»ˆ `ACK` ç¡®è®¤ï¼›
3. ç”±äºæº `IP` æ˜¯ä¼ªé€ çš„ï¼Œæ”»å‡»è€…ä¸ä¼šï¼ˆä¹Ÿæ— æ³•ï¼‰å‘é€ `ACK`ï¼Œå¯¼è‡´æœåŠ¡å™¨é•¿æ—¶é—´ç»´æŒè¿™äº›â€œåŠå¼€è¿æ¥â€ï¼›
4. æœåŠ¡å™¨åœ¨è¶…æ—¶å‰ä¼šå¤šæ¬¡é‡ä¼  `SYN+ACK`ï¼Œè¿›ä¸€æ­¥æ¶ˆè€—èµ„æºï¼›
5. æœ€ç»ˆï¼Œ**åŠè¿æ¥é˜Ÿåˆ—è¢«å æ»¡**ï¼Œåˆæ³•ç”¨æˆ·çš„è¿æ¥è¯·æ±‚æ— æ³•è¿›å…¥é˜Ÿåˆ—ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚



### 2ï¼‰å±å®³

- **è€—å°½æœåŠ¡å™¨çš„åŠè¿æ¥é˜Ÿåˆ—ï¼ˆ`backlog queue`ï¼‰**ï¼›
- **å ç”¨å†…å­˜å’Œ `CPU` èµ„æº**ï¼ˆç”¨äºç»´æŠ¤è¿æ¥çŠ¶æ€å’Œé‡ä¼ ï¼‰ï¼›
- **é˜»å¡åˆæ³•ç”¨æˆ·çš„æ–°è¿æ¥è¯·æ±‚**ï¼Œé€ æˆæœåŠ¡æ‹’ç»ï¼ˆ`Denial of Service`ï¼‰ï¼›
- åœ¨å¤§è§„æ¨¡æ”»å‡»ä¸‹ï¼Œå¯èƒ½å¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨æˆ–ç½‘ç»œç˜«ç—ªã€‚



### 3ï¼‰å¦‚ä½•ç›‘æµ‹

> å°‘é‡ `SYN_RECV` æ˜¯æ­£å¸¸çš„ï¼ˆå¦‚ç½‘ç»œå»¶è¿Ÿå¯¼è‡´ `ACK` æœªåŠæ—¶åˆ°è¾¾ï¼‰ï¼Œä½†**çŸ­æ—¶é—´å†…æ¿€å¢ + æº IP éšæœº**æ˜¯å…¸å‹æ”»å‡»ç‰¹å¾ã€‚

- ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹å¤„äº  `SYN_RECEIVED` çŠ¶æ€çš„è¿æ¥æ•°é‡æ˜¯å¦å¼‚å¸¸é«˜ï¼š

  ```
  netstat -napt | grep SYN_RECV | wc -l
  ```

- è§‚å¯Ÿè¿™äº›è¿æ¥çš„**æº IP æ˜¯å¦é«˜åº¦éšæœºã€æ— è§„å¾‹**ï¼ˆçœŸå®ç”¨æˆ·é€šå¸¸æ¥è‡ªæœ‰é™ IP æ®µï¼‰ï¼›

- ç›‘æ§ç³»ç»Ÿæ—¥å¿—æˆ–ä½¿ç”¨ `IDS`/`IPS`ï¼ˆå¦‚ `Snort`ã€`Suricata`ï¼‰æ£€æµ‹å¼‚å¸¸æµé‡æ¨¡å¼ã€‚



### 4ï¼‰é˜²å¾¡æªæ–½

| é˜²å¾¡æ–¹æ³•                     | åŸç†è¯´æ˜                                                     |
| ---------------------------- | ------------------------------------------------------------ |
| **`SYN` `Cookies`**          | æœåŠ¡å™¨åœ¨æ”¶åˆ° `SYN` æ—¶ä¸ç«‹å³åˆ†é…èµ„æºï¼Œè€Œæ˜¯é€šè¿‡åŠ å¯†ç®—æ³•ç”Ÿæˆä¸€ä¸ªâ€œ`Cookie`â€ä½œä¸ºåˆå§‹åºåˆ—å·ã€‚åªæœ‰æ”¶åˆ°åˆæ³• `ACK` åï¼Œæ‰é‡å»ºè¿æ¥ä¸Šä¸‹æ–‡ã€‚**æ— éœ€ç»´æŠ¤åŠè¿æ¥é˜Ÿåˆ—**ï¼Œå¯æœ‰æ•ˆæŠµå¾¡ `SYN` `Flood`ã€‚ |
| **ç¼©çŸ­ `SYN_RECV` è¶…æ—¶æ—¶é—´** | å‡å°‘åŠå¼€è¿æ¥çš„ç­‰å¾…æ—¶é—´ï¼ˆå¦‚ä»é»˜è®¤ 60â€“120 ç§’é™è‡³ 10â€“20 ç§’ï¼‰ï¼ŒåŠ å¿«èµ„æºå›æ”¶ã€‚ |
| **å¢å¤§åŠè¿æ¥é˜Ÿåˆ—**           | ä¸´æ—¶ç¼“è§£å°è§„æ¨¡æ”»å‡»ï¼Œä½†æ— æ³•æ ¹æœ¬è§£å†³é—®é¢˜ï¼ˆæ”»å‡»è€…å¯ç»§ç»­å¡«æ»¡ï¼‰ã€‚ |
| **å¯ç”¨é˜²ç«å¢™/`IDS` è§„åˆ™**    | é™åˆ¶å• `IP` çš„ `SYN` é€Ÿç‡ï¼ˆå¦‚ iptables + limit æ¨¡å—ï¼‰ï¼Œæˆ–ç›´æ¥ä¸¢å¼ƒå¯ç–‘æµé‡ã€‚ |
| **ä½¿ç”¨äº‘é˜²æŠ¤/`WAF`**         | å¦‚ `Cloudflare`ã€é˜¿é‡Œäº‘ `DDoS` é«˜é˜²ç­‰ï¼Œå¯åœ¨ç½‘ç»œè¾¹ç¼˜æ¸…æ´—æ¶æ„æµé‡ã€‚ |





## 5ã€`Https`

| é—®é¢˜           | HTTP             | HTTPS             |
| -------------- | ---------------- | ----------------- |
| æ•°æ®æ˜¯å¦åŠ å¯†ï¼Ÿ | æ˜æ–‡             | `TLS` åŠ å¯†        |
| èƒ½å¦é˜²ç¯¡æ”¹ï¼Ÿ   | æ— æ ¡éªŒ           | æ•°å­—ç­¾å + `Hash` |
| èƒ½å¦éªŒèº«ä»½ï¼Ÿ   | ä»»æ„ä¼ªè£…         | `CA` è¯ä¹¦è®¤è¯     |
| æ˜¯å¦æ¨èä½¿ç”¨ï¼Ÿ | ä»…ç”¨äºéæ•æ„Ÿåœºæ™¯ | **å…¨ç«™å¼ºåˆ¶å¯ç”¨**  |



### 1ï¼‰`HTTP` çš„ä¸‰å¤§å®‰å…¨é—®é¢˜

> **`HTTP` = è£¸å¥”åœ¨ç½‘ç»œä¸Šçš„ä¿¡ä½¿ï¼Œè°éƒ½èƒ½å·çœ‹ã€ä¿®æ”¹ã€å†’å……ã€‚**

#### aã€é€šä¿¡ä½¿ç”¨æ˜æ–‡ â†’ å†…å®¹å¯èƒ½è¢«çªƒå¬

- `HTTP` æŠ¥æ–‡ä»¥**æ˜æ–‡å½¢å¼ä¼ è¾“**ï¼Œä»»ä½•ä¸­é—´èŠ‚ç‚¹ï¼ˆå¦‚è·¯ç”±å™¨ã€è¿è¥å•†ã€å…¬å…± Wi-Fiï¼‰éƒ½å¯ç›´æ¥è¯»å–å†…å®¹ã€‚
- æ”»å‡»è€…å¯é€šè¿‡**ç½‘ç»œå—…æ¢**è¿˜åŸç”¨æˆ·è´¦å·ã€å¯†ç ã€é“¶è¡Œå¡ç­‰æ•æ„Ÿä¿¡æ¯ã€‚
- è¿è¥å•†ç”šè‡³å¯è¿›è¡Œ **`HTTP` åŠ«æŒ**ï¼šæ’å…¥å¹¿å‘Šã€å¼ºåˆ¶è·³è½¬ä¸‹è½½é¡µï¼ˆé€šè¿‡ `302` é‡å®šå‘æˆ–ç¯¡æ”¹ HTMLï¼‰ã€‚



#### bã€æ— æ³•éªŒè¯å®Œæ•´æ€§ â†’ æŠ¥æ–‡å¯èƒ½è¢«ç¯¡æ”¹

- `HTTP` æ²¡æœ‰æœºåˆ¶æ ¡éªŒæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ã€‚
- å³ä½¿å†…å®¹æœªè¢«è§£å¯†ï¼Œæ”»å‡»è€…ä»å¯**ç¯¡æ”¹ä¼ è¾“ä¸­çš„æ•°æ®**ï¼ˆå¦‚å°†â€œè½¬è´¦ 100 å…ƒâ€æ”¹ä¸ºâ€œè½¬è´¦ 10000 å…ƒâ€ï¼‰ï¼Œè€Œæ¥æ”¶æ–¹æ— æ³•å¯Ÿè§‰ã€‚



#### cã€æ— æ³•éªŒè¯èº«ä»½ â†’ é€šä¿¡æ–¹å¯èƒ½è¢«ä¼ªè£…

- `HTTP` ä¸éªŒè¯æœåŠ¡å™¨èº«ä»½ï¼Œä»»ä½•äººéƒ½å¯æ­å»ºé’“é±¼ç½‘ç«™ã€‚
- ç”¨æˆ·è®¿é—® `http://bank.com` æ—¶ï¼Œå®é™…å¯èƒ½è¿æ¥åˆ°ä¼ªé€ çš„æœåŠ¡å™¨ï¼Œå¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚



### 2ï¼‰`HTTPS` æ˜¯ä»€ä¹ˆï¼Ÿ

> **`HTTPS` = `HTTP` + `SSL`/`TLS` åŠ å¯†å±‚**
>
> - å®ƒä¸æ˜¯æ–°åè®®ï¼Œè€Œæ˜¯ **åœ¨ `HTTP` ä¸ `TCP` ä¹‹é—´åŠ å…¥äº†ä¸€å±‚å®‰å…¨åè®®ï¼ˆSSL/TLSï¼‰**ã€‚
> - å®é™…ä¸Šï¼Œ**`HTTPS` å°±æ˜¯â€œæŠ«ç€ `SSL`/`TLS` å¤–å£³çš„ HTTPâ€**ã€‚

- **`SSL`ï¼ˆ`Secure Socket Layer` å®‰å…¨å¥—æ¥å±‚)ï¼‰** æ˜¯æ—©æœŸåè®®ï¼Œå·²åºŸå¼ƒã€‚
- **`TLS`ï¼ˆ`**Transport Layer Security`ï¼Œä¼ è¾“å±‚å®‰å…¨åè®®** æ˜¯å…¶ç»§ä»»è€…ï¼Œç°ä»£ `HTTPS` å®é™…ä½¿ç”¨çš„æ˜¯ **TLS 1.2 æˆ– TLS 1.3**ã€‚



### 3ï¼‰`HTTPS` å¦‚ä½•è§£å†³ `HTTP` çš„é—®é¢˜

> `HTTPS` é€šè¿‡ **åŠ å¯† + èº«ä»½è®¤è¯ + å®Œæ•´æ€§æ ¡éªŒ** ä¸‰ä½ä¸€ä½“æœºåˆ¶ï¼Œå…¨é¢ä¿éšœé€šä¿¡å®‰å…¨ã€‚

#### aã€é˜²çªƒå¬ï¼šæ··åˆåŠ å¯†æœºåˆ¶

> **`HTTPS` = éå¯¹ç§°åŠ å¯†ï¼ˆå®‰å…¨æ¡æ‰‹ï¼‰ + å¯¹ç§°åŠ å¯†ï¼ˆé«˜æ•ˆé€šä¿¡ï¼‰**

| åŠ å¯†æ–¹å¼                   | ä¼˜ç‚¹         | ç¼ºç‚¹                             | ä½œç”¨                                                         |
| -------------------------- | ------------ | -------------------------------- | ------------------------------------------------------------ |
| **å¯¹ç§°åŠ å¯†**ï¼ˆå¦‚ `AES`ï¼‰   | åŠ è§£å¯†é€Ÿåº¦å¿« | å¯†é’¥åˆ†å‘å›°éš¾ï¼ˆå¦‚ä½•å®‰å…¨ä¼ å¯†é’¥ï¼Ÿï¼‰ | **å…³é”®ç‚¹**ï¼šéå¯¹ç§°åŠ å¯†**åªç”¨äºå®‰å…¨åœ°ä¼ é€’è¿™ä¸ªå¯¹ç§°å¯†é’¥**ï¼Œ**ä¸ç”¨äºåŠ å¯†å®é™…çš„ `HTTP` æ•°æ®**ï¼ |
| **éå¯¹ç§°åŠ å¯†**ï¼ˆå¦‚ `RSA`ï¼‰ | å®‰å…¨åˆ†å‘å¯†é’¥ | è®¡ç®—å¼€é”€å¤§ï¼Œä¸é€‚åˆå¤§é‡æ•°æ®       | ç”¨äºâ€œå®é™…æ•°æ®ä¼ è¾“                                            |

- **éå¯¹ç§°åŠ å¯†ï¼ˆå¦‚ `RSA`ã€`ECDHE`ï¼‰â€”â€”åªç”¨äºâ€œå¯†é’¥åå•†â€**

  - å®¢æˆ·ç«¯ç”¨æœåŠ¡å™¨çš„**å…¬é’¥**åŠ å¯†ä¸€ä¸ª**éšæœºç”Ÿæˆçš„å¯¹ç§°å¯†é’¥**

  - å®¢æˆ·ç«¯ç”¨**æœåŠ¡å™¨çš„å…¬é’¥**ï¼ˆæ¥è‡ªè¯ä¹¦ï¼‰åŠ å¯†è¿™ä¸ªå¯¹ç§°å¯†é’¥ï¼Œå‘é€ç»™æœåŠ¡å™¨ã€‚

  - æœåŠ¡å™¨ç”¨è‡ªå·±çš„**ç§é’¥**è§£å¯†ï¼Œå¾—åˆ°è¿™ä¸ªå¯¹ç§°å¯†é’¥ã€‚

- **å¯¹ç§°åŠ å¯†**ï¼ˆå¦‚ `AES-128-GCM`ã€`ChaCha20`ï¼‰**--ç”¨äºâ€œå®é™…æ•°æ®ä¼ è¾“**

  - ä¸€æ—¦åŒæ–¹éƒ½æ‹¥æœ‰äº†ç›¸åŒçš„å¯¹ç§°å¯†é’¥ï¼Œåç»­æ‰€æœ‰çš„ `HTTP` è¯·æ±‚/å“åº”æ•°æ®ï¼ˆ`HTML`ã€JSONã€å›¾ç‰‡ç­‰ï¼‰éƒ½ç”¨è¿™ä¸ª**å¯¹ç§°å¯†é’¥åŠ å¯†**ã€‚

  - å¯¹ç§°åŠ å¯†é€Ÿåº¦å¿«ã€å¼€é”€å°ï¼Œé€‚åˆå¤§é‡æ•°æ®ä¼ è¾“ã€‚



#### bã€é˜²ç¯¡æ”¹ï¼šæ•°å­—ç­¾å + å“ˆå¸Œæ ¡éªŒ

- å‘é€æ–¹å¯¹æ¶ˆæ¯è®¡ç®— **`Hash` å€¼ï¼ˆæ‘˜è¦ï¼‰**ï¼›
- ç”¨**ç§é’¥**å¯¹è¯¥æ‘˜è¦åŠ å¯†ï¼Œç”Ÿæˆ **æ•°å­—ç­¾å**ï¼›
- æ¥æ”¶æ–¹ç”¨**å…¬é’¥**è§£å¯†ç­¾åï¼Œå¾—åˆ°æ‘˜è¦ `A`ï¼›
- è‡ªå·±å¯¹æ”¶åˆ°çš„æ¶ˆæ¯å†ç®—ä¸€æ¬¡ `Hash`ï¼Œå¾—åˆ°æ‘˜è¦ Bï¼›
- è‹¥ `A` == `B`ï¼Œåˆ™è¯´æ˜**æ¶ˆæ¯æœªè¢«ç¯¡æ”¹**ã€‚



#### cã€é˜²ä¼ªè£…ï¼šæ•°å­—è¯ä¹¦ï¼ˆç”± `CA` é¢å‘ï¼‰

> å¼•å…¥ **å¯ä¿¡ç¬¬ä¸‰æ–¹ â€”â€” è¯ä¹¦é¢å‘æœºæ„ï¼ˆ`CA`, `Certificate` `Authority`ï¼‰**,æµè§ˆå™¨åœ°å€æ å‡ºç° **ğŸ”’ é”å½¢å›¾æ ‡**ï¼Œå³è¡¨ç¤º `HTTPS` æœ‰æ•ˆä¸”è¯ä¹¦å¯ä¿¡ã€‚

1. æœåŠ¡å™¨å‘ `CA` æäº¤å…¬é’¥ã€åŸŸåç­‰ä¿¡æ¯ï¼›
2. `CA` éªŒè¯èº«ä»½ï¼ˆå¦‚åŸŸåæ‰€æœ‰æƒã€ä¼ä¸šèµ„è´¨ï¼‰ï¼›
3. `CA` ç”¨è‡ªå·±çš„**ç§é’¥**å¯¹æœåŠ¡å™¨ä¿¡æ¯+å…¬é’¥è¿›è¡Œç­¾åï¼Œç”Ÿæˆ **æ•°å­—è¯ä¹¦**ï¼›
4. å®¢æˆ·ç«¯å†…ç½®äº†**å—ä¿¡ä»» `CA` çš„æ ¹è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰**ï¼›
5. æµè§ˆå™¨æ”¶åˆ°æœåŠ¡å™¨è¯ä¹¦åï¼š
   - ç”¨ `CA` å…¬é’¥éªŒè¯è¯ä¹¦ç­¾åï¼›
   - æ£€æŸ¥åŸŸåã€æœ‰æ•ˆæœŸç­‰ï¼›
   - éªŒè¯é€šè¿‡ â†’ ä¿¡ä»»è¯¥æœåŠ¡å™¨å…¬é’¥ã€‚







# äºŒã€`Request`

> `HttpServletRequest` æ˜¯ `Java` `Servlet` `API` ä¸­ç”¨äºå°è£… `HTTP` è¯·æ±‚çš„æ ¸å¿ƒå¯¹è±¡ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„æ¥å£ï¼Œç”¨äºè·å–å®¢æˆ·ç«¯è¯·æ±‚çš„å„ç±»ä¿¡æ¯ã€‚

## 1ã€è·¯å¾„ç›¸å…³

> åœ¨ `Spring Boot `å†…åµŒå®¹å™¨ä¸­ï¼Œé»˜è®¤æ²¡æœ‰ `contextPath`ï¼Œå› æ­¤ `getRequestURI()` â‰ˆ `getServletPath()`ã€‚

| æ–¹æ³•               | è¯´æ˜                                                         | ç¤ºä¾‹ï¼ˆSpring Boot æ— ä¸Šä¸‹æ–‡è·¯å¾„ï¼‰                           |
| ------------------ | ------------------------------------------------------------ | ---------------------------------------------------------- |
| `getRequestURL()`  | å®Œæ•´ `URL`ï¼ˆåè®® + ä¸»æœº + ç«¯å£ + `URI`ï¼‰ï¼Œ**ä¸å«æŸ¥è¯¢å‚æ•°**   | `http://localhost:8081/healerjean/youhui/web/authorize`    |
| `getRequestURI()`  | `URI` éƒ¨åˆ†ï¼ˆä¸å«åè®®ã€ä¸»æœºã€ç«¯å£ã€å‚æ•°ï¼‰                     | `/healerjean/youhui/web/authorize`                         |
| `getContextPath()` | `Web` åº”ç”¨ä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆä¼ ç»Ÿ WAR éƒ¨ç½²æ—¶ä¸ºé¡¹ç›®åï¼‰              | `/news`ï¼ˆä¼ ç»Ÿé¡¹ç›®ï¼‰ï¼›**`Spring Boot` é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸² `""`** |
| `getServletPath()` | `Servlet` æ˜ å°„è·¯å¾„ï¼ˆé€šå¸¸ä¸ `getRequestURI()` åœ¨æ— ä¸Šä¸‹æ–‡è·¯å¾„æ—¶ç›¸åŒï¼‰ | `/healerjean/youhui/web/authorize`                         |

## 2ã€æœåŠ¡å™¨ä¸ç½‘ç»œä¿¡æ¯

- `getServerPort()` å—åå‘ä»£ç†å½±å“ï¼ˆå¦‚ `Nginx` è½¬å‘åˆ° `8080`ï¼Œä½† `Host` æ˜¯ `80`ï¼Œåˆ™ `getServerPort()=80`ï¼‰ï¼›
- `getLocalPort()` æ˜¯ `Tomcat` å®é™…ç»‘å®šçš„ç«¯å£ï¼ˆå¦‚ `8080`ï¼‰ã€‚

| æ–¹æ³•                | è¯´æ˜                                                         | ç¤ºä¾‹                                   |
| ------------------- | ------------------------------------------------------------ | -------------------------------------- |
| `getServerName()`   | æœåŠ¡å™¨ä¸»æœºåï¼ˆæ¥è‡ª `Host` å¤´æˆ–æœ¬åœ°é…ç½®ï¼‰                     | `localhost`ã€`test.healerjean.cn`      |
| `getServerPort()`   | è·å– `Http`ç«¯å£                                              | `8081`ã€`80`                           |
| `getLocalPort()`    | è·å– æœ¬æœº ç«¯å£                                               | `8081`ã€`8086`                         |
| `getHeader("Host")` | åŸå§‹ `Host` è¯·æ±‚å¤´ï¼ˆæ ¼å¼ï¼š`host[:port]`ï¼Œ**`80`/`443` ç«¯å£ä¸æ˜¾ç¤º**ï¼‰ | `localhost:8081`ã€`test.healerjean.cn` |



## 3ã€è¯·æ±‚å…ƒæ•°æ®

| æ–¹æ³•                   | è¯´æ˜                                                         |
| ---------------------- | ------------------------------------------------------------ |
| `getMethod()`          | `HTTP` æ–¹æ³•ï¼ˆ`GET`ã€`POST`ã€`PUT` ç­‰ï¼‰                       |
| `getHeader("Referer")` | ä¸Šä¸€é¡µé¢ `URL`ï¼ˆç”¨äºé˜²ç›—é“¾ã€æ¥æºåˆ†æï¼‰ï¼Œ**ç›´æ¥è®¿é—®æ—¶ä¸º `null`** |
| `getContentType()`     | è¯·æ±‚ä½“çš„ `MIME `ç±»å‹ï¼ˆå¦‚ `application/json`ï¼‰ï¼Œ**`GET` è¯·æ±‚é€šå¸¸ä¸º `null`** |



#### aã€å¸¸è§ `Content-Type` ç±»å‹

- `getParameter()` æ–¹æ³•**ä»…æ”¯æŒ `application/x-www-form-urlencoded` å’Œ `multipart/form-data`ï¼ˆéœ€é¢å¤–è§£æï¼‰**ã€‚

| ç±»å‹                                    | ä½¿ç”¨åœºæ™¯                                  |
| --------------------------------------- | ----------------------------------------- |
| `application/x-www-form-urlencoded`     | æ™®é€šè¡¨å•æäº¤ï¼ˆé»˜è®¤ï¼‰                      |
| `multipart/form-data`                   | æ–‡ä»¶ä¸Šä¼ è¡¨å•ï¼ˆå¿…é¡»è®¾ç½®ï¼‰                  |
| `application/json`                      | `AJAX` å‘é€ `JSON` æ•°æ®                   |
| `text/plain`, `text/html`, `image/*` ç­‰ | é™æ€èµ„æºæˆ– API è¿”å›ç±»å‹ï¼ˆè¾ƒå°‘ç”¨äºè¯·æ±‚ä½“ï¼‰ |



## 4ã€è¯·æ±‚å¤´ï¼ˆ`Headers`ï¼‰

#### aã€è·å–æ‰€æœ‰è¯·æ±‚å¤´

```java
Enumeration<String> headerNames = request.getHeaderNames();
while (headerNames.hasMoreElements()) {
    String name = headerNames.nextElement();
    System.out.println(name + ": " + request.getHeader(name));
}
```



#### bã€`GET vs POST` å…¸å‹è¯·æ±‚å¤´å·®å¼‚

| ç‰¹å¾                    | GET                | POST                              |
| ----------------------- | ------------------ | --------------------------------- |
| æ˜¯å¦å« `Content-Type`   | é€šå¸¸æ—              | å¿…æœ‰ï¼ˆå¦‚ `application/json`ï¼‰     |
| æ˜¯å¦å« `Content-Length` | æ—                  | æœ‰ï¼ˆé™¤é chunkedï¼‰                |
| å‚æ•°ä½ç½®                | URL æŸ¥è¯¢å­—ç¬¦ä¸²     | è¯·æ±‚ä½“                            |
| å…¸å‹ `Header`           | `Accept`, `Cookie` | `Content-Type`, `Origin`, `Token` |



## 5ã€å‚æ•°è·å–

### 1ï¼‰ã€è·å–è¯·æ±‚å‚æ•°

#### aã€`GET` å‚æ•°ï¼š`getQueryString()`

```
// ä»…é€‚ç”¨äº GETï¼Œè¿”å›åŸå§‹æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆæœªè§£ç ï¼‰
request.getQueryString(); // age=1&name=healerjean
```



#### bã€è¡¨å•å‚æ•°ï¼ˆéæ–‡ä»¶ï¼‰ï¼š`getParameter()`

- æ”¯æŒï¼š`application/x-www-form-urlencoded`
-  **ä¸æ”¯æŒ**ï¼š`multipart/form-data`ï¼ˆéœ€ç”¨ `MultipartResolver` æˆ– `Apache` `FileUpload`ï¼‰

```
request.getParameter("name");        // å•å€¼
request.getParameterValues("hobby"); // å¤šå€¼ï¼ˆå¦‚ checkboxï¼‰
request.getParameterMap();           // æ‰€æœ‰å‚æ•° Map<String, String[]>
```



### 2ï¼‰è·å–è¯·æ±‚ä½“ï¼ˆ`Raw` `Body`ï¼‰

å½“éœ€è¦å¤„ç† `JSON`ã€`XML` æˆ–è‡ªå®šä¹‰æ ¼å¼æ—¶ï¼Œéœ€ç›´æ¥è¯»å–è¾“å…¥æµï¼š

```java
// æ–¹å¼1ï¼šå­—èŠ‚æµï¼ˆé€‚åˆäºŒè¿›åˆ¶ã€JSON ç­‰ï¼‰
InputStream inputStream = request.getInputStream();

// æ–¹å¼2ï¼šå­—ç¬¦æµï¼ˆé€‚åˆæ–‡æœ¬ï¼‰
BufferedReader reader = request.getReader();
```



### 3ï¼‰å…³é”®é™åˆ¶ï¼šæµåªèƒ½è¯»ä¸€æ¬¡ï¼

#### aã€é™åˆ¶é€»è¾‘

`getParameter()`ã€`getInputStream()`ã€`getReader()` **ä¸‰è€…äº’æ–¥**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

| åœºæ™¯                                    | è¡Œä¸º                                                         |
| --------------------------------------- | ------------------------------------------------------------ |
| **`application/x-www-form-urlencoded`** | è°ƒç”¨ `getParameter()` ä¼š**æå‰æ¶ˆè´¹è¾“å…¥æµ**ï¼Œåç»­ `getInputStream()` è¿”å›ç©º |
| **`multipart/form-data`**               | `getParameter()` **æ— æ³•è§£æ**ï¼Œå¿…é¡»ç”¨æµæˆ–ä¸“ç”¨è§£æå™¨ï¼ˆå¦‚ `Spring` çš„ `MultipartFile`ï¼‰ |
| **ä»»æ„æƒ…å†µ**                            | `getInputStream()` å’Œ `getReader()` **ä¸èƒ½åŒæ—¶è°ƒç”¨**ï¼Œå¦åˆ™æŠ› `IllegalStateException` |

#### bã€è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜è¯·æ±‚ä½“ï¼ˆå¯é‡å¤è¯»ï¼‰

- æ–¹æ¡ˆï¼šé€šè¿‡ **`HttpServletRequestWrapper`** åŒ…è£…åŸå§‹è¯·æ±‚ï¼Œé¢„å…ˆè¯»å–å¹¶ç¼“å­˜ `body`ï¼š

- é€‚ç”¨åœºæ™¯ï¼šæ—¥å¿—è®°å½•ã€éªŒç­¾ã€é‡å¤è¯»å– `body`ï¼ˆå¦‚ `API` ç½‘å…³ã€å®‰å…¨å®¡è®¡ï¼‰ã€‚



é€šè¿‡ **`HttpServletRequestWrapper`** åŒ…è£…åŸå§‹è¯·æ±‚ï¼Œé¢„å…ˆè¯»å–å¹¶ç¼“å­˜ bodyï¼š

```java
public class CachedBodyHttpServletRequest extends HttpServletRequestWrapper {
    private final byte[] cachedBody;

    public CachedBodyHttpServletRequest(HttpServletRequest request) throws IOException {
        super(request);
        this.cachedBody = StreamUtils.copyToByteArray(request.getInputStream());
    }

    @Override
    public ServletInputStream getInputStream() {
        return new ByteArrayServletInputStream(cachedBody);
    }

    @Override
    public BufferedReader getReader() {
        return new BufferedReader(new InputStreamReader(getInputStream()));
    }
}
```

é…åˆ **Filter** ä½¿ç”¨ï¼š

```java
public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) {
    HttpServletRequest request = (HttpServletRequest) req;
    CachedBodyHttpServletRequest wrappedRequest = new CachedBodyHttpServletRequest(request);
    chain.doFilter(wrappedRequest, res);
}
```



# ä¸‰ã€`Cookie` ä¸ `Session`

## 1ã€`Session` è¯¦è§£

- **`Session` æ˜¯æœåŠ¡ç«¯å¯¹è±¡**ï¼š
  - ç”±æœåŠ¡å™¨åˆ›å»ºå¹¶å­˜å‚¨ï¼ˆå†…å­˜/`Redis`/`DB` ç­‰ï¼‰
  - æ¯ä¸ª `Session` æœ‰å”¯ä¸€ IDï¼ˆ`JSESSIONID`ï¼‰ã€‚
- **`Session` `ID` é€šè¿‡ `Cookie` ä¼ é€’**ï¼š
  - é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨é€šè¿‡ `Set-Cookie: JSESSIONID=xxx` å‘ŠçŸ¥æµè§ˆå™¨ï¼›
  - æµè§ˆå™¨åç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦è¯¥ `Cookie`ã€‚
- **`Cookie` çš„ä½œç”¨åŸŸï¼ˆ`Domain` + `Path`ï¼‰å†³å®šäº†å“ªäº›è¯·æ±‚ä¼šæºå¸¦å®ƒ**ã€‚



### 1ï¼‰`Session` ç”Ÿå‘½å‘¨æœŸ

| è¡Œä¸º                                       | æ˜¯å¦é”€æ¯ `Session`              |
| ------------------------------------------ | ------------------------------- |
| è°ƒç”¨ `session.invalidate()`                | ç«‹å³é”€æ¯                        |
| è¶…è¿‡ `maxInactiveInterval`ï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼‰ | è‡ªåŠ¨é”€æ¯                        |
| å…³é—­æµè§ˆå™¨                                 | **ä¸é”€æ¯**                      |
| æœåŠ¡å™¨é‡å¯ï¼ˆå†…å­˜å­˜å‚¨ï¼‰                     | ä¸¢å¤±ï¼ˆé™¤éæŒä¹…åŒ–åˆ° Redis/Fileï¼‰ |



### 2ï¼‰ `Session` æ•°æ®æ“ä½œ

```java
HttpSession session = request.getSession(); // true: æ— åˆ™åˆ›å»º

// å­˜
session.setAttribute("USER", userDTO);

// å–
UserDTO user = (UserDTO) session.getAttribute("USER");

// éå†
Enumeration<String> names = session.getAttributeNames();
while (names.hasMoreElements()) {
    String key = names.nextElement();
    Object value = session.getAttribute(key);
    log.info("{}: {}", key, value);
}
```



## 2ã€`Cookie` è¯¦è§£

### 1ï¼‰è·å– `Cookie`

> `request.getCookies()` åªè¿”å›**å½“å‰è¯·æ±‚æºå¸¦çš„ `Cookie`**ï¼Œå— Domain/Path/Secure ç­‰å±æ€§é™åˆ¶ã€‚

```java
Cookie[] cookies = request.getCookies();
if (cookies != null) {
    for (Cookie cookie : cookies) {
        System.out.println(cookie.getName() + "=" + cookie.getValue());
    }
}
```

### 2ï¼‰`Cookie` ä¸ `Session` çš„å…³ç³»

| é¡¹ç›®     | Cookie                               | Session                             |
| -------- | ------------------------------------ | ----------------------------------- |
| å­˜å‚¨ä½ç½® | å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰                     | æœåŠ¡ç«¯                              |
| å®‰å…¨æ€§   | ä½ï¼ˆå¯è¢«çªƒå–ï¼‰                       | é«˜ï¼ˆæ•°æ®åœ¨æœåŠ¡ç«¯ï¼‰                  |
| ç”¨é€”     | ä¼ é€’ `Session` `ID`ã€è®°ä½åå¥½ç­‰      | å­˜å‚¨ç”¨æˆ·çŠ¶æ€ã€æƒé™ç­‰æ•æ„Ÿä¿¡æ¯        |
| å…³è”æ–¹å¼ | `JSESSIONID` `Cookie` æŒ‡å‘ `Session` | `Session ID` é€šå¸¸é€šè¿‡ `Cookie` ä¼ é€’ |

####  **aã€åˆ›å»º Session æ—¶è‡ªåŠ¨è®¾ç½® Cookie**

> ä¸éœ€è¦å†™ `response.addCookie(...)`ï¼Œå®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰ä¼šè‡ªåŠ¨å¤„ç†ã€‚

```
HttpSession session = request.getSession(); // æˆ– getSession(true)
```

å¦‚æœè¿™æ˜¯ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆè¿˜æ²¡æœ‰ Sessionï¼‰ï¼ŒæœåŠ¡å™¨ä¼šï¼š

- åˆ›å»ºä¸€ä¸ªæ–°çš„ `HttpSession` å¯¹è±¡
- ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ `Session ID`ï¼ˆå¦‚ `JSESSIONID=abc123xyz`ï¼‰
- **è‡ªåŠ¨é€šè¿‡ `Set-Cookie` å“åº”å¤´å°† `JSESSIONID` å‘é€ç»™æµè§ˆå™¨**



#### bã€**åç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦ `Cookie`**

æµè§ˆå™¨æ”¶åˆ° `Set-Cookie: JSESSIONID=...` åï¼Œä¼šåœ¨**åŒåŸŸä¸‹çš„åç»­è¯·æ±‚**ä¸­è‡ªåŠ¨å¸¦ä¸Šï¼š

```
Cookie: JSESSIONID=abc123xyz
```



#### cã€**æœåŠ¡å™¨è‡ªåŠ¨è¯†åˆ« `Session`**

`Servlet` å®¹å™¨ï¼ˆå¦‚ `Tomcat`ï¼‰ä¼šè‡ªåŠ¨ä»è¯·æ±‚çš„ `Cookie` ä¸­æå– `JSESSIONID`ï¼Œå¹¶æ ¹æ®å®ƒæŸ¥æ‰¾å¯¹åº”çš„ `HttpSession` å¯¹è±¡ã€‚ä½ åœ¨ä»£ç ä¸­ç›´æ¥è°ƒç”¨ï¼š

```
HttpSession session = request.getSession();
UserDTO user = (UserDTO) session.getAttribute("USER");
```









## 2ã€é—®é¢˜

### 1ï¼‰**ä¸åŒç«¯å£ï¼Œ`Session` æ˜¯å¦å…±äº«**

| æ¡ä»¶                  | æµè§ˆå™¨æ˜¯å¦å…±äº« `JSESSIONID` Cookieï¼Ÿ |
| --------------------- | ------------------------------------ |
| åŒåŸŸå + **åŒç«¯å£**   | å…±äº«ï¼ˆåŒä¸€åº”ç”¨ï¼‰                     |
| åŒåŸŸå + **ä¸åŒç«¯å£** | **ä¸å…±äº«**ï¼ˆæµè§ˆå™¨å°†ç«¯å£è§†ä¸ºä¸åŒæº   |



### 2ï¼‰**`HTTP` `Cookie` çš„ä½œç”¨åŸŸè§„åˆ™**

- `Domain=localhost`ï¼ˆæˆ–æœªæŒ‡å®šï¼‰æ—¶ï¼Œ**`Cookie` é»˜è®¤ç»‘å®šåˆ°å®Œæ•´çš„ `host:port` ç»„åˆ**ï¼›
- å³ä½¿åŸŸåç›¸åŒï¼Œ`http://localhost:8080` å’Œ `http://localhost:8081` è¢«è§†ä¸º**ä¸¤ä¸ªç‹¬ç«‹ç«™ç‚¹**ï¼›
- å› æ­¤ï¼Œå®ƒä»¬å„è‡ªè®¾ç½®çš„ `JSESSIONID` **äº’ä¸å½±å“**ï¼Œä¸ä¼šâ€œè¦†ç›–â€ã€‚



### 3ï¼‰å¦‚ä½•å®ç°è·¨ç«¯å£/è·¨åº”ç”¨ `Session` å…±äº«

> è‹¥éœ€å¤šä¸ªåº”ç”¨ï¼ˆå¦‚ `SSO` å®¢æˆ·ç«¯ï¼‰å…±äº«ç™»å½•çŠ¶æ€ï¼Œ**ä¸èƒ½ä¾èµ–é»˜è®¤ Session æœºåˆ¶**ï¼Œè€Œåº”é‡‡ç”¨ï¼š

#### æ–¹æ¡ˆ 1ï¼š**ç»Ÿä¸€ `Session` å­˜å‚¨ + ç›¸åŒ `Cookie` é…ç½®**

- å°† `Session` å­˜å…¥ **`Redis`**ï¼ˆè€Œé `Tomcat` å†…å­˜ï¼‰ï¼›

- æ‰€æœ‰åº”ç”¨é…ç½®ç›¸åŒçš„ï¼šè¿™æ ·ï¼Œ`app1.healerjean.cn:8080` å’Œ `app2.healerjean.cn:8081` å¯å…±äº« `JSESSIONID`ã€‚

  ```java
  // Spring Boot ç¤ºä¾‹
  server.servlet.session.cookie.domain = .healerjean.cn   // æ³¨æ„å‰ç¼€ç‚¹
  server.servlet.session.cookie.path = /
  ```

  

#### æ–¹æ¡ˆ 2ï¼š**`SSO`ï¼ˆå•ç‚¹ç™»å½•ï¼‰æ¶æ„**ï¼ˆæ¨èï¼‰

- ç”¨æˆ·åªåœ¨ **è®¤è¯ä¸­å¿ƒï¼ˆCAS/OAuth2 Serverï¼‰** ç™»å½•ï¼›
- å„ä¸šåŠ¡ç³»ç»Ÿï¼ˆClientï¼‰é€šè¿‡ **Ticket / Token** éªŒè¯èº«ä»½ï¼›
- **å„ Client æœ‰è‡ªå·±çš„ Session**ï¼Œä½†é€šè¿‡ `SSO` åè®®åŒæ­¥ç™»å½•çŠ¶æ€ï¼›
- **ä¸è¦æ±‚ `JSESSIONID` ç›¸åŒ**ï¼Œå› æ­¤ä¸å­˜åœ¨â€œè¦†ç›–â€é—®é¢˜ã€‚



### 4ï¼‰å…³é”®ç»“è®º

| é—®é¢˜                               | æ­£ç¡®è®¤çŸ¥                                                |
| ---------------------------------- | ------------------------------------------------------- |
| åŒåŸŸåä¸åŒç«¯å£æ˜¯å¦å…±äº« `Session`ï¼Ÿ | é»˜è®¤ä¸å…±äº«ï¼ˆæµè§ˆå™¨éš”ç¦» `Cookie`ï¼‰                       |
| å¦‚ä½•å®ç°å¤šåº”ç”¨ç™»å½•çŠ¶æ€åŒæ­¥ï¼Ÿ       | ç”¨ `SSO` æˆ–ç»Ÿä¸€ `Session` å­˜å‚¨ + `Cookie` `Domain` é…ç½® |
| å…³é—­æµè§ˆå™¨ä¼šé”€æ¯ `Session` å—ï¼Ÿ    | ä¸ä¼šï¼ˆé™¤é `Session` `Cookie` æœªæŒä¹…åŒ–ï¼‰                |





# å››ã€è·¨åŸŸè§£å†³

## 1ã€ä»€ä¹ˆæ˜¯è·¨åŸŸï¼Ÿ

### 1ï¼‰åŒæºç­–ç•¥ï¼ˆ`Same-Origin Policy`ï¼‰

> æµè§ˆå™¨å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé™åˆ¶ **ä¸åŒæº** çš„ç½‘é¡µè„šæœ¬è®¿é—®èµ„æºã€‚**åŒæº = åè®® + åŸŸå + ç«¯å£ å®Œå…¨ç›¸åŒ**

| `URL` A                   | `URL B`                  | æ˜¯å¦åŒæº | åŸå›      |
| ------------------------- | ------------------------ | -------- | -------- |
| `http://localhost:8080`   | `http://localhost:9000`  | âŒ        | ç«¯å£ä¸åŒ |
| `https://api.example.com` | `http://api.example.com` | âŒ        | åè®®ä¸åŒ |
| `http://example.com`      | `http://www.example.com` | âŒ        | åŸŸåä¸åŒ |

### 2ï¼‰è·¨åŸŸè¯·æ±‚çš„è¡¨ç°

- æµè§ˆå™¨æ§åˆ¶å°æŠ¥é”™ï¼š

  ```
  Access to XMLHttpRequest at 'http://localhost:8080/api' from origin 'http://localhost:3000' has been blocked by CORS policy.
  ```

- è¯·æ±‚å¯èƒ½å‘å‡ºï¼ˆç®€å•è¯·æ±‚ï¼‰ï¼Œä½†**å“åº”è¢«æµè§ˆå™¨æ‹¦æˆª**ï¼›

- éç®€å•è¯·æ±‚ï¼ˆå¦‚å¸¦è‡ªå®šä¹‰ `Header`ã€`JSON` `body`ï¼‰ä¼šå…ˆå‘ **é¢„æ£€è¯·æ±‚ï¼ˆ`Preflight`,`OPTIONS`ï¼‰**ã€‚



## 2ã€è§£å†³è·¨åŸŸ

| æ–¹æ¡ˆ       | é€‚ç”¨åœºæ™¯       | ä¼˜ç‚¹                                 | ç¼ºç‚¹                                 |
| ---------- | -------------- | ------------------------------------ | ------------------------------------ |
| **æ‹¦æˆªå™¨** | å…¨å±€ç»Ÿä¸€ CORS  | ä¸€æ¬¡é…ç½®ï¼Œå¤„å¤„ç”Ÿæ•ˆï¼›è‡ªåŠ¨å¤„ç† OPTIONS | æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡æ‹¦æˆªå™¨ï¼ˆè½»å¾®æ€§èƒ½å¼€é”€ï¼‰ |
| **å·¥å…·ç±»** | å•æ¥å£ç²¾ç»†æ§åˆ¶ | çµæ´»ï¼Œå¯é€‰æ˜¯å¦å¯ç”¨ CORS              | éœ€åœ¨æ¯ä¸ªæ¥å£æ‰‹åŠ¨è°ƒç”¨                 |



### 1ï¼‰å·¥å…·ç±»

```java
package com.healerjean.proj.utils.http;

/**
 * CorsUtils
 *
 * @author zhangyujin
 * @date 2025/11/12
 */

import java.net.URI;
import java.net.URISyntaxException;
import java.util.List;

public class CorsUtils {


    /**
     * æ ¡éªŒ Origin æ˜¯å¦åœ¨å…è®¸çš„åŸŸåç™½åå•ä¸­
     * - ä»¥ "." å¼€å¤´ï¼šè¡¨ç¤ºåŒ¹é…è¯¥åŸŸååŠæ‰€æœ‰å­åŸŸåï¼ˆå¦‚ ".bail.com" åŒ¹é… bail.com, app.bail.com, x.y.bail.comï¼‰
     * - ä¸ä»¥ "." å¼€å¤´ï¼šä»…ç²¾ç¡®åŒ¹é…è¯¥ä¸»åŸŸåï¼ˆå¦‚ "bail.com" åªåŒ¹é… bail.comï¼Œä¸åŒ¹é… app.bail.comï¼‰
     */
    public static boolean isValidOrigin(String origin, List<String> allowedDomains) {
        if (origin == null || origin.trim().isEmpty()) {
            return false;
        }

        String host;
        try {
            host = new URI(origin).getHost();
        } catch (URISyntaxException e) {
            return false;
        }

        if (host == null || host.isEmpty()) {
            return false;
        }

        host = host.toLowerCase();

        for (String pattern : allowedDomains) {
            if (pattern == null || pattern.trim().isEmpty()) {
                continue;
            }
            pattern = pattern.trim().toLowerCase();

            if (pattern.startsWith(".")) {
                // æ¨¡å¼æ˜¯ .example.com â†’ åŒ¹é… example.com åŠ *.example.com
                String domain = pattern.substring(1);
                if (domain.isEmpty()) {
                    continue;
                }

                // åŒ¹é…è§„åˆ™ï¼š
                // 1. host == domain ï¼ˆä¸»åŸŸï¼‰
                // 2. host ä»¥ ".domain" ç»“å°¾ï¼ˆå­åŸŸï¼‰
                if (host.equals(domain) || host.endsWith("." + domain)) {
                    return true;
                }
            } else {
                // æ¨¡å¼æ˜¯ example.com â†’ ä»…ç²¾ç¡®åŒ¹é…
                if (host.equals(pattern)) {
                    return true;
                }
            }
        }

        return false;
    }
}
```



| ç™½åå•é…ç½®         | Origin                 | æ˜¯å¦é€šè¿‡ | è¯´æ˜               |
| ------------------ | ---------------------- | -------- | ------------------ |
| `.bail.com`        | `https://bail.com`     | âœ…        | ä¸»åŸŸåŒ¹é…           |
| `.bail.com`        | `https://app.bail.com` | âœ…        | å­åŸŸåŒ¹é…           |
| `.bail.com`        | `https://x.y.bail.com` | âœ…        | å¤šçº§å­åŸŸ           |
| `.bail.com`        | `https://evilbail.com` | âŒ        | ä¸åŒ¹é…ï¼ˆä¸æ˜¯å­åŸŸï¼‰ |
| `.bail.com`        | `https://bail.com.cn`  | âŒ        | ä¸åŒ¹é…             |
| `bail.com`ï¼ˆæ— ç‚¹ï¼‰ | `https://bail.com`     | âœ…        | ç²¾ç¡®åŒ¹é…           |
| `bail.com`ï¼ˆæ— ç‚¹ï¼‰ | `https://app.bail.com` | âŒ        | ä¸åŒ¹é…å­åŸŸ         |

- **ç»Ÿä¸€ä½¿ç”¨å¸¦ç‚¹å†™æ³•**ï¼ˆæ¨èï¼‰ï¼šå¦‚æœä½ æƒ³æ”¯æŒå­åŸŸåï¼Œ**å…¨éƒ¨å†™æˆ `".xxx.com"`**ï¼Œè¯­ä¹‰æ¸…æ™°ï¼Œé¿å…æ··æ·†ã€‚
- **ä¸è¦æ··ç”¨æ•æ„ŸåŸŸå**ï¼š é¿å…åƒ `".com"` è¿™ç§è¿‡äºå®½æ³›çš„é…ç½®ï¼Œä¼šå¸¦æ¥å®‰å…¨é£é™©ã€‚
- **é…åˆ `HTTPS` ä½¿ç”¨**ï¼š åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®åªå…è®¸ `HTTPS` çš„ `Origin`ï¼ˆå¯åœ¨ `isValidOrigin` ä¸­åŠ åè®®åˆ¤æ–­ï¼‰ï¼š





### 2ï¼‰`Spring` æ‹¦æˆªå™¨è§£å†³

- å…¨å±€ç”Ÿæ•ˆï¼Œæ— éœ€æ¯ä¸ªæ¥å£å¤„ç†
- è‡ªåŠ¨å¤„ç† `OPTIONS` é¢„æ£€
- ä»…å¯¹ç™½åå•åŸŸåæ”¾è¡Œï¼Œå®‰å…¨å¯é 

```java
// src/main/java/com/yourpackage/interceptor/CorsInterceptor.java
package com.yourpackage.interceptor;

import com.yourpackage.util.CorsUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Component
public class CorsInterceptor implements HandlerInterceptor {

   // å…è®¸çš„ä¸»åŸŸåï¼ˆæ”¯æŒä»»æ„å­åŸŸåï¼‰
    private static final List<String> ALLOWED_DOMAINS = Arrays.asList(
        "a.com",
        "b.com"
        // å¯æŒ‰éœ€æ·»åŠ ï¼Œå¦‚ "example.org"
    );
  
  
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws IOException {
        String origin = request.getHeader("Origin");
        String method = request.getMethod();

        // å¤„ç†é¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰
        if ("OPTIONS".equalsIgnoreCase(method)) {
            if (origin != null && CorsUtils.isValidOrigin(origin, ALLOWED_DOMAINS)) {
                setCorsHeaders(response, origin);
            }
            response.setStatus(HttpServletResponse.SC_OK);
            return false; // ç»ˆæ­¢åç»­å¤„ç†
        }

        // å¤„ç†å®é™…è¯·æ±‚
        if (origin != null && CorsUtils.isValidOrigin(origin, ALLOWED_DOMAINS)) {
            setCorsHeaders(response, origin);
        }

        return true; // ç»§ç»­æ‰§è¡Œ Controller
    }

    private void setCorsHeaders(HttpServletResponse response, String origin) {
        response.setHeader("Access-Control-Allow-Origin", origin);
        response.setHeader("Access-Control-Allow-Credentials", "true");
        response.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
        response.setHeader("Access-Control-Allow-Headers",
            "Content-Type, Authorization, X-Requested-With, Accept, Origin");
        response.setHeader("Access-Control-Max-Age", "3600");
    }
}
```

```java
import com.yourpackage.interceptor.CorsInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private CorsInterceptor corsInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(corsInterceptor)
                .addPathPatterns("/**"); // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
    }
}
```



### 3ï¼‰å•ä¸ªæ–¹æ³•ä¸­æ‰‹åŠ¨å¤„ç† `CORS`

```java
// src/main/java/com/yourpackage/util/CorsHelper.java
package com.yourpackage.util;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class CorsHelper {

     // å…è®¸çš„ä¸»åŸŸåï¼ˆæ”¯æŒä»»æ„å­åŸŸåï¼‰
    private static final List<String> ALLOWED_DOMAINS = Arrays.asList(
        "a.com",
        "b.com"
        // å¯æŒ‰éœ€æ·»åŠ ï¼Œå¦‚ "example.org"
    );
  
    /**
     * å¤„ç† CORS è¯·æ±‚
     *
     * @return true è¡¨ç¤ºæ˜¯ OPTIONS è¯·æ±‚ä¸”å·²å¤„ç†å®Œæ¯•ï¼Œè°ƒç”¨æ–¹åº”ç›´æ¥è¿”å›ï¼›
     *         false è¡¨ç¤ºæ˜¯é OPTIONS è¯·æ±‚ï¼Œå¯ç»§ç»­ä¸šåŠ¡é€»è¾‘ã€‚
     */
    public static boolean handleCors(HttpServletRequest request, HttpServletResponse response) throws IOException {
        String origin = request.getHeader("Origin");
        if (origin == null || !CorsUtils.isValidOrigin(origin, ALLOWED_DOMAINS)) {
            // éæ³• Origin ä¸è®¾ç½® CORS å¤´ï¼ˆåŒæºè¯·æ±‚ä¸å—å½±å“ï¼‰
            return !"OPTIONS".equalsIgnoreCase(request.getMethod());
        }

        // è®¾ç½® CORS å¤´
        response.setHeader("Access-Control-Allow-Origin", origin);
        response.setHeader("Access-Control-Allow-Credentials", "true");
        response.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
        response.setHeader("Access-Control-Allow-Headers",
            "Content-Type, Authorization, X-Requested-With, Accept, Origin");
        response.setHeader("Access-Control-Max-Age", "3600");

        // å¦‚æœæ˜¯ OPTIONSï¼Œç›´æ¥è¿”å›
        if ("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
            return true;
        }

        return false; // ç»§ç»­ä¸šåŠ¡
    }
}
```



## 3ã€é—®é¢˜

### 1ï¼‰`OPTIONS` è¯·æ±‚

#### aã€ä»€ä¹ˆæ—¶å€™æµè§ˆå™¨ä¼šå‘ `OPTION`S è¯·æ±‚

> å½“è¯·æ±‚æ»¡è¶³ **â€œéç®€å•è¯·æ±‚â€** æ¡ä»¶æ—¶ï¼Œæµè§ˆå™¨ä¼š**è‡ªåŠ¨å…ˆå‘ä¸€ä¸ª OPTIONS é¢„æ£€è¯·æ±‚ï¼ˆPreflight Requestï¼‰**ï¼Œä¾‹å¦‚ï¼š

 **ç°ä»£å‰ç«¯ï¼ˆ`Axios`ã€`Fetch`ï¼‰å‡ ä¹éƒ½ä¼šè§¦å‘ `OPTIONS`**ï¼Œå› ä¸ºï¼š

- é»˜è®¤å‘ `JSON`ï¼š`Content-Type: application/json`
- å¸¦è®¤è¯å¤´ï¼š`Authorization: Bearer xxx`

| æƒ…å†µ                                                         | æ˜¯å¦è§¦å‘ OPTIONS |
| ------------------------------------------------------------ | ---------------- |
| `GET` / `POST` + `Content-Type: application/x-www-form-urlencoded` | âŒ ä¸è§¦å‘         |
| `POST` + `Content-Type: application/json`                    | âœ… è§¦å‘           |
| ä»»æ„è¯·æ±‚ + è‡ªå®šä¹‰ Headerï¼ˆå¦‚ `Authorization`, `X-Token`ï¼‰    | âœ… è§¦å‘           |
| ä½¿ç”¨ `PUT` / `DELETE` ç­‰æ–¹æ³•                                 | âœ… è§¦å‘           |



#### bã€å¦‚æœä¸å¤„ç† `OPTIONS`ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

å¦‚æœä½ çš„åç«¯ **æ²¡æœ‰è¿”å› 200 + æ­£ç¡® CORS å¤´** â†’ æµè§ˆå™¨ç›´æ¥ **æ‹¦æˆªåç»­ POST è¯·æ±‚**

- **æ¥å£è°ƒç”¨å¤±è´¥**
- **é”™è¯¯ä¿¡æ¯è¯¯å¯¼æ€§å¼º**ï¼ˆçœ‹èµ·æ¥åƒâ€œæ²¡é… CORSâ€ï¼Œå…¶å®æ˜¯â€œæ²¡å¤„ç† OPTIONSâ€ï¼‰
- **å¼€å‘ç¯å¢ƒå¯èƒ½â€œå¶ç„¶èƒ½ç”¨â€**ï¼ˆæ¯”å¦‚åªæµ‹äº† GETï¼‰ï¼Œä½†ä¸Šçº¿å POST å…¨æŒ‚



#### cã€ä¸ºä»€ä¹ˆâ€œå†å²ä»£ç æ²¡åŠ ä¹Ÿèƒ½è·‘â€ï¼Ÿ

> **ä¸å¤„ç† `OPTIONS` æ˜¯â€œä¾¥å¹¸æˆåŠŸâ€ï¼Œä¸æ˜¯â€œæ­£ç¡®å®ç°â€**

| åŸå›                      | è¯´æ˜                                                         |
| ------------------------ | ------------------------------------------------------------ |
| **åªæµ‹è¯•äº†ç®€å•è¯·æ±‚**     | æ¯”å¦‚çº¯ `GET`ã€æ— è‡ªå®šä¹‰ `Header`ï¼Œä¸ä¼šè§¦å‘ `OPTIONS`          |
| **å‰ç«¯ç”¨äº†ä»£ç†**         | å¼€å‘æ—¶é€šè¿‡ `webpack` `devServer` ä»£ç†ï¼Œç»•è¿‡äº† `CORS`         |
| **åç«¯æ¡†æ¶è‡ªåŠ¨å¤„ç†äº†**   | `Spring Boot` é»˜è®¤å¯¹æœªæ˜ å°„çš„ `OPTIONS` è¿”å› 405ï¼Œä½†æŸäº›æ—§ç‰ˆæœ¬æˆ–é…ç½®å¯èƒ½â€œå·§åˆé€šè¿‡â€ï¼ˆä¸å¯é ï¼‰ |
| **æµè§ˆå™¨ç¼“å­˜äº†é¢„æ£€ç»“æœ** | ç¬¬ä¸€æ¬¡å¤±è´¥åï¼ŒçŸ­æ—¶é—´å†…ä¸å†å‘ `OPTIONS`ï¼Œé€ æˆâ€œèƒ½ç”¨â€çš„å‡è±¡     |



### 2ï¼‰`request.getHeader("Origin")`

| `Origin` å€¼              | ç±»å‹       | æ¥æº                    | æ˜¯å¦åº”å¤„ç† CORS          |
| ------------------------ | ---------- | ----------------------- | ------------------------ |
| `null`                   | `null`     | åŒæºè¯·æ±‚ã€Postmanã€curl | ä¸éœ€è¦                   |
| `"null"`ï¼ˆå­—ç¬¦ä¸²ï¼‰       | `"null"`   | `file://` æœ¬åœ°é¡µé¢      | **ç¦æ­¢å“åº”**ï¼ˆå®‰å…¨é£é™©ï¼‰ |
| `"https://app.bail.com"` | åˆæ³• `URL` | æ­£å¸¸è·¨åŸŸé¡µé¢            | ç™½åå•æ ¡éªŒåå“åº”         |



#### aã€ä»€ä¹ˆæ—¶å€™ `Origin` ä¸º `null`ï¼Ÿ

- **åŒæºè¯·æ±‚ï¼ˆ`Same-Origin`ï¼‰**

  - å½“å‰ç«¯é¡µé¢å’Œåç«¯ API **åŒåè®® + åŒåŸŸå + åŒç«¯å£** æ—¶ï¼Œæµè§ˆå™¨ **ä¸ä¼šå‘é€ `Origin` è¯·æ±‚å¤´**ã€‚

  - æ­¤æ—¶ `request.getHeader("Origin")` è¿”å› **`null`**ï¼ˆJava å¯¹è±¡ä¸º `null`ï¼‰ã€‚

- **éæµè§ˆå™¨å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚**
  - `Postman`ã€`curl`ã€`Java HttpClient`ã€`Python requests` ç­‰å·¥å…·é»˜è®¤ **ä¸å¸¦ `Origin` å¤´**ã€‚
  - ç»“æœï¼š`getHeader("Origin") == null`

- **æŸäº›ç‰¹æ®Šæµè§ˆå™¨è¡Œä¸ºæˆ–éšç§æ¨¡å¼**ï¼šæå°‘æ•°æƒ…å†µä¸‹ï¼ˆå¦‚éšç§æµè§ˆã€æ‰©å±•å¹²æ‰°ï¼‰ï¼Œæµè§ˆå™¨å¯èƒ½çœç•¥ `Origin`ã€‚



#### bã€ä»€ä¹ˆæ—¶å€™ `Origin` æ˜¯å­—ç¬¦ä¸² `"null"`ï¼Ÿ

- **é€šè¿‡ `file://` åè®®æ‰“å¼€çš„æœ¬åœ° `HTML` é¡µé¢**
  - æµè§ˆå™¨å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œ**å°† `Origin` è®¾ä¸ºå­—ç¬¦ä¸² `"null"`**ï¼ˆæ³¨æ„ï¼šä¸æ˜¯ Java çš„ `null`ï¼Œè€Œæ˜¯å­—é¢é‡ `"null"`ï¼‰
  - æ‰€ä»¥ `request.getHeader("Origin")` è¿”å›çš„æ˜¯ **`"null"`ï¼ˆString ç±»å‹ï¼‰**



#### cã€æ˜¯å¦è¦å¯¹ `"null"` åšå“åº”ï¼Ÿ

- **å¼ºçƒˆå»ºè®®ï¼šä¸è¦ä¸º `"null"` è®¾ç½® `Access-Control-Allow-Origin`ï¼**

- åŸå› ï¼š
  - æ¥è‡ª `file://` çš„è¯·æ±‚ä¸å¯ä¿¡ï¼Œæ— æ³•éªŒè¯æ¥æº
    - å¦‚æœä½ è¿”å› `Access-Control-Allow-Origin: null`ï¼Œ**ä»»ä½•æœ¬åœ° `HTML` æ–‡ä»¶éƒ½èƒ½è°ƒç”¨ä½ çš„ `API`**ï¼Œé€ æˆä¸¥é‡å®‰å…¨é£é™©ï¼



### 3ï¼‰ä¸ºä»€ä¹ˆè¦åŠ  `CORS` é€»è¾‘

> è®©æµè§ˆå™¨çŸ¥é“ï¼šâ€œè¿™ä¸ªè·¨åŸŸè¯·æ±‚æ˜¯è¢«å…è®¸çš„ï¼Œè¯·æŠŠå“åº”å†…å®¹æš´éœ²ç»™å‰ç«¯ `JavaScript`â€

| æ˜¯å¦éœ€è¦ CORS                                   |                                    |
| ----------------------------------------------- | ---------------------------------- |
| å‰ç«¯ï¼ˆ`React/Vue`ï¼‰è°ƒç”¨è‡ªå·±åç«¯ `API`ï¼ˆä¸åŒåŸŸï¼‰ | å¿…é¡»åŠ ï¼Œå¦åˆ™å‰ç«¯æ‹¿ä¸åˆ°æ•°æ®         |
| æä¾›å¼€æ”¾ API ç»™ç¬¬ä¸‰æ–¹ç½‘é¡µä½¿ç”¨                   | å¿…é¡»åŠ ï¼ˆæˆ–ç”¨ `JSONP` / ä»£ç†ï¼‰      |
| `App` / å°ç¨‹åº / `Postman` è°ƒç”¨ `API`           | ä¸éœ€è¦ï¼ˆå®ƒä»¬ä¸å—æµè§ˆå™¨ CORS é™åˆ¶ï¼‰ |
| åŒåŸŸéƒ¨ç½²ï¼ˆå‰ç«¯å’Œåç«¯åŒä¸€ä¸ªåŸŸåï¼‰                | ä¸éœ€è¦                             |



#### aã€**è¿›å¾—å»â€ â‰  â€œæ‹¿å¾—åˆ°**

| é˜¶æ®µ              | è°åœ¨æ“ä½œ                   | æ˜¯å¦å— CORS å½±å“     |
| ----------------- | -------------------------- | -------------------- |
| **1. è¯·æ±‚å‘é€**   | æµè§ˆå™¨ â†’ ä½ çš„æœåŠ¡å™¨        | ä¸å—å½±å“ï¼ˆè¯·æ±‚ç…§å‘ï¼‰ |
| **2. åç«¯å¤„ç†**   | ä½ çš„ `Spring Controller`   | ä¸å—å½±å“ï¼ˆç…§å¸¸æ‰§è¡Œï¼‰ |
| **3. å“åº”è¿”å›**   | ä½ çš„æœåŠ¡å™¨ â†’ æµè§ˆå™¨        | ç½‘ç»œå±‚ç…§å¸¸ä¼ è¾“       |
| **4. æµè§ˆå™¨äº¤ä»˜** | æµè§ˆå™¨ â†’ å‰ç«¯ `JavaScript` | **å— `CORS` æ§åˆ¶ï¼** |



#### bã€ç»“è®º

| è¯´æ³•                           | æ˜¯å¦æ­£ç¡® | è§£é‡Š                             |
| ------------------------------ | -------- | -------------------------------- |
| è·¨åŸŸè¯·æ±‚èƒ½è¿›å…¥ `Controller`    | æ­£ç¡®     | æœåŠ¡å™¨æ— æ¡ä»¶å¤„ç†æ‰€æœ‰ `HTTP` è¯·æ±‚ |
| ä¸é… `CORS` å‰ç«¯æ‹¿ä¸åˆ°æ•°æ®â€    | æ­£ç¡®     | æµè§ˆå™¨æ‹¦æˆªäº†å“åº”çš„â€œ`JS` å¯è§æ€§   |
| ä¸é… `CORS` è¯·æ±‚ä¼šè¢«æœåŠ¡å™¨æ‹’ç» | é”™è¯¯     | æœåŠ¡å™¨æ ¹æœ¬ä¸çŸ¥é“â€œè·¨åŸŸâ€è¿™å›äº‹     |





# äº”ã€å·¥å…·ç±»

## 1ã€`Ip` å·¥å…·ç±»  

```java
package com.hlj.utils.ip;

import com.hlj.utils.ExceptionLogUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.net.InetAddress;
import java.net.UnknownHostException;

/**
 * @Desc:
 * @Author HealerJean
 * @Date 2018/7/4  ä¸‹åˆ2:36.
 */
public class IpUtil {

    public static String getIp(){
        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        if(request==null)return null;
        String ip = request.getHeader("x-forwarded-for");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        if(ip.toLowerCase().contains("x-forwarded-for")){
            String ip_temp = "";
            if(ip.contains(":") && ip.split(":").length>0 && !ip.endsWith(":")){
                ip_temp = ip.split(":")[1];
                if(StringUtils.isBlank(ip_temp)) ip_temp = ip.substring(0,ip.lastIndexOf("X-Forwarded-For"));
            }else{
                ip_temp = ip.substring(0,ip.lastIndexOf("X-Forwarded-For"));
            }
            ip = ip_temp.replaceAll(" ","");
        }
        if (ip.indexOf(",") > -1) {
            String ip_temp = ip.split(",")[0];
            ip_temp = ip_temp.replaceAll(" ", "");
            if(ip_temp.startsWith("10.") && ip.split(",").length>1){
                ip = ip.split(",")[1];
                ip = ip.replaceAll(" ", "");
            }else ip = ip_temp;
        }
        return ip;
    }


      /**
     * è·å–è°ƒç”¨çš„http/https+ åŸŸå + ç«¯å£
     * @param urlTarget
     * @return
     */
    public static String getDomainAndPort(String urlTarget)
    {
        //è·³è½¬åˆ°å¯¹åº”çš„å›è°ƒåœ°å€
        String domain = "";
        try {
            URL url = new URL(urlTarget);
            String host = url.getHost();
            int port = url.getPort();
            String s = url.toString();
            domain = s.substring(0,s.indexOf(host)+host.length());
            if(port != -1) {
                domain = domain + ":" + port;
            }
        } catch (MalformedURLException e) {
            log.info("è·å–åŸŸåå¤±è´¥");
        }
        return domain ;
    }



    /**
     * è·å–æœåŠ¡å™¨ip
     * @return
     */
    public static  String getHostIp(){
        try {
            InetAddress ia2 = InetAddress.getLocalHost();
            return  ia2.getHostAddress();
        } catch (UnknownHostException e) {
            ExceptionLogUtils.log(e,IpUtil.class);
            return  null ;
        }
    }

    /**
     * æ ¹æ®åŸŸåè·å–ip
     * www.baidu.com
     * @param url
     * @return
     */
    public  static String getIpByUrl(String url) {
        try {
            InetAddress ia2 = InetAddress.getByName(url);
            return ia2.getHostAddress();
        } catch (UnknownHostException e) {
            ExceptionLogUtils.log(e,IpUtil.class );
            return  null;
        }
    }

    public static IPEntry getAddress(String ip){
        return  IPSeeker.getInstance().getAddress(ip);
    }

    public static void main(String[] args) {
        System.out.println(getAddress("106.39.75.134"));
    }

}

```



## 2ã€`Request` å·¥å…·ç±» 

```java

import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

/**
 * é™æ€è·å–HttpServletRequest å’Œ sessionçš„æ–¹æ³•
 * è¦ä½¿ç”¨æ­¤ç±»éœ€è¦åœ¨web.xmlæ³¨å†Œorg.springframework.web.context.request.RequestContextListener
 */
public class RequestHolder {

    public static HttpSession getSession() {
        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        return request.getSession();
    }

    public static HttpServletRequest getRequest() {
        return ((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getRequest();
    }

    public static HttpServletResponse getResponse() {
        return ((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getResponse();
    }

}
```



## 3ã€`Cookie` å·¥å…·ç±» 

```java
package com.duodian.youhui.admin.utils.cookie;

import com.duodian.youhui.admin.utils.RequestHolder;
import org.apache.commons.lang3.StringUtils;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * @Desc: Cookie å·¥å…·ç±»
 * @Date:  2018/9/12 ä¸‹åˆ1:02.
 */

public class CookieHelper {


    public static void setCookie(String key,String value,Integer seconds){
        HttpServletResponse response = RequestHolder.getResponse();
        Cookie add = new Cookie(key,value);
        add.setMaxAge(seconds);
        add.setPath("/");
        response.addCookie(add);
    }

    public static String getCookieValue(String key){
        HttpServletRequest request = RequestHolder.getRequest();
        Cookie[] cookies = request.getCookies();
        if (cookies == null){
            return null;
        }
        for (Cookie cookie : cookies){
            if (StringUtils.equals(cookie.getName(), key)){
                return cookie.getValue();
            }
        }
        return null;
    }

    public static void clearCookie(String key){
        HttpServletResponse response = RequestHolder.getResponse();
        Cookie clear = new Cookie(key,"");
        clear.setMaxAge(0);
        clear.setComment("æ¸…é™¤cookie");
        clear.setPath("/");
        response.addCookie(clear);
    }


}

```



## 4ã€`Session` å·¥å…·

```java
package com.duodian.admore.home.utils;

import com.duodian.admore.constants.AppConstants;
import com.duodian.admore.core.spring.RequestHolder;
import com.duodian.admore.entity.db.user.User;

import javax.servlet.http.HttpSession;

public class SessionUtils {

   
    public static final String SESSION_USER = "user";


    public static void initSession(User user){
        HttpSession session = RequestHolder.getSession();
        session.setAttribute(SESSION_USER,user);
    }

    public static void clearSession(){
        HttpSession session = RequestHolder.getSession();
        session.invalidate();
    }

    public static User getSessionUser(){
        HttpSession session = RequestHolder.getSession();
        User user = (User)session.getAttribute(SESSION_USER);
        return user;
    }


}

```























![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)   



<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>Â 
<div id="gitalk-container"></div>Â    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'AAAAAAAAAAAAAAA',
    });
    gitalk.render('gitalk-container');
</script>Â 
