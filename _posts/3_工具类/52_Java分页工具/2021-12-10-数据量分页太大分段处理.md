---
title: 数据量分页太大分段处理
date: 2012-12-10 00:00:00
tags: 
- Database
category: 
- Database
description: 数据量分页太大分段处理
---

**前言**     

 Github：[https://github.com/HealerJean](https://github.com/HealerJean)         

 博客：[http://blog.healerjean.com](http://HealerJean.github.io)          



# 1、`Java` 分段

```java
package com.jd.baoxian.merchant.route.service.utils;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.tuple.ImmutablePair;

import java.util.ArrayList;
import java.util.List;


@Slf4j
public class BigDataQueryUtils {

  // /**
  //  * 1、获取分段结果
  //  */
  // public static void main(String[] args) {
  //     int totalCount = 0;
  //     int intervalLength = 5;
  //     List<ImmutablePair<Integer, Integer>> result = intervalPairOfTotalCount(totalCount, intervalLength);
  //     // result.forEach(item -> System.out.println(item.getLeft() + "-" + item.getRight()));
  //
  //     List<String> list = Lists.newArrayList("1","2","3","4","5");
  //     List<List<String>> lists = intervalPairOfTotalCount(list, 6);
  //     lists.forEach(item -> {
  //         item.forEach(item2->{
  //             System.out.printf(item2);
  //         });
  //         System.out.println();
  //     });
  // }


  /**
     * 获取分段区间，索引从0开始，注意下游
     *
     * @param totalCount 总数量
     * @param pageSize   区间长度
     */
  public static List<ImmutablePair<Integer, Integer>> sizeSub(Integer totalCount, Integer pageSize) {
    List<ImmutablePair<Integer, Integer>> result = new ArrayList<>();

    Integer pageCount;
    if (totalCount % pageSize == 0) {
      pageCount = totalCount / pageSize;
    } else {
      pageCount = totalCount / pageSize + 1;
    }

    Integer pageNow = 1;
    while (pageNow <= pageCount) {
      int startIndex = (pageNow - 1) * pageSize;
      int endIndex = pageNow.compareTo(pageCount) != 0 ? startIndex + pageSize : totalCount;
      ImmutablePair<Integer, Integer> pair = ImmutablePair.of(startIndex, endIndex);
      pageNow++;
      result.add(pair);
    }
    return result;
  }


  /**
     * 获取分段区间，索引从0开始，注意下游
     *
     * @param list     数据
     * @param pageSize 区间长度
     */
  public static <T> List<List<T>> listSub(List<T> list, Integer pageSize) {
    Integer totalCount = list.size();
    List<List<T>> result = new ArrayList<>();

    Integer pageCount;
    if (totalCount % pageSize == 0) {
      pageCount = totalCount / pageSize;
    } else {
      pageCount = totalCount / pageSize + 1;
    }

    Integer pageNow = 1;
    while (pageNow <= pageCount) {
      int startIndex = (pageNow - 1) * pageSize;
      int endIndex = pageNow.compareTo(pageCount) != 0 ? startIndex + pageSize : totalCount;
      List<T> sonList = list.subList(startIndex, endIndex);
      pageNow++;
      result.add(sonList);
    }
    return result;
  }

}

```



# 2、接口一次性查(分页)

> 注意下游bug导致无线死循环，防止方法，设置方法请求次数或者设置超时时间

```java

   @Override
    public List<AftersaleBill> queryAfterSalePageList(PageQuery<AftersaleBillQuery> query) {
        List<AftersaleBill> result = new ArrayList<>();

        query.setPageNo(1);
        query.setPageSize(100);
        boolean finish = false;
        try {
            while (Boolean.FALSE.equals(finish)) {
                PageListResult<AftersaleBill> pageListResult = aftersaleBillResource.queryAfterSalePageList(query);
                if (pageListResult == null || !"0".equals(pageListResult.getCode())) {
                    log.error(" fail, query:{}, pageListResult:{}", JSON.toJSONString(query), JSON.toJSONString(pageListResult);
                    throw new AppRunTimeException("接口返回错误");
                }
                if (!CollectionUtils.isEmpty(pageListResult.getValues()) && pageListResult.getPagenation() != null && pageListResult.getPagenation().getPageCount() >= pageListResult.getPagenation().getPageNo()) {
                    result.addAll(pageListResult.getValues());
                    query.setPageNo(query.getPageNo() + 1);
                    continue;
                }
                finish = true;
            }
        } catch (Exception e) {
            log.error(" error, query:{}", JSON.toJSONString(query));
            throw new AppRunTimeException("接口查询异常");
        }
        return result;
    }
```

# 3、数据库一次查询(分页)

```java
@Override
public List<Policy> select(PolicyQuery query) {
  List<Policy> result = new ArrayList<>();
  int pageNo = NumberConstant.ONE;
  int pageSize = NumberConstant.TEN_THOUSAND;
  while (true) {
    PageHelper.startPage(pageNo, pageSize);
    List<Policy> periods = policyMapper.select(query);
    if (CollectionUtils.isEmpty(periods)) {
      return result;
    }
    pageNo = pageNo + 1;
    result.addAll(periods);
  }
}
```







![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk 评论 start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
<div id="gitalk-container"></div>    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'kh83w2LedSlTHY15',
    });
    gitalk.render('gitalk-container');
</script> 



<!-- Gitalk end -->



