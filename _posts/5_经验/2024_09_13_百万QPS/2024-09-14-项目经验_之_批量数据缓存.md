---
title: é¡¹ç›®ç»éªŒ_ä¹‹_æ‰¹é‡æ•°æ®ç¼“å­˜
date: 2024-09-14 00:00:00
tags: 
- Experience
category: 
- Experience
description: é¡¹ç›®ç»éªŒ_ä¹‹_æ‰¹é‡æ•°æ®ç¼“å­˜
---

**å‰è¨€**     

 Githubï¼š[https://github.com/HealerJean](https://github.com/HealerJean)         

 åšå®¢ï¼š[http://blog.healerjean.com](http://HealerJean.github.io)          





# ä¸€ã€å…¨é‡æ•°æ®é¢„çƒ­ç³»ç»Ÿ

## 1ã€è®¾è®¡è¦æ±‚

- **æ•°æ®ä¸ä¸¢**ï¼šå³ä½¿ä¸­é—´æœåŠ¡å‡æ­»ï¼Œæ¢å¤åä¹Ÿèƒ½è¿½ä¸Šã€‚
- **ä¸€è‡´æ€§**ï¼š`5000` å°æœºå™¨æ•°æ®åŸºæœ¬ä¸€è‡´ï¼ˆå…è®¸ç§’çº§å»¶è¿Ÿï¼‰
- **æ€§èƒ½**ï¼šé¿å…å¤§ `Key` ã€é¿å…å…¨é‡æ›¿æ¢ã€é¿å…é«˜ `CPU/GC`
- **å¯æ‰©å±•**ï¼šæ”¯æŒæ¯æ—¥å…¨é‡åˆ·æ–° + å¢é‡åŒæ­¥



## 2ã€æ•°æ®æ¨¡å‹

```sql
CREATE TABLE user_tag (
    userId BIGINT NOT NULL,
    tag_id INT NOT NULL,
    tag_value VARCHAR(255),
    update_time BIGINT NOT NULL, -- æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    PRIMARY KEY (user_id)
) ENGINE=InnoDB;
```



# äºŒã€å…¨é‡å†™å…¥æ–¹æ¡ˆ

## 1ã€æ–¹æ¡ˆç›®æ ‡

| ç›®æ ‡                       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| **æ”¯æŒåƒä¸‡çº§æ•°æ®å…¨é‡åŠ è½½** | æ•°æ®æ€»é‡çº¦ 10GBï¼ˆæ¯æ¡è®°å½• ~1KBï¼‰ï¼Œéœ€é¿å… OOM å’Œé•¿æ—¶é—´é˜»å¡    |
| **é«˜æ•ˆå­˜å‚¨ä¸ä¼ è¾“**         | å‡å°‘ç£ç›˜å ç”¨ã€ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œä¼˜å…ˆé€‰æ‹©ç´§å‡‘åºåˆ—åŒ–æ ¼å¼ï¼Œä»¥åŠä½¿ç”¨å‹æµ‹ |
| **åˆ†ç‰‡å¹¶è¡Œå†™å…¥åŠ é€Ÿ**       | åˆ©ç”¨å¤šçº¿ç¨‹æå‡å†™å…¥é€Ÿåº¦ï¼Œç¼©çŸ­æ•´ä½“å¯¼å‡ºè€—æ—¶                     |
| **åŸå­æ€§å‘å¸ƒæœºåˆ¶**         | é˜²æ­¢å®¢æˆ·ç«¯è¯»å–åˆ°â€œéƒ¨åˆ†å®Œæˆâ€çš„å¿«ç…§æ–‡ä»¶                         |
| **ç‰ˆæœ¬æ§åˆ¶ä¸é€šçŸ¥æœºåˆ¶**     | å®ç°æœåŠ¡ç«¯ä¸»åŠ¨é€šçŸ¥ï¼Œç¡®ä¿ä¸‹æ¸¸åŠæ—¶æ„ŸçŸ¥æ–°ç‰ˆæœ¬                   |
| **è‡ªåŠ¨æ¸…ç†æ—§å¿«ç…§**         | é¿å… OSS/S3 å­˜å‚¨æ— é™è†¨èƒ€ï¼Œä¿ç•™æœ€è¿‘ 7 å¤©å†å²                  |
| **å¢é‡èµ·ç‚¹å¯è¿½æº¯**         | è®°å½•æœ¬æ¬¡å…¨é‡å¼€å§‹æ—¶é—´ï¼Œä½œä¸ºåç»­å¢é‡æ‹‰å–çš„èµ·å§‹ä½ç‚¹             |
| **ç”Ÿäº§çº§ç¨³å®šæ€§ä¿éšœ**       | æ”¯æŒå¤±è´¥é‡è¯•ã€ä¸´æ—¶æ–‡ä»¶ä¿æŠ¤ã€æ—¥å¿—ç›‘æ§                         |



## 2ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
+------------------+     +----------------------------+
|   æºç³»ç»Ÿ (MySQL)   | --> | åˆ†é¡µè¯»å– + æµå¼å¤„ç†å¼•æ“      |
+------------------+     +--------------+-------------+
                                         |
                                         v
                       +----------------------------------+
                       | æŒ‰ userId å“ˆå¸Œåˆ†å‘åˆ° N ä¸ªåˆ†ç‰‡å†™å…¥å™¨ |
                       +----------------+-----------------+
                                        |
                                        v
                   +--------------------+--------------------+
                   |               OSS / S3 å­˜å‚¨å±‚              |
                   |  full_data_v{version}_{shardId}.pb.gz     |
                   +--------------------+--------------------+
                                        |
                                        v
                             +----------+-----------+
                             |   ZooKeeper ç‰ˆæœ¬ä¸­å¿ƒ    |
                             | /data-loader/full-version |
                             +----------+-----------+
                                        |
                                        v
                            +-----------+------------+
                            | ä¸‹æ¸¸æœåŠ¡ï¼ˆç›‘å¬ ZK å˜æ›´ï¼‰   |
                            | ä¸‹è½½åˆ†ç‰‡ â†’ è§£å‹ â†’ åŠ è½½å†…å­˜  |
                            +-----------+------------+
```

## 3ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1ï¼‰æ•°æ®æºè¯»å–æ¨¡å—

- é—®é¢˜èƒŒæ™¯ï¼šç›´æ¥ `SELECT * FROM table` ä¼šä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®ï¼Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼ˆ`OOM`ï¼‰ï¼Œå°¤å…¶åœ¨åƒä¸‡çº§ä»¥ä¸Šæ•°æ®é‡æ—¶ä¸å¯æ¥å—ã€‚

- è§£å†³æ–¹æ¡ˆï¼šåŸºäºä¸»é”®çš„æ¸¸æ ‡åˆ†é¡µ
  - ä½¿ç”¨ `user_id`ï¼ˆä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼‰ä½œä¸ºåˆ†é¡µé”šç‚¹ã€‚
  - æ¯æ¬¡è¯»å– `1W` æ¡ï¼Œé¿å…å†…å­˜å †ç§¯ã€‚
  - ä¸ä¾èµ– `OFFSET`ï¼Œé¿å…æ·±åº¦åˆ†é¡µæ€§èƒ½ä¸‹é™ã€‚

```sql
SELECT user_id, tag_id, tag_value, update_time
FROM user_tag
WHERE user_id > ?
ORDER BY user_id ASC
LIMIT 10000;
```

```java
public List<UserTag> findByPage(Long lastId, int pageSize) {
    String sql = "SELECT ... WHERE user_id > ? ORDER BY user_id LIMIT ?";
    return jdbcTemplate.query(sql, (rs, rowNum) -> mapRowToUserTag(rs), lastId, pageSize);
}
```

### 2ï¼‰åºåˆ—åŒ–æ ¼å¼

| æ ¼å¼                | å¤§å°å¯¹æ¯” | æ€§èƒ½å¯¹æ¯” | æ˜¯å¦æ¨è |
| ------------------- | -------- | -------- | -------- |
| `JSON`              | 100%     | 1x       | âŒ        |
| `Protobuf`          | ~40%     | 3x æ›´å¿«  | âœ…        |
| `Protobuf` + `Gzip` | ~15%     | 2.5x     | âœ…âœ…âœ…      |

### 3ï¼‰æ•°æ®åˆ†ç‰‡ç­–ç•¥ï¼ˆè´Ÿè½½å‡è¡¡ + å°æ–‡ä»¶ä¼˜åŒ–ï¼‰

| å‚æ•°     | åŸå§‹æ–¹æ¡ˆ | ä¼˜åŒ–åæ–¹æ¡ˆ     |
| -------- | -------- | -------------- |
| åˆ†ç‰‡æ•°   | 1000 ç‰‡  | **100 ç‰‡**     |
| å•ç‰‡å¤§å° | ~10MB    | **~100â€“150MB** |
| æ–‡ä»¶å‘½å | `_json`  | `_pb.gz`       |

- **ä¸ºä»€ä¹ˆæ”¹ä¸º `100` ç‰‡ï¼Ÿ**

  - `1000` ä¸ªå°æ–‡ä»¶ä¼šå¯¼è‡´ `OSS` å…ƒæ•°æ®å‹åŠ›å¤§ã€åˆ—ä¸¾æ…¢ã€æ‰“å¼€å¼€é”€é«˜ã€‚

  - æ¯ä¸ªåˆ†ç‰‡çº¦ `100MB` æ˜¯ S3/OSS æ¨èçš„æœ€ä½³å®è·µï¼ˆå…¼é¡¾å¹¶å‘ä¸ç®¡ç†æ•ˆç‡ï¼‰ã€‚

  - å®¢æˆ·ç«¯åªéœ€ä¸‹è½½ `100` ä¸ªæ–‡ä»¶ï¼Œè€Œé 1000 ä¸ªï¼Œè¿æ¥æ•°å¯æ§ã€‚

- **å“ˆå¸Œç®—æ³•æ”¹è¿›ï¼ˆé˜²å€¾æ–œï¼‰ï¼š**

  - ```
    int shardId = Math.floorMod(Objects.hash(userId), SHARD_COUNT);
    ```

  - ä½¿ç”¨ `Objects.hash()` æä¾›æ›´å¥½çš„æ•£åˆ—åˆ†å¸ƒã€‚

  - `Math.floorMod` ç¡®ä¿ç»“æœä¸ºæ­£æ•´æ•°ï¼Œé¿å…è´Ÿç´¢å¼•å¼‚å¸¸ã€‚

### 4ï¼‰å­˜å‚¨å±‚è®¾è®¡ï¼š å‹ç¼©ä¸Šä¼ 

> ä½¿ç”¨ `GZIPOutputStream` åŒ…è£¹è¾“å‡ºæµï¼Œè‡ªåŠ¨å‹ç¼©ï¼š

```java
OutputStream rawStream = new FileOutputStream(tempFile);
GZIPOutputStream gos = new GZIPOutputStream(rawStream);
CodedOutputStream cos = CodedOutputStream.newInstance(gos);
```



### 5ï¼‰ç‰ˆæœ¬é€šçŸ¥æœºåˆ¶ï¼š`ZooKeeper` å®æ—¶æ¨é€

> æ³¨æ„ï¼šä¸€å®šè¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡æƒ…å†µè€Œå®šï¼Œé˜²æ­¢å…¨é‡åˆ·æ–°å¯¼è‡´ `CPU` å‡é«˜ï¼Œå¼•å‘æœåŠ¡å¯ç”¨ç‡é™ä½

| æ–¹æ¡ˆ                  | å»¶è¿Ÿ     | å¯é æ€§ | æ¨èåº¦ |
| --------------------- | -------- | ------ | ------ |
| å®šæ—¶æ‹‰å–ï¼ˆå¦‚æ¯åˆ†é’Ÿï¼‰  | æœ€é«˜ 60s | ä½     | â­â­     |
| `ZooKeeper` `Watcher` | < 1s     | é«˜     | â­â­â­â­â­  |

```java
{
  "version": 1730486400000,
  "startTime": 1730486390000,
  "shardCount": 100,
  "totalCount": 9876543,
  "createTime": 1730486405000
}
```

#### aã€å‘å¸ƒæµç¨‹ï¼š

- æ‰€æœ‰åˆ†ç‰‡å†™å®Œå¹¶ publishã€‚

- æ›´æ–° `/data-loader/full-version` èŠ‚ç‚¹å†…å®¹ã€‚

- æ‰€æœ‰ç›‘å¬è¯¥èŠ‚ç‚¹çš„æœåŠ¡æ”¶åˆ°äº‹ä»¶å›è°ƒï¼Œè§¦å‘ `reload`

#### bã€`Watcher` æ³¨æ„äº‹é¡¹ï¼š

- `Watcher`  æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œéœ€åœ¨å›è°ƒä¸­é‡æ–°æ³¨å†Œã€‚

- å»ºè®®å°è£…æˆå®ˆæŠ¤çº¿ç¨‹æŒç»­ç›‘å¬ã€‚



### 6ï¼‰ æ¸…ç†ç­–ç•¥ï¼šä¿ç•™æœ€è¿‘ 7 å¤©å¿«ç…§

- é˜²æ­¢å­˜å‚¨æ— é™å¢é•¿ã€‚
- æ”¯æŒå›æ»šåˆ°è¿‡å»ä¸€å‘¨å†…çš„ä»»æ„ç‰ˆæœ¬ã€‚
- é™ä½å¤‡ä»½æˆæœ¬ã€‚

```java
long cutoff = currentVersion - 7L * 24 * 3600_000;
for (String file : oss.listFiles("full_data_v")) {
    long version = parseVersionFromFilename(file);
    if (version < cutoff) {
        oss.delete(file);
    }
```



### 7ï¼‰å¢é‡é‡è¡”æ¥ï¼šè®°å½• `lastFullLoadTime`

- å…³é”®å­—æ®µï¼š

  - `startTime`: å½“å‰å…¨é‡ä»»åŠ¡å¼€å§‹çš„æ—¶é—´æˆ³ï¼ˆå³ä¸Šæ¬¡å…¨é‡å®Œæˆåç¬¬ä¸€æ¬¡å¢é‡çš„èµ·ç‚¹ï¼‰

  - æˆ–è€…æ›´ç²¾ç¡®åœ°ä½¿ç”¨ `max(update_time)` ä½œä¸ºèµ·ç‚¹ï¼ˆå–å†³äºä¸šåŠ¡è¯­ä¹‰ï¼‰

- åç»­å¢é‡æ¶ˆè´¹æ–¹å¼ï¼š

  | æ¥æº             | æ‹‰å–æ–¹å¼                          |
  | ---------------- | --------------------------------- |
  | `MySQL` `Binlog` | ä» `update_time > startTime` æŸ¥è¯¢ |
  | `Kafka`          | ä»å¯¹åº”æ—¶é—´ç‚¹çš„ offset å¼€å§‹æ¶ˆè´¹    |
  | `Redis` `Stream` | XREAD with `$` or timestamp       |

### 8ï¼‰é”™è¯¯å¤„ç†ä¸å¥å£®æ€§è®¾è®¡

#### aã€å¥å£®æ€§è®¾è®¡

| é£é™©           | åº”å¯¹æªæ–½                                       |
| -------------- | ---------------------------------------------- |
| å†™å…¥ä¸­é€”å´©æºƒ   | ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œä¸‹æ¬¡å¯åŠ¨å¯åˆ¤æ–­æ˜¯å¦ç»§ç»­           |
| **æ–­ç‚¹ç»­ä¼ **   | è®°å½•å·²å¤„ç†çš„æœ€å¤§ `user_id`ï¼Œå¤±è´¥åä»ä¸­æ–­å¤„æ¢å¤ |
| `ZK` è¿æ¥æ–­å¼€  | è‡ªåŠ¨é‡è¿ + æœ¬åœ°ç¼“å­˜æœ€åç‰ˆæœ¬                    |
| å†…å­˜æº¢å‡º       | æµå¼å¤„ç†ï¼Œæ— ä¸­é—´é›†åˆç¼“å­˜                       |
| æ–‡ä»¶æœªå®Œå…¨å†™å…¥ | åªæœ‰å…¨éƒ¨å†™å®Œæ‰å‘å¸ƒç‰ˆæœ¬                         |

#### bã€éªŒè¯æ–¹å¼

| éªŒè¯é¡¹     | æ–¹æ³•                                              |
| ---------- | ------------------------------------------------- |
| æ–­ç‚¹ç»­ä¼    | kill è¿›ç¨‹ â†’ é‡å¯ â†’ æŸ¥çœ‹æ—¥å¿—æ˜¯å¦ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­     |
| æ•°æ®ä¸€è‡´   | æŸ¥çœ‹ä¸‹æ¸¸æ—¥å¿—æ˜¯å¦æ‰“å° ` åŠ è½½æˆåŠŸï¼Œå…± X æ¡`         |
| æ–‡ä»¶å®Œæ•´æ€§ | `cat /data-preload/snapshots/manifest*.json`      |
| æ–­ç‚¹æ–‡ä»¶   | `cat /data-preload/checkpoints/checkpoint_v*.txt` |



### 9ï¼‰æ–‡ä»¶å‘½åè§„èŒƒ & ç¤ºä¾‹

- `version`: `System.currentTimeMillis()`ï¼Œå…¨å±€å”¯ä¸€ä¸”æœ‰åº
- `shardId`: `[0, 99]`
- `.pb.gz`: `Protobuf` + `Gzip` å‹ç¼©æ ¼å¼

```
full_data_v{version}_{shardId}.pb.gz

ç¤ºä¾‹ï¼š
full_data_v1730486400000_0.pb.gz
full_data_v1730486400000_1.pb.gz
...
full_data_v1730486400000_99.pb.gz
```



### 10ï¼‰æ€§èƒ½ä¼°ç®—ï¼ˆä»¥ `1000` ä¸‡æ¡ä¸ºä¾‹ï¼‰

| æŒ‡æ ‡            | æ•°å€¼                     |
| --------------- | ------------------------ |
| åŸå§‹æ•°æ®å¤§å°    | ~10 GB                   |
| Protobuf å¤§å°   | ~4 GB                    |
| Protobuf + Gzip | **~1.5 GB**              |
| åˆ†ç‰‡æ•°é‡        | 100 ä¸ª                   |
| å¹³å‡æ¯ä¸ªæ–‡ä»¶    | ~15 MB                   |
| å¯¼å‡ºè€—æ—¶        | 5â€“10 åˆ†é’Ÿï¼ˆDB è´Ÿè½½æ­£å¸¸ï¼‰ |
| å†…å­˜å ç”¨        | < `200 MB`ï¼ˆæµå¼å¤„ç†ï¼‰   |
| `CPU` å ç”¨      | ä¸­ç­‰ï¼ˆProtobuf åºåˆ—åŒ–ï¼‰  |



### 11ï¼‰æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

| ç»´åº¦         | è¯´æ˜                                             |
| ------------ | ------------------------------------------------ |
| **é«˜æ•ˆæ€§**   | Protobuf + Gzip æè‡´å‹ç¼©ï¼ŒèŠ‚çœ 85% å­˜å‚¨          |
| **ä¸€è‡´æ€§**   | ä¸´æ—¶æ–‡ä»¶ + ZK åŸå­å‘å¸ƒï¼Œæœç»è„è¯»                 |
| **å¯ç»´æŠ¤æ€§** | è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œé˜²æ­¢æ•°æ®è†¨èƒ€                     |
| **å¯è§‚æµ‹æ€§** | ç‰ˆæœ¬ä¿¡æ¯ä¸°å¯Œï¼Œæ”¯æŒç›‘æ§å‘Šè­¦                       |
| **æ‰©å±•æ€§**   | åˆ†ç‰‡ç»“æ„å¤©ç„¶æ”¯æŒæ°´å¹³æ‰©å±•                         |
| **å…¼å®¹æ€§**   | Protobuf è·¨è¯­è¨€ï¼Œæ˜“äºè¢« Go/Python/C++ å®¢æˆ·ç«¯è§£æ |





## 4ã€ä»£ç å®ç°

```java
public class SnapshotConfig {
    // æ•°æ®åº“
    public String dbUrl = "jdbc:mysql://localhost:3306/test";
    public String dbUser = "root";
    public String dbPassword = "password";

    // åˆ†ç‰‡
    public int shardCount = 100;
    public int fetchSize = 10_000;

    // è·¯å¾„
    public String baseDir = "/data-preload";

    // çº¿ç¨‹
    public int readerThreads = 1;
    public int writerThreads = 4; // å†™å…¥ .pb.gz å¯å¹¶è¡Œ

    // ZK
    public String zkConnect = "localhost:2181";
    public String zkVersionPath = "/data-loader/full-version";
}
```



### 1ï¼‰`OSS` æœåŠ¡ `OssService`

```java
import java.io.*;
import java.nio.file.*;
import java.util.*;

public class OssService {
    public static final Path SNAPSHOT_DIR = Paths.get("/data-preload/snapshots");
    public static final Path CHECKPOINT_DIR = Paths.get("/data-preload/checkpoints");

    static {
        try {
            Files.createDirectories(SNAPSHOT_DIR);
            Files.createDirectories(CHECKPOINT_DIR);
        } catch (IOException e) {
            throw new RuntimeException("åˆ›å»ºç›®å½•å¤±è´¥", e);
        }
    }

    // è·å–å‹ç¼©è¾“å‡ºæµï¼ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼‰
    public OutputStream getCompressedOutputStream(String filename) throws IOException {
        Path tempFile = SNAPSHOT_DIR.resolve(filename + ".tmp");
        FileOutputStream fos = new FileOutputStream(tempFile);
        return new GZIPOutputStream(fos);
    }

    // åŸå­å‘å¸ƒï¼šä¸´æ—¶ â†’ æ­£å¼
    public void publishFile(String filename) throws IOException {
        Path temp = SNAPSHOT_DIR.resolve(filename + ".tmp");
        Path target = SNAPSHOT_DIR.resolve(filename);
        Files.move(temp, target, StandardCopyOption.REPLACE_EXISTING);
        Log.info("å‘å¸ƒæ–‡ä»¶: %s", filename);
    }

    // åˆ—å‡ºæ‰€æœ‰å·²å‘å¸ƒçš„å¿«ç…§æ–‡ä»¶
    public List<String> listPublishedFiles(String prefix) throws IOException {
        try (Stream<Path> stream = Files.list(SNAPSHOT_DIR)) {
            return stream
                .map(p -> p.getFileName().toString())
                .filter(name -> name.startsWith(prefix) && !name.endsWith(".tmp"))
                .sorted()
                .collect(Collectors.toList());
        }
    }
}
```



### 2ï¼‰æ•°æ®æ¨¡å‹ç»“æ„ `UserTag`

```java
public class UserTag {
    private long userId;
    private int tagId;
    private String tagValue;
    private long updateTime;

}
```



### 3ï¼‰åˆ†ç‰‡å†™å…¥å™¨ `ShardWriter`

```java
import com.example.proto.UserTagProto;
import java.io.*;

public class ShardWriter implements AutoCloseable {
    private final int shardId;
    private final String filename;
    private final OssService ossService;
    private CodedOutputStream cos;
    private int recordCount = 0;
    private boolean closed = false;

    public ShardWriter(int shardId, String filename, OssService ossService) throws IOException {
        this.shardId = shardId;
        this.filename = filename;
        this.ossService = ossService;

        OutputStream os = ossService.getCompressedOutputStream(filename);
        this.cos = CodedOutputStream.newInstance(os);
    }

    public void add(UserTag userTag) throws IOException {
        if (closed) throw new IOException("Writer å·²å…³é—­");

        UserTagProto.UserTag proto = UserTagProto.UserTag.newBuilder()
            .setUserId(userTag.getUserId())
            .setTagId(userTag.getTagId())
            .setTagValue(userTag.getTagValue())
            .setUpdateTime(userTag.getUpdateTime())
            .build();

        proto.writeTo(cos);
        recordCount++;
    }

    @Override
    public void close() throws IOException {
        if (!closed) {
            cos.flush();
            cos.close(); // ä¼šçº§è”å…³é—­ GZIP å’Œ FileOutputStream
            ossService.publishFile(filename);
            closed = true;
            Log.info("åˆ†ç‰‡ %d å†™å…¥å®Œæˆï¼Œå…± %d æ¡", shardId, recordCount);
        }
    }

    public int getRecordCount() { return recordCount; }
}
```



### 4ï¼‰æ–­ç‚¹ç®¡ç† `CheckpointManager`

```java
import com.google.gson.*;
import java.io.*;
import java.nio.file.*;
import java.util.*;

public class CheckpointManager {
    private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();

    public static class Checkpoint {
        public long version;
        public long lastProcessedUserId;
        public int totalRecordsWritten;
        public long updateTime;
    }

    public static Checkpoint load(long version) {
        Path path = OssService.CHECKPOINT_DIR.resolve("checkpoint_v" + version + ".txt");
        if (!Files.exists(path)) return null;

        try (Reader r = Files.newBufferedReader(path)) {
            return GSON.fromJson(r, Checkpoint.class);
        } catch (Exception e) {
            Log.warn("è¯»å– checkpoint å¤±è´¥: %s", e.getMessage());
            return null;
        }
    }

    public static void save(long version, long lastUserId, int totalCount) {
        Checkpoint cp = new Checkpoint();
        cp.version = version;
        cp.lastProcessedUserId = lastUserId;
        cp.totalRecordsWritten = totalCount;
        cp.updateTime = System.currentTimeMillis();

        String json = GSON.toJson(cp);
        Path path = OssService.CHECKPOINT_DIR.resolve("checkpoint_v" + version + ".txt");

        try {
            Files.write(path, json.getBytes(), StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);
        } catch (IOException e) {
            Log.error("ä¿å­˜ checkpoint å¤±è´¥", e);
        }
    }
}
```



### 5ï¼‰æ ¡éªŒæ¸…å•ç”Ÿæˆ `ManifestGenerator`

```java
import com.google.gson.*;
import java.io.*;
import java.nio.file.*;
import java.util.*;

public class ManifestGenerator {
    private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();

    public static class FileInfo {
        public String filename;
        public int recordCount;
    }

    public static class Manifest {
        public long version;
        public int shardCount;
        public int totalRecordCount;
        public long createTime;
        public List<FileInfo> files = new ArrayList<>();
    }

    public static void generate(long version, List<ShardWriter> writers, int expectedTotal) 
      throws IOException {
        Manifest mf = new Manifest();
        mf.version = version;
        mf.shardCount = writers.size();
        mf.totalRecordCount = expectedTotal;
        mf.createTime = System.currentTimeMillis();

        int actualTotal = 0;
        for (int i = 0; i < writers.size(); i++) {
            ShardWriter w = writers.get(i);
            FileInfo fi = new FileInfo();
            fi.filename = String.format("full_data_v%d_%d.pb.gz", version, i);
            fi.recordCount = w.getRecordCount();
            mf.files.add(fi);
            actualTotal += fi.recordCount;
        }

        if (actualTotal != expectedTotal) {
            throw new IllegalStateException(
                "è®°å½•æ€»æ•°ä¸ä¸€è‡´ï¼é¢„æœŸ=" + expectedTotal + ", å®é™…=" + actualTotal
            );
        }

        String json = GSON.toJson(mf);
        Path path = OssService.SNAPSHOT_DIR.resolve("manifest_v" + version + ".json");
        Files.write(path, json.getBytes(StandardCharsets.UTF_8));

        // åŸå­å‘å¸ƒ
        OssService oss = new OssService();
        oss.publishFile("manifest_v" + version + ".json");
        Log.info("âœ… manifest.json ç”Ÿæˆå®Œæˆï¼Œæ€»æ¡æ•°: %d", expectedTotal);
    }
}
```











```java
// è¯»ä¸¤ä¸ªç‰ˆæœ¬çš„ manifest
SnapshotManifest oldManifest = readManifest("manifest/full_data_v123450000.json");
SnapshotManifest newManifest = readManifest("manifest/full_data_v123456789.json");

// å¯¹æ¯”æ€»æ¡æ•°
if (oldManifest.totalRecords != newManifest.totalRecords) {
    Log.warn("æ¡æ•°å˜åŒ–: %d â†’ %d", oldManifest.totalRecords, newManifest.totalRecords);
}

// éå†æ‰€æœ‰åˆ†ç‰‡ï¼Œé€ä¸ªå¯¹æ¯”å†…å®¹ï¼ˆå¯ç”¨ Spark æˆ–å¤šçº¿ç¨‹ï¼‰
for (int i = 0; i < 100; i++) {
    compareShard(oldManifest.getShard(i), newManifest.getShard(i));
}
```



### 6ï¼‰å…¨é‡ç”Ÿæˆå™¨ `FullSnapshotGenerator`

#### aã€ä¸»ç±»ï¼š`FullSnapshotGenerator`

```java
@Component
@RequiredArgsConstructor
public class FullSnapshotGenerator {

    private final UserTagLoader userTagLoader;
    private final ShardWriterManager shardWriterManager;
    private final SnapshotPublisher snapshotPublisher;
    private final SnapshotCleanupService snapshotCleanupService;

    private static final int SHARD_COUNT = 100;
    private static final int WRITE_THREAD_POOL = 8;

    public void generate() throws Exception {
        long version = System.currentTimeMillis();
        long startTime = System.currentTimeMillis();

        Log.info("ã€å…¨é‡ç”Ÿæˆã€‘å¼€å§‹ï¼Œç‰ˆæœ¬: {}, åˆ†ç‰‡: {}", version, SHARD_COUNT);

        // 1. åˆ›å»ºæ‰€æœ‰åˆ†ç‰‡å†™å…¥å™¨
        List<ShardWriter> writers = shardWriterManager.createWriters(version);

        // 2. åˆ†é¡µåŠ è½½æ•°æ®ï¼Œå¹¶å†™å…¥å¯¹åº”åˆ†ç‰‡ï¼ˆå•çº¿ç¨‹è¯» + ç›´æ¥å†™ï¼‰
        int total = userTagLoader.loadBatchAndDistribute(writers, SHARD_COUNT);

        // 3. å¹¶è¡Œå…³é—­æ‰€æœ‰å†™å…¥å™¨ï¼ˆè§¦å‘ flush + publishï¼‰
        shardWriterManager.closeAllInParallel(writers, WRITE_THREAD_POOL);
        Log.info("ã€å…¨é‡ç”Ÿæˆã€‘å†™å…¥å®Œæˆï¼Œå…± {} æ¡", total);

        // 4. ç”Ÿæˆæ ¡éªŒæ¸…å•ï¼ˆæ–°å¢ï¼‰
        manifestGenerator.generate(version, writers);
      
        // 6. å‘å¸ƒæ–°ç‰ˆæœ¬
        snapshotPublisher.publish(version, startTime, total);

        // 6. æ¸…ç†è¿‡æœŸå¿«ç…§
        snapshotCleanupService.cleanupOldSnapshots(version);

        Log.info("âœ… å…¨é‡ç”Ÿæˆå®Œæˆï¼Œç‰ˆæœ¬: {}", version);
    }
}
```



 `manifest/full_data_v123456789.json`

```java
{
  "version": 123456789,
  "shardCount": 100,
  "totalRecords": 2345678,
  "generatedAt": 1730480000000,
  "entries": [
    {
      "filename": "full_data_v123456789_0.pb.gz",
      "size": 1048576,
      "md5": "a1b2c3d4...",
      "recordCount": 25000
    },
    {
      "filename": "full_data_v123456789_1.pb.gz",
      "size": 983040,
      "md5": "e5f6g7h8...",
      "recordCount": 23000
    }
    // ... å…¶ä»– 98 ä¸ª
  ]
}
```









#### bã€æ•°æ®åŠ è½½å™¨ ``UserTagLoader.java``

```java
@Component
@RequiredArgsConstructor
public class UserTagLoader {

    private final JdbcTemplate jdbcTemplate;

    private static final int BATCH_SIZE = 10_000;

    /**
     * åˆ†é¡µåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå¹¶æŒ‰ user_id åˆ†å‘åˆ°å¯¹åº”åˆ†ç‰‡å†™å…¥å™¨
     */
    public int loadBatchAndDistribute(List<ShardWriter> writers, int shardCount) {
        long lastId = 0L;
        int total = 0;

        while (true) {
            List<UserTag> batch = loadBatch(lastId);
            if (batch.isEmpty()) break;

            for (UserTag tag : batch) {
                int shardId = Math.floorMod(Objects.hash(tag.getUserId()), shardCount);
                writers.get(shardId).add(tag);
                lastId = tag.getUserId();
            }

            total += batch.size();
            if (total % 100_000 == 0) {
                Log.info("å·²åŠ è½½ {} æ¡", total);
            }
        }

        return total;
    }

    private List<UserTag> loadBatch(long lastId) {
        String sql = """
            SELECT user_id, tag_id, tag_value, update_time
            FROM user_tag
            WHERE user_id > ?
            ORDER BY user_id
            LIMIT ?
            """;
        return jdbcTemplate.query(sql, (rs, rowNum) -> {
            UserTag tag = new UserTag();
            tag.setUserId(rs.getLong("user_id"));
            tag.setTagId(rs.getInt("tag_id"));
            tag.setTagValue(rs.getString("tag_value"));
            tag.setUpdateTime(rs.getLong("update_time"));
            return tag;
        }, lastId, BATCH_SIZE);
    }
}
```



#### cã€åˆ†ç‰‡å†™å…¥ç®¡ç†å™¨ï¼š`ShardWriterManager.java`

```java
@Component
@RequiredArgsConstructor
public class ShardWriterManager {

    private final OssService ossService;

    private static final String FILE_PREFIX = "full_data_v";

    /**
     * åˆ›å»ºæŒ‡å®šç‰ˆæœ¬çš„æ‰€æœ‰åˆ†ç‰‡å†™å…¥å™¨
     */
    public List<ShardWriter> createWriters(long version) {
        List<ShardWriter> writers = new ArrayList<>();
        for (int i = 0; i < SHARD_COUNT; i++) {
            String filename = String.format("%s%d_%d.pb.gz", FILE_PREFIX, version, i);
            writers.add(new ShardWriter(i, filename, ossService));
        }
        return writers;
    }

    /**
     * å¹¶è¡Œå…³é—­æ‰€æœ‰å†™å…¥å™¨ï¼ˆè§¦å‘ flush + OOS publishï¼‰
     */
    public void closeAllInParallel(List<ShardWriter> writers, int threadPoolSize) throws Exception {
        try (ExecutorService pool = Executors.newFixedThreadPool(threadPoolSize)) {
            List<Future<?>> futures = new ArrayList<>();
            for (ShardWriter w : writers) {
                futures.add(pool.submit(w::close));
            }
            for (Future<?> f : futures) {
                f.get(); // ç­‰å¾…å®Œæˆï¼ŒæŠ›å‡ºå¼‚å¸¸
            }
        }
    }
}
```



#### dã€ç‰ˆæœ¬å‘å¸ƒå™¨ï¼š`SnapshotPublisher.java`

```java
@Component
@RequiredArgsConstructor
public class SnapshotPublisher {

    private final ZooKeeper zkClient;

    private static final String ZK_PATH = "/data-loader/full-version";

    public void publish(long version, long startTime, long totalCount) throws Exception {
        String data = String.format(
            "{\"version\":%d,\"startTime\":%d,\"shardCount\":100,\"totalCount\":%d,\"createTime\":%d}",
            version, startTime, totalCount, System.currentTimeMillis()
        );

        if (zkClient.exists(ZK_PATH, false) == null) {
            zkClient.create(ZK_PATH, data.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        } else {
            zkClient.setData(ZK_PATH, data.getBytes(), -1);
        }
        Log.info("ZK ç‰ˆæœ¬å·²æ›´æ–°: {}", data);
    }
}
```

#### eã€æ—§å¿«ç…§æ¸…ç†æœåŠ¡ï¼š`SnapshotCleanupService.java`

```java
@Component
@RequiredArgsConstructor
public class SnapshotCleanupService {

    private final OssService ossService;

    private static final String FILE_PREFIX = "full_data_v";
    private static final long EXPIRE_MS = 7 * 24 * 3600_000L; // 7å¤©
    private static final Pattern VERSION_PATTERN = Pattern.compile(FILE_PREFIX + "(\\d+)_\\d+\\.pb\\.gz");

    public void cleanupOldSnapshots(long currentVersion) {
        try {
            List<String> files = ossService.listPublishedFiles(FILE_PREFIX);
            long cutoff = currentVersion - EXPIRE_MS;

            for (String file : files) {
                Matcher m = VERSION_PATTERN.matcher(file);
                if (m.find()) {
                    long version = Long.parseLong(m.group(1));
                    if (version < cutoff) {
                        ossService.delete(file);
                        Log.info("ğŸ—‘ï¸ æ¸…ç†æ—§å¿«ç…§: {}", file);
                    }
                }
            }
        } catch (Exception e) {
            Log.error("æ¸…ç†æ—§å¿«ç…§å¤±è´¥", e);
        }
    }
}
```



## 5ã€æ•°æ®éªŒè¯

| æ–‡ä»¶                      | ä½œç”¨             | æ˜¯å¦å¿…é¡»   |
| ------------------------- | ---------------- | ---------- |
| `ShardWriter.java`        | å†™æ•°æ®           | âœ…          |
| `ManifestGenerator.java`  | ç”Ÿæˆè£…ç®±å•       | âœ…          |
| `ManifestComparator.java` | æ¯”è£…ç®±å•ï¼ˆå¿«ï¼‰   | âœ… æ¨è     |
| `ManifestValidator.java`  | éªŒè£…ç®±å•ï¼ˆé˜²é”™ï¼‰ | âœ… æ¨è     |
| `DataDiffTool.java`       | æ¯”è´§å†…å®¹ï¼ˆå‡†ï¼‰   | âœ… é«˜é˜¶éœ€æ±‚ |

### 1ï¼‰`Manifest` å’Œ æ•°æ®æ–‡ä»¶ï¼ˆå¦‚ `.pb.gz`ï¼‰åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«

| æ–‡ä»¶                                              | ä½œç”¨                   | è°ç”¨ï¼Ÿ                                         | å†…å®¹ç¤ºä¾‹                                                     |
| ------------------------------------------------- | ---------------------- | ---------------------------------------------- | ------------------------------------------------------------ |
| `full_data_v123456789_0.pb.gz` ï¼ˆæ•°æ®åˆ†ç‰‡ï¼‰       | å­˜çœŸæ­£çš„ç”¨æˆ·æ ‡ç­¾æ•°æ®   | **ä¸‹æ¸¸è®¡ç®—ç³»ç»Ÿ** ï¼ˆå¦‚ Flinkã€Sparkã€æŸ¥è¯¢æœåŠ¡ï¼‰ | `user_id: 1001, tag_id: 101, value: "åŒ—äº¬", update_time: 1730480000` |
| `manifest/full_data_v123456789.json` ï¼ˆæ¸…å•æ–‡ä»¶ï¼‰ | æè¿°æœ¬æ¬¡å¿«ç…§çš„â€œå…ƒä¿¡æ¯â€ | **è°ƒåº¦ç³»ç»Ÿã€æ ¡éªŒæœåŠ¡ã€å¯¹æ¯”å·¥å…·**               | `{ "version": 123456789, "shardCount": 100, "totalRecords": 2345678, "entries": [ { "filename": "full_data_v123456789_0.pb.gz", "size": 1048576, "recordCount": 25000 } ] }` |

### 2ï¼‰æ•°æ®å¯¹æ¯”

#### **aã€éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆé˜²ä¸¢ã€é˜²é”™ï¼‰**

> ä½ ä»Šå¤©ç”Ÿæˆäº†ä¸€ä¸ªå…¨é‡å¿«ç…§ `V123456789`ï¼Œæ˜å¤©åˆç”Ÿæˆä¸€ä¸ª `V123457000`

```
// V123456789 çš„ manifest
{
  "version": 123456789,
  "totalRecords": 2345678,
  "shardCount": 100
}

// V123457000 çš„ manifest
{
  "version": 123457000,
  "totalRecords": 2300000,   // âŒ å°‘äº† 4.5 ä¸‡æ¡ï¼
  "shardCount": 99           // âŒ å°‘äº†ä¸€ä¸ªåˆ†ç‰‡ï¼
}
```

#### **bã€å®šä½æ•°æ®å˜åŒ–ï¼ˆè°å˜äº†ï¼Ÿæ€ä¹ˆå˜çš„ï¼Ÿï¼‰**

> ä½ æƒ³çŸ¥é“ï¼š**å“ªäº›ç”¨æˆ·çš„æ ‡ç­¾è¢«æ›´æ–°äº†ï¼Ÿ**æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„ **æ•°æ®æ–‡ä»¶å†…å®¹**ï¼ˆä¸æ˜¯ manifestï¼Œæ˜¯ `.pb.gz`ï¼‰ã€‚

- ç”¨æˆ·ç”»åƒå˜åŒ–åˆ†æ
- æ•°æ®åŒæ­¥é“¾è·¯æ˜¯å¦å‡†ç¡®
- å®¡è®¡ï¼šè°æ”¹äº†æ•°æ®ï¼Ÿ

| ç”¨æˆ·ID | V123456789 | V123457000 | å˜åŒ–                     |
| ------ | ---------- | ---------- | ------------------------ |
| 1001   | åŸå¸‚: åŒ—äº¬ | åŸå¸‚: ä¸Šæµ· | âœ… æ›´æ–°                   |
| 1002   | æ ‡ç­¾: ç”·   | ï¼ˆæ— ï¼‰     | âŒ åˆ é™¤ï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·æ³¨é”€ï¼‰ |
| 1003   | ï¼ˆæ— ï¼‰     | å…´è¶£: æ¸¸æˆ | â• æ–°å¢                   |



#### **cã€ç¾å¤‡æ¢å¤æ—¶â€œéªŒè¯å®Œæ•´æ€§â€**

> å‡è®¾ `OSS` æŒ‚äº†ï¼Œä½ ä»å¤‡ä»½æ¢å¤äº†ä¸€æ‰¹ `.pb.gz` æ–‡ä»¶ã€‚ä½ æ€ä¹ˆçŸ¥é“è¿™äº›æ–‡ä»¶æ˜¯å®Œæ•´çš„ï¼Ÿæœ‰æ²¡æœ‰å°‘ä¼ ï¼Ÿ

```java
if (recoveredFile.length() != manifestEntry.size) {
    Log.error("æ–‡ä»¶å¤§å°ä¸ç¬¦: %s", filename);
}
if (!computeMd5(recoveredFile).equals(manifestEntry.md5)) {
    Log.error("MD5 æ ¡éªŒå¤±è´¥: %s", filename);
}
```



#### **dã€ç°åº¦å‘å¸ƒ & A/B æµ‹è¯•**

ä½ æ”¹äº†æ ‡ç­¾è®¡ç®—é€»è¾‘ï¼Œæƒ³éªŒè¯æ–°æ—§ä¸¤ç‰ˆç»“æœæ˜¯å¦ä¸€è‡´ã€‚

1. ç”¨æ—§é€»è¾‘ç”Ÿæˆå¿«ç…§ A
2. ç”¨æ–°é€»è¾‘ç”Ÿæˆå¿«ç…§ B
3. å¯¹æ¯” A å’Œ B çš„ `manifest`ï¼ˆçœ‹æ€»é‡ï¼‰
4. å¯¹æ¯” A å’Œ B çš„æ•°æ®å†…å®¹ï¼ˆçœ‹å·®å¼‚ç‡ï¼‰



### 3ï¼‰ä»£ç å®ç°

#### aã€**å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„ `manifest`ï¼Œå¿«é€Ÿå‘ç°å…ƒæ•°æ®å¼‚å¸¸**

```java
import java.util.Map;
import java.util.HashMap;

/**
 * æ¸…å•å¯¹æ¯”å™¨ï¼šç”¨äºæ¯”è¾ƒä¸¤ä¸ªå¿«ç…§ç‰ˆæœ¬çš„å…ƒæ•°æ®å·®å¼‚
 * ç”¨é€”ï¼šç›‘æ§æ•°æ®é‡çªå˜ã€åˆ†ç‰‡ä¸¢å¤±ã€æ–‡ä»¶æŸåç­‰
 */
public class ManifestComparator {

    public static class DiffResult {
        public final long versionA, versionB;
        public final long totalRecordsDiff;
        public final int shardCountDiff;
        public final int missingFiles;     // A æœ‰ B æ²¡æœ‰
        public final int addedFiles;       // B æœ‰ A æ²¡æœ‰
        public final int sizeMismatch;     // åŒåæ–‡ä»¶ size ä¸åŒ
        public final int md5Mismatch;      // åŒåæ–‡ä»¶ md5 ä¸åŒ

        public DiffResult(long versionA, long versionB, long totalRecordsDiff, int shardCountDiff,
                         int missingFiles, int addedFiles, int sizeMismatch, int md5Mismatch) {
            this.versionA = versionA;
            this.versionB = versionB;
            this.totalRecordsDiff = totalRecordsDiff;
            this.shardCountDiff = shardCountDiff;
            this.missingFiles = missingFiles;
            this.addedFiles = addedFiles;
            this.sizeMismatch = sizeMismatch;
            this.md5Mismatch = md5Mismatch;
        }

        public boolean hasError() {
            return missingFiles > 0 || addedFiles > 0 || sizeMismatch > 0 || md5Mismatch > 0;
        }

        public boolean hasWarning() {
            return Math.abs(totalRecordsDiff) > 1000; // æ¡æ•°å˜åŒ–è¶…è¿‡ 1000 è§†ä¸ºè­¦å‘Š
        }

        @Override
        public String toString() {
            return String.format("ManifestDiff[V%dâ†’V%d] totalDiff=%d, shardDiff=%d, " +
                               "missing=%d, added=%d, sizeErr=%d, md5Err=%d]",
                versionA, versionB, totalRecordsDiff, shardCountDiff,
                missingFiles, addedFiles, sizeMismatch, md5Mismatch);
        }
    }

    /**
     * å¯¹æ¯”ä¸¤ä¸ª manifest
     */
    public DiffResult compare(ManifestGenerator.SnapshotManifest manifestA,
                              ManifestGenerator.SnapshotManifest manifestB) {

        long totalRecordsDiff = manifestB.totalRecords - manifestA.totalRecords;
        int shardCountDiff = manifestB.shardCount - manifestA.shardCount;

        Map<String, ManifestGenerator.ManifestEntry> mapA = new HashMap<>();
        for (ManifestGenerator.ManifestEntry e : manifestA.entries) {
            mapA.put(e.filename, e);
        }

        int missing = 0, added = 0, sizeMismatch = 0, md5Mismatch = 0;

        for (ManifestGenerator.ManifestEntry entryB : manifestB.entries) {
            ManifestGenerator.ManifestEntry entryA = mapA.get(entryB.filename);
            if (entryA == null) {
                added++;
            } else {
                if (entryA.size != entryB.size) {
                    sizeMismatch++;
                }
                if (entryA.md5 != null && entryB.md5 != null &&
                    !entryA.md5.equals(entryB.md5)) {
                    md5Mismatch++;
                }
                mapA.remove(entryB.filename);
            }
        }
        missing = mapA.size(); // å‰©ä¸‹çš„éƒ½æ˜¯ A æœ‰ B æ²¡æœ‰

        return new DiffResult(
            manifestA.version, manifestB.version,
            totalRecordsDiff, shardCountDiff,
            missing, added, sizeMismatch, md5Mismatch
        );
    }
}
```



#### bã€**å¯¹æ¯”ä¸¤ä¸ªå¿«ç…§çš„æ•°æ®å†…å®¹ï¼Œåˆ†æå…·ä½“å“ªäº›ç”¨æˆ·æ ‡ç­¾å˜äº†**

```java
import com.example.proto.UserTagProto;
import java.io.InputStream;
import java.util.Map;
import java.util.HashMap;
import java.util.concurrent.atomic.AtomicLong;

/**
 * æ•°æ®å†…å®¹å¯¹æ¯”å·¥å…·
 *
 * åŠŸèƒ½ï¼š
 * - è¯»å–ä¸¤ä¸ªç‰ˆæœ¬çš„åˆ†ç‰‡æ–‡ä»¶ï¼ˆæŒ‰ shardId å¯¹åº”ï¼‰
 * - è§£æ Protobuf æµï¼Œæ„å»º userId â†’ tagId â†’ value æ˜ å°„
 * - å¯¹æ¯”å˜åŒ–ï¼šæ–°å¢ã€åˆ é™¤ã€ä¿®æ”¹
 *
 * æ³¨æ„ï¼šé€‚åˆä¸­å°è§„æ¨¡æ•°æ®ï¼ˆå•åˆ†ç‰‡ < 1GBï¼‰ï¼Œå¤§è§„æ¨¡ç”¨ Spark
 */
public class DataDiffTool {

    private final OssService ossService;

    public DataDiffTool(OssService ossService) {
        this.ossService = ossService;
    }

    public static class DiffStats {
        public final AtomicLong added = new AtomicLong(0);  // æ–°å¢æ ‡ç­¾
        public final AtomicLong removed = new AtomicLong(0); // åˆ é™¤æ ‡ç­¾
        public final AtomicLong changed = new AtomicLong(0); // ä¿®æ”¹æ ‡ç­¾å€¼
        public final AtomicLong same = new AtomicLong(0);    // æœªå˜

        public void log() {
            Log.info("ğŸ“Š æ•°æ®å¯¹æ¯”ç»“æœ: æ–°å¢=%d, åˆ é™¤=%d, ä¿®æ”¹=%d, ä¸å˜=%d",
                     added.get(), removed.get(), changed.get(), same.get());
        }
    }

    /**
     * å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æŒ‡å®šåˆ†ç‰‡
     * @param shardId åˆ†ç‰‡ ID
     * @param versionA æ—§ç‰ˆæœ¬
     * @param versionB æ–°ç‰ˆæœ¬
     */
    public DiffStats compareShard(int shardId, long versionA, long versionB) throws IOException {
        String fileA = getShardFilename(versionA, shardId);
        String fileB = getShardFilename(versionB, shardId);

        Map<Long, Map<Integer, String>> dataA = loadFromFile(fileA);
        Map<Long, Map<Integer, String>> dataB = loadFromFile(fileB);

        DiffStats stats = new DiffStats();

        // éå†æ–°æ•°æ®ï¼Œå¯¹æ¯”æ—§æ•°æ®
        for (Map.Entry<Long, Map<Integer, String>> entry : dataB.entrySet()) {
            long userId = entry.getKey();
            Map<Integer, String> tagsB = entry.getValue();
            Map<Integer, String> tagsA = dataA.getOrDefault(userId, new HashMap<>());

            for (Map.Entry<Integer, String> tag : tagsB.entrySet()) {
                int tagId = tag.getKey();
                String valueB = tag.getValue();
                String valueA = tagsA.get(tagId);

                if (valueA == null) {
                    stats.added.incrementAndGet();
                } else if (!valueA.equals(valueB)) {
                    stats.changed.incrementAndGet();
                } else {
                    stats.same.incrementAndGet();
                }
                tagsA.remove(tagId); // æ ‡è®°å·²å¤„ç†
            }
        }

        // å‰©ä¸‹çš„éƒ½æ˜¯è¢«åˆ é™¤çš„
        for (Map<Integer, String> left : dataA.values()) {
            stats.removed.addAndGet(left.size());
        }

        return stats;
    }

    /**
     * åŠ è½½ä¸€ä¸ªåˆ†ç‰‡æ–‡ä»¶åˆ°å†…å­˜æ˜ å°„
     * æ ¼å¼ï¼šuserId â†’ tagId â†’ value
     */
    private Map<Long, Map<Integer, String>> loadFromFile(String filename) throws IOException {
        Map<Long, Map<Integer, String>> result = new HashMap<>();
        InputStream is = ossService.download(filename);
        try (InputStream compressed = new GZIPInputStream(is)) {
            UserTagProto.UserTag tag;
            while ((tag = UserTagProto.UserTag.parseDelimitedFrom(compressed)) != null) {
                result.computeIfAbsent(tag.getUserId(), k -> new HashMap<>())
                      .put(tag.getTagId(), tag.getTagValue());
            }
        }
        return result;
    }

    private String getShardFilename(long version, int shardId) {
        return String.format("full_data_v%d_%d.pb.gz", version, shardId);
    }
}
```

#### cã€**éªŒè¯æŸä¸ª `manifest` å¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€æœªæŸå**

```java
/**
 * Manifest æ ¡éªŒå™¨ï¼šéªŒè¯æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€å¤§å°å’Œ MD5 æ˜¯å¦åŒ¹é…
 */
public class ManifestValidator {

    private final OssService ossService;

    public ManifestValidator(OssService ossService) {
        this.ossService = ossService;
    }

    public static class ValidationResult {
        public final boolean success;
        public final int totalFiles;
        public final int missingFiles;
        public final int sizeErrors;
        public final int md5Errors;

        public ValidationResult(boolean success, int totalFiles, int missingFiles, int sizeErrors, int md5Errors) {
            this.success = success;
            this.totalFiles = totalFiles;
            this.missingFiles = missingFiles;
            this.sizeErrors = sizeErrors;
            this.md5Errors = md5Errors;
        }

        public String summary() {
            return String.format("æ ¡éªŒç»“æœ: %s, æ–‡ä»¶æ•°=%d, ç¼ºå¤±=%d, å¤§å°é”™=%d, MD5é”™=%d",
                success ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥", totalFiles, missingFiles, sizeErrors, md5Errors);
        }
    }

    /**
     * éªŒè¯ manifest ä¸­æ‰€æœ‰æ–‡ä»¶çš„å®Œæ•´æ€§
     */
    public ValidationResult validate(ManifestGenerator.SnapshotManifest manifest) {
        int missing = 0, sizeErr = 0, md5Err = 0;

        for (ManifestGenerator.ManifestEntry entry : manifest.entries) {
            try {
                if (!ossService.exists(entry.filename)) {
                    Log.error("æ–‡ä»¶ä¸å­˜åœ¨: %s", entry.filename);
                    missing++;
                    continue;
                }

                long actualSize = ossService.getFileSize(entry.filename);
                if (actualSize != entry.size) {
                    Log.error("æ–‡ä»¶å¤§å°ä¸ç¬¦: %s, æœŸæœ›=%d, å®é™…=%d", entry.filename, entry.size, actualSize);
                    sizeErr++;
                    continue;
                }

                if (entry.md5 != null && !entry.md5.isEmpty()) {
                    String actualMd5 = ossService.getFileMd5(entry.filename);
                    if (!entry.md5.equals(actualMd5)) {
                        Log.error("MD5 æ ¡éªŒå¤±è´¥: %s, æœŸæœ›=%s, å®é™…=%s", entry.filename, entry.md5, actualMd5);
                        md5Err++;
                    }
                }
            } catch (Exception e) {
                Log.error("æ ¡éªŒæ–‡ä»¶æ—¶å¼‚å¸¸: %s", e, entry.filename);
                missing++;
            }
        }

        boolean success = missing == 0 && sizeErr == 0 && md5Err == 0;
        return new ValidationResult(success, manifest.entries.size(), missing, sizeErr, md5Err);
    }
}
```



#### 4ï¼‰å¦‚ä½•ä½¿ç”¨ï¼Ÿ

#### aã€ç”Ÿæˆå¿«ç…§åï¼š**ç”Ÿæˆ + æ ¡éªŒ manifest**

```
// ç”Ÿæˆ manifest
manifestGenerator.generate(version, writers);

// ç«‹å³è‡ªæ£€
SnapshotManifest manifest = manifestGenerator.readManifest(version);
ValidationResult result = validator.validate(manifest);
if (!result.success) {
    throw new RuntimeException("å¿«ç…§æ ¡éªŒå¤±è´¥ï¼š" + result.summary());
}
```

#### bã€æ¯æ—¥ç›‘æ§ï¼š**å¯¹æ¯”æ˜¨å¤©å’Œä»Šå¤©çš„ manifest**

```java
SnapshotManifest yesterday = manifestLoader.load(version - 1);
SnapshotManifest today     = manifestLoader.load(version);

DiffResult diff = new ManifestComparator().compare(yesterday, today);
if (diff.hasError()) {
    alertService.send("å…¨é‡å¿«ç…§å¼‚å¸¸: " + diff.toString());
}
if (diff.hasWarning()) {
    Log.warn("æ•°æ®é‡å˜åŒ–è¾ƒå¤§: " + diff.toString());
}
```



#### cã€å‘å¸ƒå‰éªŒè¯ï¼š**å¯¹æ¯”æ–°æ—§ç‰ˆæœ¬æ•°æ®å†…å®¹**

```java
DataDiffTool diffTool = new DataDiffTool(ossService);
DiffStats stats = diffTool.compareShard(0, oldVersion, newVersion); // å…ˆæ¯”ä¸€ä¸ªåˆ†ç‰‡
stats.log();

if (stats.changed.get() > 1000) {
    Log.warn("æ ‡ç­¾å˜åŒ–è¿‡å¤šï¼Œéœ€äººå·¥ç¡®è®¤");
}
```





# äºŒã€å¢é‡å†™å…¥æ–¹æ¡ˆ

aã€ä½¿ç”¨kafkaã€ä½¿ç”¨redis stream ä½¿ç”¨redisæ™®é€š

# ä¸‰ã€å…¨é‡åŠ è½½æ–¹æ¡ˆ





# å››ã€å¢é‡åŠ è½½æ–¹æ¡ˆ





# äº”ã€æ•°æ®å¯¹æ¯”æ–¹æ¡ˆ



































![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk è¯„è®º start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>Â 
<div id="gitalk-container"></div>Â    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'o6Fh1rEi5GbzvuNe',
    });
    gitalk.render('gitalk-container');
</script>Â 




<!-- Gitalk end -->



