---
title: é¡¹ç›®ç»éªŒ_ä¹‹_å…¨é‡æ•°æ®é¢„çƒ­
date: 2024-09-14 00:00:00
tags: 
- Experience
category: 
- Experience
description: é¡¹ç›®ç»éªŒ_ä¹‹_å…¨é‡æ•°æ®é¢„çƒ­
---

**å‰è¨€**     

 Githubï¼š[https://github.com/HealerJean](https://github.com/HealerJean)         

 åšå®¢ï¼š[http://blog.healerjean.com](http://HealerJean.github.io)          



# ä¸€ã€å…¨é‡æ•°æ®é¢„çƒ­ç³»ç»Ÿ



- **æ•°æ®ä¸ä¸¢**ï¼šå³ä½¿ä¸­é—´æœåŠ¡å‡æ­»ï¼Œæ¢å¤åä¹Ÿèƒ½è¿½ä¸Šã€‚
- **ä¸€è‡´æ€§**ï¼š`5000` å°æœºå™¨æ•°æ®åŸºæœ¬ä¸€è‡´ï¼ˆå…è®¸ç§’çº§å»¶è¿Ÿï¼‰
- **æ€§èƒ½**ï¼šé¿å…å¤§ `Key` ã€é¿å…å…¨é‡æ›¿æ¢ã€é¿å…é«˜ `CPU/GC`
- **å¯æ‰©å±•**ï¼šæ”¯æŒæ¯æ—¥å…¨é‡åˆ·æ–° + å¢é‡åŒæ­¥



# äºŒã€å…¨é‡å†™å…¥æ–¹æ¡ˆ

## 1ã€æ–¹æ¡ˆç›®æ ‡

| ç›®æ ‡                       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| **æ”¯æŒåƒä¸‡çº§æ•°æ®å…¨é‡åŠ è½½** | æ•°æ®æ€»é‡çº¦ 10GBï¼ˆæ¯æ¡è®°å½• ~1KBï¼‰ï¼Œéœ€é¿å… OOM å’Œé•¿æ—¶é—´é˜»å¡    |
| **é«˜æ•ˆå­˜å‚¨ä¸ä¼ è¾“**         | å‡å°‘ç£ç›˜å ç”¨ã€ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œä¼˜å…ˆé€‰æ‹©ç´§å‡‘åºåˆ—åŒ–æ ¼å¼ï¼Œæ¯ä¸ªæ•°æ®æºå¯é€‰åºåˆ—åŒ–æ–¹å¼ï¼Œå¯é€‰å‹æµ‹ |
| **åˆ†ç‰‡å¹¶è¡Œå†™å…¥åŠ é€Ÿ**       | åˆ©ç”¨å¤šçº¿ç¨‹æå‡å†™å…¥é€Ÿåº¦ï¼Œç¼©çŸ­æ•´ä½“å¯¼å‡ºè€—æ—¶                     |
| **åŸå­æ€§å‘å¸ƒæœºåˆ¶**         | é˜²æ­¢å®¢æˆ·ç«¯è¯»å–åˆ°â€œéƒ¨åˆ†å®Œæˆâ€çš„å¿«ç…§æ–‡ä»¶                         |
| **ç‰ˆæœ¬æ§åˆ¶ä¸é€šçŸ¥æœºåˆ¶**     | å®ç°æœåŠ¡ç«¯ä¸»åŠ¨é€šçŸ¥ï¼Œç¡®ä¿ä¸‹æ¸¸åŠæ—¶æ„ŸçŸ¥æ–°ç‰ˆæœ¬                   |
| **è‡ªåŠ¨æ¸…ç†æ—§å¿«ç…§**         | é¿å… OSS/S3 å­˜å‚¨æ— é™è†¨èƒ€ï¼Œä¿ç•™æœ€è¿‘ 7 å¤©å†å²                  |
| **å¢é‡èµ·ç‚¹å¯è¿½æº¯**         | è®°å½•æœ¬æ¬¡å…¨é‡å¼€å§‹æ—¶é—´ï¼Œä½œä¸ºåç»­å¢é‡æ‹‰å–çš„èµ·å§‹ä½ç‚¹             |
| **ç”Ÿäº§çº§ç¨³å®šæ€§ä¿éšœ**       | æ”¯æŒå¤±è´¥é‡è¯•ã€ä¸´æ—¶æ–‡ä»¶ä¿æŠ¤ã€æ—¥å¿—ç›‘æ§                         |



## 2ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

- **æ•°æ®æºè¯»å–**ï¼šåŸºäºä¸»é”®æ¸¸æ ‡åˆ†é¡µï¼Œæµå¼åŠ è½½ï¼Œé¿å… OOMã€‚
- **åˆ†ç‰‡å†™å…¥**ï¼šæŒ‰ `userId` å“ˆå¸Œåˆ†å‘åˆ°å¤šä¸ªåˆ†ç‰‡ï¼Œå¹¶è¡Œå†™å…¥ã€‚
- **åºåˆ—åŒ–å‹ç¼©**ï¼šä½¿ç”¨ Protobuf + GZIPï¼Œæè‡´å‹ç¼©ã€‚
- **åŸå­å‘å¸ƒ**ï¼šå…ˆå†™ `.tmp` ä¸´æ—¶æ–‡ä»¶ï¼Œå®Œæˆå `rename` å‘å¸ƒã€‚
- **ç‰ˆæœ¬é€šçŸ¥**ï¼šå°†æœ€æ–°ç‰ˆæœ¬å·å†™å…¥ Redisï¼Œä¸‹æ¸¸è½®è¯¢æ„ŸçŸ¥ã€‚
- **æ¸…ç†æ—§ç‰ˆæœ¬**ï¼šä¿ç•™æœ€è¿‘ 7 å¤©å¿«ç…§ï¼Œé˜²æ­¢å­˜å‚¨è†¨èƒ€

```
+------------------+     +----------------------------+
|   æºç³»ç»Ÿ (MySQL)   | --> | åˆ†é¡µè¯»å– + æµå¼å¤„ç†å¼•æ“      |
+------------------+     +--------------+-------------+
                                         |
                                         v
                       +----------------------------------+
                       | æŒ‰ userId å“ˆå¸Œåˆ†å‘åˆ° N ä¸ªåˆ†ç‰‡å†™å…¥å™¨ |
                       +----------------+-----------------+
                                        |
                                        v
                   +--------------------+--------------------+
                   |            å¯¹è±¡å­˜å‚¨å±‚ (OSS / S3)           |
                   |  full_data_v{version}_{shardId}.pb.gz     |
                   +--------------------+--------------------+
                                        |
                                        v
                             +----------+-----------+
                             |    Redis ç‰ˆæœ¬ä¸­å¿ƒ     |
                             | snapshot:user_tag:latest |
                             +----------+-----------+
                                        |
                                        v
                            +-----------+------------+
                            | ä¸‹æ¸¸æœåŠ¡ï¼ˆå®šæ—¶è½®è¯¢ Redisï¼‰  |
                            | ä¸‹è½½åˆ†ç‰‡ â†’ è§£å‹ â†’ åŠ è½½å†…å­˜  |
                            +-----------+------------+
```

## 3ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1ï¼‰æ•°æ®æºè¯»å–æ¨¡å—

- é—®é¢˜èƒŒæ™¯ï¼šç›´æ¥ `SELECT * FROM table` ä¼šä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®ï¼Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼ˆ`OOM`ï¼‰ï¼Œå°¤å…¶åœ¨åƒä¸‡çº§ä»¥ä¸Šæ•°æ®é‡æ—¶ä¸å¯æ¥å—ã€‚

- è§£å†³æ–¹æ¡ˆï¼šåŸºäºä¸»é”®çš„æ¸¸æ ‡åˆ†é¡µ
  - ä½¿ç”¨ `user_id`ï¼ˆä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼‰ä½œä¸ºåˆ†é¡µé”šç‚¹ã€‚
  - æ¯æ¬¡è¯»å– `1W` æ¡ï¼Œé¿å…å†…å­˜å †ç§¯ã€‚
  - ä¸ä¾èµ– `OFFSET`ï¼Œé¿å…æ·±åº¦åˆ†é¡µæ€§èƒ½ä¸‹é™ã€‚

```sql
SELECT user_id, tag_id, tag_value, update_time
FROM user_tag
WHERE user_id > ?
ORDER BY user_id ASC
LIMIT 10000;
```

```java
public List<UserTag> findByPage(Long lastId, int pageSize) {
    String sql = "SELECT ... WHERE user_id > ? ORDER BY user_id LIMIT ?";
    return jdbcTemplate.query(sql, (rs, rowNum) -> mapRowToUserTag(rs), lastId, pageSize);
}
```



### 2ï¼‰åºåˆ—åŒ–æ ¼å¼

> æ¨èä½¿ç”¨ **`Protobuf` + `GZIP`** ç»„åˆï¼Œåœ¨å‹ç¼©ç‡å’Œè§£ææ€§èƒ½ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡ï¼Œé€‚åˆè·¨è¯­è¨€ã€é«˜æ€§èƒ½åœºæ™¯ã€‚

- **å†…éƒ¨é«˜æ€§èƒ½æœåŠ¡é€šä¿¡** â†’ ç”¨ `Protobuf`
- **å¯¹å¤– `REST API` / è°ƒè¯•å‹å¥½** â†’ ç”¨ `JSON`ï¼ˆæˆ– `JSON + Gzip` å¦‚æœå¸¦å®½ç´§å¼ ï¼‰
- **æŒä¹…åŒ–å­˜å‚¨ / æ‰¹é‡æ•°æ®å¯¼å‡º** â†’ ç”¨ `Protobuf + Gzip`
- **å·²æœ‰ `JSON` ç³»ç»Ÿæƒ³é™å¸¦å®½** â†’ å¿«é€Ÿå¯ç”¨ `JSON + Gzip`ï¼ˆé›¶ä»£ç æ”¹é€ ï¼‰

| æ ¼å¼                | å¤§å°å¯¹æ¯” | æ€§èƒ½å¯¹æ¯”      | æ˜¯å¦æ¨è | è¯´æ˜                                                        |
| ------------------- | -------- | ------------- | -------- | ----------------------------------------------------------- |
| `JSON`              | 100%     | 1x            | âŒ        | å¯è¯»æ€§å¥½ï¼Œä½†ä½“ç§¯å¤§ã€æ€§èƒ½ä½ï¼Œä¸é€‚åˆé«˜æ€§èƒ½æˆ–å¸¦å®½æ•æ„Ÿåœºæ™¯      |
| `JSON + Gzip`       | ~30%     | ~0.8xï¼ˆç•¥æ…¢ï¼‰ | âœ…        | ä½“ç§¯æ˜¾è‘—å‡å°ï¼Œé€‚åˆç½‘ç»œä¼ è¾“ï¼›ä½† CPU å¼€é”€å¢åŠ ï¼Œä¸”ä»éœ€è§£ææ–‡æœ¬ |
| `Protobuf`          | ~40%     | 3x æ›´å¿«       | âœ…âœ…       | äºŒè¿›åˆ¶ã€é«˜æ•ˆã€è·¨è¯­è¨€ï¼Œé€‚åˆå†…éƒ¨æœåŠ¡é€šä¿¡å’Œå­˜å‚¨                |
| `Protobuf` + `Gzip` | ~15%     | 2.5x          | âœ…âœ…âœ…      | æè‡´å‹ç¼© + é«˜æ€§èƒ½ï¼Œé€‚åˆå†·æ•°æ®å­˜å‚¨æˆ–é«˜æˆæœ¬å¸¦å®½åœºæ™¯           |



### 3ï¼‰`OSS` æ•°æ®åˆ†ç‰‡ç­–ç•¥ï¼ˆè´Ÿè½½å‡è¡¡ + å°æ–‡ä»¶ä¼˜åŒ–ï¼‰

#### aã€åˆ†ç‰‡å¤§å°

| å‚æ•°             | åŸå§‹æ–¹æ¡ˆï¼ˆ1000ç‰‡ï¼‰ | ä¼˜åŒ–åæ–¹æ¡ˆï¼ˆ100ç‰‡ï¼‰ |
| ---------------- | ------------------ | ------------------- |
| å•ç‰‡å¤§å°         | ~10MB              | ~100â€“150MB          |
| æ–‡ä»¶æ•°é‡         | 1000               | 100                 |
| å¹¶å‘è¿æ¥         | é«˜ï¼ˆæ˜“è¶…é™ï¼‰       | é€‚ä¸­                |
| `OSS` å…ƒæ•°æ®å‹åŠ› | æé«˜               | å¯æ§                |

- **ä¸ºä»€ä¹ˆæ”¹ä¸º `100` ç‰‡ï¼Ÿ**

  - **`SS`/`S3` æœ€ä½³å®è·µå»ºè®®å•ä¸ªå¯¹è±¡å¤§å° â‰¥ 100MB**ï¼Œä»¥å‡å°‘å…ƒæ•°æ®å¼€é”€å’Œåˆ—ä¸¾å»¶è¿Ÿ
- `1000` ä¸ªå°æ–‡ä»¶ä¼šå¯¼è‡´ `OSS` å…ƒæ•°æ®å‹åŠ›å¤§ã€åˆ—ä¸¾æ…¢ã€æ‰“å¼€å¼€é”€é«˜ã€‚
  
  - `100` ä¸ªåˆ†ç‰‡å¯åœ¨å¤§å¤šæ•°é›†ç¾¤ç¯å¢ƒä¸­è‰¯å¥½å¹¶è¡Œå¤„ç†ã€‚
  
- **å“ˆå¸Œç®—æ³•æ”¹è¿›ï¼ˆé˜²å€¾æ–œï¼‰ï¼š**

  - ```
    int shardId = Math.floorMod(Objects.hash(userId), SHARD_COUNT);
    ```

  - ä½¿ç”¨ `Objects.hash()` æä¾›æ›´å¥½çš„æ•£åˆ—åˆ†å¸ƒã€‚

  - `Math.floorMod` ç¡®ä¿ç»“æœä¸ºæ­£æ•´æ•°ï¼Œé¿å…è´Ÿç´¢å¼•å¼‚å¸¸ã€‚

#### bã€`OSS` æ€§èƒ½ä¼˜åŒ–

é—®é¢˜1ï¼š`OSS`  èƒ½å¦æ”¯æŒæ•°åƒå°æœºå™¨åŒæ—¶ä¸‹è½½åŒä¸€ä¸ªæ–‡ä»¶ï¼Ÿ

ç­”æ¡ˆï¼šï¼š**å®Œå…¨å¯ä»¥ï¼Œä½†å¿…é¡»ä¼˜åŒ–æ–¹å¼ï¼Œä¸èƒ½ 5000 å°æœºå™¨åŒæ—¶ä¸‹è½½ï¼Œå¯¼è‡´ æ‰€æœ‰è¯·æ±‚æ‰“åˆ°åŒä¸€ä¸ª `Object`ï¼Œè¿™æ ·ä¼šå¯¼è‡´**

- `OSS` å†…éƒ¨çƒ­ç‚¹ï¼ˆè™½ç„¶ä¼šè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰
- å‡ºå£å¸¦å®½ç“¶é¢ˆï¼ˆå¦‚æœéƒ½åœ¨ä¸€ä¸ª VPC å‡ºå£ï¼‰
- ä¸‹è½½æ…¢ã€è¶…æ—¶ã€å¤±è´¥ç‡é«˜



é—®é¢˜2ï¼šæ­£ç¡®åšæ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ   

ç­”æ¡ˆï¼šæ­£ç¡®åšæ³•ï¼š**`OSS` + `CDN` åŠ é€Ÿï¼ˆæ¨èæ–¹æ¡ˆï¼‰**

- `10GB` æ–‡ä»¶ï¼Œ`CDN` ç¼“å­˜åï¼Œ**`3000` å°æœºå™¨å¯åœ¨ `10` åˆ†é’Ÿå†…å…¨éƒ¨ä¸‹è½½å®Œæˆ**ï¼ˆå¹³å‡ 50MB/sï¼‰
- **`CDN` ç¼“å­˜ç­–ç•¥**ï¼š
  - ç¼“å­˜ `.pb.gz` æ–‡ä»¶ï¼Œ`TTL` è®¾ç½®ä¸º `0`ï¼ˆä¸è‡ªåŠ¨è¿‡æœŸï¼‰
  - æ‰‹åŠ¨è°ƒç”¨ `Refresh` åˆ·æ–°ç¼“å­˜ï¼ˆæ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼‰
- **`OSS` + `CDN`  å¼€å¯ `HTTPS`**
- **ä½¿ç”¨å†…ç½‘ `CDN`ï¼ˆå¦‚æœæ”¯æŒï¼‰** â†’ æ›´å¿«ã€æ›´ä¾¿å®œ

| ä¼˜åŠ¿                         | è¯´æ˜                                    |
| ---------------------------- | --------------------------------------- |
| **é¦–è¯·æ±‚å›æºï¼Œåç»­å‘½ä¸­ç¼“å­˜** | ç¬¬ä¸€å°æœºå™¨ä¸‹è½½åï¼Œ`CDN` ç¼“å­˜æ•´ä¸ªæ–‡ä»¶    |
| **å°±è¿‘æ¥å…¥ç‚¹ï¼ˆ`Edge`ï¼‰ä¸‹è½½** | æ¯å°æœºå™¨ä»æœ€è¿‘çš„ `CDN` èŠ‚ç‚¹æ‹‰å–ï¼Œé€Ÿåº¦å¿« |
| **æ”¯æŒç™¾ä¸‡çº§å¹¶å‘ä¸‹è½½**       | `CDN` å¤©ç”Ÿä¸ºé«˜å¹¶å‘è®¾è®¡                  |
| **å‡è½» `OSS` å‹åŠ›**          | åªæœ‰å°‘é‡å›æºè¯·æ±‚                        |



### 4ï¼‰å­˜å‚¨å±‚è®¾è®¡ï¼š å‹ç¼©ä¸Šä¼ ä¸åŸå­å‘å¸ƒ

#### aã€å‹ç¼©æµæ„å»ºï¼ˆ`GZIP` + `Protobuf`ï¼‰

> ä½¿ç”¨ `GZIPOutputStream` åŒ…è£¹è¾“å‡ºæµï¼Œè‡ªåŠ¨å‹ç¼©ï¼š

```java
OutputStream rawStream = storage.getOutputStream(tempFilename);
GZIPOutputStream gos = new GZIPOutputStream(rawStream);
CodedOutputStream cos = CodedOutputStream.newInstance(gos);

// å†™å…¥æ¯æ¡æ¶ˆæ¯ï¼ˆdelimitedï¼‰
for (UserTag record : batch) {
    UserTagProto proto = convertToProto(record);
    proto.writeDelimitedTo(cos); // è‡ªåŠ¨æ·»åŠ é•¿åº¦å‰ç¼€
}
cos.flush();
gos.close(); // è§¦å‘å‹ç¼©ç»“æŸ
```



#### bã€åŸå­å‘å¸ƒæœºåˆ¶ï¼ˆä¸´æ—¶æ–‡ä»¶ + `rename`ï¼‰

- è‹¥ä»»åŠ¡ä¸­æ–­ï¼Œä¸´æ—¶æ–‡ä»¶å­˜åœ¨ï¼Œä¸‹æ¬¡å¯æ¢å¤ï¼›
- å®¢æˆ·ç«¯åªçœ‹åˆ°å®Œæ•´å‘å¸ƒçš„æ–‡ä»¶ï¼Œä¸ä¼šè¯»åˆ°åŠæˆå“ï¼›
- æ”¯æŒå¤šç§åº•å±‚å­˜å‚¨ï¼ˆæœ¬åœ°/`OSS`/`S3`ï¼‰ç»Ÿä¸€è¯­ä¹‰ã€‚

```java
// å†™å…¥ .tmp ä¸´æ—¶æ–‡ä»¶
String tempFile = filename + ".tmp";
try (OutputStream os = storage.getOutputStream(tempFile)) {
    writeData(os);
}

// åŸå­æ€§å‘å¸ƒï¼šrename to final name
storage.publish(tempFile, filename); 
```



### 5ï¼‰ç‰ˆæœ¬é€šçŸ¥æœºåˆ¶ï¼š`Redis` æ›¿ä»£ `ZooKeeper`

#### aã€ `ZooKeeper` çš„å±€é™æ€§ï¼ˆä¸æ¨èç”¨äºäº‹ä»¶å¹¿æ’­ï¼‰

| é£é™©                  | è¯´æ˜                                      |
| --------------------- | ----------------------------------------- |
| `ZK` ç¬æ—¶æ¨é€é£æš´     | ä¸€æ¬¡ `setData()`ï¼ŒZK å‘æ•°åƒå°æœºå™¨å‘é€äº‹ä»¶ |
| `ZK` å»¶è¿Ÿå‡é«˜         | å¤§é‡ Watcher å¯¼è‡´åè°ƒæœåŠ¡å“åº”å˜æ…¢         |
| å®¢æˆ·ç«¯å¤„ç†ä¸è¿‡æ¥      | æ•°åƒå°æœºå™¨åŒæ—¶å‘èµ·ä¸‹è½½ â†’ ç½‘ç»œæ´ªå³°         |
| `ZK` ä¸æ˜¯æ¶ˆæ¯å¹¿æ’­ç³»ç»Ÿ | å®ƒæ˜¯åè°ƒæœåŠ¡ï¼Œä¸é€‚åˆå¤§è§„æ¨¡äº‹ä»¶é€šçŸ¥        |

#### bã€æ¨èæ–¹æ¡ˆï¼š`Redis` è½»é‡çº§ç‰ˆæœ¬ä¸­å¿ƒ

- **`TTL` è®¾ç½®ï¼š**æ‰€æœ‰ `key` è®¾ç½® 7 å¤©è¿‡æœŸï¼Œä¸å¿«ç…§ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚
- **ä¸‹æ¸¸è¡Œä¸ºï¼š**
  - æ¯éš” `1~5` åˆ†é’Ÿè½®è¯¢ä¸€æ¬¡ `snapshot:{dataSource}:latest`ï¼›
  - å‘ç°ç‰ˆæœ¬å˜åŒ–åï¼Œä¸‹è½½å¯¹åº”çš„ `manifest` å¹¶æ ¡éªŒå„åˆ†ç‰‡ã€‚

```bash
 å½“å‰æœ€æ–°ç‰ˆæœ¬å·
snapshot:user_tag:latest â†’ "1730486400"

# ç‰ˆæœ¬è¯¦æƒ…ï¼ˆHashï¼‰
snapshot:user_tag:1730486400.version â†’ "1730486400"
snapshot:user_tag:1730486400.createTime â†’ "1730486400000"
snapshot:user_tag:1730486400.recordCount â†’ "9876543"
snapshot:user_tag:1730486400.manifestUrl â†’ "manifest/user_tag_v1730486400_manifest.json"
```



### 6ï¼‰ æ¸…ç†ç­–ç•¥ï¼šä¿ç•™æœ€è¿‘ 7 å¤©å¿«ç…§

> é˜²æ­¢å­˜å‚¨æ— é™å¢é•¿ã€‚æ”¯æŒå›æ»šåˆ°è¿‡å»ä¸€å‘¨å†…çš„ä»»æ„ç‰ˆæœ¬ã€‚é™ä½å¤‡ä»½æˆæœ¬ã€‚

```java
public void cleanupOld(String dataSource, long currentVersion) {
    try {
        String prefix = dataSource + "_v";

        for (String file : storage.listFiles(prefix)) {
            Long ver = extractVersion(file);
            if (ver != null && ver < currentVersion) {
                storage.delete(file);
                log.info("ğŸ—‘ï¸ åˆ é™¤æ—§å¿«ç…§æ–‡ä»¶: {}", file);
            }
        }

        // æ¸…ç†æ—§ manifest å’Œ checkpoint
        cleanupByPrefix("manifest/" + prefix, currentVersion);
        cleanupByPrefix("checkpoints/" + prefix, currentVersion);

    } catch (IOException e) {
        log.error("æ¸…ç†å¤±è´¥", e);
    }
}

private void cleanupByPrefix(String prefix, long currentVersion) throws IOException {
    for (String file : storage.listFiles(prefix)) {
        Long ver = extractVersion(file);
        if (ver != null && ver < currentVersion) {
            storage.delete(file);
            log.info("ğŸ—‘ï¸ åˆ é™¤æ—§è¾…åŠ©æ–‡ä»¶: {}", file);
        }
    }
}
```





### 7ï¼‰å¢é‡è¡”æ¥ï¼šè®°å½•å…¨é‡å¼€å§‹æ—¶é—´

- å…³é”®å­—æ®µï¼š

  - `startTime`: å½“å‰å…¨é‡ä»»åŠ¡å¼€å§‹çš„æ—¶é—´æˆ³ï¼ˆå³ä¸Šæ¬¡å…¨é‡å®Œæˆåç¬¬ä¸€æ¬¡å¢é‡çš„èµ·ç‚¹ï¼‰

  - ä¹Ÿå¯ä½¿ç”¨ `max(update_time)` ä½œä¸ºæ›´ç²¾ç¡®çš„èµ·ç‚¹ï¼Œå–å†³äºä¸šåŠ¡è¯­ä¹‰ã€‚

- åç»­å¢é‡æ¶ˆè´¹æ–¹å¼ï¼š

  | æ¥æº             | æ‹‰å–æ–¹å¼                          |
  | ---------------- | --------------------------------- |
  | `MySQL` `Binlog` | ä» `update_time > startTime` æŸ¥è¯¢ |
  | `Kafka`          | ä»å¯¹åº”æ—¶é—´ç‚¹çš„ offset å¼€å§‹æ¶ˆè´¹    |
  | `Redis` `Stream` | XREAD with `$` or timestamp       |





### 8ï¼‰é”™è¯¯å¤„ç†ä¸å¥å£®æ€§è®¾è®¡

#### aã€å¥å£®æ€§è®¾è®¡

| é£é™©           | åº”å¯¹æªæ–½                                       |
| -------------- | ---------------------------------------------- |
| å†™å…¥ä¸­é€”å´©æºƒ   | ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œä¸‹æ¬¡å¯åŠ¨å¯åˆ¤æ–­æ˜¯å¦ç»§ç»­           |
| **æ–­ç‚¹ç»­ä¼ **   | è®°å½•å·²å¤„ç†çš„æœ€å¤§ `user_id`ï¼Œå¤±è´¥åä»ä¸­æ–­å¤„æ¢å¤ |
| `ZK` è¿æ¥æ–­å¼€  | è‡ªåŠ¨é‡è¿ + æœ¬åœ°ç¼“å­˜æœ€åç‰ˆæœ¬                    |
| å†…å­˜æº¢å‡º       | æµå¼å¤„ç†ï¼Œæ— ä¸­é—´é›†åˆç¼“å­˜                       |
| æ–‡ä»¶æœªå®Œå…¨å†™å…¥ | åªæœ‰å…¨éƒ¨å†™å®Œæ‰å‘å¸ƒç‰ˆæœ¬                         |



#### bã€éªŒè¯æ–¹å¼

| éªŒè¯é¡¹     | æ–¹æ³•                                              |
| ---------- | ------------------------------------------------- |
| æ–­ç‚¹ç»­ä¼    | kill è¿›ç¨‹ â†’ é‡å¯ â†’ æŸ¥çœ‹æ—¥å¿—æ˜¯å¦ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­     |
| æ•°æ®ä¸€è‡´   | æŸ¥çœ‹ä¸‹æ¸¸æ—¥å¿—æ˜¯å¦æ‰“å° ` åŠ è½½æˆåŠŸï¼Œå…± X æ¡`         |
| æ–‡ä»¶å®Œæ•´æ€§ | `cat /data-preload/snapshots/manifest*.json`      |
| æ–­ç‚¹æ–‡ä»¶   | `cat /data-preload/checkpoints/checkpoint_v*.txt` |



### 9ï¼‰æ–‡ä»¶å‘½åè§„èŒƒ & ç¤ºä¾‹

- `dataSource`: æ•°æ®æºåç§°ï¼ˆå¦‚ `user_tag`, `item_profile`ï¼‰
- `version`: `System.currentTimeMillis()`ï¼Œå…¨å±€å”¯ä¸€ä¸”æœ‰åº
- `shardId`: `[0, N-1]`
- `.pb.gz`: Protobuf + Gzip å‹ç¼©æ ¼å¼

```
full_data_v{version}_{shardId}.pb.gz

ç¤ºä¾‹ï¼š
full_data_v1730486400000_0.pb.gz
full_data_v1730486400000_1.pb.gz
...
full_data_v1730486400000_99.pb.gz
```





### 10ï¼‰æ€§èƒ½ä¼°ç®—ï¼ˆä»¥ `1000` ä¸‡æ¡ä¸ºä¾‹ï¼‰

| æŒ‡æ ‡            | æ•°å€¼                     |
| --------------- | ------------------------ |
| åŸå§‹æ•°æ®å¤§å°    | ~10 GB                   |
| Protobuf å¤§å°   | ~4 GB                    |
| Protobuf + Gzip | **~1.5 GB**              |
| åˆ†ç‰‡æ•°é‡        | 100 ä¸ª                   |
| å¹³å‡æ¯ä¸ªæ–‡ä»¶    | ~15 MB                   |
| å¯¼å‡ºè€—æ—¶        | 5â€“10 åˆ†é’Ÿï¼ˆDB è´Ÿè½½æ­£å¸¸ï¼‰ |
| å†…å­˜å ç”¨        | < `200 MB`ï¼ˆæµå¼å¤„ç†ï¼‰   |
| `CPU` å ç”¨      | ä¸­ç­‰ï¼ˆProtobuf åºåˆ—åŒ–ï¼‰  |



### 11ï¼‰æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

| ç»´åº¦         | è¯´æ˜                                               |
| ------------ | -------------------------------------------------- |
| **é«˜æ•ˆæ€§**   | Protobuf + Gzip æè‡´å‹ç¼©ï¼ŒèŠ‚çœ 85% å­˜å‚¨            |
| **ä¸€è‡´æ€§**   | ä¸´æ—¶æ–‡ä»¶ + ZK åŸå­å‘å¸ƒï¼Œæœç»è„è¯»                   |
| **å¯ç»´æŠ¤æ€§** | è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œé˜²æ­¢æ•°æ®è†¨èƒ€                       |
| **å¯è§‚æµ‹æ€§** | ç‰ˆæœ¬ä¿¡æ¯ä¸°å¯Œï¼Œæ”¯æŒç›‘æ§å‘Šè­¦                         |
| **æ‰©å±•æ€§**   | åˆ†ç‰‡ç»“æ„å¤©ç„¶æ”¯æŒæ°´å¹³æ‰©å±•                           |
| **å…¼å®¹æ€§**   | `Protobuf` è·¨è¯­è¨€ï¼Œæ˜“äºè¢« Go/Python/C++ å®¢æˆ·ç«¯è§£æ |

#### 1ï¼‰æµè¯»å–ï¼Œè€Œä¸æ˜¯ `csv`

| ç»´åº¦               | æµå¼æ–‡æœ¬è¯»å–                    | EasyExcel è¯» CSV                                          |
| ------------------ | ------------------------------- | --------------------------------------------------------- |
| **é€‚ç”¨æ ¼å¼**       | çº¯æ–‡æœ¬ CSVï¼ˆæ¯è¡Œä¸€ä¸ªè®°å½•ï¼‰      | å®˜æ–¹**ä¸ä¸»æ¨ CSV**ï¼Œéœ€é¢å¤–é…ç½®ï¼ŒåŠŸèƒ½å¼±äº Excel            |
| **å†…å­˜å ç”¨**       | æä½ï¼ˆé€è¡Œè¯»ï¼Œæ— ç¼“å­˜ï¼‰          | è¾ƒä½ï¼ˆSAX æ¨¡å¼ï¼‰ï¼Œä½† CSV è§£æä¸å¦‚åŸç”Ÿæµé«˜æ•ˆ               |
| **æ€§èƒ½**           | é«˜ï¼ˆæ— åå°„ã€æ— æ³¨è§£è§£æï¼‰        | ä¸­ç­‰ï¼ˆæœ‰å¯¹è±¡æ˜ å°„å¼€é”€ï¼‰                                    |
| **å¼€å‘æ•ˆç‡**       | éœ€æ‰‹åŠ¨è§£æå­—æ®µï¼ˆsplit æˆ– JSONï¼‰ | å¯ç”¨ `@ExcelProperty` è‡ªåŠ¨æ˜ å°„ï¼ˆä½† CSV æ”¯æŒå·®ï¼‰           |
| **é”™è¯¯å¤„ç†**       | ç²¾ç»†ï¼ˆå¯å®šä½åˆ°å…·ä½“è¡Œï¼‰          | è¾ƒç²—ï¼ˆä¾èµ– `EasyExcel` å¼‚å¸¸å›è°ƒï¼‰                         |
| **ä¾èµ–**           | æ— é¢å¤–ä¾èµ–                      | éœ€å¼•å…¥ `easyexcel`                                        |
| **`CSV` ç‰¹æ€§æ”¯æŒ** | éœ€è‡ªå·±å¤„ç†å¼•å·ã€è½¬ä¹‰ã€åˆ†éš”ç¬¦ç­‰  | `EasyExcel` çš„ CSV reader åŠŸèƒ½è¾ƒå¼±ï¼Œå¯¹ RFC4180 æ”¯æŒä¸å®Œæ•´ |



# äºŒã€å¢é‡å†™å…¥æ–¹æ¡ˆ

**åŸºäº Redis çš„å¢é‡æ•°æ®å†™å…¥æ–¹æ¡ˆ**ï¼Œç”¨äºå°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¢é‡æ•°æ®é«˜æ•ˆã€æœ‰åºåœ°æŒä¹…åŒ–åˆ° `Redis` ä¸­ï¼Œå¹¶æ”¯æŒæŒ‰æ—¶é—´çª—å£å’Œåˆ†ç‰‡ï¼ˆ`shard`ï¼‰ç»„ç»‡æ•°æ®ï¼ŒåŒæ—¶å…·å¤‡å®¹é”™æ¢å¤èƒ½åŠ›ã€‚



## 1ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1ï¼‰ä¸ºä»€ä¹ˆéœ€è¦å¢é‡å¿«ç…§ï¼Ÿ

- **å…¨é‡å¿«ç…§æˆæœ¬é«˜**ï¼šæ¯æ¬¡é‡æ–°æ‹‰å–æ‰€æœ‰ç”¨æˆ·æ ‡ç­¾æ•°æ®ï¼ˆå¦‚ `user_tag`ï¼‰ä¼šæ¶ˆè€—å¤§é‡ I/Oã€ç½‘ç»œå’Œå†…å­˜ã€‚
- **å®æ—¶æ€§è¦æ±‚**ï¼šä¸šåŠ¡éœ€è¦è¿‘å®æ—¶æ„ŸçŸ¥ç”¨æˆ·æ ‡ç­¾å˜æ›´ï¼ˆå¦‚æ‰“æ ‡ã€å»æ ‡ï¼‰ï¼Œä¸èƒ½ä¾èµ–å°æ—¶çº§/å¤©çº§å…¨é‡ã€‚
- **èµ„æºéš”ç¦»**ï¼šå…¨é‡ä¸å¢é‡åº”è§£è€¦ï¼Œé¿å…äº’ç›¸å¹²æ‰°ã€‚

### 2ï¼‰è®¾è®¡ç›®æ ‡

- **é«˜ååã€ä½å»¶è¿Ÿ**åœ°å¤„ç†æ¥è‡ªæ¶ˆæ¯é˜Ÿåˆ—çš„å¢é‡æ•°æ®ï¼›
- **ä¿è¯æ•°æ®é¡ºåºæ€§**ï¼ˆé€šè¿‡å…¨å±€é€’å¢ `offset`ï¼‰ï¼›
- **æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢**ï¼ˆé€šè¿‡æ—¶é—´ç´¢å¼•ï¼‰ï¼›
- **è‡ªåŠ¨åˆ†ç‰‡å­˜å‚¨**ï¼Œé¿å…å•ä¸ª` ZSET` è¿‡å¤§å½±å“æ€§èƒ½ï¼›
- **å…·å¤‡æ•…éšœæ¢å¤èƒ½åŠ›**ï¼šå½“ `Redis` ä¸­ `offset` ä¸¢å¤±æ—¶ï¼Œèƒ½ä»æ•°æ®åº“æ¢å¤ï¼›
- **æ§åˆ¶å†…å­˜å ç”¨**ï¼šé€šè¿‡ `TTL` å’Œåˆ†ç‰‡æ•°é‡é™åˆ¶è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ã€‚







## 2ã€æ–¹æ¡ˆé€‰å‹

### 1ï¼‰æ–¹æ¡ˆå¯¹æ¯”

#### aã€ `Kafka` + **`Redis` `ZSET`** + åˆ†ç‰‡åç§»

> **éå¸¸é€‚åˆæ•°ç™¾~æ•°åƒå°æœºå™¨**ã€‚

**1ï¼‰åŸç†**ï¼š

- æ•°æ®æŒ‰ `offset` å†™å…¥`Redis`  `ZSET`ï¼ˆ`score` = `offset`ï¼Œ`member` = `data`ï¼‰

- æ¯ä¸ª `shard` å¯¹åº”ä¸€ä¸ª `ZSET` `key`ï¼ˆå¦‚ `incr:dataset:shard0`ï¼‰

- å®¢æˆ·ç«¯æœ¬åœ°ç»´æŠ¤ `currentOffset`ï¼ŒæŒ‰ `offset` èŒƒå›´æ‹‰å–

- åˆ†ç‰‡å¤§å°ç”± `maxMembersSize` æ§åˆ¶ï¼ˆå¦‚æ¯ `shard` `1000` æ¡ï¼‰

- ç©º `shard` æ—¶ä¸»åŠ¨æ¢æµ‹ä¸‹ä¸€ä¸ª `shard` é˜²æ¼



**2ï¼‰ä¼˜ç‚¹**

- **å¤©ç„¶æ”¯æŒé«˜å¹¶å‘è¯»**ï¼š
  - `Redis` å•å®ä¾‹å¯æ”¯æ’‘æ•°ä¸‡ `QPS`
  - `ZSET` `rangeByScore` æ˜¯ `O(logN + M)`ï¼Œæ€§èƒ½è‰¯å¥½ã€‚
- **ç²¾ç¡® `offset` æ§åˆ¶**ï¼šåŸºäº `score` çš„åç§»æœºåˆ¶ï¼Œæ”¯æŒä»»æ„ `offset` æ‹‰å–ï¼Œé€‚åˆâ€œæŒ‰ä½ç‚¹æ¢å¤â€ã€‚
- **æ— éœ€ä¸­é—´ä»¶ä¾èµ–**ï¼šä»…ä¾èµ– `Redis`ï¼Œéƒ¨ç½²ç®€å•ã€‚
- **æ”¯æŒå…¨é‡+å¢é‡ç»Ÿä¸€æ¨¡å‹**ï¼šå…¨é‡å¯è§†ä¸º æŒ‡å®š `offset` å¼€å§‹æ‹‰ã€‚



**3ï¼‰ç¼ºç‚¹**

- **åç§»é‡ç®¡ç†å¤æ‚**
  - **å†™å…¥ç«¯**ï¼šç”Ÿäº§è€…éœ€æŒ‰ `offset` å†™å…¥æ­£ç¡® `shard`ï¼ˆéœ€åè°ƒï¼‰ã€‚
  - **å®¢æˆ·ç«¯ï¼š**éœ€è¦è‡ªè¡Œç»´æŠ¤åç§»é‡ï¼Œå®¹æ˜“å‡ºé”™
  - **

- **ç©ºçª—å£é—®é¢˜**ï¼š
  - åˆ†ç‰‡è¾¹ç•Œï¼šè‹¥æŸ `shard` æ— æ•°æ®ï¼Œéœ€ä¸»åŠ¨æ¢æµ‹ä¸‹ä¸€ `shard`
  - åˆ‡æ¢è¾¹ç•Œæ˜“å‡ºé”™ï¼šå¦‚ `maxMembersSize` å˜åŒ–å¯¼è‡´ `shard` è®¡ç®—ä¸ä¸€è‡´





#### bã€`Kafka` å¹¿æ’­æ¨¡å¼ (é¦–é€‰)

> **ç™¾å°ä»¥å†…**è¾ƒåˆé€‚ï¼›**æ•°ç™¾å°å‹‰å¼ºå¯ç”¨**ï¼ˆéœ€å¤§é›†ç¾¤+åˆ†åŒºè°ƒä¼˜ï¼‰ï¼›**æ•°åƒå°ä»¥ä¸Šä¸æ¨è**ï¼ˆé™¤éåšåˆ†å±‚ä»£ç†ï¼‰ã€‚

**1ï¼‰åŸç†**

- æ¯å°æœºå™¨å¯åŠ¨æ—¶ç”Ÿæˆå”¯ä¸€ `group.id`ï¼ˆå¦‚ `hotcache-${host}-${pid}`ï¼‰
- æ‰€æœ‰æœºå™¨è®¢é˜…åŒä¸€ä¸ª `topic`ï¼Œå„è‡ªç‹¬ç«‹æ¶ˆè´¹å…¨éƒ¨ partition
- `offset` ç”± `Kafka` è‡ªåŠ¨ç®¡ç†ï¼ˆ__consumer_offsetsï¼‰



**2ï¼‰ä¼˜ç‚¹**

- **`offset` è‡ªåŠ¨æŒä¹…åŒ–**ï¼š`Kafka` è‡ªåŠ¨è®°å½•æ¯ä¸ª `group` çš„æ¶ˆè´¹ä½ç‚¹ï¼Œé‡å¯åè‡ªåŠ¨ `resume`ã€‚
- **æ–­ç½‘è¿½èµ¶èƒ½åŠ›å¼º**ï¼šåªè¦æ•°æ®æœªè¢« `retention` æ¸…é™¤ï¼ˆå¦‚ä¿ç•™ 7 å¤©ï¼‰ï¼Œå¯ä»ä»»æ„ `offset` æ‹‰å–ã€‚
- **é«˜ååã€æŒä¹…åŒ–å­˜å‚¨**ï¼š`Kafka` æœ¬èº«ä¸ºæ—¥å¿—è®¾è®¡ï¼Œç£ç›˜é¡ºåºå†™ï¼Œæ”¯æŒ `TB` çº§æ•°æ®ã€‚



**3ï¼‰ç¼ºç‚¹**

- **è¿ç»´å¤æ‚åº¦é«˜**ï¼š
  - éœ€ç»´æŠ¤ `Kafka` é›†ç¾¤ã€`ZooKeeper/KRaft`ã€ç›‘æ§ `lag` ç­‰
  - **è¿æ¥æ•°çˆ†ç‚¸**ï¼šæ¯å°æœºå™¨ä¸€ä¸ª `consumer`ï¼Œæ•°åƒå° â†’ æ•°åƒä¸ª `TCP` è¿æ¥ + æ¶ˆè´¹è€…åè°ƒå¼€é”€ã€‚

- **å¸¦å®½å‹åŠ›å¤§**ï¼šæ¯å°æœºå™¨éƒ½è¦æ‹‰å…¨é‡å¢é‡æ•°æ®ï¼ˆå¹¿æ’­è¯­ä¹‰ï¼‰ï¼Œç½‘ç»œå¸¦å®½ Ã— `N`ã€‚
- **`Kafka` é›†ç¾¤å‹åŠ›**ï¼š
  - æ•°åƒæ¶ˆè´¹è€…åŒæ—¶æ‹‰å–åŒä¸€ `topic`ï¼Œ`broker` è´Ÿè½½é«˜
  - å¯åŠ¨é£æš´ï¼šæœåŠ¡æ‰¹é‡é‡å¯æ—¶ï¼Œæ‰€æœ‰æœºå™¨åŒæ—¶æ‹‰å†å²æ•°æ®ï¼Œ`Kafka broker` ç¬é—´è¢«æ‰“æ»¡ã€‚



**4ï¼‰é€‚ç”¨åœºæ™¯**

- æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯
- æ¶ˆæ¯é‡ä¸æ˜¯ç‰¹åˆ«å·¨å¤§çš„æƒ…å†µ
- å®¢æˆ·ç«¯æ•°é‡åœ¨æ•°ç™¾å°ä»¥å†…



**5ï¼‰ä¼ªä»£ç **

```java
// ç®€åŒ–ç‰ˆå®ç°
@KafkaListener(topics = "#{'${cache.topics}'.split(',')}")
public void handleCacheUpdate(ConsumerRecord<String, CacheUpdateMessage> record) {
    try {
        applyCacheUpdate(record.value());
        // å¼‚æ­¥æäº¤åç§»é‡
        kafkaTemplate.commitSync();
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œè®°å½•å¼‚å¸¸ä½†ä¸æäº¤åç§»é‡
        log.error("Failed to process cache update", e);
    }
}

// æœåŠ¡å¯åŠ¨æ—¶å…¨é‡åŠ è½½ + å¢é‡è¿½èµ¶
@PostConstruct
public void init() {
    // 1. ä»OSSåŠ è½½å…¨é‡
    loadFullDataFromOSS();
    
    // 2. å¯»æ‰¾åˆé€‚çš„Kafkaåç§»é‡å¼€å§‹ä½ç½®
    long startOffset = calculateStartOffset();
    
    // 3. ä»æŒ‡å®šä½ç½®å¼€å§‹æ¶ˆè´¹
    kafkaConsumer.seekToBeginning(Collections.singletonList(partition));
    kafkaConsumer.seek(partition, startOffset);
}
```



#### dã€`Redis Stream`  + æ¶ˆè´¹è€…ç»„

**1ï¼‰åŸç†**

- ä½¿ç”¨ `Redis 5.0+` çš„ `Stream` æ•°æ®ç»“æ„
- åˆ›å»º `consumer group`ï¼Œæ¯å°æœºå™¨ä½œä¸ºç‹¬ç«‹ `consumer` åŠ å…¥ï¼ˆå¯å…±äº« `group`ï¼Œä¹Ÿå¯ç‹¬ç«‹ï¼‰
- ä½†ä½ è¦çš„æ˜¯**å¹¿æ’­**ï¼Œæ‰€ä»¥æ¯å°æœºå™¨åº”ä½¿ç”¨**ç‹¬ç«‹ `group`**



**2ï¼‰ä¼˜ç‚¹**

- **æ”¯æŒæ¶ˆè´¹ç»„ + `offset` è‡ªåŠ¨ç®¡ç†**ï¼šæ¯” `ZSET` æ›´è§„èŒƒã€‚
- **å†…å­˜å¯æ§**ï¼š`Stream` æ”¯æŒ `MAXLEN ~ N` è‡ªåŠ¨æˆªæ–­ï¼Œé¿å…æ— é™å¢é•¿ã€‚



**3ï¼‰ç¼ºç‚¹**

- **ä»æ˜¯å¹¿æ’­æ¨¡å¼**ï¼šæ¯å°æœºå™¨ç‹¬ç«‹ `group` â†’ æ•°æ®å…¨é‡å¤åˆ¶ï¼Œå¸¦å®½æµªè´¹åŒ `Kafka`ã€‚
- **`Redis` å•ç‚¹ç“¶é¢ˆï¼š**
  - `Stream` å†™å…¥æ˜¯å•çº¿ç¨‹ï¼ˆ`Redis` ä¸»çº¿ç¨‹ï¼‰ï¼Œé«˜ååä¸‹æ˜“æˆç“¶é¢ˆã€‚
  - æ•°ä¸‡å° `consumer` åŒæ—¶è¯»ï¼Œ`Redis` `CPU` å’Œç½‘ç»œæ‰“æ»¡ã€‚
- **æ— æ°´å¹³æ‰©å±•ï¼š**
  - `Redis` `Cluster` ä¸‹`Stream` å¿…é¡»åœ¨ä¸€ä¸ª `slot`ï¼ˆå³ä¸€ä¸ª `master`ï¼‰ï¼Œæ— æ³•åˆ†ç‰‡ã€‚
  - æ‰€æœ‰è¯»å†™å‹åœ¨ä¸€ä¸ª `Redis` `master`ï¼ˆ`Stream` æ— æ³•åˆ†ç‰‡ï¼‰



**4ï¼‰é€‚ç”¨è§„æ¨¡**

- **å‡ å ~ æ•°ç™¾å°**ï¼šå¯ç”¨ï¼Œä¼˜äº `ZSET`ï¼ˆå› æœ‰ `ACK` å’Œè‡ªåŠ¨æˆªæ–­ï¼‰ã€‚
- **æ•°åƒå°ä»¥ä¸Š**ï¼š**ä¸æ¨è**ã€‚`Redis` æˆä¸ºå•ç‚¹ç“¶é¢ˆï¼Œä¸”å¹¿æ’­æµé‡å¤§ã€‚





### 2ï¼‰æ·±åº¦åˆ†æ

####  **aã€æœåŠ¡é‡å¯å¦‚ä½•åŠ è½½å…¨é‡ + å¢é‡ï¼Ÿ**

> **`Kafka` æœ€æ ‡å‡†ï¼Œ`ZSET` æœ€è½»é‡**ã€‚

- **`Kafka`**ï¼šå…¨é‡ä» `OSS`ï¼Œå¢é‡ä» `committed` `offset` æ‹‰å–ï¼ˆå¤©ç„¶æ”¯æŒï¼‰ã€‚
- **`Redis` `Stream`**ï¼šå…¨é‡ `OSS`ï¼Œå¢é‡ä»æœ¬åœ°å­˜å‚¨çš„ `last-id` å¼€å§‹ `XREAD`ã€‚
- **`Redis` `ZSET`**ï¼šå…¨é‡ `OSS`ï¼Œå¢é‡ä»æœ¬åœ° `offset` å¼€å§‹è®¡ç®— `shard` æ‹‰å–ï¼ˆä½ å·²å®ç°ï¼‰ã€‚



#### bã€**å…ƒæ•°æ®ä¸è¿æ¥çˆ†ç‚¸é—®é¢˜**

| ç»´åº¦           | **`Kafka`**                        | **`Redis` `Stream`**                                         | **Redis ZSETï¼ˆåˆ†ç‰‡æ–¹æ¡ˆï¼‰**                                   |
| -------------- | ---------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **å†…å­˜å ç”¨**   | ç£ç›˜å­˜å‚¨ï¼Œå†…å­˜ç”¨äºç¼“å­˜ï¼ˆå¤šèŠ‚ç‚¹ï¼‰   | å¸¸é©»å†…å­˜ ï¼š**å•èŠ‚ç‚¹æ‰¿è½½å…¨éƒ¨å‹åŠ›**                            | å¸¸é©»å†…å­˜ï¼Œ **`shard` å¯åˆ†æ•£å¤šèŠ‚ç‚¹**                          |
| **æœºå™¨æ‰©å±•**   | `partition` + `broker`             | **æ— æ³•æ‰©å±•**ï¼ˆå• `key` é”æ­»ï¼Œ**å•ç‚¹å¿…å´©**ï¼‰                  | åŠ  `shard` + `Redis` èŠ‚ç‚¹                                    |
| **è¿ç»´ç®¡ç†**   | é«˜ï¼ˆéœ€ç›‘æ§ `lag`ã€`ISR`ã€ç£ç›˜ï¼‰    | ä¸­ï¼ˆç›‘æ§å†…å­˜ã€è¿æ¥ã€`trim`ï¼‰                                 | ä½ï¼ˆç›‘æ§ `Redis` `Cluster` ï¼‰                                |
| **å…ƒæ•°æ®è§„æ¨¡** | **`O`(æ¶ˆè´¹è€…æ•° Ã— åˆ†åŒºæ•°)**         | **O(æ¶ˆè´¹è€…æ•° + pending æ•°)ï¼Œææ˜“å†…å­˜çˆ†ç‚¸**                   | **O(`shard` æ•°)**                                            |
| **è¿æ¥æ•°å½±å“** | é«˜è¿æ¥æ•°ï¼Œä½† **åˆ†æ•£åˆ°å¤š `Broker`** | é«˜è¿æ¥æ•° **å…¨å‹å• Redis èŠ‚ç‚¹**ï¼Œé•¿è¿æ¥ + é«˜é¢‘ç›‘å¬ â†’ **ä¸»çº¿ç¨‹é˜»å¡** | è¿æ¥æ± å¤ç”¨ï¼Œ**è¿æ¥åˆ†æ•£åˆ° Cluster**ï¼ŒçŸ­è¯·æ±‚ â†’ **ä½å»¶è¿Ÿã€é«˜åå** |





## 3ã€æ ¸å¿ƒç»„ä»¶æ¦‚è§ˆ

| ç»„ä»¶                       | èŒè´£                                                     |
| -------------------------- | -------------------------------------------------------- |
| `SnapshotGlobalConfig`     | é…ç½®ä¸­å¿ƒï¼Œç®¡ç†å„æ•°æ®é›†ï¼ˆå¦‚ `user_tag`ï¼‰çš„å…¨é‡ & å¢é‡å‚æ•° |
| `IncrementalWriteService`  | æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQ/Kafkaï¼‰ä¸­çš„å¢é‡äº‹ä»¶ï¼Œå†™å…¥ Redis         |
| `SnapshotPathEnum`         | å®šä¹‰ Redis ä¸­å„ç±» Key çš„å‘½åè§„èŒƒï¼ˆè·¯å¾„æ¨¡æ¿ï¼‰             |
| `DatasetIncrementalConfig` | å¢é‡ç›¸å…³é…ç½®é¡¹ï¼ˆå¦‚åˆ†ç‰‡å¤§å°ã€TTLã€è½åº“å‘¨æœŸç­‰ï¼‰            |

### 1ï¼‰å…³é”®é…ç½®é¡¹è¯´æ˜

```
hot-snapshot:
  datasets:
    user_tag:
      incremental:
        max-members-size: 4000        # æ¯ä¸ª ZSET æœ€å¤šå­˜ 4000 æ¡
        db-save-offset-interval: 100  # æ¯ 100 æ¡è½åº“ä¸€æ¬¡ offset
        ttl-seconds: 86400            # æ•°æ®ä¿ç•™ 24 å°æ—¶
        time2-offset-interval: 60     # æ¯ 60 ç§’è®°å½•ä¸€æ¬¡æ—¶é—´åç§»ï¼ˆå®é™…ä»£ç æœªç”¨æ­¤å€¼ï¼ï¼‰
```

### 2ï¼‰`Redis` æ•°æ®ç»“æ„è®¾è®¡

| ç”¨é€”         | Key ç¤ºä¾‹                              | è¯´æ˜                            |
| ------------ | ------------------------------------- | ------------------------------- |
| å…¨å±€ offset  | `user_tag:incr:latestOffset`          | INCR ç”Ÿæˆå”¯ä¸€ ID                |
| å¢é‡åˆ†ç‰‡     | `user_tag:incr:shard:0`               | ZSETï¼Œmember=data, score=offset |
| æ—¶é—´åç§»æ˜ å°„ | `user_tag:incr:timeOffset:1730985600` | value=offset                    |
| æ—¶é—´æ®µè®°å½•   | `user_tag:incr:timePeriod`            | ZSETï¼Œè®°å½•æ‰€æœ‰æ—¶é—´æˆ³ï¼ˆç”¨äºæ¸…ç†  |



## 4ã€å¢é‡å†™å…¥å…¨æµç¨‹è¯¦è§£

```java
package com.healerjean.proj.hotcache.incr;


import com.healerjean.proj.hotcache.config.DatasetIncrementalConfig;
import com.healerjean.proj.hotcache.config.IncrementalExecutionConfig;
import com.healerjean.proj.hotcache.config.SnapshotGlobalConfig;
import com.healerjean.proj.hotcache.enums.SnapshotPathEnum;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.time.Duration;
import java.time.LocalDateTime;

/**
 * æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€… - å¤„ç†å¢é‡æ•°æ®å†™å…¥
 *
 * @author zhangyujin
 * @date 2025/11/3
 */
@Slf4j
@Component
public class IncrementalWriteService {


    /***
     * snapshotGlobalConfig
     */
    @Resource
    private SnapshotGlobalConfig snapshotGlobalConfig;

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    /**
     * å¢é‡ä»»åŠ¡å†™å…¥
     *
     * @param datasetName datasetName
     */
    public void write(String data, String datasetName) {
        IncrementalExecutionConfig executionConfig = snapshotGlobalConfig.instanceIncrementalConfig(datasetName);
        DatasetIncrementalConfig incrementalConfig = executionConfig.getIncrementalConfig();
        Long ttlSeconds = incrementalConfig.getTtlSeconds();
        LocalDateTime dateTime = LocalDateTime.now();
        Duration ttl = Duration.ofSeconds(ttlSeconds);
        // 1. è·å–å…¨å±€å”¯ä¸€ offset


        String offsetKey =  SnapshotPathEnum.REDIS_INCR_LATEST_OFFSET_KEY.format(datasetName);
        Long offset = redisTemplate.opsForValue().increment(offsetKey);
        // 2. å¦‚æœ Redis è¿”å› nullï¼ˆå¦‚ key ä¸å­˜åœ¨ä¸” incr å¤±è´¥ï¼‰ï¼Œä» DB æ¢å¤
        if (offset == null || offset <= 0) {
            offset = restoreOffsetFromDb(datasetName, offsetKey);
        }

        // 2. æ ¹æ® offset è®¡ç®—åˆ†ç‰‡ IDï¼ˆæ¯ MAX_MEMBERS_PER_ZSET ä¸€ä¸ªåˆ†ç‰‡ï¼‰
        Integer maxMembersSize = incrementalConfig.getMaxMembersSize();
        long shardId = (offset - 1) / maxMembersSize;
        String zsetKey =  SnapshotPathEnum.REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId);

        // 3. å†™å…¥ ZSETï¼ˆscore = offsetï¼‰
        Boolean added = redisTemplate.opsForZSet().add(zsetKey, data, (double) offset);
        if (Boolean.TRUE.equals(added)) {
            redisTemplate.expire(zsetKey, ttl);
        }

        // 4. å†™å…¥æ—¶é—´ç´¢å¼•
        long incrTimeSecond = executionConfig.getIncrIntervalTimeSecond(dateTime, 1);
        String timePeriodKey =  SnapshotPathEnum.REDIS_INCR_TIME_PERIOD_KEY.format(datasetName);
        String timeOffset =  SnapshotPathEnum.REDIS_INCR_TIME_OFFSET_KEY.format(datasetName, String.valueOf(incrTimeSecond));
        redisTemplate.opsForValue().set(timeOffset, offset.toString(), ttl);
        redisTemplate.opsForZSet().add(timePeriodKey, String.valueOf(incrTimeSecond), (double) incrTimeSecond);
        Long currentSize = redisTemplate.opsForZSet().size(timePeriodKey);
        if (currentSize != null && currentSize > maxMembersSize) {
            long removeCount = currentSize - maxMembersSize;
            redisTemplate.opsForZSet().removeRange(timePeriodKey, 0, removeCount - 1);
        }
        redisTemplate.expire(timePeriodKey, ttl);

        Integer dbSaveOffsetInterval = incrementalConfig.getDbSaveOffsetInterval();
        if (offset % dbSaveOffsetInterval == 0) {
            // 6. å°† offset å†™å…¥æ•°æ®åº“
        }

    }

    /**
     * ä»æ•°æ®åº“æ¢å¤
     *
     * @param datasetName datasetName
     * @param offsetKey   offsetKey
     * @return {@link Long}
     */
    private long restoreOffsetFromDb(String datasetName, String offsetKey) {
        String lockKey = "lock:offset:init:" + datasetName;
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
        if (Boolean.FALSE.equals(locked)) {
            throw new RuntimeException("Interrupted while waiting for offset init");
        }
        try {
            // ä» DB è¯»å–æœ€æ–° offset
            // Long dbOffset = offsetRepository.getCurrentOffsetFromDb(datasetName);
            // long nextOffset = dbOffset + 1;
            // redisTemplate.opsForValue().set(offsetKey, String.valueOf(nextOffset));
            // return nextOffset;
        } finally {
            redisTemplate.delete(lockKey);
        }
        return 1;
    }

}
```



### 1ï¼‰è·å–å…¨å±€å”¯ä¸€ `offset`

> ğŸ’¡ è‹¥ Redis åˆæ¬¡å¯åŠ¨æˆ– key ä¸å­˜åœ¨ï¼Œ`INCR` è¿”å› 1ï¼›è‹¥å¤±è´¥ï¼ˆå¦‚é›†ç¾¤æ•…éšœï¼‰ï¼Œåˆ™å°è¯•ä» DB æ¢å¤ï¼ˆè§å®¹é”™æœºåˆ¶ï¼‰ã€‚

```
String offsetKey = "user_tag:incr:latestOffset";
Long offset = redisTemplate.opsForValue().increment(offsetKey);
```

- ä½¿ç”¨ `Redis` çš„ `INCR` åŸå­æ“ä½œç”Ÿæˆé€’å¢ offsetã€‚
- **ä½œç”¨**ï¼šä½œä¸ºæ¯æ¡å¢é‡æ•°æ®çš„â€œå”¯ä¸€ `ID`â€å’Œæ’åºä¾æ®ï¼ˆ`ZSET` çš„ `score`ï¼‰ã€‚



### 2ï¼‰å®¹ç¾å…œåº• â€”â€” ä» DB æ¢å¤ offsetï¼ˆå¯é€‰ï¼‰

> è®¾è®¡æ„å›¾ï¼šä¿è¯ç³»ç»Ÿåœ¨ Redis ä¸å¯ç”¨æ—¶ä»èƒ½å®‰å…¨æ¢å¤ï¼Œé¿å… offset é‡ç½®å¯¼è‡´æ•°æ®é‡å¤/ä¸¢å¤±

- å½“ `Redis` å¼‚å¸¸ï¼ˆå¦‚é›†ç¾¤æ•…éšœã€`key` è¢«è¯¯åˆ ï¼‰ï¼Œå°è¯•ä»æ•°æ®åº“æ¢å¤æœ€æ–° `offset`
- ä½¿ç”¨ **`Redis` åˆ†å¸ƒå¼é”** é˜²æ­¢å¹¶å‘åˆå§‹åŒ–å†²çª

```
if (offset == null || offset <= 0) {
    offset = restoreOffsetFromDb(datasetName, offsetKey);
}
```



### 3ï¼‰è®¡ç®—åˆ†ç‰‡ `ID` å¹¶å†™å…¥ `ZSet`

```java
long shardId = (offset - 1) / maxMembersSize;
String zsetKey = REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId);
```

- **åˆ†ç‰‡ç­–ç•¥**ï¼šæ¯ `maxMembersSize` æ¡æ•°æ®ä¸€ä¸ª ZSetï¼ˆå¦‚ 10 ä¸‡æ¡/åˆ†ç‰‡ï¼‰
- **Score = offset**ï¼šä¿è¯æŒ‰å†™å…¥é¡ºåºæ’åºï¼Œä¾¿äºä¸‹æ¸¸æŒ‰ offset èŒƒå›´æ‹‰å–
- **è‡ªåŠ¨è¿‡æœŸ**ï¼šæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹è®¾ç½® TTLï¼Œé¿å…å†…å­˜æ— é™å¢é•¿



### 4ï¼‰å†™å…¥ `ZSET`ï¼ˆæŒ‰ `offset` æ’åºï¼‰

```java
redisTemplate.opsForZSet().add(zsetKey, data, (double) offset);
redisTemplate.expire(zsetKey, ttlSeconds); // å¦‚ 86400s = 24h
```

- `ZSET` ç»“æ„ï¼š
  - `member` = åºåˆ—åŒ–åçš„ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚ `JSON` å­—ç¬¦ä¸²ï¼‰
  - `score` = `offset`ï¼ˆä¿è¯å…¨å±€æœ‰åºï¼‰
- è®¾ç½® `TTL` è‡ªåŠ¨è¿‡æœŸï¼Œé¿å…æ— é™å †ç§¯ã€‚



### 5ï¼‰å»ºç«‹æ—¶é—´ç´¢å¼•ï¼ˆ`Time-to-Offset` æ˜ å°„ï¼‰

```java
long incrTimeSecond = executionConfig.getIncrIntervalTimeSecond(dateTime, 1); // æŒ‰ç§’å¯¹é½
String timeOffsetKey = "user_tag:incr:timeOffset:" + incrTimeSecond;
redisTemplate.opsForValue().set(timeOffsetKey, String.valueOf(offset), ttl);
```

- **ä½œç”¨**ï¼šæ”¯æŒâ€œæŒ‰æ—¶é—´æŸ¥è¯¢è¯¥æ—¶åˆ»ä¹‹åçš„æ‰€æœ‰å¢é‡â€ã€‚
- ä¾‹å¦‚ï¼šæƒ³çŸ¥é“ä»Šå¤© `10:00` ä¹‹åæœ‰å“ªäº›å˜æ›´ï¼Ÿå…ˆæŸ¥ `timeOffset:1730985600` å¾—åˆ° offset=12345ï¼Œå†ä» offset=12345 å¼€å§‹æ‹‰å–ã€‚



## 5ã€ä»£ç å®ç°

### 1ï¼‰æ™®é€š `redis` ï¼ˆå¹¶å‘é£é™©ï¼‰

```java
package com.healerjean.proj.hotcache.incr;


import com.healerjean.proj.hotcache.config.DatasetIncrementalConfig;
import com.healerjean.proj.hotcache.config.IncrementalExecutionConfig;
import com.healerjean.proj.hotcache.config.SnapshotGlobalConfig;
import com.healerjean.proj.hotcache.enums.SnapshotPathEnum;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.time.Duration;
import java.time.LocalDateTime;

/**
 * æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€… - å¤„ç†å¢é‡æ•°æ®å†™å…¥
 *
 * @author zhangyujin
 * @date 2025/11/3
 */
@Slf4j
@Component
public class IncrementalWriteService {


    /***
     * snapshotGlobalConfig
     */
    @Resource
    private SnapshotGlobalConfig snapshotGlobalConfig;

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    /**
     * å¢é‡ä»»åŠ¡å†™å…¥
     *
     * @param datasetName datasetName
     */
    public void write(String data, String datasetName) {
        IncrementalExecutionConfig executionConfig = snapshotGlobalConfig.instanceIncrementalConfig(datasetName);
        DatasetIncrementalConfig incrementalConfig = executionConfig.getIncrementalConfig();
        Long ttlSeconds = incrementalConfig.getTtlSeconds();
        LocalDateTime dateTime = LocalDateTime.now();
        Duration ttl = Duration.ofSeconds(ttlSeconds);

        // 1. è·å–å…¨å±€å”¯ä¸€ offset
        String offsetKey = SnapshotPathEnum.REDIS_INCR_LATEST_OFFSET_KEY.format(datasetName);
        Long offset = redisTemplate.opsForValue().increment(offsetKey);
        // 2. å¦‚æœ Redis è¿”å› nullï¼ˆå¦‚ key ä¸å­˜åœ¨ä¸” incr å¤±è´¥ï¼‰ï¼Œä» DB æ¢å¤
        if (offset == null || offset <= 0) {
            offset = restoreOffsetFromDb(datasetName, offsetKey);
        }else {
            // 6. todo å°† offset å†™å…¥æ•°æ®åº“
        }

        // 2. æ ¹æ® offset è®¡ç®—åˆ†ç‰‡ IDï¼ˆæ¯ MAX_MEMBERS_PER_ZSET ä¸€ä¸ªåˆ†ç‰‡ï¼‰
        Integer maxMembersSize = incrementalConfig.getMaxMembersSize();
        long shardId = (offset - 1) / maxMembersSize;
        String zsetKey = SnapshotPathEnum.REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId);

        // 3. å†™å…¥ ZSETï¼ˆscore = offsetï¼‰
        Boolean added = redisTemplate.opsForZSet().add(zsetKey, data, (double) offset);
        if (Boolean.TRUE.equals(added)) {
            redisTemplate.expire(zsetKey, ttl);
        }

        // 4. å†™å…¥æ—¶é—´ç´¢å¼•
        long incrTimeSecond = executionConfig.getIncrIntervalTimeSecond(dateTime, 1);
        String timePeriodKey = SnapshotPathEnum.REDIS_INCR_TIME_PERIOD_KEY.format(datasetName);
        String timeOffset = SnapshotPathEnum.REDIS_INCR_TIME_OFFSET_KEY.format(datasetName, String.valueOf(incrTimeSecond));
        redisTemplate.opsForValue().set(timeOffset, offset.toString(), ttl);
        redisTemplate.opsForZSet().add(timePeriodKey, String.valueOf(incrTimeSecond), (double) incrTimeSecond);
        Long currentSize = redisTemplate.opsForZSet().size(timePeriodKey);
        if (currentSize != null && currentSize > maxMembersSize) {
            long removeCount = currentSize - maxMembersSize;
            redisTemplate.opsForZSet().removeRange(timePeriodKey, 0, removeCount - 1);
        }
        redisTemplate.expire(timePeriodKey, ttl);

        // 6. todo å°† offset å†™å…¥æ•°æ®åº“

    }

    /**
     * ä»æ•°æ®åº“æ¢å¤
     *
     * @param datasetName datasetName
     * @param offsetKey   offsetKey
     * @return {@link Long}
     */
    private long restoreOffsetFromDb(String datasetName, String offsetKey) {
        String lockKey = "lock:offset:init:" + datasetName;
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
        if (Boolean.FALSE.equals(locked)) {
            throw new RuntimeException("Interrupted while waiting for offset init");
        }
        try {
            // ä» DB è¯»å–æœ€æ–° offset
            // Long dbOffset = offsetRepository.getCurrentOffsetFromDb(datasetName);
            // long nextOffset = dbOffset + 1;
            // redisTemplate.opsForValue().set(offsetKey, String.valueOf(nextOffset));
            // return nextOffset;
        } finally {
            redisTemplate.delete(lockKey);
        }
        return 1;
    }


}
```



### 2ï¼‰`LUA-redis`

```java
package com.healerjean.proj.hotcache.incr;


import com.healerjean.proj.hotcache.config.DatasetIncrementalConfig;
import com.healerjean.proj.hotcache.config.IncrementalExecutionConfig;
import com.healerjean.proj.hotcache.config.SnapshotGlobalConfig;
import com.healerjean.proj.hotcache.enums.SnapshotPathEnum;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.script.RedisScript;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

/**
 * æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€… - å¤„ç†å¢é‡æ•°æ®å†™å…¥
 *
 * @author zhangyujin
 * @date 2025/11/3
 */
@Slf4j
@Component
public class IncrementalLuaWriteService {


    private final static RedisScript<String> WRITE_INCREMENTAL_SCRIPT = RedisScript.of(
            "redis.call('ZADD', KEYS[1], ARGV[2], ARGV[1]);" +
                    "redis.call('EXPIRE', KEYS[1], ARGV[3]);" +
                    "redis.call('SET', KEYS[2], ARGV[2], 'EX', ARGV[3]);" +
                    "redis.call('ZADD', KEYS[3], ARGV[4], ARGV[4]);" +
                    "redis.call('EXPIRE', KEYS[3], ARGV[3]);" +
                    "local maxMembers = tonumber(ARGV[5]);" +
                    "local currentSize = redis.call('ZCARD', KEYS[3]);" +
                    "if currentSize > maxMembers then " +
                    "  local removeCount = currentSize - maxMembers; " +
                    "  redis.call('ZREMRANGEBYRANK', KEYS[3], 0, removeCount - 1); " +
                    "end; " +
                    "return 1;",
            Long.class
    );

    /***
     * snapshotGlobalConfig
     */
    @Resource
    private SnapshotGlobalConfig snapshotGlobalConfig;

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    /**
     * å¢é‡ä»»åŠ¡å†™å…¥
     *
     * @param datasetName datasetName
     */
    public void write(String data, String datasetName) {
        IncrementalExecutionConfig executionConfig = snapshotGlobalConfig.instanceIncrementalConfig(datasetName);
        DatasetIncrementalConfig incrementalConfig = executionConfig.getIncrementalConfig();
        Long ttlSeconds = incrementalConfig.getTtlSeconds();
        Integer maxMembersSize = incrementalConfig.getMaxMembersSize();
        LocalDateTime now = LocalDateTime.now();

        // 1. è·å–å…¨å±€å”¯ä¸€ offset
        String offsetKey = SnapshotPathEnum.REDIS_INCR_LATEST_OFFSET_KEY.format(datasetName);
        Long offset = redisTemplate.opsForValue().increment(offsetKey);
        if (offset == null || offset <= 0) {
            offset = restoreOffsetFromDb(datasetName, offsetKey);
            // æ³¨æ„ï¼šrestore åå»ºè®® SET offsetKey offset+1 é¿å…é‡å¤ï¼Œæ­¤å¤„ç®€åŒ–
        }else {
            // 6. todo å°† offset å†™å…¥æ•°æ®åº“
        }

        // 2. è®¡ç®— shardId å’Œæ‰€æœ‰ keys
        long shardId = (offset - 1) / maxMembersSize;
        String shardKey = SnapshotPathEnum.REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId);
        long incrTimeSecond = executionConfig.getIncrIntervalTimeSecond(now, 1);
        String timeOffsetKey = SnapshotPathEnum.REDIS_INCR_TIME_OFFSET_KEY.format(datasetName, String.valueOf(incrTimeSecond));
        String timePeriodKey = SnapshotPathEnum.REDIS_INCR_TIME_PERIOD_KEY.format(datasetName);

        // 3. å‡†å¤‡ Lua å‚æ•°
        List<String> keys = Arrays.asList(shardKey, timeOffsetKey, timePeriodKey);
        List<String> args = Arrays.asList(
                data,
                String.valueOf(offset),
                String.valueOf(ttlSeconds),
                String.valueOf(incrTimeSecond),
                String.valueOf(maxMembersSize)
        );

        // 4. æ‰§è¡Œ Lua è„šæœ¬
        redisTemplate.execute(WRITE_INCREMENTAL_SCRIPT, keys, args);
    }

    /**
     * ä»æ•°æ®åº“æ¢å¤
     *
     * @param datasetName datasetName
     * @param offsetKey   offsetKey
     * @return {@link Long}
     */
    private long restoreOffsetFromDb(String datasetName, String offsetKey) {
        String lockKey = "lock:offset:init:" + datasetName;
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
        if (Boolean.FALSE.equals(locked)) {
            throw new RuntimeException("Interrupted while waiting for offset init");
        }
        try {
            // ä» DB è¯»å–æœ€æ–° offset
            // Long dbOffset = offsetRepository.getCurrentOffsetFromDb(datasetName);
            // long nextOffset = dbOffset + 1;
            // redisTemplate.opsForValue().set(offsetKey, String.valueOf(nextOffset));
            // return nextOffset;
        } finally {
            redisTemplate.delete(lockKey);
        }
        return 1;
    }


}
```



## 6ã€`FAQ`

### 1ï¼‰å®¹é”™ä¸æ¢å¤æœºåˆ¶

#### aã€`Redis` `offset` ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

- é€šè¿‡åˆ†å¸ƒå¼é” `lock:offset:init:user_tag` é˜²æ­¢å¹¶å‘åˆå§‹åŒ–ã€‚
- ä»æ•°æ®åº“è¯»å–æœ€æ–° `offset`ï¼Œ`+1` åå†™å› `Redis`ã€‚æ³¨æ„ä¸Šé”ï¼Œé˜²æ­¢å¹¶å‘
- **æ³¨æ„**ï¼šå½“å‰ä»£ç ä¸­ `DB` æ¢å¤é€»è¾‘è¢«æ³¨é‡Šï¼Œéœ€å®ç° `offsetRepository.getCurrentOffsetFromDb()`ã€‚



#### bã€æ•°æ®é‡å¤ `or` ä¸¢å¤±ï¼Ÿ

- **ä¸ä¿è¯ `exactly`-`once`**ï¼Œä½†å¯é€šè¿‡ offset å¹‚ç­‰å¤„ç†ï¼ˆæ¶ˆè´¹ç«¯å»é‡ï¼‰ã€‚
- å»ºè®®ï¼šä¸šåŠ¡æ•°æ®è‡ªå¸¦ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ï¼Œä¾¿äºå»é‡ã€‚







# ä¸‰ã€å…¨é‡åŠ è½½æ–¹æ¡ˆ

## 1ã€æ•´ä½“ç›®æ ‡

- **å¯åŠ¨æ—¶åŠ è½½æœ€æ–°å…¨é‡å¿«ç…§**ï¼ˆä»æœ¬åœ°æˆ– `OSS` ä¸‹è½½å¹¶ååºåˆ—åŒ–ï¼‰ã€‚
- **è¯»å– `Redis` ä¸­çš„å…ƒæ•°æ®**ï¼ˆåŒ…æ‹¬ `incrPullTimeLowerBound` å’Œå½“å‰ offsetï¼‰ã€‚
- å¢é‡æ‹‰å–ï¼š
  - ä»` Redis` `ZSET` æ‹‰å–å¢é‡æ•°æ®ï¼ˆåŸºäºæ—¶é—´åŒºé—´ + offsetï¼‰ã€‚
  - å¯¹å†…å­˜ä¸­çš„å…¨é‡æ•°æ®åš **åŸåœ°æ›´æ–°ï¼ˆ`add` / `delete` / `modify`ï¼‰**ã€‚
- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯5ç§’ï¼‰ï¼š
  - æ ¹æ®æœ¬åœ°è®°å½•çš„ `offset`ï¼ŒæŒç»­æ‹‰å–æ–°å†™å…¥çš„å¢é‡æ•°æ®ã€‚
  - æ›´æ–°æœ¬åœ° `offset`ã€‚

## 2ã€å…¨é‡åŠ è½½

### 1ï¼‰å®šæ—¶-åŠ è½½æ–¹æ¡ˆ

> **`Redis` + è½®è¯¢ï¼ˆç®€å•ï¼Œé€‚åˆå®¹å¿å»¶è¿Ÿï¼‰**

- **å®¢æˆ·ç«¯éšæœºå»¶è¿Ÿï¼ˆæœ€ç®€å•æœ‰æ•ˆï¼‰ï¼š**æ¯å°æœºå™¨æ”¶åˆ°â€œæ–°ç‰ˆæœ¬å¯ç”¨â€åï¼Œ**ä¸æ˜¯ç«‹å³ä¸‹è½½**ï¼Œè€Œæ˜¯éšæœºç­‰å¾… `0 ~ T` ç§’å†å¼€å§‹ã€‚

- **å•æœºé™æµï¼š**åˆ·æ–°æœŸé—´è¿›è¡Œé™æµï¼Œæ¯”å¦‚å¤šåˆ†ç‰‡åŒæ—¶ä¸‹è½½ç­‰

```java
while (true) {
    Long latest = redis.get("latest_snapshot_version");
    if (latest > currentVersion) {
        downloadFromCDN(latest);
        break;
    }
    Thread.sleep(5000); // æ¯ 5 ç§’æŸ¥ä¸€æ¬¡
}
```



### 2ï¼‰ä»£ç å®ç°

```java
package com.healerjean.proj.hotcache.service.pull;

import com.alibaba.fastjson.JSON;
import com.google.gson.Gson;
import com.healerjean.proj.hotcache.config.DatasetSnapshotConfig;
import com.healerjean.proj.hotcache.config.SnapshotGlobalConfig;
import com.healerjean.proj.hotcache.enums.SnapshotPathEnum;
import com.healerjean.proj.hotcache.factory.SnapshotFactory;
import com.healerjean.proj.hotcache.model.SnapshotMetadata;
import com.healerjean.proj.hotcache.model.UserTag;
import com.healerjean.proj.hotcache.service.cache.InMemoryUserTagCache;
import com.healerjean.proj.hotcache.service.serialization.DataSerializerStrategy;
import com.healerjean.proj.hotcache.service.storage.StorageServiceStrategy;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;

/**
 * FullLoadToMemoryService
 *
 * @author zhangyujin
 * @date 2025/11/6
 */
@Service
@Slf4j
public class FullLoadToMemoryService {

    @Autowired
    private SnapshotGlobalConfig snapshotGlobalConfig;

    @Autowired
    private InMemoryUserTagCache userTagCache;

    @Resource
    private RedisTemplate<String, String> redisTemplate;

    public void loadLatestFullSnapshotToMemory(String datasetName) throws Exception {
        // 1. ä» Redis è·å–æœ€æ–°ç‰ˆæœ¬
        String latestKey = SnapshotPathEnum.REDIS_SNAPSHOT_LATEST_VERSION_KEY.format(datasetName);
        String latestVersion = redisTemplate.opsForValue().get(latestKey);
        if (latestVersion == null) {
            throw new IllegalStateException("No full snapshot found in Redis");
        }

        // 2. è·å–å…ƒæ•°æ®ï¼ˆå« manifestUrlï¼‰
        String metaKey = SnapshotPathEnum.REDIS_SNAPSHOT_VERSION_META_KEY.format(datasetName, latestVersion);
        String metaJson = redisTemplate.opsForValue().get(metaKey);
        SnapshotMetadata metadata = new Gson().fromJson(metaJson, SnapshotMetadata.class);

        // 3. æ ¹æ® storageStrategy ä¸‹è½½æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶å¹¶ååºåˆ—åŒ–
        DatasetSnapshotConfig snapshotConfig = metadata.getConfig();
        StorageServiceStrategy storage = SnapshotFactory.getInstance().getStorageServiceStrategy(datasetName, snapshotConfig.getStorageStrategy());
        DataSerializerStrategy dataSerializer = SnapshotFactory.getInstance().getDataSerializer(datasetName, snapshotConfig.getSerializerStrategy());
        for (SnapshotMetadata.FileInfo fileInfo : metadata.getFileInfoMap().values()) {
            try (InputStream is = storage.download(fileInfo.getFilename())) {
                BufferedReader reader = new BufferedReader(new InputStreamReader(is));
                String line;
                while ((line = reader.readLine()) != null) {
                    if (!line.trim().isEmpty()) {
                        try {
                            UserTag userTag = (UserTag)dataSerializer.deserialize(line.getBytes(StandardCharsets.UTF_8));
                            userTagCache.put(userTag.getUserId(), userTag);
                        }catch (Exception e){
                            log.error("line:{}, fileInfo:{}", line, JSON.toJSONString(fileInfo), e);
                            throw new RuntimeException(e.getMessage(), e);
                        }
                    }
                }
            }
        }
        log.info("âœ… å…¨é‡åŠ è½½å®Œæˆï¼Œå…± {} æ¡è®°å½•", userTagCache.getAll().size());
    }
}
```



# å››ã€å¢é‡åŠ è½½æ–¹æ¡ˆ

## 1ã€èƒŒæ™¯ä¸ç›®æ ‡

> åœ¨é«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„ç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿä¸­ï¼Œ**å†…å­˜ç¼“å­˜**ï¼ˆå¦‚ `InMemoryUserTagCache`ï¼‰æ˜¯æå‡æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ã€‚ä½†å¦‚ä½•é«˜æ•ˆã€å¯é åœ°å°† Redis ä¸­çš„**å¢é‡æ•°æ®**åŒæ­¥åˆ°å†…å­˜ï¼Œæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚
>
> æ ¸å¿ƒç›®æ ‡ï¼š**ä» Redis ä¸­æŒ‰åç§»é‡ï¼ˆ`offset`ï¼‰æˆ–æ—¶é—´ä¸‹ç•Œï¼ˆ`time lower bound`ï¼‰æ‹‰å–å¢é‡æ•°æ®ï¼Œå¹¶æŒç»­åŠ è½½åˆ°æœ¬åœ°å†…å­˜ç¼“å­˜ä¸­ï¼Œå®ç°â€œçƒ­æ›´æ–°â€è€Œä¸ä¸­æ–­æœåŠ¡ã€‚**



## 2ã€æ ¸å¿ƒç»„ä»¶æ¦‚è§ˆ

### 1ï¼‰æ–¹æ³•æä¾›

è¯¥æœåŠ¡æä¾›ä¸¤ä¸ªä¸»è¦å…¥å£æ–¹æ³•ï¼š

| æ–¹æ³•                                              | åŠŸèƒ½                                                         |
| ------------------------------------------------- | ------------------------------------------------------------ |
| `pullIncrementalByOffset(String datasetName)`     | **åŸºäºåç§»é‡**ï¼ˆ`offset`ï¼‰æŒç»­æ‹‰å–å¢é‡æ•°æ®                   |
| `pullIncrementalByLowerBound(String datasetName)` | **åŸºäºæ—¶é—´ä¸‹ç•Œ**å®šä½èµ·å§‹ `offset`ï¼Œå†è°ƒç”¨ `pullIncrementalByOffset` |



### 2ï¼‰`Redis` æ•°æ®ç»“æ„ä¾èµ–

| Key ç±»å‹ | æšä¸¾                                | ç”¨é€”                                          |
| -------- | ----------------------------------- | --------------------------------------------- |
| `String` | `REDIS_SNAPSHOT_LATEST_VERSION_KEY` | å­˜å‚¨æœ€æ–°å¿«ç…§ç‰ˆæœ¬å·                            |
| `String` | `REDIS_SNAPSHOT_VERSION_META_KEY`   | å­˜å‚¨å¿«ç…§å…ƒæ•°æ®ï¼ˆå« `incrPullTimeLowerBound`ï¼‰ |
| `ZSet`   | `REDIS_INCR_TIME_PERIOD_KEY`        | æ—¶é—´æˆ³ â†’ ç”¨äºæŸ¥æ‰¾èµ·å§‹æ—¶é—´                     |
| `String` | `REDIS_INCR_TIME_OFFSET_KEY`        | æ—¶é—´æˆ³ â†’ offset æ˜ å°„                          |
| `ZSet`   | `REDIS_INCR_CURRENT_SHARD_KEY`      | åˆ†ç‰‡å¢é‡æ•°æ®ï¼ˆscore=offset, value=äº‹ä»¶å†…å®¹ï¼‰  |



### 3ï¼‰å…³é”®è®¾è®¡

#### aã€æ•°æ®åˆ†ç‰‡ï¼ˆ`Shardin`gï¼‰æœºåˆ¶

- å¢é‡æ•°æ®å­˜å‚¨åœ¨ `Redis` çš„ **`ZSET`** ä¸­ï¼ŒæŒ‰ **`score` = offset** æ’åºã€‚
- ç”±äº `ZSET` æœ‰æ€§èƒ½ä¸Šé™ï¼ˆå¦‚æˆå‘˜æ•°é™åˆ¶ï¼‰ï¼Œç³»ç»Ÿé‡‡ç”¨åˆ†ç‰‡ç­–ç•¥ï¼š
  - æ¯ä¸ªåˆ†ç‰‡æœ€å¤šå®¹çº³ `maxMembersSize` æ¡è®°å½•ã€‚
  - åˆ†ç‰‡ `ID` è®¡ç®—å…¬å¼ï¼š `shardId = (offset - 1) / maxMembersSize`
  - å¯¹åº” `Redis Key`ï¼š`REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId)`



#### bã€æœ¬åœ°åç§»é‡è¿½è¸ª

- æ¯ä¸ª `datasetName` ç»´æŠ¤ä¸€ä¸ª**åŸå­åç§»é‡**ï¼Œè¡¨ç¤º**å·²å¤„ç†çš„æœ€å¤§ `offset`**ã€‚
- åˆå§‹å€¼ç”± `pullIncrementalByLowerBound` æ ¹æ®æ—¶é—´æˆ³åæŸ¥å¾—åˆ°ã€‚

```java
private final static Map<String, AtomicLong> LOCAL_PROCESSED_OFFSET_MAP = new ConcurrentHashMap<>();
```



### 3ï¼‰ä»£ç å®ç°

#### aã€é€šè¿‡æ—¶é—´æ‹‰å–

```java
/**
 * æ—¶é—´é©±åŠ¨çš„èµ·å§‹ç‚¹å®šä½
 */
public void pullIncrementalByLowerBound(String datasetName) {
    // 1ã€ä» Redis è·å–æœ€æ–°å¿«ç…§ç‰ˆæœ¬ï¼ˆlatestVersionï¼‰
    String latestKey = SnapshotPathEnum.REDIS_SNAPSHOT_LATEST_VERSION_KEY.format(datasetName);
    String latestVersion = redisTemplate.opsForValue().get(latestKey);
    if (latestVersion == null) {
        throw new IllegalStateException("No full snapshot found in Redis");
    }

    // 2. è§£æå…¶å…ƒæ•°æ® SnapshotMetadataï¼Œè·å– incrPullTimeLowerBoundï¼ˆæ—¶é—´æˆ³ï¼‰
    String metaKey = SnapshotPathEnum.REDIS_SNAPSHOT_VERSION_META_KEY.format(datasetName, latestVersion);
    String metaJson = redisTemplate.opsForValue().get(metaKey);
    SnapshotMetadata metadata = new Gson().fromJson(metaJson, SnapshotMetadata.class);
    long incrPullTimeLowerBound = metadata.getIncrPullTimeLowerBound();
    String timePeriodKey = SnapshotPathEnum.REDIS_INCR_TIME_PERIOD_KEY.format(datasetName);

    // 3ã€ æŸ¥æ‰¾ >= æ—¶é—´ä¸‹ç•Œçš„ç¬¬ä¸€ä¸ªæ—¶é—´ç‚¹
    Set<String> candidates = redisTemplate.opsForZSet().rangeByScore(timePeriodKey, (double) incrPullTimeLowerBound, Double.MAX_VALUE, 0, 1);
    if (CollectionUtils.isEmpty(candidates)) {
        LOCAL_PROCESSED_OFFSET_MAP.put(datasetName, new AtomicLong(0));
        log.info("No time period found >= {} for dataset {}", incrPullTimeLowerBound, datasetName);
        return;
    }

    // 4ã€é€šè¿‡ REDIS_INCR_TIME_OFFSET_KEY åæŸ¥å¯¹åº”çš„ offset
    String firstTimeStr = candidates.iterator().next();
    String offsetKey = SnapshotPathEnum.REDIS_INCR_TIME_OFFSET_KEY.format(datasetName, firstTimeStr);
    String offsetValue = redisTemplate.opsForValue().get(offsetKey);
    long latestOffset = Long.parseLong(offsetValue);

    // 5ã€åˆå§‹åŒ– LOCAL_PROCESSED_OFFSET_MAP å¹¶å¯åŠ¨ pullIncrementalByOffset
    LOCAL_PROCESSED_OFFSET_MAP.put(datasetName, new AtomicLong(latestOffset));
    pullIncrementalByOffset(datasetName);
}
```



#### bã€é€šè¿‡æ¸¸æ ‡æ‹‰å–

```java
@Autowired
private SnapshotGlobalConfig snapshotGlobalConfig;

@Autowired
private InMemoryUserTagCache userTagCache;

@Resource
private RedisTemplate<String, String> redisTemplate;

private static final long PULL_BATCH_SIZE = 300L;

/**
 * æœ¬åœ°å·²å¤„ç†çš„åç§»é‡ï¼ˆå¿…é¡»å…ˆé€šè¿‡ pullIncrementalByLowerBound åˆå§‹åŒ–ï¼‰
 */
private final static Map<String, AtomicLong> LOCAL_PROCESSED_OFFSET_MAP = new ConcurrentHashMap<>();


/**
 * å¢é‡æ‹‰å–æµç¨‹
 *
 * @param datasetName datasetName
 */
public void pullIncrementalByOffset(String datasetName) {
    if (!LOCAL_PROCESSED_OFFSET_MAP.containsKey(datasetName)) {
        log.warn("Offset not initialized for dataset: {}. Skipping pull. Call pullIncrementalByLowerBound first.", datasetName);
        return;
    }
    IncrementalExecutionConfig executionConfig = snapshotGlobalConfig.instanceIncrementalConfig(datasetName);
    DatasetIncrementalConfig incrementalConfig = executionConfig.getIncrementalConfig();
    Integer maxMembersSize = incrementalConfig.getMaxMembersSize();
    AtomicLong atomicCurrentOffset = LOCAL_PROCESSED_OFFSET_MAP.get(datasetName);

    while (true) {
        // 1ã€è®¡ç®—å½“å‰åº”è¯»å–çš„ shardIdï¼Œ
        long currentOffset = atomicCurrentOffset.get();
        String latestKey = SnapshotPathEnum.REDIS_INCR_LATEST_OFFSET_KEY.format(datasetName);
        String latestOffsetStr = redisTemplate.opsForValue().get(latestKey);
        long latestOffset = Long.parseLong(latestOffsetStr);
        if (currentOffset >= latestOffset) {
            // å½“å‰ shard å·²è¿½ä¸Šæœ€æ–° offset â†’ ç»“æŸ
            log.debug("Dataset {} caught up to latest offset {}, sleeping...", datasetName, latestOffset);
            break;
        }

        // 2ã€ä» Redis ZSET æ‹‰å–ä¸€æ‰¹æ•°æ®
        long shardId = currentOffset / maxMembersSize;
        String shardKey = SnapshotPathEnum.REDIS_INCR_CURRENT_SHARD_KEY.format(datasetName, shardId);
        long nextOffset = currentOffset + 1;
        double maxScore = Math.min(nextOffset + PULL_BATCH_SIZE - 1, latestOffset);
        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet().rangeByScoreWithScores(shardKey, (double) nextOffset, maxScore);

        // 3ã€é˜²æ­¢æ‹‰å–æ•°æ®ä¸ºç©ºï¼Œä¸”å½“å‰ offset æœªæ›´æ–°ï¼Œåˆ™ç»§ç»­æ‹‰å–
        if (CollectionUtils.isEmpty(tuples)) {
            // å½“å‰ shard æ— æ•°æ®ï¼Œå°è¯•è·³è½¬åˆ°ä¸‹ä¸€ä¸ª shard èµ·å§‹ä½ç½®
            long nextShardStart = (shardId + 1) * maxMembersSize;
            long jumpTo = Math.min(nextShardStart, latestOffset);
            // å¦‚æœè·³è½¬å¹…åº¦å¾ˆå¤§ï¼ˆæ¯”å¦‚è¶…è¿‡ä¸€ä¸ª batchï¼‰ï¼Œå…ˆå°æ­¥è¯•æ¢
            if (jumpTo - currentOffset > PULL_BATCH_SIZE * 2) {
                // åªå‰è¿›ä¸€å°æ­¥ï¼Œé¿å…è·¨åº¦è¿‡å¤§è·³è¿‡å¼‚å¸¸æ•°æ®
                jumpTo = currentOffset + 1;
            }

            if (jumpTo > currentOffset) {
                atomicCurrentOffset.set(jumpTo);
                log.debug("Advanced offset to {} for dataset {}", jumpTo, datasetName);
                continue;
            }
            // å·²åˆ°æœ€æ–°ï¼Œä½†ä»æ— æ•°æ® â†’ å¯èƒ½æ•°æ®å»¶è¿Ÿï¼Œç¨åé‡è¯•
            log.debug("No data found in shard {} for dataset {}, but not caught up yet.", shardId, datasetName);
            break;
        }

        // 4ã€æ‰¹é‡å¤„ç† & æ›´æ–°åç§»é‡
        for (ZSetOperations.TypedTuple<String> data : tuples) {
            Double score = data.getScore();
            String value = data.getValue();
        }

        // 5ã€æ›´æ–°æœ¬åœ° offset ä¸ºæœ¬æ¬¡æ‹‰å–çš„æœ€å¤§ score
        // æ›´æ–° offset ä¸ºæœ¬æ¬¡æœ€å¤§ scoreï¼ˆæ³¨æ„ï¼šä¸å† +1ï¼‰
        long maxProcessedOffset = tuples.stream()
                .mapToLong(t -> Objects.requireNonNull(t.getScore()).longValue())
                .max()
                .orElse(currentOffset);

        atomicCurrentOffset.set(maxProcessedOffset);
        log.debug("Pulled {} records for dataset {}, offset updated to {}",
                tuples.size(), datasetName, maxProcessedOffset);
    }
}
```





# äº”ã€æ•°æ®éªŒè¯æ–¹æ¡ˆ

## 1ã€å¯è§‚æµ‹æ€§éªŒè¯

### 1ï¼‰å…³é”®éªŒè¯æ¸…å•

| éªŒè¯ç±»åˆ«     | å…³é”®é—®é¢˜               | éªŒè¯æ‰‹æ®µ              |
| ------------ | ---------------------- | --------------------- |
| **æ•°æ®å®Œæ•´** | å…¨é‡æ˜¯å¦ä¸¢æ•°æ®ï¼Ÿ       | è¡Œæ•°å¯¹æ¯” + æŠ½æ ·æ ¡éªŒ   |
| **åŸå­å‘å¸ƒ** | æ˜¯å¦è¯»åˆ°åŠæˆå“ï¼Ÿ       | ä¸­æ–­æµ‹è¯• + æ–‡ä»¶æ£€æŸ¥   |
| **å®¹é”™æ¢å¤** | `Redis` æŒ‚äº†èƒ½å¦æ¢å¤ï¼Ÿ | æ¸…ç©º offset + é‡å¯    |
| æ€§èƒ½è¾¾æ ‡     | èƒ½å¦æ”¯æ’‘5000å°ï¼Ÿ       | å‹æµ‹ + CDN å¹¶å‘æµ‹è¯•   |
| è‡ªåŠ¨æ¸…ç†     | å­˜å‚¨æ˜¯å¦ä¼šçˆ†ç‚¸ï¼Ÿ       | æ¨¡æ‹Ÿå¤šç‰ˆæœ¬ + æ£€æŸ¥æ¸…ç† |



### 2ï¼‰å¿…é¡»å…·å¤‡çš„ç›‘æ§é¡¹ï¼š

| ç±»åˆ«       | ç›‘æ§é¡¹                                | éªŒè¯æ–¹å¼                   |
| ---------- | ------------------------------------- | -------------------------- |
| **å…¨é‡**   | å¿«ç…§ç”Ÿæˆè€—æ—¶ã€æ–‡ä»¶å¤§å°ã€`recordCount` | æŸ¥çœ‹æ—¥å¿—æˆ– Prometheus æŒ‡æ ‡ |
| **å¢é‡**   | å½“å‰ offsetã€æ¯ç§’å¤„ç†é‡ã€åˆ†ç‰‡æ•°é‡     | Redis ç›‘æ§ + åº”ç”¨æŒ‡æ ‡      |
| **å­˜å‚¨**   | OSS/S3 æ–‡ä»¶æ•°é‡ã€æ€»å¤§å°               | å­˜å‚¨å¹³å°æ§åˆ¶å°             |
| **ä¸€è‡´æ€§** | å„èŠ‚ç‚¹ç¼“å­˜å·®å¼‚ç‡                      | æ—¥å¿—é‡‡æ ·æ¯”å¯¹               |
| **é”™è¯¯**   | åºåˆ—åŒ–å¤±è´¥ã€ç½‘ç»œè¶…æ—¶ã€DB è¿æ¥å¼‚å¸¸     | å‘Šè­¦æ—¥å¿—                   |



## 2ã€æ•°æ®å‡†ç¡®æ€§éªŒè¯

### 1ï¼‰**æ•°æ®å®Œæ•´æ€§éªŒè¯**

- **ç›®æ ‡**ï¼š**ç¡®è®¤å…¨é‡å¿«ç…§åŒ…å«æ‰€æœ‰åº”æœ‰è®°å½•ï¼Œæ— é—æ¼ã€‚**
- æ–¹æ³•ï¼š
  - å¯¹æ¯”æºæ•°æ®åº“ï¼ˆå¦‚ `MySQL`ï¼‰ä¸­ `user_tag` è¡¨çš„æ€»è¡Œæ•° `vs` å¿«ç…§å…ƒæ•°æ®ä¸­çš„ `recordCount`ã€‚
  - æŠ½æ ·æ ¡éªŒï¼šéšæœºé€‰å–è‹¥å¹² `user_id`ï¼Œæ£€æŸ¥å…¶åœ¨å¿«ç…§æ–‡ä»¶å’Œæ•°æ®åº“ä¸­çš„å­—æ®µæ˜¯å¦ä¸€è‡´ï¼ˆå¦‚ `tag_value`, `update_time`ï¼‰ã€‚
  - æ£€æŸ¥åˆ†ç‰‡æ€»æ•° Ã— å¹³å‡æ¯ç‰‡è®°å½•æ•° â‰ˆ æ€»è®°å½•æ•°ï¼ˆé¿å…æŸåˆ†ç‰‡ä¸¢å¤±



### 2ï¼‰**æ–‡ä»¶åŸå­æ€§ä¸ä¸€è‡´æ€§éªŒè¯**

- **ç›®æ ‡**ï¼š**ç¡®ä¿å®¢æˆ·ç«¯ä¸ä¼šè¯»åˆ°â€œåŠæˆå“â€å¿«ç…§**ã€‚
- æ–¹æ³•ï¼š
  - åœ¨å¿«ç…§ç”Ÿæˆè¿‡ç¨‹ä¸­ `kill` è¿›ç¨‹ï¼Œé‡å¯åæ£€æŸ¥ï¼š
    - æ˜¯å¦å­˜åœ¨ `.tmp` æ–‡ä»¶ï¼ˆè¯´æ˜æœªå®Œæˆå‘å¸ƒï¼‰ã€‚
    - **ç¡®ä¿`Redis` ä¸­çš„ `latest` ç‰ˆæœ¬æ˜¯å¦ä»ä¸ºæ—§ç‰ˆæœ¬ï¼ˆæœªé”™è¯¯æ›´æ–°ï¼‰ã€‚**
  - å‘å¸ƒå®Œæˆåï¼Œæ£€æŸ¥æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å‘½åè§„èŒƒï¼ˆæ—  `.tmp` åç¼€ï¼‰ã€‚



### 3ï¼‰**å‹ç¼©ä¸åºåˆ—åŒ–æ­£ç¡®æ€§éªŒè¯**

- **ç›®æ ‡**ï¼š`Protobuf` + `GZIP` èƒ½æ­£ç¡®ååºåˆ—åŒ–ã€‚
- æ–¹æ³•ï¼š
  - æ‰‹åŠ¨ä¸‹è½½ä¸€ä¸ª `.pb.gz` æ–‡ä»¶ï¼Œç”¨å·¥å…·ï¼ˆå¦‚ `protoc --decode` æˆ–è‡ªç ”è§£æè„šæœ¬ï¼‰è§£å‹å¹¶è§£æã€‚
  - éªŒè¯è§£æå‡ºçš„æ•°æ®ç»“æ„ä¸åŸå§‹è®°å½•ä¸€è‡´ï¼ˆå­—æ®µåã€ç±»å‹ã€å€¼ï¼‰ã€‚





### 4ï¼‰**`5000` å°æœºå™¨æ•°æ®ä¸€è‡´æ€§éªŒè¯**

- **ç›®æ ‡**ï¼šæ‰€æœ‰èŠ‚ç‚¹æœ€ç»ˆçŠ¶æ€åŸºæœ¬ä¸€è‡´ï¼ˆç§’çº§å»¶è¿Ÿå†…ï¼‰ã€‚
- æ–¹æ³•ï¼š
  - åœ¨ä¸€å°æœºå™¨ä¸ŠæŸ¥è¯¢æŸä¸ª `user_id` çš„æ ‡ç­¾ã€‚
  - åŒæ—¶åœ¨å…¶ä»–å¤šå°æœºå™¨ä¸ŠæŸ¥è¯¢åŒä¸€ `user_id`ã€‚
  - æ±‡æ€»æ•°æ®å®šæ—¶ä¸ŠæŠ¥ï¼Œé€šè¿‡æ—¥å¿—é‡‡é›† + èšåˆåˆ†æå®ç°å¤§è§„æ¨¡æ¯”å¯¹ã€‚



## 3ã€æ€§èƒ½ä¸ç¨³å®šæ€§éªŒè¯

### 1ï¼‰**å…¨é‡å¯¼å‡ºæ€§èƒ½éªŒè¯**

- æŒ‡æ ‡ï¼š
  - å¯¼å‡ºè€—æ—¶ â‰¤ 10åˆ†é’Ÿï¼ˆ1000ä¸‡æ¡ï¼‰ã€‚
  - å†…å­˜å ç”¨ < 200MBï¼ˆæµå¼å¤„ç†ï¼‰ã€‚
  - `CPU`  ä½¿ç”¨ç‡å¹³ç¨³ï¼Œæ— é•¿æ—¶é—´ GCã€‚
- æ–¹æ³•ï¼š
  - åœ¨ç”Ÿäº§ç±»ä¼¼ç¯å¢ƒå‹æµ‹ï¼Œç›‘æ§èµ„æºä½¿ç”¨ã€‚
  - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `OOM`ã€è¶…æ—¶ã€è¿æ¥æ± è€—å°½ç­‰é”™è¯¯ã€‚

### 2ï¼‰**å¢é‡ååéªŒè¯**

- æŒ‡æ ‡ï¼š
  - æ”¯æŒ â‰¥ 1ä¸‡æ¡/ç§’çš„å¢é‡å†™å…¥ã€‚
  - `Redis ZSET` å•åˆ†ç‰‡ â‰¤ `4000` æ¡ï¼Œé¿å…å¤§ `Key`ã€‚
- æ–¹æ³•ï¼š
  - ä½¿ç”¨å‹æµ‹å·¥å…·æ¨¡æ‹Ÿé«˜å¹¶å‘å¢é‡äº‹ä»¶ã€‚
  - ç›‘æ§ `Redis` å†…å­˜ã€`CPU`ã€ç½‘ç»œå¸¦å®½ã€‚
  - æ£€æŸ¥ `LOCAL_PROCESSED_OFFSET_MAP` æ˜¯å¦æŒç»­å¢é•¿ï¼ˆæ— å¡é¡¿ï¼‰ã€‚

### 3ï¼‰**`CDN` ä¸‹è½½å¹¶å‘éªŒè¯**

- **ç›®æ ‡**ï¼š`5000` å°æœºå™¨èƒ½å¿«é€Ÿä¸‹è½½å¿«ç…§ã€‚
- æ–¹æ³•ï¼š
  - æ¨¡æ‹Ÿ 1000~5000 å°å®¢æˆ·ç«¯å¹¶å‘ä» `CDN` ä¸‹è½½ `.pb.gz` æ–‡ä»¶ã€‚
  - æµ‹é‡å¹³å‡ä¸‹è½½æ—¶é—´ã€å¤±è´¥ç‡ã€‚
  - ç¡®è®¤ `CDN` ç¼“å­˜å‘½ä¸­ç‡ > `99%`ï¼ˆé¦–å°å›æºï¼Œå…¶ä½™å‘½ä¸­è¾¹ç¼˜èŠ‚ç‚¹ï¼‰ã€‚



### 4ï¼‰`CPU` å½±å“

> **â€œå°‘åˆ†é…ã€æ…¢å¤„ç†ã€é”™å³°å¹²ã€åˆ†éš”ç¦»â€**ï¼Œå†…å­˜æœåŠ¡çš„æ€§èƒ½ç“¶é¢ˆå¾€å¾€ä¸åœ¨è®¡ç®—ï¼Œè€Œåœ¨ **å¯¹è±¡åˆ›å»ºè¿‡å¤š â†’ è§¦å‘é¢‘ç¹ GC â†’ STWï¼ˆStop-The-Worldï¼‰å¡é¡¿**ã€‚

| ç›®æ ‡         | å…·ä½“æ€ä¹ˆåš                                            |
| ------------ | ----------------------------------------------------- |
| **é™ `GC`**  | æµå¼å¤„ç† + é¿å…ä¸­é—´å¯¹è±¡ + ç”¨åŸç”Ÿæ•°ç»„ + å¯¹è±¡æ± ï¼ˆè°¨æ…ï¼‰ |
| **ç¨³ `CPU`** | é”™å³°å…¨é‡ + é™æµå¢é‡ + åˆ†æ‰¹æ‹‰å–ï¼ˆæ¯æ‰¹ â‰¤1000 æ¡ï¼‰       |
| **ä¼˜å†…å­˜**   | æ‰å¹³ç»“æ„ + ä¸å¯å˜å…¨é‡å¿«ç…§ + é¿å… HashMap åµŒå¥—         |
| **è°ƒ `JVM`** | å›ºå®šå † + `G1`/`ZGC` + ç›‘æ§ GC æ—¥å¿—                    |
| **åšéš”ç¦»**   | æ‹‰å–å’ŒæœåŠ¡åˆ†ç¦»è¿›ç¨‹ï¼Œæˆ–ç”¨ `cgroup` é™ `CPU`            |



#### aã€æ§åˆ¶æ‹‰å–èŠ‚å¥ â†’ é¿å… CPU çªåˆº

> å…¨é‡ + å¤šæºå¢é‡åŒæ—¶æ‹‰ï¼ŒCPU ç¬é—´æ‰“æ»¡ï¼ŒGC è·Ÿç€æš´å¢ã€‚

- **é”™å³°è°ƒåº¦å…¨é‡ä»»åŠ¡**
  - ä¸è¦æ‰€æœ‰æ•°æ®æºåŒæ—¶å¼€å§‹å…¨é‡ï¼›
  - é€šè¿‡é…ç½®ä¸­å¿ƒæˆ– `cron` æ§åˆ¶å¯åŠ¨æ—¶é—´ã€‚
- **é™åˆ¶å¢é‡æ¶ˆè´¹é€Ÿç‡**
  - ç»™æ¯ä¸ªæ•°æ®æºçš„å¢é‡æ‹‰å–è®¾ç½® **æœ€å¤§ååä¸Šé™**ï¼ˆå¦‚ 5000 æ¡/ç§’ï¼‰ï¼›
  - è¶…è¿‡å°± `sleep` æˆ–ä¸¢å¼ƒèƒŒå‹ï¼ˆæ ¹æ®ä¸šåŠ¡å®¹å¿åº¦ï¼‰ï¼›
- **æµå¼å¤„ç†ï¼Œç¦æ­¢â€œå…¨è½½å…¥å†å¤„ç†â€**
  - å…¨é‡å¯¼å‡ºæ—¶ï¼Œ**è¾¹è¯»è¾¹è§£æè¾¹æ›´æ–°å†…å­˜**ï¼Œä¸è¦å…ˆæŠŠ 1000 ä¸‡æ¡å…¨ load åˆ° List é‡Œï¼›
  - ç”¨ `cursor` / `scroll API` åˆ†æ‰¹æ‹‰ï¼ˆæ¯æ‰¹ 1000 æ¡ï¼‰ï¼Œå¤„ç†å®Œä¸€æ‰¹å†æ‹‰ä¸‹ä¸€æ‰¹ã€‚

#### bã€å†…å­˜ç»“æ„ä¼˜åŒ– â†’ å‡å°‘ `GC` `Roots` 

- **ä½¿ç”¨ç´§å‡‘å†…å­˜å¸ƒå±€**

  - `Map<Long, String>`ï¼ˆ`HashMap` èŠ‚ç‚¹å¯¹è±¡å¤šï¼Œ`GC` å‹åŠ›å¤§ï¼‰ã€‚

  - ä¾‹å¦‚ï¼šæŠŠ user_id â†’ tag æ˜ å°„ï¼Œç”¨ä¸¤ä¸ªå¹³è¡Œæ•°ç»„å®ç°ï¼ˆç±»ä¼¼åˆ—å¼å­˜å‚¨ï¼‰ï¼š

    ```java
    user_ids: [1001, 1002, 1003, ...]  
    tags:     ["VIP", "NORMAL", "TEST", ...]
    ```

    ```
    Map<Long, String>ï¼ˆHashMap èŠ‚ç‚¹å¯¹è±¡å¤šï¼ŒGC å‹åŠ›å¤§ï¼‰
    ```

- **é¿å…åµŒå¥—å¯¹è±¡å’Œé•¿é“¾å¼•ç”¨**

  - å¯¹è±¡å›¾è¶Šæ‰å¹³ï¼Œ`GC` æ‰«æè¶Šå¿«ï¼›
  - ä¸è¦ç”¨ `User -> Profile -> Settings -> Map<...>` è¿™ç§æ·±ç»“æ„ã€‚

  

- **å®šæœŸâ€œå†»ç»“â€å…¨é‡æ•°æ®**

  - å…¨é‡åŠ è½½å®Œæˆåï¼ŒæŠŠæ•°æ®ç»“æ„æ ‡è®°ä¸º **ä¸å¯å˜ï¼ˆ`Immutable`ï¼‰**ï¼›
  - åç»­å¢é‡åªæ›´æ–°å¢é‡ç¼“å­˜ï¼ŒæŸ¥è¯¢æ—¶ `merge`ï¼›
  - ä¸å¯å˜å¯¹è±¡æ›´å®¹æ˜“è¢« `JVM` ä¼˜åŒ–ï¼Œä¸”ä¸ä¼šåœ¨è€å¹´ä»£é¢‘ç¹ä¿®æ”¹ã€‚













![ContactAuthor](https://raw.githubusercontent.com/HealerJean/HealerJean.github.io/master/assets/img/artical_bottom.jpg)



<!-- Gitalk è¯„è®º start  -->

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>Â 
<div id="gitalk-container"></div>Â    
 <script type="text/javascript">
    var gitalk = new Gitalk({
		clientID: `1d164cd85549874d0e3a`,
		clientSecret: `527c3d223d1e6608953e835b547061037d140355`,
		repo: `HealerJean.github.io`,
		owner: 'HealerJean',
		admin: ['HealerJean'],
		id: 'o6Fh1rEi5GbzvuNe',
    });
    gitalk.render('gitalk-container');
</script>Â 




<!-- Gitalk end -->



